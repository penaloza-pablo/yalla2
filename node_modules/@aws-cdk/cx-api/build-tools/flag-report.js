"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Generate FEATURE_FLAGS.md, a report of all current feature flags
 */
const fs_1 = require("fs");
const path = require("path");
const validate_flags_1 = require("./validate-flags");
const feats = require("../lib/features");
const flag_modeling_1 = require("../lib/private/flag-modeling");
async function main() {
    (0, validate_flags_1.validateFlags)();
    await updateMarkdownFile(path.join(__dirname, '..', 'FEATURE_FLAGS.md'), {
        table: flagsTable(),
        details: flagsDetails(),
        json: recommendedJson(),
        removed: removedFlags(),
        diff: changedFlags(),
        migratejson: migrateJson(),
    });
    // Write to the package root
    await updateRecommendedFlagsFile(path.join(__dirname, '..', '..', 'recommended-feature-flags.json'));
}
function flagsTable() {
    return renderTable([
        ['Flag', 'Summary', 'Since', 'Type'],
        ...v2flags().map(([name, flag]) => [
            renderLink(mdEsc(name), githubHeadingLink(flagDetailsHeading(name, flag))),
            flag.summary,
            flag.introducedIn.v2 ?? '',
            renderType(flag.type, 'short'),
        ]),
    ]);
}
function removedFlags() {
    const removedInV2 = flags(flag => flag.introducedIn.v2 === undefined && flag.introducedIn.v1 !== undefined);
    return renderTable([
        ['Flag', 'Summary', 'Type', 'Since'],
        ...removedInV2.map(([name, flag]) => [
            renderLink(mdEsc(name), githubHeadingLink(flagDetailsHeading(name, flag))),
            flag.summary,
            renderType(flag.type, 'short'),
            flag.introducedIn.v1 ?? '',
        ]),
    ]);
}
function changedFlags() {
    const changedInV2 = flags(flag => !!flag.unconfiguredBehavesLike?.v2 && !!flag.introducedIn.v2);
    return renderTable([
        ['Flag', 'Summary', 'Type', 'Since', 'v1 default', 'v2 default'],
        ...changedInV2.map(([name, flag]) => [
            renderLink(mdEsc(name), githubHeadingLink(flagDetailsHeading(name, flag))),
            flag.summary,
            renderType(flag.type, 'short'),
            flag.introducedIn.v1 ?? '',
            renderValue(false),
            renderValue(flag.unconfiguredBehavesLike?.v2),
        ]),
    ]);
}
function migrateJson() {
    const changedInV2 = flags(flag => !!flag.unconfiguredBehavesLike?.v2 && !!flag.introducedIn.v2 && !!flag.introducedIn.v1);
    const context = Object.fromEntries(changedInV2.map(([name, _]) => [name, false]));
    return [
        '```json',
        JSON.stringify({ context }, undefined, 2),
        '```',
    ].join('\n');
}
function flagsDetails() {
    const allFlags = flags(_ => true);
    return allFlags.flatMap(([name, flag]) => [
        `### ${flagDetailsHeading(name, flag)}`,
        '',
        `*${flag.summary}*`,
        '',
        `Flag type: ${renderType(flag.type, 'long')}`,
        '',
        dedent(flag.detailsMd),
        '',
        renderTable([
            ['Since', 'Unset behaves like', 'Recommended value'],
            // V1
            flag.introducedIn.v1
                ? [flag.introducedIn.v1, renderValue(false), renderValue(flag.recommendedValue)]
                : ['(not in v1)', '', ''],
            // V2
            flag.introducedIn.v2
                ? [flag.introducedIn.v2, renderValue(flag.unconfiguredBehavesLike?.v2 ?? false), renderValue(flag.recommendedValue)]
                : flag.unconfiguredBehavesLike?.v2 !== undefined
                    ? ['(not configurable in v2)', renderValue(flag.unconfiguredBehavesLike?.v2), '']
                    : ['(not in v2)', '', ''],
        ]),
        ...oldBehavior(flag) ? [
            `**Compatibility with old behavior:** ${oldBehavior(flag)}`,
            '',
        ] : [],
        '',
    ]).join('\n');
}
function oldBehavior(flag) {
    switch (flag.type) {
        case flag_modeling_1.FlagType.ApiDefault: return flag.compatibilityWithOldBehaviorMd;
        case flag_modeling_1.FlagType.BugFix: return flag.compatibilityWithOldBehaviorMd;
        case flag_modeling_1.FlagType.VisibleContext: return undefined;
        case flag_modeling_1.FlagType.Temporary: return flag.compatibilityWithOldBehaviorMd;
    }
}
function recommendedJson() {
    return [
        '```json',
        JSON.stringify({ context: feats.CURRENTLY_RECOMMENDED_FLAGS }, undefined, 2),
        '```',
    ].join('\n');
}
function v2flags() {
    return flags(flag => flag.introducedIn.v2 !== undefined);
}
function flags(pred) {
    const entries = Object.entries(feats.FLAGS)
        .filter(([_, flag]) => pred(flag));
    entries.sort((a, b) => firstCmp(
    // Sort by versions first
    (0, flag_modeling_1.compareVersions)(a[1].introducedIn.v2, b[1].introducedIn.v2), (0, flag_modeling_1.compareVersions)(a[1].introducedIn.v1, b[1].introducedIn.v1), 
    // Then sort by name
    a[0].localeCompare(b[0])));
    return entries;
}
function renderType(type, flavor) {
    switch (type) {
        case flag_modeling_1.FlagType.ApiDefault: return longShort('New default behavior', 'new default');
        case flag_modeling_1.FlagType.BugFix: return longShort('Backwards incompatible bugfix', 'fix');
        case flag_modeling_1.FlagType.VisibleContext: return longShort('Configuration option', 'config');
        case flag_modeling_1.FlagType.Temporary: return longShort('Temporary flag', 'temporary');
    }
    function longShort(long, short) {
        return flavor === 'long' ? long : short;
    }
}
function renderTable(rows) {
    return [
        '',
        '| ' + rows[0].join(' | ') + ' |',
        '| ' + rows[0].map(_ => '-----').join(' | ') + ' |',
        ...rows.slice(1).map(row => '| ' + row.join(' | ') + ' |'),
        '',
    ].join('\n');
}
/**
 * Return the heading that will be used to caption this flag's details
 */
function flagDetailsHeading(name, _) {
    return name;
}
/**
 * Return a link that is valid on GitHub to refer to a heading
 */
function githubHeadingLink(heading) {
    return `#${heading.toLowerCase().replace(/ /g, '-').replace(/[^a-z0-9_-]/g, '')}`;
}
/**
 * Remove shared leading whitespace from all non-empty lines
 */
function dedent(body) {
    const lines = body.split('\n').filter((x) => x.trim() !== '');
    const leadingWs = lines.map(x => x.match(/^ */)?.[0].length ?? 0);
    const sharedWs = Math.min(...leadingWs);
    const re = new RegExp('^' + ' '.repeat(sharedWs), 'mg');
    return body.replace(re, '').trim();
}
function renderValue(x) {
    return `\`${JSON.stringify(x)}\``;
}
function renderLink(caption, link) {
    return `[${caption}](${link})`;
}
function mdEsc(x) {
    return x.replace(/_/g, '\\_');
}
async function updateMarkdownFile(filename, sections) {
    let contents = await fs_1.promises.readFile(filename, { encoding: 'utf-8' });
    for (const [section, value] of Object.entries(sections)) {
        const re = new RegExp(`<!-- BEGIN ${section} -->(.*)<!-- END ${section} -->`, 's');
        contents = contents.replace(re, `<!-- BEGIN ${section} -->\n${value}\n<!-- END ${section} -->`);
    }
    await fs_1.promises.writeFile(filename, contents, { encoding: 'utf-8' });
}
async function updateRecommendedFlagsFile(filename) {
    await fs_1.promises.writeFile(filename, JSON.stringify(feats.CURRENTLY_RECOMMENDED_FLAGS, undefined, 2), { encoding: 'utf-8' });
}
function firstCmp(...xs) {
    return xs.find(x => x !== 0) ?? 0;
}
main().catch(e => {
    console.error(e);
    process.exitCode = 1;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhZy1yZXBvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmbGFnLXJlcG9ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOztHQUVHO0FBQ0gsMkJBQW9DO0FBQ3BDLDZCQUE2QjtBQUM3QixxREFBaUQ7QUFDakQseUNBQXlDO0FBQ3pDLGdFQUFtRjtBQUVuRixLQUFLLFVBQVUsSUFBSTtJQUNqQixJQUFBLDhCQUFhLEdBQUUsQ0FBQztJQUVoQixNQUFNLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxFQUFFO1FBQ3ZFLEtBQUssRUFBRSxVQUFVLEVBQUU7UUFDbkIsT0FBTyxFQUFFLFlBQVksRUFBRTtRQUN2QixJQUFJLEVBQUUsZUFBZSxFQUFFO1FBQ3ZCLE9BQU8sRUFBRSxZQUFZLEVBQUU7UUFDdkIsSUFBSSxFQUFFLFlBQVksRUFBRTtRQUNwQixXQUFXLEVBQUUsV0FBVyxFQUFFO0tBQzNCLENBQUMsQ0FBQztJQUVILDRCQUE0QjtJQUM1QixNQUFNLDBCQUEwQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsZ0NBQWdDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZHLENBQUM7QUFFRCxTQUFTLFVBQVU7SUFDakIsT0FBTyxXQUFXLENBQUM7UUFDakIsQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUM7UUFDcEMsR0FBRyxPQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQ2hDO1lBQ0UsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxpQkFBaUIsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMxRSxJQUFJLENBQUMsT0FBTztZQUNaLElBQUksQ0FBQyxZ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YSByZXBvcnQgb2YgYWxsIGN1cnJlbnQgZmVhdHVyZSBmbGFnc1xuICovXG5pbXBvcnQgeyBwcm9taXNlcyBhcyBmcyB9IGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyB2YWxpZGF0ZUZsYWdzIH0gZnJvbSAnLi92YWxpZGF0ZS1mbGFncyc7XG5pbXBvcnQgKiBhcyBmZWF0cyBmcm9tICcuLi9saWIvZmVhdHVyZXMnO1xuaW1wb3J0IHsgRmxhZ0luZm8sIEZsYWdUeXBlLCBjb21wYXJlVmVyc2lvbnMgfSBmcm9tICcuLi9saWIvcHJpdmF0ZS9mbGFnLW1vZGVsaW5nJztcblxuYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcbiAgdmFsaWRhdGVGbGFncygpO1xuXG4gIGF3YWl0IHVwZGF0ZU1hcmtkb3duRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnRkVBVFVSRV9GTEFHUy5tZCcpLCB7XG4gICAgdGFibGU6IGZsYWdzVGFibGUoKSxcbiAgICBkZXRhaWxzOiBmbGFnc0RldGFpbHMoKSxcbiAgICBqc29uOiByZWNvbW1lbmRlZEpzb24oKSxcbiAgICByZW1vdmVkOiByZW1vdmVkRmxhZ3MoKSxcbiAgICBkaWZmOiBjaGFuZ2VkRmxhZ3MoKSxcbiAgICBtaWdyYXRlanNvbjogbWlncmF0ZUpzb24oKSxcbiAgfSk7XG5cbiAgLy8gV3JpdGUgdG8gdGhlIHBhY2thZ2Ugcm9vdFxuICBhd2FpdCB1cGRhdGVSZWNvbW1lbmRlZEZsYWdzRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAncmVjb21tZW5kZWQtZmVhdHVyZS1mbGFncy5qc29uJykpO1xufVxuXG5mdW5jdGlvbiBmbGFnc1RhYmxlKCkge1xuICByZXR1cm4gcmVuZGVyVGFibGUoW1xuICAgIFsnRmxhZycsICdTdW1tYXJ5JywgJ1NpbmNlJywgJ1R5cGUnXSxcbiAgICAuLi52MmZsYWdzKCkubWFwKChbbmFtZSwgZmxhZ10pID0+XG4gICAgICBbXG4gICAgICAgIHJlbmRlckxpbmsobWRFc2MobmFtZSksIGdpdGh1YkhlYWRpbmdMaW5rKGZsYWdEZXRhaWxzSGVhZGluZyhuYW1lLCBmbGFnKSkpLFxuICAgICAgICBmbGFnLnN1bW1hcnksXG4gICAgICAgIGZsYWcuaW50cm9kdWNlZEluLnYyID8/ICcnLFxuICAgICAgICByZW5kZXJUeXBlKGZsYWcudHlwZSwgJ3Nob3J0JyksXG4gICAgICBdLFxuICAgICksXG4gIF0pO1xufVxuXG5mdW5jdGlvbiByZW1vdmVkRmxhZ3MoKSB7XG4gIGNvbnN0IHJlbW92ZWRJblYyID0gZmxhZ3MoZmxhZyA9PiBmbGFnLmludHJvZHVjZWRJbi52MiA9PT0gdW5kZWZpbmVkICYmIGZsYWcuaW50cm9kdWNlZEluLnYxICE9PSB1bmRlZmluZWQpO1xuXG4gIHJldHVybiByZW5kZXJUYWJsZShbXG4gICAgWydGbGFnJywgJ1N1bW1hcnknLCAnVHlwZScsICdTaW5jZSddLFxuICAgIC4uLnJlbW92ZWRJblYyLm1hcCgoW25hbWUsIGZsYWddKSA9PiBbXG4gICAgICByZW5kZXJMaW5rKG1kRXNjKG5hbWUpLCBnaXRodWJIZWFkaW5nTGluayhmbGFnRGV0YWlsc0hlYWRpbmcobmFtZSwgZmxhZykpKSxcbiAgICAgIGZsYWcuc3VtbWFyeSxcbiAgICAgIHJlbmRlclR5cGUoZmxhZy50eXBlLCAnc2hvcnQnKSxcbiAgICAgIGZsYWcuaW50cm9kdWNlZEluLnYxID8/ICcnLFxuICAgIF0pLFxuICBdKTtcbn1cblxuZnVuY3Rpb24gY2hhbmdlZEZsYWdzKCkge1xuICBjb25zdCBjaGFuZ2VkSW5WMiA9IGZsYWdzKGZsYWcgPT4gISFmbGFnLnVuY29uZmlndXJlZEJlaGF2ZXNMaWtlPy52MiAmJiAhIWZsYWcuaW50cm9kdWNlZEluLnYyKTtcblxuICByZXR1cm4gcmVuZGVyVGFibGUoW1xuICAgIFsnRmxhZycsICdTdW1tYXJ5JywgJ1R5cGUnLCAnU2luY2UnLCAndjEgZGVmYXVsdCcsICd2MiBkZWZhdWx0J10sXG4gICAgLi4uY2hhbmdlZEluVjIubWFwKChbbmFtZSwgZmxhZ10pID0+IFtcbiAgICAgIHJlbmRlckxpbmsobWRFc2MobmFtZSksIGdpdGh1YkhlYWRpbmdMaW5rKGZsYWdEZXRhaWxzSGVhZGluZyhuYW1lLCBmbGFnKSkpLFxuICAgICAgZmxhZy5zdW1tYXJ5LFxuICAgICAgcmVuZGVyVHlwZShmbGFnLnR5cGUsICdzaG9ydCcpLFxuICAgICAgZmxhZy5pbnRyb2R1Y2VkSW4udjEgPz8gJycsXG4gICAgICByZW5kZXJWYWx1ZShmYWxzZSksXG4gICAgICByZW5kZXJWYWx1ZShmbGFnLnVuY29uZmlndXJlZEJlaGF2ZXNMaWtlPy52MiksXG4gICAgXSksXG4gIF0pO1xufVxuXG5mdW5jdGlvbiBtaWdyYXRlSnNvbigpIHtcbiAgY29uc3QgY2hhbmdlZEluVjIgPSBmbGFncyhmbGFnID0+ICEhZmxhZy51bmNvbmZpZ3VyZWRCZWhhdmVzTGlrZT8udjIgJiYgISFmbGFnLmludHJvZHVjZWRJbi52MiAmJiAhIWZsYWcuaW50cm9kdWNlZEluLnYxKTtcblxuICBjb25zdCBjb250ZXh0ID0gT2JqZWN0LmZyb21FbnRyaWVzKGNoYW5nZWRJblYyLm1hcCgoW25hbWUsIF9dKSA9PiBbbmFtZSwgZmFsc2VdKSk7XG5cbiAgcmV0dXJuIFtcbiAgICAnYGBganNvbicsXG4gICAgSlNPTi5zdHJpbmdpZnkoeyBjb250ZXh0IH0sIHVuZGVmaW5lZCwgMiksXG4gICAgJ2BgYCcsXG4gIF0uam9pbignXFxuJyk7XG59XG5cbmZ1bmN0aW9uIGZsYWdzRGV0YWlscygpIHtcbiAgY29uc3QgYWxsRmxhZ3MgPSBmbGFncyhfID0+IHRydWUpO1xuXG4gIHJldHVybiBhbGxGbGFncy5mbGF0TWFwKChbbmFtZSwgZmxhZ10pID0+IFtcbiAgICBgIyMjICR7ZmxhZ0RldGFpbHNIZWFkaW5nKG5hbWUsIGZsYWcpfWAsXG4gICAgJycsXG4gICAgYCoke2ZsYWcuc3VtbWFyeX0qYCxcbiAgICAnJyxcbiAgICBgRmxhZyB0eXBlOiAke3JlbmRlclR5cGUoZmxhZy50eXBlLCAnbG9uZycpfWAsXG4gICAgJycsXG4gICAgZGVkZW50KGZsYWcuZGV0YWlsc01kKSxcbiAgICAnJyxcbiAgICByZW5kZXJUYWJsZShbXG4gICAgICBbJ1NpbmNlJywgJ1Vuc2V0IGJlaGF2ZXMgbGlrZScsICdSZWNvbW1lbmRlZCB2YWx1ZSddLFxuXG4gICAgICAvLyBWMVxuICAgICAgZmxhZy5pbnRyb2R1Y2VkSW4udjFcbiAgICAgICAgPyBbZmxhZy5pbnRyb2R1Y2VkSW4udjEsIHJlbmRlclZhbHVlKGZhbHNlKSwgcmVuZGVyVmFsdWUoZmxhZy5yZWNvbW1lbmRlZFZhbHVlKV1cbiAgICAgICAgOiBbJyhub3QgaW4gdjEpJywgJycsICcnXSxcblxuICAgICAgLy8gVjJcbiAgICAgIGZsYWcuaW50cm9kdWNlZEluLnYyXG4gICAgICAgID8gW2ZsYWcuaW50cm9kdWNlZEluLnYyLCByZW5kZXJWYWx1ZShmbGFnLnVuY29uZmlndXJlZEJlaGF2ZXNMaWtlPy52MiA/PyBmYWxzZSksIHJlbmRlclZhbHVlKGZsYWcucmVjb21tZW5kZWRWYWx1ZSldXG4gICAgICAgIDogZmxhZy51bmNvbmZpZ3VyZWRCZWhhdmVzTGlrZT8udjIgIT09IHVuZGVmaW5lZFxuICAgICAgICAgID8gWycobm90IGNvbmZpZ3VyYWJsZSBpbiB2MiknLCByZW5kZXJWYWx1ZShmbGFnLnVuY29uZmlndXJlZEJlaGF2ZXNMaWtlPy52MiksICcnXVxuICAgICAgICAgIDogWycobm90IGluIHYyKScsICcnLCAnJ10sXG4gICAgXSksXG4gICAgLi4ub2xkQmVoYXZpb3IoZmxhZykgPyBbXG4gICAgICBgKipDb21wYXRpYmlsaXR5IHdpdGggb2xkIGJlaGF2aW9yOioqICR7b2xkQmVoYXZpb3IoZmxhZyl9YCxcbiAgICAgICcnLFxuICAgIF0gOiBbXSxcbiAgICAnJyxcbiAgXSkuam9pbignXFxuJyk7XG59XG5cbmZ1bmN0aW9uIG9sZEJlaGF2aW9yKGZsYWc6IEZsYWdJbmZvKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgc3dpdGNoIChmbGFnLnR5cGUpIHtcbiAgICBjYXNlIEZsYWdUeXBlLkFwaURlZmF1bHQ6IHJldHVybiBmbGFnLmNvbXBhdGliaWxpdHlXaXRoT2xkQmVoYXZpb3JNZDtcbiAgICBjYXNlIEZsYWdUeXBlLkJ1Z0ZpeDogcmV0dXJuIGZsYWcuY29tcGF0aWJpbGl0eVdpdGhPbGRCZWhhdmlvck1kO1xuICAgIGNhc2UgRmxhZ1R5cGUuVmlzaWJsZUNvbnRleHQ6IHJldHVybiB1bmRlZmluZWQ7XG4gICAgY2FzZSBGbGFnVHlwZS5UZW1wb3Jhcnk6IHJldHVybiBmbGFnLmNvbXBhdGliaWxpdHlXaXRoT2xkQmVoYXZpb3JNZDtcbiAgfVxufVxuXG5mdW5jdGlvbiByZWNvbW1lbmRlZEpzb24oKSB7XG4gIHJldHVybiBbXG4gICAgJ2BgYGpzb24nLFxuICAgIEpTT04uc3RyaW5naWZ5KHsgY29udGV4dDogZmVhdHMuQ1VSUkVOVExZX1JFQ09NTUVOREVEX0ZMQUdTIH0sIHVuZGVmaW5lZCwgMiksXG4gICAgJ2BgYCcsXG4gIF0uam9pbignXFxuJyk7XG59XG5cbmZ1bmN0aW9uIHYyZmxhZ3MoKSB7XG4gIHJldHVybiBmbGFncyhmbGFnID0+IGZsYWcuaW50cm9kdWNlZEluLnYyICE9PSB1bmRlZmluZWQpO1xufVxuXG5mdW5jdGlvbiBmbGFncyhwcmVkOiAoeDogRmxhZ0luZm8pID0+IGJvb2xlYW4pIHtcbiAgY29uc3QgZW50cmllcyA9IE9iamVjdC5lbnRyaWVzKGZlYXRzLkZMQUdTKVxuICAgIC5maWx0ZXIoKFtfLCBmbGFnXSkgPT4gcHJlZChmbGFnKSk7XG5cbiAgZW50cmllcy5zb3J0KChhLCBiKSA9PiBmaXJzdENtcChcbiAgICAvLyBTb3J0IGJ5IHZlcnNpb25zIGZpcnN0XG4gICAgY29tcGFyZVZlcnNpb25zKGFbMV0uaW50cm9kdWNlZEluLnYyLCBiWzFdLmludHJvZHVjZWRJbi52MiksXG4gICAgY29tcGFyZVZlcnNpb25zKGFbMV0uaW50cm9kdWNlZEluLnYxLCBiWzFdLmludHJvZHVjZWRJbi52MSksXG4gICAgLy8gVGhlbiBzb3J0IGJ5IG5hbWVcbiAgICBhWzBdLmxvY2FsZUNvbXBhcmUoYlswXSkpKTtcblxuICByZXR1cm4gZW50cmllcztcbn1cblxuZnVuY3Rpb24gcmVuZGVyVHlwZSh0eXBlOiBGbGFnVHlwZSwgZmxhdm9yOiAnc2hvcnQnIHwgJ2xvbmcnKTogc3RyaW5nIHtcbiAgc3dpdGNoICh0eXBlKSB7XG4gICAgY2FzZSBGbGFnVHlwZS5BcGlEZWZhdWx0OiByZXR1cm4gbG9uZ1Nob3J0KCdOZXcgZGVmYXVsdCBiZWhhdmlvcicsICduZXcgZGVmYXVsdCcpO1xuICAgIGNhc2UgRmxhZ1R5cGUuQnVnRml4OiByZXR1cm4gbG9uZ1Nob3J0KCdCYWNrd2FyZHMgaW5jb21wYXRpYmxlIGJ1Z2ZpeCcsICdmaXgnKTtcbiAgICBjYXNlIEZsYWdUeXBlLlZpc2libGVDb250ZXh0OiByZXR1cm4gbG9uZ1Nob3J0KCdDb25maWd1cmF0aW9uIG9wdGlvbicsICdjb25maWcnKTtcbiAgICBjYXNlIEZsYWdUeXBlLlRlbXBvcmFyeTogcmV0dXJuIGxvbmdTaG9ydCgnVGVtcG9yYXJ5IGZsYWcnLCAndGVtcG9yYXJ5Jyk7XG4gIH1cblxuICBmdW5jdGlvbiBsb25nU2hvcnQobG9uZzogc3RyaW5nLCBzaG9ydDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGZsYXZvciA9PT0gJ2xvbmcnID8gbG9uZyA6IHNob3J0O1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlbmRlclRhYmxlKHJvd3M6IHN0cmluZ1tdW10pIHtcbiAgcmV0dXJuIFtcbiAgICAnJyxcbiAgICAnfCAnICsgcm93c1swXS5qb2luKCcgfCAnKSArICcgfCcsXG4gICAgJ3wgJyArIHJvd3NbMF0ubWFwKF8gPT4gJy0tLS0tJykuam9pbignIHwgJykgKyAnIHwnLFxuICAgIC4uLnJvd3Muc2xpY2UoMSkubWFwKHJvdyA9PiAnfCAnICsgcm93LmpvaW4oJyB8ICcpICsgJyB8JyksXG4gICAgJycsXG4gIF0uam9pbignXFxuJyk7XG59XG5cbi8qKlxuICogUmV0dXJuIHRoZSBoZWFkaW5nIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGNhcHRpb24gdGhpcyBmbGFnJ3MgZGV0YWlsc1xuICovXG5mdW5jdGlvbiBmbGFnRGV0YWlsc0hlYWRpbmcobmFtZTogc3RyaW5nLCBfOiBGbGFnSW5mbykge1xuICByZXR1cm4gbmFtZTtcbn1cblxuLyoqXG4gKiBSZXR1cm4gYSBsaW5rIHRoYXQgaXMgdmFsaWQgb24gR2l0SHViIHRvIHJlZmVyIHRvIGEgaGVhZGluZ1xuICovXG5mdW5jdGlvbiBnaXRodWJIZWFkaW5nTGluayhoZWFkaW5nOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGAjJHtoZWFkaW5nLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvIC9nLCAnLScpLnJlcGxhY2UoL1teYS16MC05Xy1dL2csICcnKX1gO1xufVxuXG4vKipcbiAqIFJlbW92ZSBzaGFyZWQgbGVhZGluZyB3aGl0ZXNwYWNlIGZyb20gYWxsIG5vbi1lbXB0eSBsaW5lc1xuICovXG5mdW5jdGlvbiBkZWRlbnQoYm9keTogc3RyaW5nKSB7XG4gIGNvbnN0IGxpbmVzID0gYm9keS5zcGxpdCgnXFxuJykuZmlsdGVyKCh4KSA9PiB4LnRyaW0oKSAhPT0gJycpO1xuICBjb25zdCBsZWFkaW5nV3MgPSBsaW5lcy5tYXAoeCA9PiB4Lm1hdGNoKC9eICovKT8uWzBdLmxlbmd0aCA/PyAwKTtcbiAgY29uc3Qgc2hhcmVkV3MgPSBNYXRoLm1pbiguLi5sZWFkaW5nV3MpO1xuICBjb25zdCByZSA9IG5ldyBSZWdFeHAoJ14nICsgJyAnLnJlcGVhdChzaGFyZWRXcyksICdtZycpO1xuICByZXR1cm4gYm9keS5yZXBsYWNlKHJlLCAnJykudHJpbSgpO1xufVxuXG5mdW5jdGlvbiByZW5kZXJWYWx1ZSh4OiBhbnkpIHtcbiAgcmV0dXJuIGBcXGAke0pTT04uc3RyaW5naWZ5KHgpfVxcYGA7XG59XG5cbmZ1bmN0aW9uIHJlbmRlckxpbmsoY2FwdGlvbjogc3RyaW5nLCBsaW5rOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGBbJHtjYXB0aW9ufV0oJHtsaW5rfSlgO1xufVxuXG5mdW5jdGlvbiBtZEVzYyh4OiBzdHJpbmcpIHtcbiAgcmV0dXJuIHgucmVwbGFjZSgvXy9nLCAnXFxcXF8nKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlTWFya2Rvd25GaWxlKGZpbGVuYW1lOiBzdHJpbmcsIHNlY3Rpb25zOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KSB7XG4gIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVuYW1lLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pO1xuXG4gIGZvciAoY29uc3QgW3NlY3Rpb24sIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhzZWN0aW9ucykpIHtcbiAgICBjb25zdCByZSA9IG5ldyBSZWdFeHAoYDwhLS0gQkVHSU4gJHtzZWN0aW9ufSAtLT4oLiopPCEtLSBFTkQgJHtzZWN0aW9ufSAtLT5gLCAncycpO1xuICAgIGNvbnRlbnRzID0gY29udGVudHMucmVwbGFjZShyZSwgYDwhLS0gQkVHSU4gJHtzZWN0aW9ufSAtLT5cXG4ke3ZhbHVlfVxcbjwhLS0gRU5EICR7c2VjdGlvbn0gLS0+YCk7XG4gIH1cblxuICBhd2FpdCBmcy53cml0ZUZpbGUoZmlsZW5hbWUsIGNvbnRlbnRzLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVSZWNvbW1lbmRlZEZsYWdzRmlsZShmaWxlbmFtZTogc3RyaW5nKSB7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShmaWxlbmFtZSwgSlNPTi5zdHJpbmdpZnkoZmVhdHMuQ1VSUkVOVExZX1JFQ09NTUVOREVEX0ZMQUdTLCB1bmRlZmluZWQsIDIpLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pO1xufVxuXG5mdW5jdGlvbiBmaXJzdENtcCguLi54czogbnVtYmVyW10pIHtcbiAgcmV0dXJuIHhzLmZpbmQoeCA9PiB4ICE9PSAwKSA/PyAwO1xufVxuXG5tYWluKCkuY2F0Y2goZSA9PiB7XG4gIGNvbnNvbGUuZXJyb3IoZSk7XG4gIHByb2Nlc3MuZXhpdENvZGUgPSAxO1xufSk7XG4iXX0=