"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RichSpecDatabase = exports.loadDatabase = exports.emptyDatabase = void 0;
const fs_1 = require("fs");
const zlib_1 = require("zlib");
const tskb_1 = require("@cdklabs/tskb");
function emptyDatabase() {
    return new tskb_1.Database({
        resource: (0, tskb_1.entityCollection)().index({
            cloudFormationType: (0, tskb_1.fieldIndex)('cloudFormationType', tskb_1.stringCmp),
        }),
        region: (0, tskb_1.entityCollection)().index({
            name: (0, tskb_1.fieldIndex)('name', tskb_1.stringCmp),
        }),
        service: (0, tskb_1.entityCollection)().index({
            name: (0, tskb_1.fieldIndex)('name', tskb_1.stringCmp),
            cloudFormationNamespace: (0, tskb_1.fieldIndex)('cloudFormationNamespace', tskb_1.stringCmp),
        }),
        eventTypeDefinition: (0, tskb_1.entityCollection)(),
        typeDefinition: (0, tskb_1.entityCollection)(),
        augmentations: (0, tskb_1.entityCollection)(),
        metric: (0, tskb_1.entityCollection)().index({
            name: (0, tskb_1.fieldIndex)('name', tskb_1.stringCmp),
            namespace: (0, tskb_1.fieldIndex)('namespace', tskb_1.stringCmp),
            dedupKey: (0, tskb_1.fieldIndex)('dedupKey', tskb_1.stringCmp),
        }),
        dimensionSet: (0, tskb_1.entityCollection)().index({
            dedupKey: (0, tskb_1.fieldIndex)('dedupKey', tskb_1.stringCmp),
        }),
        event: (0, tskb_1.entityCollection)().index({
            name: (0, tskb_1.fieldIndex)('name', tskb_1.stringCmp),
        }),
    }, (r) => ({
        hasResource: r.relationship('service', 'resource'),
        regionHasResource: r.relationship('region', 'resource'),
        regionHasService: r.relationship('region', 'service'),
        usesType: r.relationship('resource', 'typeDefinition'),
        isAugmented: r.relationship('resource', 'augmentations'),
        usesDimensionSet: r.relationship('metric', 'dimensionSet'),
        resourceHasMetric: r.relationship('resource', 'metric'),
        serviceHasMetric: r.relationship('service', 'metric'),
        resourceHasDimensionSet: r.relationship('resource', 'dimensionSet'),
        serviceHasDimensionSet: r.relationship('service', 'dimensionSet'),
        resourceHasEvent: r.relationship('resource', 'event'),
        eventUsesType: r.relationship('event', 'eventTypeDefinition'),
    }));
}
exports.emptyDatabase = emptyDatabase;
async function loadDatabase(pathToDb) {
    const db = emptyDatabase();
    const contents = await fs_1.promises.readFile(pathToDb);
    const json = pathToDb.endsWith('.gz') ? (0, zlib_1.gunzipSync)(contents).toString('utf-8') : contents.toString('utf-8');
    db.load(JSON.parse(json));
    return db;
}
exports.loadDatabase = loadDatabase;
/**
 * Helpers for working with a SpecDatabase
 */
class RichSpecDatabase {
    constructor(db) {
        this.db = db;
    }
    /**
     * Find all resources of a given type
     */
    resourceByType(cfnType, operation = 'resourceByType') {
        const res = this.db.lookup('resource', 'cloudFormationType', 'equals', cfnType);
        if (res.length === 0) {
            throw new Error(`${operation}: no such resource: ${cfnType}`);
        }
        return res[0];
    }
    /**
     * All type definitions used by a certain resource
     */
    resourceTypeDefs(cfnType) {
        const resource = this.db.lookup('resource', 'cloudFormationType', 'equals', cfnType).only();
        return this.db.follow('usesType', resource).map((x) => x.entity);
    }
    /**
     * Find a type definition from a given property type
     */
    tryFindDef(type) {
        return type.type === 'ref' ? this.db.get('typeDefinition', type.reference.$ref) : undefined;
    }
}
exports.RichSpecDatabase = RichSpecDatabase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdHlwZXMvZGF0YWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkJBQW9DO0FBQ3BDLCtCQUFrQztBQUNsQyx3Q0FBa0Y7QUF3QmxGLFNBQWdCLGFBQWE7SUFDM0IsT0FBTyxJQUFJLGVBQVEsQ0FDakI7UUFDRSxRQUFRLEVBQUUsSUFBQSx1QkFBZ0IsR0FBWSxDQUFDLEtBQUssQ0FBQztZQUMzQyxrQkFBa0IsRUFBRSxJQUFBLGlCQUFVLEVBQUMsb0JBQW9CLEVBQUUsZ0JBQVMsQ0FBQztTQUNoRSxDQUFDO1FBQ0YsTUFBTSxFQUFFLElBQUEsdUJBQWdCLEdBQVUsQ0FBQyxLQUFLLENBQUM7WUFDdkMsSUFBSSxFQUFFLElBQUEsaUJBQVUsRUFBQyxNQUFNLEVBQUUsZ0JBQVMsQ0FBQztTQUNwQyxDQUFDO1FBQ0YsT0FBTyxFQUFFLElBQUEsdUJBQWdCLEdBQVcsQ0FBQyxLQUFLLENBQUM7WUFDekMsSUFBSSxFQUFFLElBQUEsaUJBQVUsRUFBQyxNQUFNLEVBQUUsZ0JBQVMsQ0FBQztZQUNuQyx1QkFBdUIsRUFBRSxJQUFBLGlCQUFVLEVBQUMseUJBQXlCLEVBQUUsZ0JBQVMsQ0FBQztTQUMxRSxDQUFDO1FBQ0YsbUJBQW1CLEVBQUUsSUFBQSx1QkFBZ0IsR0FBdUI7UUFDNUQsY0FBYyxFQUFFLElBQUEsdUJBQWdCLEdBQWtCO1FBQ2xELGFBQWEsRUFBRSxJQUFBLHVCQUFnQixHQUF3QjtRQUN2RCxNQUFNLEVBQUUsSUFBQSx1QkFBZ0IsR0FBVSxDQUFDLEtBQUssQ0FBQztZQUN2QyxJQUFJLEVBQUUsSUFBQSxpQkFBVSxFQUFDLE1BQU0sRUFBRSxnQkFBUyxDQUFDO1lBQ25DLFNBQVMsRUFBRSxJQUFBLGlCQUFVLEVBQUMsV0FBVyxFQUFFLGdCQUFTLENBQUM7WUFDN0MsUUFBUSxFQUFFLElBQUEsaUJBQVUsRUFBQyxVQUFVLEVBQUUsZ0JBQVMs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LENBQUM7SUFDaEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksZ0JBQWdCLENBQUMsT0FBZTtRQUNyQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsb0JBQW9CLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzVGLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25FLENBQUM7SUFFRDs7T0FFRztJQUNJLFVBQVUsQ0FBQyxJQUFrQjtRQUNsQyxPQUFPLElBQUksQ0FBQyxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDOUYsQ0FBQztDQUNGO0FBNUJELDRDQTRCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHByb21pc2VzIGFzIGZzIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgZ3VuemlwU3luYyB9IGZyb20gJ3psaWInO1xuaW1wb3J0IHsgRGF0YWJhc2UsIGVudGl0eUNvbGxlY3Rpb24sIGZpZWxkSW5kZXgsIHN0cmluZ0NtcCB9IGZyb20gJ0BjZGtsYWJzL3Rza2InO1xuaW1wb3J0IHsgSXNBdWdtZW50ZWRSZXNvdXJjZSwgUmVzb3VyY2VBdWdtZW50YXRpb24gfSBmcm9tICcuL2F1Z21lbnRhdGlvbnMnO1xuaW1wb3J0IHsgUmVzb3VyY2VIYXNFdmVudCwgRXZlbnQsIEV2ZW50VXNlc1R5cGUsIEV2ZW50VHlwZURlZmluaXRpb24gfSBmcm9tICcuL2V2ZW50JztcbmltcG9ydCB7XG4gIERpbWVuc2lvblNldCxcbiAgTWV0cmljLFxuICBSZXNvdXJjZUhhc0RpbWVuc2lvblNldCxcbiAgU2VydmljZUhhc0RpbWVuc2lvblNldCxcbiAgVXNlc0RpbWVuc2lvblNldCxcbiAgUmVzb3VyY2VIYXNNZXRyaWMsXG4gIFNlcnZpY2VIYXNNZXRyaWMsXG59IGZyb20gJy4vbWV0cmljcyc7XG5pbXBvcnQge1xuICBSZXNvdXJjZSxcbiAgU2VydmljZSxcbiAgVHlwZURlZmluaXRpb24sXG4gIFByb3BlcnR5VHlwZSxcbiAgUmVnaW9uLFxuICBIYXNSZXNvdXJjZSxcbiAgUmVnaW9uSGFzUmVzb3VyY2UsXG4gIFJlZ2lvbkhhc1NlcnZpY2UsXG4gIFVzZXNUeXBlLFxufSBmcm9tICcuL3Jlc291cmNlJztcblxuZXhwb3J0IGZ1bmN0aW9uIGVtcHR5RGF0YWJhc2UoKSB7XG4gIHJldHVybiBuZXcgRGF0YWJhc2UoXG4gICAge1xuICAgICAgcmVzb3VyY2U6IGVudGl0eUNvbGxlY3Rpb248UmVzb3VyY2U+KCkuaW5kZXgoe1xuICAgICAgICBjbG91ZEZvcm1hdGlvblR5cGU6IGZpZWxkSW5kZXgoJ2Nsb3VkRm9ybWF0aW9uVHlwZScsIHN0cmluZ0NtcCksXG4gICAgICB9KSxcbiAgICAgIHJlZ2lvbjogZW50aXR5Q29sbGVjdGlvbjxSZWdpb24+KCkuaW5kZXgoe1xuICAgICAgICBuYW1lOiBmaWVsZEluZGV4KCduYW1lJywgc3RyaW5nQ21wKSxcbiAgICAgIH0pLFxuICAgICAgc2VydmljZTogZW50aXR5Q29sbGVjdGlvbjxTZXJ2aWNlPigpLmluZGV4KHtcbiAgICAgICAgbmFtZTogZmllbGRJbmRleCgnbmFtZScsIHN0cmluZ0NtcCksXG4gICAgICAgIGNsb3VkRm9ybWF0aW9uTmFtZXNwYWNlOiBmaWVsZEluZGV4KCdjbG91ZEZvcm1hdGlvbk5hbWVzcGFjZScsIHN0cmluZ0NtcCksXG4gICAgICB9KSxcbiAgICAgIGV2ZW50VHlwZURlZmluaXRpb246IGVudGl0eUNvbGxlY3Rpb248RXZlbnRUeXBlRGVmaW5pdGlvbj4oKSxcbiAgICAgIHR5cGVEZWZpbml0aW9uOiBlbnRpdHlDb2xsZWN0aW9uPFR5cGVEZWZpbml0aW9uPigpLFxuICAgICAgYXVnbWVudGF0aW9uczogZW50aXR5Q29sbGVjdGlvbjxSZXNvdXJjZUF1Z21lbnRhdGlvbj4oKSxcbiAgICAgIG1ldHJpYzogZW50aXR5Q29sbGVjdGlvbjxNZXRyaWM+KCkuaW5kZXgoe1xuICAgICAgICBuYW1lOiBmaWVsZEluZGV4KCduYW1lJywgc3RyaW5nQ21wKSxcbiAgICAgICAgbmFtZXNwYWNlOiBmaWVsZEluZGV4KCduYW1lc3BhY2UnLCBzdHJpbmdDbXApLFxuICAgICAgICBkZWR1cEtleTogZmllbGRJbmRleCgnZGVkdXBLZXknLCBzdHJpbmdDbXApLFxuICAgICAgfSksXG4gICAgICBkaW1lbnNpb25TZXQ6IGVudGl0eUNvbGxlY3Rpb248RGltZW5zaW9uU2V0PigpLmluZGV4KHtcbiAgICAgICAgZGVkdXBLZXk6IGZpZWxkSW5kZXgoJ2RlZHVwS2V5Jywgc3RyaW5nQ21wKSxcbiAgICAgIH0pLFxuICAgICAgZXZlbnQ6IGVudGl0eUNvbGxlY3Rpb248RXZlbnQ+KCkuaW5kZXgoe1xuICAgICAgICBuYW1lOiBmaWVsZEluZGV4KCduYW1lJywgc3RyaW5nQ21wKSxcbiAgICAgIH0pLFxuICAgIH0sXG4gICAgKHIpID0+ICh7XG4gICAgICBoYXNSZXNvdXJjZTogci5yZWxhdGlvbnNoaXA8SGFzUmVzb3VyY2U+KCdzZXJ2aWNlJywgJ3Jlc291cmNlJyksXG4gICAgICByZWdpb25IYXNSZXNvdXJjZTogci5yZWxhdGlvbnNoaXA8UmVnaW9uSGFzUmVzb3VyY2U+KCdyZWdpb24nLCAncmVzb3VyY2UnKSxcbiAgICAgIHJlZ2lvbkhhc1NlcnZpY2U6IHIucmVsYXRpb25zaGlwPFJlZ2lvbkhhc1NlcnZpY2U+KCdyZWdpb24nLCAnc2VydmljZScpLFxuICAgICAgdXNlc1R5cGU6IHIucmVsYXRpb25zaGlwPFVzZXNUeXBlPigncmVzb3VyY2UnLCAndHlwZURlZmluaXRpb24nKSxcbiAgICAgIGlzQXVnbWVudGVkOiByLnJlbGF0aW9uc2hpcDxJc0F1Z21lbnRlZFJlc291cmNlPigncmVzb3VyY2UnLCAnYXVnbWVudGF0aW9ucycpLFxuICAgICAgdXNlc0RpbWVuc2lvblNldDogci5yZWxhdGlvbnNoaXA8VXNlc0RpbWVuc2lvblNldD4oJ21ldHJpYycsICdkaW1lbnNpb25TZXQnKSxcbiAgICAgIHJlc291cmNlSGFzTWV0cmljOiByLnJlbGF0aW9uc2hpcDxSZXNvdXJjZUhhc01ldHJpYz4oJ3Jlc291cmNlJywgJ21ldHJpYycpLFxuICAgICAgc2VydmljZUhhc01ldHJpYzogci5yZWxhdGlvbnNoaXA8U2VydmljZUhhc01ldHJpYz4oJ3NlcnZpY2UnLCAnbWV0cmljJyksXG4gICAgICByZXNvdXJjZUhhc0RpbWVuc2lvblNldDogci5yZWxhdGlvbnNoaXA8UmVzb3VyY2VIYXNEaW1lbnNpb25TZXQ+KCdyZXNvdXJjZScsICdkaW1lbnNpb25TZXQnKSxcbiAgICAgIHNlcnZpY2VIYXNEaW1lbnNpb25TZXQ6IHIucmVsYXRpb25zaGlwPFNlcnZpY2VIYXNEaW1lbnNpb25TZXQ+KCdzZXJ2aWNlJywgJ2RpbWVuc2lvblNldCcpLFxuICAgICAgcmVzb3VyY2VIYXNFdmVudDogci5yZWxhdGlvbnNoaXA8UmVzb3VyY2VIYXNFdmVudD4oJ3Jlc291cmNlJywgJ2V2ZW50JyksXG4gICAgICBldmVudFVzZXNUeXBlOiByLnJlbGF0aW9uc2hpcDxFdmVudFVzZXNUeXBlPignZXZlbnQnLCAnZXZlbnRUeXBlRGVmaW5pdGlvbicpLFxuICAgIH0pLFxuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbG9hZERhdGFiYXNlKHBhdGhUb0RiOiBzdHJpbmcpIHtcbiAgY29uc3QgZGIgPSBlbXB0eURhdGFiYXNlKCk7XG4gIGNvbnN0IGNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUocGF0aFRvRGIpO1xuICBjb25zdCBqc29uID0gcGF0aFRvRGIuZW5kc1dpdGgoJy5neicpID8gZ3VuemlwU3luYyhjb250ZW50cykudG9TdHJpbmcoJ3V0Zi04JykgOiBjb250ZW50cy50b1N0cmluZygndXRmLTgnKTtcbiAgZGIubG9hZChKU09OLnBhcnNlKGpzb24pKTtcbiAgcmV0dXJuIGRiO1xufVxuXG5leHBvcnQgdHlwZSBTcGVjRGF0YWJhc2UgPSBSZXR1cm5UeXBlPHR5cGVvZiBlbXB0eURhdGFiYXNlPjtcblxuLyoqXG4gKiBIZWxwZXJzIGZvciB3b3JraW5nIHdpdGggYSBTcGVjRGF0YWJhc2VcbiAqL1xuZXhwb3J0IGNsYXNzIFJpY2hTcGVjRGF0YWJhc2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGRiOiBTcGVjRGF0YWJhc2UpIHt9XG5cbiAgLyoqXG4gICAqIEZpbmQgYWxsIHJlc291cmNlcyBvZiBhIGdpdmVuIHR5cGVcbiAgICovXG4gIHB1YmxpYyByZXNvdXJjZUJ5VHlwZShjZm5UeXBlOiBzdHJpbmcsIG9wZXJhdGlvbiA9ICdyZXNvdXJjZUJ5VHlwZScpOiBSZXNvdXJjZSB7XG4gICAgY29uc3QgcmVzID0gdGhpcy5kYi5sb29rdXAoJ3Jlc291cmNlJywgJ2Nsb3VkRm9ybWF0aW9uVHlwZScsICdlcXVhbHMnLCBjZm5UeXBlKTtcbiAgICBpZiAocmVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke29wZXJhdGlvbn06IG5vIHN1Y2ggcmVzb3VyY2U6ICR7Y2ZuVHlwZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc1swXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbGwgdHlwZSBkZWZpbml0aW9ucyB1c2VkIGJ5IGEgY2VydGFpbiByZXNvdXJjZVxuICAgKi9cbiAgcHVibGljIHJlc291cmNlVHlwZURlZnMoY2ZuVHlwZTogc3RyaW5nKTogcmVhZG9ubHkgVHlwZURlZmluaXRpb25bXSB7XG4gICAgY29uc3QgcmVzb3VyY2UgPSB0aGlzLmRiLmxvb2t1cCgncmVzb3VyY2UnLCAnY2xvdWRGb3JtYXRpb25UeXBlJywgJ2VxdWFscycsIGNmblR5cGUpLm9ubHkoKTtcbiAgICByZXR1cm4gdGhpcy5kYi5mb2xsb3coJ3VzZXNUeXBlJywgcmVzb3VyY2UpLm1hcCgoeCkgPT4geC5lbnRpdHkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbmQgYSB0eXBlIGRlZmluaXRpb24gZnJvbSBhIGdpdmVuIHByb3BlcnR5IHR5cGVcbiAgICovXG4gIHB1YmxpYyB0cnlGaW5kRGVmKHR5cGU6IFByb3BlcnR5VHlwZSk6IFR5cGVEZWZpbml0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdHlwZS50eXBlID09PSAncmVmJyA/IHRoaXMuZGIuZ2V0KCd0eXBlRGVmaW5pdGlvbicsIHR5cGUucmVmZXJlbmNlLiRyZWYpIDogdW5kZWZpbmVkO1xuICB9XG59XG4iXX0=