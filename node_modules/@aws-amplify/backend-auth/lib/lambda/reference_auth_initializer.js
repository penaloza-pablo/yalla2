import { CognitoIdentityProviderClient, DescribeUserPoolClientCommand, DescribeUserPoolCommand, GetUserPoolMfaConfigCommand, ListGroupsCommand, ListIdentityProvidersCommand, } from '@aws-sdk/client-cognito-identity-provider';
import { CognitoIdentityClient, DescribeIdentityPoolCommand, GetIdentityPoolRolesCommand, } from '@aws-sdk/client-cognito-identity';
import { randomUUID } from 'node:crypto';
/**
 * Initializer that fetches and process auth resources.
 */
export class ReferenceAuthInitializer {
    cognitoIdentityClient;
    cognitoIdentityProviderClient;
    uuidGenerator;
    /**
     * Create a new initializer
     * @param cognitoIdentityClient identity client
     * @param cognitoIdentityProviderClient identity provider client
     */
    constructor(cognitoIdentityClient, cognitoIdentityProviderClient, uuidGenerator) {
        this.cognitoIdentityClient = cognitoIdentityClient;
        this.cognitoIdentityProviderClient = cognitoIdentityProviderClient;
        this.uuidGenerator = uuidGenerator;
    }
    /**
     * Handles custom resource events
     * @param event event to process
     * @returns custom resource response
     */
    handleEvent = async (event) => {
        console.info(`Received '${event.RequestType}' event`);
        // physical id is only generated on create, otherwise it must stay the same
        const physicalId = event.RequestType === 'Create'
            ? this.uuidGenerator()
            : event.PhysicalResourceId;
        // on delete, just respond with success since we don't need to do anything
        if (event.RequestType === 'Delete') {
            return {
                RequestId: event.RequestId,
                LogicalResourceId: event.LogicalResourceId,
                PhysicalResourceId: physicalId,
                StackId: event.StackId,
                NoEcho: true,
                Status: 'SUCCESS',
            };
        }
        // for create or update events, we will fetch and validate resource properties
        const props = event.ResourceProperties;
        const { userPool, userPoolPasswordPolicy, userPoolMFA, userPoolGroups, userPoolProviders, userPoolClient, identityPool, roles, } = await this.getResourceDetails(props.userPoolId, props.identityPoolId, props.userPoolClientId);
        this.validateResources(userPool, userPoolProviders, userPoolGroups, userPoolClient, identityPool, roles, props);
        const userPoolOutputs = await this.getUserPoolOutputs(userPool, userPoolPasswordPolicy, userPoolProviders, userPoolMFA, props.region);
        const identityPoolOutputs = await this.getIdentityPoolOutputs(identityPool);
        const userPoolClientOutputs = await this.getUserPoolClientOutputs(userPoolClient);
        const data = {
            userPoolId: props.userPoolId,
            webClientId: props.userPoolClientId,
            identityPoolId: props.identityPoolId,
            ...userPoolOutputs,
            ...identityPoolOutputs,
            ...userPoolClientOutputs,
        };
        return {
            RequestId: event.RequestId,
            LogicalResourceId: event.LogicalResourceId,
            PhysicalResourceId: physicalId,
            StackId: event.StackId,
            NoEcho: true,
            Data: data,
            Status: 'SUCCESS',
        };
    };
    getUserPool = async (userPoolId) => {
        const userPoolCommand = new DescribeUserPoolCommand({
            UserPoolId: userPoolId,
        });
        const userPoolResponse = await this.cognitoIdentityProviderClient.send(userPoolCommand);
        if (!userPoolResponse.UserPool) {
            throw new Error('Failed to retrieve the specified UserPool.');
        }
        const userPool = userPoolResponse.UserPool;
        const policy = userPool.Policies?.PasswordPolicy;
        if (!policy) {
            throw new Error('Failed to retrieve password policy.');
        }
        return {
            userPool: userPoolResponse.UserPool,
            userPoolPasswordPolicy: policy,
        };
    };
    getUserPoolMFASettings = async (userPoolId) => {
        // mfa types
        const mfaCommand = new GetUserPoolMfaConfigCommand({
            UserPoolId: userPoolId,
        });
        const mfaResponse = await this.cognitoIdentityProviderClient.send(mfaCommand);
        return mfaResponse;
    };
    getUserPoolGroups = async (userPoolId) => {
        let nextToken;
        const groups = [];
        do {
            const listGroupsResponse = await this.cognitoIdentityProviderClient.send(new ListGroupsCommand({
                UserPoolId: userPoolId,
                NextToken: nextToken,
            }));
            if (!listGroupsResponse.Groups) {
                throw new Error('An error occurred while retrieving the groups for the user pool.');
            }
            groups.push(...listGroupsResponse.Groups);
            nextToken = listGroupsResponse.NextToken;
        } while (nextToken);
        return groups;
    };
    getUserPoolProviders = async (userPoolId) => {
        const providers = [];
        let nextToken;
        do {
            const providersResponse = await this.cognitoIdentityProviderClient.send(new ListIdentityProvidersCommand({
                UserPoolId: userPoolId,
                NextToken: nextToken,
            }));
            if (providersResponse.Providers === undefined) {
                throw new Error('An error occurred while retrieving identity providers for the user pool.');
            }
            providers.push(...providersResponse.Providers);
            nextToken = providersResponse.NextToken;
        } while (nextToken);
        return providers;
    };
    getIdentityPool = async (identityPoolId) => {
        const idpResponse = await this.cognitoIdentityClient.send(new DescribeIdentityPoolCommand({
            IdentityPoolId: identityPoolId,
        }));
        if (!idpResponse.IdentityPoolId) {
            throw new Error('An error occurred while retrieving the identity pool details.');
        }
        return idpResponse;
    };
    getIdentityPoolRoles = async (identityPoolId) => {
        const rolesCommand = new GetIdentityPoolRolesCommand({
            IdentityPoolId: identityPoolId,
        });
        const rolesResponse = await this.cognitoIdentityClient.send(rolesCommand);
        if (!rolesResponse.Roles) {
            throw new Error('An error occurred while retrieving the roles for the identity pool.');
        }
        return rolesResponse.Roles;
    };
    getUserPoolClient = async (userPoolId, userPoolClientId) => {
        const userPoolClientCommand = new DescribeUserPoolClientCommand({
            UserPoolId: userPoolId,
            ClientId: userPoolClientId,
        });
        const userPoolClientResponse = await this.cognitoIdentityProviderClient.send(userPoolClientCommand);
        if (!userPoolClientResponse.UserPoolClient) {
            throw new Error('An error occurred while retrieving the user pool client details.');
        }
        return userPoolClientResponse.UserPoolClient;
    };
    /**
     * Retrieves all of the resource data that is necessary for validation and output generation.
     * @param userPoolId userPoolId
     * @param identityPoolId identityPoolId
     * @param userPoolClientId userPoolClientId
     * @returns all necessary resource data
     */
    getResourceDetails = async (userPoolId, identityPoolId, userPoolClientId) => {
        const { userPool, userPoolPasswordPolicy } = await this.getUserPool(userPoolId);
        const userPoolMFA = await this.getUserPoolMFASettings(userPoolId);
        const userPoolProviders = await this.getUserPoolProviders(userPoolId);
        const userPoolGroups = await this.getUserPoolGroups(userPoolId);
        const userPoolClient = await this.getUserPoolClient(userPoolId, userPoolClientId);
        const identityPool = await this.getIdentityPool(identityPoolId);
        const roles = await this.getIdentityPoolRoles(identityPoolId);
        return {
            userPool,
            userPoolPasswordPolicy,
            userPoolMFA,
            userPoolProviders,
            userPoolGroups,
            userPoolClient,
            identityPool,
            roles,
        };
    };
    /**
     * Validate the resource associations.
     * 1. make sure the user pool & user pool client pair are a cognito provider for the identity pool
     * 2. make sure the provided auth/unauth role ARNs match the roles for the identity pool
     * 3. make sure the user pool client is a web client
     * @param userPool userPool
     * @param userPoolProviders the user pool providers
     * @param userPoolGroups the existing groups for the userPool
     * @param userPoolClient userPoolClient
     * @param identityPool identityPool
     * @param identityPoolRoles identityPool roles
     * @param props props that include the roles which we compare with the actual roles for the identity pool
     */
    validateResources = (userPool, userPoolProviders, userPoolGroups, userPoolClient, identityPool, identityPoolRoles, props) => {
        // verify the user pool is a cognito provider for this identity pool
        if (!identityPool.CognitoIdentityProviders ||
            identityPool.CognitoIdentityProviders.length === 0) {
            throw new Error('The specified identity pool does not have any cognito identity providers.');
        }
        // check for alias attributes, since we don't support this yet
        if (userPool.AliasAttributes && userPool.AliasAttributes.length > 0) {
            throw new Error('The specified user pool is configured with alias attributes which are not currently supported.');
        }
        // check OAuth settings
        if (userPoolProviders.length > 0) {
            // validate user pool
            const domainSpecified = userPool.Domain || userPool.CustomDomain;
            if (!domainSpecified) {
                throw new Error('You must configure a domain for your UserPool if external login providers are enabled.');
            }
            // validate user pool client
            const hasLogoutUrls = userPoolClient.LogoutURLs && userPoolClient.LogoutURLs.length > 0;
            const hasCallbackUrls = userPoolClient.CallbackURLs && userPoolClient.CallbackURLs.length > 0;
            if (!hasLogoutUrls) {
                throw new Error('Your UserPool client must have "Allowed sign-out URLs" configured if external login providers are enabled.');
            }
            if (!hasCallbackUrls) {
                throw new Error('Your UserPool client must have "Allowed callback URLs" configured if external login providers are enabled.');
            }
        }
        // make sure props groups Roles actually exist for the user pool
        const groupEntries = Object.entries(props.groups);
        for (const [groupName, groupRoleARN] of groupEntries) {
            const match = userPoolGroups.find((g) => g.RoleArn === groupRoleARN);
            if (match === undefined) {
                throw new Error(`The group '${groupName}' with role '${groupRoleARN}' does not match any group for the specified user pool.`);
            }
        }
        // verify that the user pool + user pool client pair are configured with the identity pool
        const matchingProvider = identityPool.CognitoIdentityProviders.find((p) => {
            const matchingUserPool = p.ProviderName ===
                `cognito-idp.${props.region}.amazonaws.com/${userPool.Id}`;
            const matchingUserPoolClient = p.ClientId === userPoolClient.ClientId;
            return matchingUserPool && matchingUserPoolClient;
        });
        if (!matchingProvider) {
            throw new Error('The user pool and user pool client pair do not match any cognito identity providers for the specified identity pool.');
        }
        // verify the auth / unauth roles from the props match the identity pool roles that we retrieved
        const authRoleArn = identityPoolRoles['authenticated'];
        const unauthRoleArn = identityPoolRoles['unauthenticated'];
        if (authRoleArn !== props.authRoleArn) {
            throw new Error('The provided authRoleArn does not match the authenticated role for the specified identity pool.');
        }
        if (unauthRoleArn !== props.unauthRoleArn) {
            throw new Error('The provided unauthRoleArn does not match the unauthenticated role for the specified identity pool.');
        }
        // make sure the client is a web client here (web clients shouldn't have client secrets)
        if (userPoolClient?.ClientSecret) {
            throw new Error('The specified user pool client is not configured as a web client.');
        }
    };
    /**
     * Transform the userPool data into outputs.
     * @param userPool user pool
     * @param userPoolPasswordPolicy user pool password policy
     * @param userPoolProviders user pool providers
     * @param userPoolMFA user pool MFA settings
     * @returns formatted outputs
     */
    getUserPoolOutputs = (userPool, userPoolPasswordPolicy, userPoolProviders, userPoolMFA, region) => {
        // password policy requirements
        const requirements = [];
        userPoolPasswordPolicy.RequireNumbers &&
            requirements.push('REQUIRES_NUMBERS');
        userPoolPasswordPolicy.RequireLowercase &&
            requirements.push('REQUIRES_LOWERCASE');
        userPoolPasswordPolicy.RequireUppercase &&
            requirements.push('REQUIRES_UPPERCASE');
        userPoolPasswordPolicy.RequireSymbols &&
            requirements.push('REQUIRES_SYMBOLS');
        // mfa types
        const mfaTypes = [];
        if (userPoolMFA.SmsMfaConfiguration &&
            userPoolMFA.SmsMfaConfiguration.SmsConfiguration) {
            mfaTypes.push('SMS_MFA');
        }
        if (userPoolMFA.SoftwareTokenMfaConfiguration?.Enabled) {
            mfaTypes.push('TOTP');
        }
        if (userPoolMFA.EmailMfaConfiguration) {
            mfaTypes.push('EMAIL_MFA');
        }
        // social providers
        const socialProviders = [];
        if (userPoolProviders) {
            for (const provider of userPoolProviders) {
                const providerType = provider.ProviderType;
                const providerName = provider.ProviderName;
                if (providerType === 'Google') {
                    socialProviders.push('GOOGLE');
                }
                if (providerType === 'Facebook') {
                    socialProviders.push('FACEBOOK');
                }
                if (providerType === 'SignInWithApple') {
                    socialProviders.push('SIGN_IN_WITH_APPLE');
                }
                if (providerType === 'LoginWithAmazon') {
                    socialProviders.push('LOGIN_WITH_AMAZON');
                }
                if (providerType === 'OIDC' && providerName) {
                    socialProviders.push(providerName);
                }
                if (providerType === 'SAML' && providerName) {
                    socialProviders.push(providerName);
                }
            }
        }
        // domain
        const oauthDomain = userPool.CustomDomain ?? userPool.Domain ?? '';
        const fullDomainPath = userPool.CustomDomain
            ? userPool.CustomDomain
            : `${oauthDomain}.auth.${region}.amazoncognito.com`;
        const data = {
            signupAttributes: JSON.stringify(userPool.SchemaAttributes?.filter((attribute) => attribute.Required && attribute.Name).map((attribute) => attribute.Name?.toLowerCase()) || []),
            usernameAttributes: JSON.stringify(userPool.UsernameAttributes?.map((attribute) => attribute.toLowerCase()) || []),
            verificationMechanisms: JSON.stringify(userPool.AutoVerifiedAttributes ?? []),
            passwordPolicyMinLength: userPoolPasswordPolicy.MinimumLength === undefined
                ? ''
                : userPoolPasswordPolicy.MinimumLength.toString(),
            passwordPolicyRequirements: JSON.stringify(requirements),
            mfaConfiguration: userPool.MfaConfiguration ?? 'OFF',
            mfaTypes: JSON.stringify(mfaTypes),
            socialProviders: JSON.stringify(socialProviders),
            oauthCognitoDomain: fullDomainPath,
        };
        return data;
    };
    /**
     * Transforms identityPool info into outputs.
     * @param identityPool identity pool data
     * @returns formatted outputs
     */
    getIdentityPoolOutputs = (identityPool) => {
        const data = {
            allowUnauthenticatedIdentities: identityPool.AllowUnauthenticatedIdentities === true ? 'true' : 'false',
        };
        return data;
    };
    /**
     * Transforms userPoolClient info into outputs.
     * @param userPoolClient userPoolClient data
     * @returns formatted outputs
     */
    getUserPoolClientOutputs = (userPoolClient) => {
        const data = {
            oauthScope: JSON.stringify(userPoolClient.AllowedOAuthScopes ?? []),
            oauthRedirectSignIn: userPoolClient.CallbackURLs
                ? userPoolClient.CallbackURLs.join(',')
                : '',
            oauthRedirectSignOut: userPoolClient.LogoutURLs
                ? userPoolClient.LogoutURLs.join(',')
                : '',
            oauthResponseType: userPoolClient.AllowedOAuthFlows
                ? userPoolClient.AllowedOAuthFlows.join(',')
                : '',
            oauthClientId: userPoolClient.ClientId,
        };
        return data;
    };
}
/**
 * Entry point for the lambda-backend custom resource to retrieve auth outputs.
 */
export const handler = async (event) => {
    const initializer = new ReferenceAuthInitializer(new CognitoIdentityClient(), new CognitoIdentityProviderClient(), randomUUID);
    return initializer.handleEvent(event);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlX2F1dGhfaW5pdGlhbGl6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGFtYmRhL3JlZmVyZW5jZV9hdXRoX2luaXRpYWxpemVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE9BQU8sRUFDTCw2QkFBNkIsRUFDN0IsNkJBQTZCLEVBQzdCLHVCQUF1QixFQUN2QiwyQkFBMkIsRUFHM0IsaUJBQWlCLEVBQ2pCLDRCQUE0QixHQUs3QixNQUFNLDJDQUEyQyxDQUFDO0FBQ25ELE9BQU8sRUFDTCxxQkFBcUIsRUFDckIsMkJBQTJCLEVBRTNCLDJCQUEyQixHQUM1QixNQUFNLGtDQUFrQyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFZekM7O0dBRUc7QUFDSCxNQUFNLE9BQU8sd0JBQXdCO0lBT3pCO0lBQ0E7SUFDQTtJQVJWOzs7O09BSUc7SUFDSCxZQUNVLHFCQUE0QyxFQUM1Qyw2QkFBNEQsRUFDNUQsYUFBMkI7UUFGM0IsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUM1QyxrQ0FBNkIsR0FBN0IsNkJBQTZCLENBQStCO1FBQzVELGtCQUFhLEdBQWIsYUFBYSxDQUFjO0lBQ2xDLENBQUM7SUFFSjs7OztPQUlHO0lBQ0ksV0FBVyxHQUFHLEtBQUssRUFBRSxLQUF3QyxFQUFFLEVBQUU7UUFDdEUsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLEtBQUssQ0FBQyxXQUFXLFNBQVMsQ0FBQyxDQUFDO1FBQ3RELDJFQUEyRTtRQUMzRSxNQUFNLFVBQVUsR0FDZCxLQUFLLENBQUMsV0FBVyxLQUFLLFFBQVE7WUFDNUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQztRQUUvQiwwRUFBMEU7UUFDMUUsSUFBSSxLQUFLLENBQUMsV0FBVyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ25DLE9BQU87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Q0FBQyxDQUFDLEVBQUU7WUFDTixvQkFBb0IsRUFBRSxjQUFjLENBQUMsVUFBVTtnQkFDN0MsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztnQkFDckMsQ0FBQyxDQUFDLEVBQUU7WUFDTixpQkFBaUIsRUFBRSxjQUFjLENBQUMsaUJBQWlCO2dCQUNqRCxDQUFDLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7Z0JBQzVDLENBQUMsQ0FBQyxFQUFFO1lBQ04sYUFBYSxFQUFFLGNBQWMsQ0FBQyxRQUFRO1NBQ3ZDLENBQUM7UUFDRixPQUFPLElBQUksQ0FBQztJQUNkLENBQUMsQ0FBQztDQUNIO0FBRUQ7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUF3QyxFQUNPLEVBQUU7SUFDakQsTUFBTSxXQUFXLEdBQUcsSUFBSSx3QkFBd0IsQ0FDOUMsSUFBSSxxQkFBcUIsRUFBRSxFQUMzQixJQUFJLDZCQUE2QixFQUFFLEVBQ25DLFVBQVUsQ0FDWCxDQUFDO0lBQ0YsT0FBTyxXQUFXLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3hDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCxcbiAgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVJlc3BvbnNlLFxuICBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlU3VjY2Vzc1Jlc3BvbnNlLFxufSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7XG4gIENvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50LFxuICBEZXNjcmliZVVzZXJQb29sQ2xpZW50Q29tbWFuZCxcbiAgRGVzY3JpYmVVc2VyUG9vbENvbW1hbmQsXG4gIEdldFVzZXJQb29sTWZhQ29uZmlnQ29tbWFuZCxcbiAgR2V0VXNlclBvb2xNZmFDb25maWdDb21tYW5kT3V0cHV0LFxuICBHcm91cFR5cGUsXG4gIExpc3RHcm91cHNDb21tYW5kLFxuICBMaXN0SWRlbnRpdHlQcm92aWRlcnNDb21tYW5kLFxuICBQYXNzd29yZFBvbGljeVR5cGUsXG4gIFByb3ZpZGVyRGVzY3JpcHRpb24sXG4gIFVzZXJQb29sQ2xpZW50VHlwZSxcbiAgVXNlclBvb2xUeXBlLFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtY29nbml0by1pZGVudGl0eS1wcm92aWRlcic7XG5pbXBvcnQge1xuICBDb2duaXRvSWRlbnRpdHlDbGllbnQsXG4gIERlc2NyaWJlSWRlbnRpdHlQb29sQ29tbWFuZCxcbiAgRGVzY3JpYmVJZGVudGl0eVBvb2xDb21tYW5kT3V0cHV0LFxuICBHZXRJZGVudGl0eVBvb2xSb2xlc0NvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1jb2duaXRvLWlkZW50aXR5JztcbmltcG9ydCB7IHJhbmRvbVVVSUQgfSBmcm9tICdub2RlOmNyeXB0byc7XG5pbXBvcnQgeyBBdXRoT3V0cHV0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuZXhwb3J0IHR5cGUgUmVmZXJlbmNlQXV0aEluaXRpYWxpemVyUHJvcHMgPSB7XG4gIHVzZXJQb29sSWQ6IHN0cmluZztcbiAgaWRlbnRpdHlQb29sSWQ6IHN0cmluZztcbiAgYXV0aFJvbGVBcm46IHN0cmluZztcbiAgdW5hdXRoUm9sZUFybjogc3RyaW5nO1xuICB1c2VyUG9vbENsaWVudElkOiBzdHJpbmc7XG4gIGdyb3VwczogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgcmVnaW9uOiBzdHJpbmc7XG59O1xuXG4vKipcbiAqIEluaXRpYWxpemVyIHRoYXQgZmV0Y2hlcyBhbmQgcHJvY2VzcyBhdXRoIHJlc291cmNlcy5cbiAqL1xuZXhwb3J0IGNsYXNzIFJlZmVyZW5jZUF1dGhJbml0aWFsaXplciB7XG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgaW5pdGlhbGl6ZXJcbiAgICogQHBhcmFtIGNvZ25pdG9JZGVudGl0eUNsaWVudCBpZGVudGl0eSBjbGllbnRcbiAgICogQHBhcmFtIGNvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50IGlkZW50aXR5IHByb3ZpZGVyIGNsaWVudFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjb2duaXRvSWRlbnRpdHlDbGllbnQ6IENvZ25pdG9JZGVudGl0eUNsaWVudCxcbiAgICBwcml2YXRlIGNvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50OiBDb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudCxcbiAgICBwcml2YXRlIHV1aWRHZW5lcmF0b3I6ICgpID0+IHN0cmluZyxcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBIYW5kbGVzIGN1c3RvbSByZXNvdXJjZSBldmVudHNcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50IHRvIHByb2Nlc3NcbiAgICogQHJldHVybnMgY3VzdG9tIHJlc291cmNlIHJlc3BvbnNlXG4gICAqL1xuICBwdWJsaWMgaGFuZGxlRXZlbnQgPSBhc3luYyAoZXZlbnQ6IENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCkgPT4ge1xuICAgIGNvbnNvbGUuaW5mbyhgUmVjZWl2ZWQgJyR7ZXZlbnQuUmVxdWVzdFR5cGV9JyBldmVudGApO1xuICAgIC8vIHBoeXNpY2FsIGlkIGlzIG9ubHkgZ2VuZXJhdGVkIG9uIGNyZWF0ZSwgb3RoZXJ3aXNlIGl0IG11c3Qgc3RheSB0aGUgc2FtZVxuICAgIGNvbnN0IHBoeXNpY2FsSWQgPVxuICAgICAgZXZlbnQuUmVxdWVzdFR5cGUgPT09ICdDcmVhdGUnXG4gICAgICAgID8gdGhpcy51dWlkR2VuZXJhdG9yKClcbiAgICAgICAgOiBldmVudC5QaHlzaWNhbFJlc291cmNlSWQ7XG5cbiAgICAvLyBvbiBkZWxldGUsIGp1c3QgcmVzcG9uZCB3aXRoIHN1Y2Nlc3Mgc2luY2Ugd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgIGlmIChldmVudC5SZXF1ZXN0VHlwZSA9PT0gJ0RlbGV0ZScpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIFJlcXVlc3RJZDogZXZlbnQuUmVxdWVzdElkLFxuICAgICAgICBMb2dpY2FsUmVzb3VyY2VJZDogZXZlbnQuTG9naWNhbFJlc291cmNlSWQsXG4gICAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogcGh5c2ljYWxJZCxcbiAgICAgICAgU3RhY2tJZDogZXZlbnQuU3RhY2tJZCxcbiAgICAgICAgTm9FY2hvOiB0cnVlLFxuICAgICAgICBTdGF0dXM6ICdTVUNDRVNTJyxcbiAgICAgIH0gYXMgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVN1Y2Nlc3NSZXNwb25zZTtcbiAgICB9XG4gICAgLy8gZm9yIGNyZWF0ZSBvciB1cGRhdGUgZXZlbnRzLCB3ZSB3aWxsIGZldGNoIGFuZCB2YWxpZGF0ZSByZXNvdXJjZSBwcm9wZXJ0aWVzXG4gICAgY29uc3QgcHJvcHMgPVxuICAgICAgZXZlbnQuUmVzb3VyY2VQcm9wZXJ0aWVzIGFzIHVua25vd24gYXMgUmVmZXJlbmNlQXV0aEluaXRpYWxpemVyUHJvcHM7XG4gICAgY29uc3Qge1xuICAgICAgdXNlclBvb2wsXG4gICAgICB1c2VyUG9vbFBhc3N3b3JkUG9saWN5LFxuICAgICAgdXNlclBvb2xNRkEsXG4gICAgICB1c2VyUG9vbEdyb3VwcyxcbiAgICAgIHVzZXJQb29sUHJvdmlkZXJzLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICBpZGVudGl0eVBvb2wsXG4gICAgICByb2xlcyxcbiAgICB9ID0gYXdhaXQgdGhpcy5nZXRSZXNvdXJjZURldGFpbHMoXG4gICAgICBwcm9wcy51c2VyUG9vbElkLFxuICAgICAgcHJvcHMuaWRlbnRpdHlQb29sSWQsXG4gICAgICBwcm9wcy51c2VyUG9vbENsaWVudElkLFxuICAgICk7XG5cbiAgICB0aGlzLnZhbGlkYXRlUmVzb3VyY2VzKFxuICAgICAgdXNlclBvb2wsXG4gICAgICB1c2VyUG9vbFByb3ZpZGVycyxcbiAgICAgIHVzZXJQb29sR3JvdXBzLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICBpZGVudGl0eVBvb2wsXG4gICAgICByb2xlcyxcbiAgICAgIHByb3BzLFxuICAgICk7XG5cbiAgICBjb25zdCB1c2VyUG9vbE91dHB1dHMgPSBhd2FpdCB0aGlzLmdldFVzZXJQb29sT3V0cHV0cyhcbiAgICAgIHVzZXJQb29sLFxuICAgICAgdXNlclBvb2xQYXNzd29yZFBvbGljeSxcbiAgICAgIHVzZXJQb29sUHJvdmlkZXJzLFxuICAgICAgdXNlclBvb2xNRkEsXG4gICAgICBwcm9wcy5yZWdpb24sXG4gICAgKTtcbiAgICBjb25zdCBpZGVudGl0eVBvb2xPdXRwdXRzID0gYXdhaXQgdGhpcy5nZXRJZGVudGl0eVBvb2xPdXRwdXRzKGlkZW50aXR5UG9vbCk7XG4gICAgY29uc3QgdXNlclBvb2xDbGllbnRPdXRwdXRzID1cbiAgICAgIGF3YWl0IHRoaXMuZ2V0VXNlclBvb2xDbGllbnRPdXRwdXRzKHVzZXJQb29sQ2xpZW50KTtcbiAgICBjb25zdCBkYXRhOiBPbWl0PEF1dGhPdXRwdXRbJ3BheWxvYWQnXSwgJ2F1dGhSZWdpb24nPiA9IHtcbiAgICAgIHVzZXJQb29sSWQ6IHByb3BzLnVzZXJQb29sSWQsXG4gICAgICB3ZWJDbGllbnRJZDogcHJvcHMudXNlclBvb2xDbGllbnRJZCxcbiAgICAgIGlkZW50aXR5UG9vbElkOiBwcm9wcy5pZGVudGl0eVBvb2xJZCxcbiAgICAgIC4uLnVzZXJQb29sT3V0cHV0cyxcbiAgICAgIC4uLmlkZW50aXR5UG9vbE91dHB1dHMsXG4gICAgICAuLi51c2VyUG9vbENsaWVudE91dHB1dHMsXG4gICAgfTtcbiAgICByZXR1cm4ge1xuICAgICAgUmVxdWVzdElkOiBldmVudC5SZXF1ZXN0SWQsXG4gICAgICBMb2dpY2FsUmVzb3VyY2VJZDogZXZlbnQuTG9naWNhbFJlc291cmNlSWQsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IHBoeXNpY2FsSWQsXG4gICAgICBTdGFja0lkOiBldmVudC5TdGFja0lkLFxuICAgICAgTm9FY2hvOiB0cnVlLFxuICAgICAgRGF0YTogZGF0YSxcbiAgICAgIFN0YXR1czogJ1NVQ0NFU1MnLFxuICAgIH0gYXMgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVN1Y2Nlc3NSZXNwb25zZTtcbiAgfTtcblxuICBwcml2YXRlIGdldFVzZXJQb29sID0gYXN5bmMgKHVzZXJQb29sSWQ6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IHVzZXJQb29sQ29tbWFuZCA9IG5ldyBEZXNjcmliZVVzZXJQb29sQ29tbWFuZCh7XG4gICAgICBVc2VyUG9vbElkOiB1c2VyUG9vbElkLFxuICAgIH0pO1xuICAgIGNvbnN0IHVzZXJQb29sUmVzcG9uc2UgPVxuICAgICAgYXdhaXQgdGhpcy5jb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudC5zZW5kKHVzZXJQb29sQ29tbWFuZCk7XG4gICAgaWYgKCF1c2VyUG9vbFJlc3BvbnNlLlVzZXJQb29sKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSB0aGUgc3BlY2lmaWVkIFVzZXJQb29sLicpO1xuICAgIH1cbiAgICBjb25zdCB1c2VyUG9vbCA9IHVzZXJQb29sUmVzcG9uc2UuVXNlclBvb2w7XG4gICAgY29uc3QgcG9saWN5ID0gdXNlclBvb2wuUG9saWNpZXM/LlBhc3N3b3JkUG9saWN5O1xuICAgIGlmICghcG9saWN5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBwYXNzd29yZCBwb2xpY3kuJyk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICB1c2VyUG9vbDogdXNlclBvb2xSZXNwb25zZS5Vc2VyUG9vbCxcbiAgICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3k6IHBvbGljeSxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0VXNlclBvb2xNRkFTZXR0aW5ncyA9IGFzeW5jICh1c2VyUG9vbElkOiBzdHJpbmcpID0+IHtcbiAgICAvLyBtZmEgdHlwZXNcbiAgICBjb25zdCBtZmFDb21tYW5kID0gbmV3IEdldFVzZXJQb29sTWZhQ29uZmlnQ29tbWFuZCh7XG4gICAgICBVc2VyUG9vbElkOiB1c2VyUG9vbElkLFxuICAgIH0pO1xuICAgIGNvbnN0IG1mYVJlc3BvbnNlID1cbiAgICAgIGF3YWl0IHRoaXMuY29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQuc2VuZChtZmFDb21tYW5kKTtcbiAgICByZXR1cm4gbWZhUmVzcG9uc2U7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbEdyb3VwcyA9IGFzeW5jICh1c2VyUG9vbElkOiBzdHJpbmcpID0+IHtcbiAgICBsZXQgbmV4dFRva2VuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgY29uc3QgZ3JvdXBzOiBHcm91cFR5cGVbXSA9IFtdO1xuICAgIGRvIHtcbiAgICAgIGNvbnN0IGxpc3RHcm91cHNSZXNwb25zZSA9IGF3YWl0IHRoaXMuY29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQuc2VuZChcbiAgICAgICAgbmV3IExpc3RHcm91cHNDb21tYW5kKHtcbiAgICAgICAgICBVc2VyUG9vbElkOiB1c2VyUG9vbElkLFxuICAgICAgICAgIE5leHRUb2tlbjogbmV4dFRva2VuLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgICBpZiAoIWxpc3RHcm91cHNSZXNwb25zZS5Hcm91cHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSByZXRyaWV2aW5nIHRoZSBncm91cHMgZm9yIHRoZSB1c2VyIHBvb2wuJyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGdyb3Vwcy5wdXNoKC4uLmxpc3RHcm91cHNSZXNwb25zZS5Hcm91cHMpO1xuICAgICAgbmV4dFRva2VuID0gbGlzdEdyb3Vwc1Jlc3BvbnNlLk5leHRUb2tlbjtcbiAgICB9IHdoaWxlIChuZXh0VG9rZW4pO1xuICAgIHJldHVybiBncm91cHM7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbFByb3ZpZGVycyA9IGFzeW5jICh1c2VyUG9vbElkOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBwcm92aWRlcnM6IFByb3ZpZGVyRGVzY3JpcHRpb25bXSA9IFtdO1xuICAgIGxldCBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBkbyB7XG4gICAgICBjb25zdCBwcm92aWRlcnNSZXNwb25zZSA9IGF3YWl0IHRoaXMuY29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQuc2VuZChcbiAgICAgICAgbmV3IExpc3RJZGVudGl0eVByb3ZpZGVyc0NvbW1hbmQoe1xuICAgICAgICAgIFVzZXJQb29sSWQ6IHVzZXJQb29sSWQsXG4gICAgICAgICAgTmV4dFRva2VuOiBuZXh0VG9rZW4sXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICAgIGlmIChwcm92aWRlcnNSZXNwb25zZS5Qcm92aWRlcnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgaWRlbnRpdHkgcHJvdmlkZXJzIGZvciB0aGUgdXNlciBwb29sLicsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBwcm92aWRlcnMucHVzaCguLi5wcm92aWRlcnNSZXNwb25zZS5Qcm92aWRlcnMpO1xuICAgICAgbmV4dFRva2VuID0gcHJvdmlkZXJzUmVzcG9uc2UuTmV4dFRva2VuO1xuICAgIH0gd2hpbGUgKG5leHRUb2tlbik7XG4gICAgcmV0dXJuIHByb3ZpZGVycztcbiAgfTtcblxuICBwcml2YXRlIGdldElkZW50aXR5UG9vbCA9IGFzeW5jIChpZGVudGl0eVBvb2xJZDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgaWRwUmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNvZ25pdG9JZGVudGl0eUNsaWVudC5zZW5kKFxuICAgICAgbmV3IERlc2NyaWJlSWRlbnRpdHlQb29sQ29tbWFuZCh7XG4gICAgICAgIElkZW50aXR5UG9vbElkOiBpZGVudGl0eVBvb2xJZCxcbiAgICAgIH0pLFxuICAgICk7XG4gICAgaWYgKCFpZHBSZXNwb25zZS5JZGVudGl0eVBvb2xJZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgcmV0cmlldmluZyB0aGUgaWRlbnRpdHkgcG9vbCBkZXRhaWxzLicsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gaWRwUmVzcG9uc2U7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRJZGVudGl0eVBvb2xSb2xlcyA9IGFzeW5jIChpZGVudGl0eVBvb2xJZDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3Qgcm9sZXNDb21tYW5kID0gbmV3IEdldElkZW50aXR5UG9vbFJvbGVzQ29tbWFuZCh7XG4gICAgICBJZGVudGl0eVBvb2xJZDogaWRlbnRpdHlQb29sSWQsXG4gICAgfSk7XG4gICAgY29uc3Qgcm9sZXNSZXNwb25zZSA9IGF3YWl0IHRoaXMuY29nbml0b0lkZW50aXR5Q2xpZW50LnNlbmQocm9sZXNDb21tYW5kKTtcbiAgICBpZiAoIXJvbGVzUmVzcG9uc2UuUm9sZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgdGhlIHJvbGVzIGZvciB0aGUgaWRlbnRpdHkgcG9vbC4nLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHJvbGVzUmVzcG9uc2UuUm9sZXM7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbENsaWVudCA9IGFzeW5jIChcbiAgICB1c2VyUG9vbElkOiBzdHJpbmcsXG4gICAgdXNlclBvb2xDbGllbnRJZDogc3RyaW5nLFxuICApID0+IHtcbiAgICBjb25zdCB1c2VyUG9vbENsaWVudENvbW1hbmQgPSBuZXcgRGVzY3JpYmVVc2VyUG9vbENsaWVudENvbW1hbmQoe1xuICAgICAgVXNlclBvb2xJZDogdXNlclBvb2xJZCxcbiAgICAgIENsaWVudElkOiB1c2VyUG9vbENsaWVudElkLFxuICAgIH0pO1xuICAgIGNvbnN0IHVzZXJQb29sQ2xpZW50UmVzcG9uc2UgPVxuICAgICAgYXdhaXQgdGhpcy5jb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudC5zZW5kKHVzZXJQb29sQ2xpZW50Q29tbWFuZCk7XG4gICAgaWYgKCF1c2VyUG9vbENsaWVudFJlc3BvbnNlLlVzZXJQb29sQ2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSByZXRyaWV2aW5nIHRoZSB1c2VyIHBvb2wgY2xpZW50IGRldGFpbHMuJyxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB1c2VyUG9vbENsaWVudFJlc3BvbnNlLlVzZXJQb29sQ2xpZW50O1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgYWxsIG9mIHRoZSByZXNvdXJjZSBkYXRhIHRoYXQgaXMgbmVjZXNzYXJ5IGZvciB2YWxpZGF0aW9uIGFuZCBvdXRwdXQgZ2VuZXJhdGlvbi5cbiAgICogQHBhcmFtIHVzZXJQb29sSWQgdXNlclBvb2xJZFxuICAgKiBAcGFyYW0gaWRlbnRpdHlQb29sSWQgaWRlbnRpdHlQb29sSWRcbiAgICogQHBhcmFtIHVzZXJQb29sQ2xpZW50SWQgdXNlclBvb2xDbGllbnRJZFxuICAgKiBAcmV0dXJucyBhbGwgbmVjZXNzYXJ5IHJlc291cmNlIGRhdGFcbiAgICovXG4gIHByaXZhdGUgZ2V0UmVzb3VyY2VEZXRhaWxzID0gYXN5bmMgKFxuICAgIHVzZXJQb29sSWQ6IHN0cmluZyxcbiAgICBpZGVudGl0eVBvb2xJZDogc3RyaW5nLFxuICAgIHVzZXJQb29sQ2xpZW50SWQ6IHN0cmluZyxcbiAgKSA9PiB7XG4gICAgY29uc3QgeyB1c2VyUG9vbCwgdXNlclBvb2xQYXNzd29yZFBvbGljeSB9ID1cbiAgICAgIGF3YWl0IHRoaXMuZ2V0VXNlclBvb2wodXNlclBvb2xJZCk7XG4gICAgY29uc3QgdXNlclBvb2xNRkEgPSBhd2FpdCB0aGlzLmdldFVzZXJQb29sTUZBU2V0dGluZ3ModXNlclBvb2xJZCk7XG4gICAgY29uc3QgdXNlclBvb2xQcm92aWRlcnMgPSBhd2FpdCB0aGlzLmdldFVzZXJQb29sUHJvdmlkZXJzKHVzZXJQb29sSWQpO1xuICAgIGNvbnN0IHVzZXJQb29sR3JvdXBzID0gYXdhaXQgdGhpcy5nZXRVc2VyUG9vbEdyb3Vwcyh1c2VyUG9vbElkKTtcbiAgICBjb25zdCB1c2VyUG9vbENsaWVudCA9IGF3YWl0IHRoaXMuZ2V0VXNlclBvb2xDbGllbnQoXG4gICAgICB1c2VyUG9vbElkLFxuICAgICAgdXNlclBvb2xDbGllbnRJZCxcbiAgICApO1xuICAgIGNvbnN0IGlkZW50aXR5UG9vbCA9IGF3YWl0IHRoaXMuZ2V0SWRlbnRpdHlQb29sKGlkZW50aXR5UG9vbElkKTtcbiAgICBjb25zdCByb2xlcyA9IGF3YWl0IHRoaXMuZ2V0SWRlbnRpdHlQb29sUm9sZXMoaWRlbnRpdHlQb29sSWQpO1xuICAgIHJldHVybiB7XG4gICAgICB1c2VyUG9vbCxcbiAgICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3ksXG4gICAgICB1c2VyUG9vbE1GQSxcbiAgICAgIHVzZXJQb29sUHJvdmlkZXJzLFxuICAgICAgdXNlclBvb2xHcm91cHMsXG4gICAgICB1c2VyUG9vbENsaWVudCxcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIHJvbGVzLFxuICAgIH07XG4gIH07XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIHRoZSByZXNvdXJjZSBhc3NvY2lhdGlvbnMuXG4gICAqIDEuIG1ha2Ugc3VyZSB0aGUgdXNlciBwb29sICYgdXNlciBwb29sIGNsaWVudCBwYWlyIGFyZSBhIGNvZ25pdG8gcHJvdmlkZXIgZm9yIHRoZSBpZGVudGl0eSBwb29sXG4gICAqIDIuIG1ha2Ugc3VyZSB0aGUgcHJvdmlkZWQgYXV0aC91bmF1dGggcm9sZSBBUk5zIG1hdGNoIHRoZSByb2xlcyBmb3IgdGhlIGlkZW50aXR5IHBvb2xcbiAgICogMy4gbWFrZSBzdXJlIHRoZSB1c2VyIHBvb2wgY2xpZW50IGlzIGEgd2ViIGNsaWVudFxuICAgKiBAcGFyYW0gdXNlclBvb2wgdXNlclBvb2xcbiAgICogQHBhcmFtIHVzZXJQb29sUHJvdmlkZXJzIHRoZSB1c2VyIHBvb2wgcHJvdmlkZXJzXG4gICAqIEBwYXJhbSB1c2VyUG9vbEdyb3VwcyB0aGUgZXhpc3RpbmcgZ3JvdXBzIGZvciB0aGUgdXNlclBvb2xcbiAgICogQHBhcmFtIHVzZXJQb29sQ2xpZW50IHVzZXJQb29sQ2xpZW50XG4gICAqIEBwYXJhbSBpZGVudGl0eVBvb2wgaWRlbnRpdHlQb29sXG4gICAqIEBwYXJhbSBpZGVudGl0eVBvb2xSb2xlcyBpZGVudGl0eVBvb2wgcm9sZXNcbiAgICogQHBhcmFtIHByb3BzIHByb3BzIHRoYXQgaW5jbHVkZSB0aGUgcm9sZXMgd2hpY2ggd2UgY29tcGFyZSB3aXRoIHRoZSBhY3R1YWwgcm9sZXMgZm9yIHRoZSBpZGVudGl0eSBwb29sXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlUmVzb3VyY2VzID0gKFxuICAgIHVzZXJQb29sOiBVc2VyUG9vbFR5cGUsXG4gICAgdXNlclBvb2xQcm92aWRlcnM6IFByb3ZpZGVyRGVzY3JpcHRpb25bXSxcbiAgICB1c2VyUG9vbEdyb3VwczogR3JvdXBUeXBlW10sXG4gICAgdXNlclBvb2xDbGllbnQ6IFVzZXJQb29sQ2xpZW50VHlwZSxcbiAgICBpZGVudGl0eVBvb2w6IERlc2NyaWJlSWRlbnRpdHlQb29sQ29tbWFuZE91dHB1dCxcbiAgICBpZGVudGl0eVBvb2xSb2xlczogUmVjb3JkPHN0cmluZywgc3RyaW5nPixcbiAgICBwcm9wczogUmVmZXJlbmNlQXV0aEluaXRpYWxpemVyUHJvcHMsXG4gICkgPT4ge1xuICAgIC8vIHZlcmlmeSB0aGUgdXNlciBwb29sIGlzIGEgY29nbml0byBwcm92aWRlciBmb3IgdGhpcyBpZGVudGl0eSBwb29sXG4gICAgaWYgKFxuICAgICAgIWlkZW50aXR5UG9vbC5Db2duaXRvSWRlbnRpdHlQcm92aWRlcnMgfHxcbiAgICAgIGlkZW50aXR5UG9vbC5Db2duaXRvSWRlbnRpdHlQcm92aWRlcnMubGVuZ3RoID09PSAwXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdUaGUgc3BlY2lmaWVkIGlkZW50aXR5IHBvb2wgZG9lcyBub3QgaGF2ZSBhbnkgY29nbml0byBpZGVudGl0eSBwcm92aWRlcnMuJyxcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIGNoZWNrIGZvciBhbGlhcyBhdHRyaWJ1dGVzLCBzaW5jZSB3ZSBkb24ndCBzdXBwb3J0IHRoaXMgeWV0XG4gICAgaWYgKHVzZXJQb29sLkFsaWFzQXR0cmlidXRlcyAmJiB1c2VyUG9vbC5BbGlhc0F0dHJpYnV0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnVGhlIHNwZWNpZmllZCB1c2VyIHBvb2wgaXMgY29uZmlndXJlZCB3aXRoIGFsaWFzIGF0dHJpYnV0ZXMgd2hpY2ggYXJlIG5vdCBjdXJyZW50bHkgc3VwcG9ydGVkLicsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGNoZWNrIE9BdXRoIHNldHRpbmdzXG4gICAgaWYgKHVzZXJQb29sUHJvdmlkZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIHZhbGlkYXRlIHVzZXIgcG9vbFxuICAgICAgY29uc3QgZG9tYWluU3BlY2lmaWVkID0gdXNlclBvb2wuRG9tYWluIHx8IHVzZXJQb29sLkN1c3RvbURvbWFpbjtcbiAgICAgIGlmICghZG9tYWluU3BlY2lmaWVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnWW91IG11c3QgY29uZmlndXJlIGEgZG9tYWluIGZvciB5b3VyIFVzZXJQb29sIGlmIGV4dGVybmFsIGxvZ2luIHByb3ZpZGVycyBhcmUgZW5hYmxlZC4nLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyB2YWxpZGF0ZSB1c2VyIHBvb2wgY2xpZW50XG4gICAgICBjb25zdCBoYXNMb2dvdXRVcmxzID1cbiAgICAgICAgdXNlclBvb2xDbGllbnQuTG9nb3V0VVJMcyAmJiB1c2VyUG9vbENsaWVudC5Mb2dvdXRVUkxzLmxlbmd0aCA+IDA7XG4gICAgICBjb25zdCBoYXNDYWxsYmFja1VybHMgPVxuICAgICAgICB1c2VyUG9vbENsaWVudC5DYWxsYmFja1VSTHMgJiYgdXNlclBvb2xDbGllbnQuQ2FsbGJhY2tVUkxzLmxlbmd0aCA+IDA7XG4gICAgICBpZiAoIWhhc0xvZ291dFVybHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdZb3VyIFVzZXJQb29sIGNsaWVudCBtdXN0IGhhdmUgXCJBbGxvd2VkIHNpZ24tb3V0IFVSTHNcIiBjb25maWd1cmVkIGlmIGV4dGVybmFsIGxvZ2luIHByb3ZpZGVycyBhcmUgZW5hYmxlZC4nLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKCFoYXNDYWxsYmFja1VybHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdZb3VyIFVzZXJQb29sIGNsaWVudCBtdXN0IGhhdmUgXCJBbGxvd2VkIGNhbGxiYWNrIFVSTHNcIiBjb25maWd1cmVkIGlmIGV4dGVybmFsIGxvZ2luIHByb3ZpZGVycyBhcmUgZW5hYmxlZC4nLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIG1ha2Ugc3VyZSBwcm9wcyBncm91cHMgUm9sZXMgYWN0dWFsbHkgZXhpc3QgZm9yIHRoZSB1c2VyIHBvb2xcbiAgICBjb25zdCBncm91cEVudHJpZXMgPSBPYmplY3QuZW50cmllcyhwcm9wcy5ncm91cHMpO1xuICAgIGZvciAoY29uc3QgW2dyb3VwTmFtZSwgZ3JvdXBSb2xlQVJOXSBvZiBncm91cEVudHJpZXMpIHtcbiAgICAgIGNvbnN0IG1hdGNoID0gdXNlclBvb2xHcm91cHMuZmluZCgoZykgPT4gZy5Sb2xlQXJuID09PSBncm91cFJvbGVBUk4pO1xuICAgICAgaWYgKG1hdGNoID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBUaGUgZ3JvdXAgJyR7Z3JvdXBOYW1lfScgd2l0aCByb2xlICcke2dyb3VwUm9sZUFSTn0nIGRvZXMgbm90IG1hdGNoIGFueSBncm91cCBmb3IgdGhlIHNwZWNpZmllZCB1c2VyIHBvb2wuYCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gdmVyaWZ5IHRoYXQgdGhlIHVzZXIgcG9vbCArIHVzZXIgcG9vbCBjbGllbnQgcGFpciBhcmUgY29uZmlndXJlZCB3aXRoIHRoZSBpZGVudGl0eSBwb29sXG4gICAgY29uc3QgbWF0Y2hpbmdQcm92aWRlciA9IGlkZW50aXR5UG9vbC5Db2duaXRvSWRlbnRpdHlQcm92aWRlcnMuZmluZCgocCkgPT4ge1xuICAgICAgY29uc3QgbWF0Y2hpbmdVc2VyUG9vbDogYm9vbGVhbiA9XG4gICAgICAgIHAuUHJvdmlkZXJOYW1lID09PVxuICAgICAgICBgY29nbml0by1pZHAuJHtwcm9wcy5yZWdpb259LmFtYXpvbmF3cy5jb20vJHt1c2VyUG9vbC5JZH1gO1xuICAgICAgY29uc3QgbWF0Y2hpbmdVc2VyUG9vbENsaWVudDogYm9vbGVhbiA9XG4gICAgICAgIHAuQ2xpZW50SWQgPT09IHVzZXJQb29sQ2xpZW50LkNsaWVudElkO1xuICAgICAgcmV0dXJuIG1hdGNoaW5nVXNlclBvb2wgJiYgbWF0Y2hpbmdVc2VyUG9vbENsaWVudDtcbiAgICB9KTtcbiAgICBpZiAoIW1hdGNoaW5nUHJvdmlkZXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1RoZSB1c2VyIHBvb2wgYW5kIHVzZXIgcG9vbCBjbGllbnQgcGFpciBkbyBub3QgbWF0Y2ggYW55IGNvZ25pdG8gaWRlbnRpdHkgcHJvdmlkZXJzIGZvciB0aGUgc3BlY2lmaWVkIGlkZW50aXR5IHBvb2wuJyxcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIHZlcmlmeSB0aGUgYXV0aCAvIHVuYXV0aCByb2xlcyBmcm9tIHRoZSBwcm9wcyBtYXRjaCB0aGUgaWRlbnRpdHkgcG9vbCByb2xlcyB0aGF0IHdlIHJldHJpZXZlZFxuICAgIGNvbnN0IGF1dGhSb2xlQXJuID0gaWRlbnRpdHlQb29sUm9sZXNbJ2F1dGhlbnRpY2F0ZWQnXTtcbiAgICBjb25zdCB1bmF1dGhSb2xlQXJuID0gaWRlbnRpdHlQb29sUm9sZXNbJ3VuYXV0aGVudGljYXRlZCddO1xuICAgIGlmIChhdXRoUm9sZUFybiAhPT0gcHJvcHMuYXV0aFJvbGVBcm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1RoZSBwcm92aWRlZCBhdXRoUm9sZUFybiBkb2VzIG5vdCBtYXRjaCB0aGUgYXV0aGVudGljYXRlZCByb2xlIGZvciB0aGUgc3BlY2lmaWVkIGlkZW50aXR5IHBvb2wuJyxcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICh1bmF1dGhSb2xlQXJuICE9PSBwcm9wcy51bmF1dGhSb2xlQXJuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdUaGUgcHJvdmlkZWQgdW5hdXRoUm9sZUFybiBkb2VzIG5vdCBtYXRjaCB0aGUgdW5hdXRoZW50aWNhdGVkIHJvbGUgZm9yIHRoZSBzcGVjaWZpZWQgaWRlbnRpdHkgcG9vbC4nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBtYWtlIHN1cmUgdGhlIGNsaWVudCBpcyBhIHdlYiBjbGllbnQgaGVyZSAod2ViIGNsaWVudHMgc2hvdWxkbid0IGhhdmUgY2xpZW50IHNlY3JldHMpXG4gICAgaWYgKHVzZXJQb29sQ2xpZW50Py5DbGllbnRTZWNyZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1RoZSBzcGVjaWZpZWQgdXNlciBwb29sIGNsaWVudCBpcyBub3QgY29uZmlndXJlZCBhcyBhIHdlYiBjbGllbnQuJyxcbiAgICAgICk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBUcmFuc2Zvcm0gdGhlIHVzZXJQb29sIGRhdGEgaW50byBvdXRwdXRzLlxuICAgKiBAcGFyYW0gdXNlclBvb2wgdXNlciBwb29sXG4gICAqIEBwYXJhbSB1c2VyUG9vbFBhc3N3b3JkUG9saWN5IHVzZXIgcG9vbCBwYXNzd29yZCBwb2xpY3lcbiAgICogQHBhcmFtIHVzZXJQb29sUHJvdmlkZXJzIHVzZXIgcG9vbCBwcm92aWRlcnNcbiAgICogQHBhcmFtIHVzZXJQb29sTUZBIHVzZXIgcG9vbCBNRkEgc2V0dGluZ3NcbiAgICogQHJldHVybnMgZm9ybWF0dGVkIG91dHB1dHNcbiAgICovXG4gIHByaXZhdGUgZ2V0VXNlclBvb2xPdXRwdXRzID0gKFxuICAgIHVzZXJQb29sOiBVc2VyUG9vbFR5cGUsXG4gICAgdXNlclBvb2xQYXNzd29yZFBvbGljeTogUGFzc3dvcmRQb2xpY3lUeXBlLFxuICAgIHVzZXJQb29sUHJvdmlkZXJzOiBQcm92aWRlckRlc2NyaXB0aW9uW10sXG4gICAgdXNlclBvb2xNRkE6IEdldFVzZXJQb29sTWZhQ29uZmlnQ29tbWFuZE91dHB1dCxcbiAgICByZWdpb246IHN0cmluZyxcbiAgKSA9PiB7XG4gICAgLy8gcGFzc3dvcmQgcG9saWN5IHJlcXVpcmVtZW50c1xuICAgIGNvbnN0IHJlcXVpcmVtZW50czogc3RyaW5nW10gPSBbXTtcbiAgICB1c2VyUG9vbFBhc3N3b3JkUG9saWN5LlJlcXVpcmVOdW1iZXJzICYmXG4gICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfTlVNQkVSUycpO1xuICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3kuUmVxdWlyZUxvd2VyY2FzZSAmJlxuICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX0xPV0VSQ0FTRScpO1xuICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3kuUmVxdWlyZVVwcGVyY2FzZSAmJlxuICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1VQUEVSQ0FTRScpO1xuICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3kuUmVxdWlyZVN5bWJvbHMgJiZcbiAgICAgIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19TWU1CT0xTJyk7XG4gICAgLy8gbWZhIHR5cGVzXG4gICAgY29uc3QgbWZhVHlwZXM6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKFxuICAgICAgdXNlclBvb2xNRkEuU21zTWZhQ29uZmlndXJhdGlvbiAmJlxuICAgICAgdXNlclBvb2xNRkEuU21zTWZhQ29uZmlndXJhdGlvbi5TbXNDb25maWd1cmF0aW9uXG4gICAgKSB7XG4gICAgICBtZmFUeXBlcy5wdXNoKCdTTVNfTUZBJyk7XG4gICAgfVxuICAgIGlmICh1c2VyUG9vbE1GQS5Tb2Z0d2FyZVRva2VuTWZhQ29uZmlndXJhdGlvbj8uRW5hYmxlZCkge1xuICAgICAgbWZhVHlwZXMucHVzaCgnVE9UUCcpO1xuICAgIH1cblxuICAgIGlmICh1c2VyUG9vbE1GQS5FbWFpbE1mYUNvbmZpZ3VyYXRpb24pIHtcbiAgICAgIG1mYVR5cGVzLnB1c2goJ0VNQUlMX01GQScpO1xuICAgIH1cbiAgICAvLyBzb2NpYWwgcHJvdmlkZXJzXG4gICAgY29uc3Qgc29jaWFsUHJvdmlkZXJzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGlmICh1c2VyUG9vbFByb3ZpZGVycykge1xuICAgICAgZm9yIChjb25zdCBwcm92aWRlciBvZiB1c2VyUG9vbFByb3ZpZGVycykge1xuICAgICAgICBjb25zdCBwcm92aWRlclR5cGUgPSBwcm92aWRlci5Qcm92aWRlclR5cGU7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyTmFtZSA9IHByb3ZpZGVyLlByb3ZpZGVyTmFtZTtcbiAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ0dvb2dsZScpIHtcbiAgICAgICAgICBzb2NpYWxQcm92aWRlcnMucHVzaCgnR09PR0xFJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ0ZhY2Vib29rJykge1xuICAgICAgICAgIHNvY2lhbFByb3ZpZGVycy5wdXNoKCdGQUNFQk9PSycpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdTaWduSW5XaXRoQXBwbGUnKSB7XG4gICAgICAgICAgc29jaWFsUHJvdmlkZXJzLnB1c2goJ1NJR05fSU5fV0lUSF9BUFBMRScpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdMb2dpbldpdGhBbWF6b24nKSB7XG4gICAgICAgICAgc29jaWFsUHJvdmlkZXJzLnB1c2goJ0xPR0lOX1dJVEhfQU1BWk9OJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ09JREMnICYmIHByb3ZpZGVyTmFtZSkge1xuICAgICAgICAgIHNvY2lhbFByb3ZpZGVycy5wdXNoKHByb3ZpZGVyTmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ1NBTUwnICYmIHByb3ZpZGVyTmFtZSkge1xuICAgICAgICAgIHNvY2lhbFByb3ZpZGVycy5wdXNoKHByb3ZpZGVyTmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBkb21haW5cbiAgICBjb25zdCBvYXV0aERvbWFpbiA9IHVzZXJQb29sLkN1c3RvbURvbWFpbiA/PyB1c2VyUG9vbC5Eb21haW4gPz8gJyc7XG4gICAgY29uc3QgZnVsbERvbWFpblBhdGggPSB1c2VyUG9vbC5DdXN0b21Eb21haW5cbiAgICAgID8gdXNlclBvb2wuQ3VzdG9tRG9tYWluXG4gICAgICA6IGAke29hdXRoRG9tYWlufS5hdXRoLiR7cmVnaW9ufS5hbWF6b25jb2duaXRvLmNvbWA7XG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIHNpZ251cEF0dHJpYnV0ZXM6IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICB1c2VyUG9vbC5TY2hlbWFBdHRyaWJ1dGVzPy5maWx0ZXIoXG4gICAgICAgICAgKGF0dHJpYnV0ZSkgPT4gYXR0cmlidXRlLlJlcXVpcmVkICYmIGF0dHJpYnV0ZS5OYW1lLFxuICAgICAgICApLm1hcCgoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUuTmFtZT8udG9Mb3dlckNhc2UoKSkgfHwgW10sXG4gICAgICApLFxuICAgICAgdXNlcm5hbWVBdHRyaWJ1dGVzOiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgdXNlclBvb2wuVXNlcm5hbWVBdHRyaWJ1dGVzPy5tYXAoKGF0dHJpYnV0ZSkgPT5cbiAgICAgICAgICBhdHRyaWJ1dGUudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgKSB8fCBbXSxcbiAgICAgICksXG4gICAgICB2ZXJpZmljYXRpb25NZWNoYW5pc21zOiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgdXNlclBvb2wuQXV0b1ZlcmlmaWVkQXR0cmlidXRlcyA/PyBbXSxcbiAgICAgICksXG4gICAgICBwYXNzd29yZFBvbGljeU1pbkxlbmd0aDpcbiAgICAgICAgdXNlclBvb2xQYXNzd29yZFBvbGljeS5NaW5pbXVtTGVuZ3RoID09PSB1bmRlZmluZWRcbiAgICAgICAgICA/ICcnXG4gICAgICAgICAgOiB1c2VyUG9vbFBhc3N3b3JkUG9saWN5Lk1pbmltdW1MZW5ndGgudG9TdHJpbmcoKSxcbiAgICAgIHBhc3N3b3JkUG9saWN5UmVxdWlyZW1lbnRzOiBKU09OLnN0cmluZ2lmeShyZXF1aXJlbWVudHMpLFxuICAgICAgbWZhQ29uZmlndXJhdGlvbjogdXNlclBvb2wuTWZhQ29uZmlndXJhdGlvbiA/PyAnT0ZGJyxcbiAgICAgIG1mYVR5cGVzOiBKU09OLnN0cmluZ2lmeShtZmFUeXBlcyksXG4gICAgICBzb2NpYWxQcm92aWRlcnM6IEpTT04uc3RyaW5naWZ5KHNvY2lhbFByb3ZpZGVycyksXG4gICAgICBvYXV0aENvZ25pdG9Eb21haW46IGZ1bGxEb21haW5QYXRoLFxuICAgIH07XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgLyoqXG4gICAqIFRyYW5zZm9ybXMgaWRlbnRpdHlQb29sIGluZm8gaW50byBvdXRwdXRzLlxuICAgKiBAcGFyYW0gaWRlbnRpdHlQb29sIGlkZW50aXR5IHBvb2wgZGF0YVxuICAgKiBAcmV0dXJucyBmb3JtYXR0ZWQgb3V0cHV0c1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRJZGVudGl0eVBvb2xPdXRwdXRzID0gKFxuICAgIGlkZW50aXR5UG9vbDogRGVzY3JpYmVJZGVudGl0eVBvb2xDb21tYW5kT3V0cHV0LFxuICApID0+IHtcbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOlxuICAgICAgICBpZGVudGl0eVBvb2wuQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzID09PSB0cnVlID8gJ3RydWUnIDogJ2ZhbHNlJyxcbiAgICB9O1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIC8qKlxuICAgKiBUcmFuc2Zvcm1zIHVzZXJQb29sQ2xpZW50IGluZm8gaW50byBvdXRwdXRzLlxuICAgKiBAcGFyYW0gdXNlclBvb2xDbGllbnQgdXNlclBvb2xDbGllbnQgZGF0YVxuICAgKiBAcmV0dXJucyBmb3JtYXR0ZWQgb3V0cHV0c1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbENsaWVudE91dHB1dHMgPSAodXNlclBvb2xDbGllbnQ6IFVzZXJQb29sQ2xpZW50VHlwZSkgPT4ge1xuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICBvYXV0aFNjb3BlOiBKU09OLnN0cmluZ2lmeSh1c2VyUG9vbENsaWVudC5BbGxvd2VkT0F1dGhTY29wZXMgPz8gW10pLFxuICAgICAgb2F1dGhSZWRpcmVjdFNpZ25JbjogdXNlclBvb2xDbGllbnQuQ2FsbGJhY2tVUkxzXG4gICAgICAgID8gdXNlclBvb2xDbGllbnQuQ2FsbGJhY2tVUkxzLmpvaW4oJywnKVxuICAgICAgICA6ICcnLFxuICAgICAgb2F1dGhSZWRpcmVjdFNpZ25PdXQ6IHVzZXJQb29sQ2xpZW50LkxvZ291dFVSTHNcbiAgICAgICAgPyB1c2VyUG9vbENsaWVudC5Mb2dvdXRVUkxzLmpvaW4oJywnKVxuICAgICAgICA6ICcnLFxuICAgICAgb2F1dGhSZXNwb25zZVR5cGU6IHVzZXJQb29sQ2xpZW50LkFsbG93ZWRPQXV0aEZsb3dzXG4gICAgICAgID8gdXNlclBvb2xDbGllbnQuQWxsb3dlZE9BdXRoRmxvd3Muam9pbignLCcpXG4gICAgICAgIDogJycsXG4gICAgICBvYXV0aENsaWVudElkOiB1c2VyUG9vbENsaWVudC5DbGllbnRJZCxcbiAgICB9O1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xufVxuXG4vKipcbiAqIEVudHJ5IHBvaW50IGZvciB0aGUgbGFtYmRhLWJhY2tlbmQgY3VzdG9tIHJlc291cmNlIHRvIHJldHJpZXZlIGF1dGggb3V0cHV0cy5cbiAqL1xuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQsXG4pOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VSZXNwb25zZT4gPT4ge1xuICBjb25zdCBpbml0aWFsaXplciA9IG5ldyBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXIoXG4gICAgbmV3IENvZ25pdG9JZGVudGl0eUNsaWVudCgpLFxuICAgIG5ldyBDb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudCgpLFxuICAgIHJhbmRvbVVVSUQsXG4gICk7XG4gIHJldHVybiBpbml0aWFsaXplci5oYW5kbGVFdmVudChldmVudCk7XG59O1xuIl19