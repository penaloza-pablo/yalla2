/**
 * Translate an Auth factory's loginWith to its Auth construct counterpart. Backend secret fields will be resolved
 * to an CFN token and map to the required construct type. Note that not all construct secret fields are of sdk
 * SecretValue type, many are (wrongly) of type string as well.
 */
export const translateToAuthConstructLoginWith = (authFactoryLoginWith, backendSecretResolver) => {
    const result = authFactoryLoginWith;
    if (authFactoryLoginWith.webAuthn !== undefined) {
        if (authFactoryLoginWith.webAuthn === true) {
            result.webAuthn = {
                relyingPartyId: 'AUTO',
                userVerification: 'preferred',
            };
        }
        else {
            result.webAuthn = {
                relyingPartyId: authFactoryLoginWith.webAuthn.relyingPartyId ?? 'AUTO',
                userVerification: authFactoryLoginWith.webAuthn.userVerification ?? 'preferred',
            };
        }
    }
    if (!authFactoryLoginWith.externalProviders) {
        return result;
    }
    const externalProviders = authFactoryLoginWith.externalProviders;
    result.externalProviders = {
        ...externalProviders,
    };
    const amazonProps = translateAmazonProps(backendSecretResolver, externalProviders.loginWithAmazon);
    if (amazonProps) {
        result.externalProviders.loginWithAmazon = amazonProps;
    }
    const appleProps = translateAppleProps(backendSecretResolver, externalProviders.signInWithApple);
    if (appleProps) {
        result.externalProviders.signInWithApple = appleProps;
    }
    const facebookProps = translateFacebookProps(backendSecretResolver, externalProviders.facebook);
    if (facebookProps) {
        result.externalProviders.facebook = facebookProps;
    }
    const oidcProps = translateOidcProps(backendSecretResolver, externalProviders.oidc);
    if (oidcProps) {
        result.externalProviders.oidc = oidcProps;
    }
    const googleProps = translateGoogleProps(backendSecretResolver, externalProviders.google);
    if (googleProps) {
        result.externalProviders.google = googleProps;
    }
    return result;
};
/**
 * Translates the senders property from AmplifyAuthProps to AuthProps format.
 * @param senders - The senders object from AmplifyAuthProps.
 * @param getInstanceProps - Properties used to get an instance of the sender.
 * @returns The translated senders object in AuthProps format, or undefined if no valid sender is provided.
 * @description
 * This function handles the translation of the 'senders' property, specifically for email and sms senders.
 * If no senders are provided, it returns undefined.
 * If a sender has a 'getInstance' method, it retrieves the Lambda function and returns it.
 * Otherwise, it returns the sender as is.
 */
export const translateToAuthConstructSenders = (senders, getInstanceProps) => {
    if (!senders || !(senders.email || senders.sms)) {
        return undefined;
    }
    const authConstructSenders = {};
    // Handle CustomEmailSender type
    if (senders.email && 'handler' in senders.email) {
        const lambda = 'getInstance' in senders.email.handler
            ? senders.email.handler.getInstance(getInstanceProps).resources.lambda
            : senders.email.handler;
        authConstructSenders.email = {
            handler: lambda,
            kmsKeyArn: senders.email.kmsKeyArn,
        };
    }
    else if (senders.email && 'fromEmail' in senders.email) {
        // Handle SES configuration
        authConstructSenders.email = { ...senders.email };
    }
    // Handle CustomSmsSender type
    if (senders.sms && 'handler' in senders.sms) {
        const lambda = 'getInstance' in senders.sms.handler
            ? senders.sms.handler.getInstance(getInstanceProps).resources.lambda
            : senders.sms.handler;
        authConstructSenders.sms = {
            handler: lambda,
            kmsKeyArn: senders.sms.kmsKeyArn,
        };
    }
    else if (senders.sms) {
        // Handle SNS configuration
        authConstructSenders.sms = { ...senders.sms };
    }
    return authConstructSenders;
};
const translateAmazonProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateAppleProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, teamId, keyId, privateKey, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        teamId: backendSecretResolver.resolveSecret(teamId).unsafeUnwrap(),
        keyId: backendSecretResolver.resolveSecret(keyId).unsafeUnwrap(),
        privateKey: backendSecretResolver.resolveSecret(privateKey).unsafeUnwrap(),
    };
};
const translateFacebookProps = (backendSecretResolver, facebookProviderProps) => {
    if (!facebookProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = facebookProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateOidcProps = (backendSecretResolver, oidcProviderProps) => {
    if (!oidcProviderProps || oidcProviderProps.length === 0) {
        return undefined;
    }
    const result = [];
    for (const provider of oidcProviderProps) {
        const { clientId, clientSecret, ...noSecretProps } = provider;
        result.push({
            ...noSecretProps,
            clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
            clientSecret: backendSecretResolver
                .resolveSecret(clientSecret)
                .unsafeUnwrap(),
        });
    }
    return result;
};
const translateGoogleProps = (backendSecretResolver, googleProviderProps) => {
    if (!googleProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret: clientSecretValue, ...noSecretProps } = googleProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver.resolveSecret(clientSecretValue),
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRlX2F1dGhfcHJvcHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdHJhbnNsYXRlX2F1dGhfcHJvcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBd0JBOzs7O0dBSUc7QUFDSCxNQUFNLENBQUMsTUFBTSxpQ0FBaUMsR0FBRyxDQUMvQyxvQkFBK0MsRUFDL0MscUJBQTRDLEVBQ3BCLEVBQUU7SUFDMUIsTUFBTSxNQUFNLEdBQ1Ysb0JBQThDLENBQUM7SUFFakQsSUFBSSxvQkFBb0IsQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDaEQsSUFBSSxvQkFBb0IsQ0FBQyxRQUFRLEtBQUssSUFBSSxFQUFFLENBQUM7WUFDM0MsTUFBTSxDQUFDLFFBQVEsR0FBRztnQkFDaEIsY0FBYyxFQUFFLE1BQU07Z0JBQ3RCLGdCQUFnQixFQUFFLFdBQVc7YUFDOUIsQ0FBQztRQUNKLENBQUM7YUFBTSxDQUFDO1lBQ04sTUFBTSxDQUFDLFFBQVEsR0FBRztnQkFDaEIsY0FBYyxFQUFFLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxjQUFjLElBQUksTUFBTTtnQkFDdEUsZ0JBQWdCLEVBQ2Qsb0JBQW9CLENBQUMsUUFBUSxDQUFDLGdCQUFnQixJQUFJLFdBQVc7YUFDaEUsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBRUQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDNUMsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVELE1BQU0saUJBQWlCLEdBQUcsb0JBQW9CLENBQUMsaUJBQWlCLENBQUM7SUFDakUsTUFBTSxDQUFDLGlCQUFpQixHQUFHO1FBQ3pCLEdBQUksaUJBQXlEO0tBQzlELENBQUM7SUFFRixNQUFNLFdBQVcsR0FBRyxvQkFBb0IsQ0FDdEMscUJBQXFCLEVBQ3JCLGlCQUFpQixDQUFDLGVBQWUsQ0FDbEMsQ0FBQztJQUNGLElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsTUFB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QUNWLEdBQUcsYUFBYTtZQUNoQixRQUFRLEVBQUUscUJBQXFCLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFlBQVksRUFBRTtZQUN0RSxZQUFZLEVBQUUscUJBQXFCO2lCQUNoQyxhQUFhLENBQUMsWUFBWSxDQUFDO2lCQUMzQixZQUFZLEVBQUU7U0FDbEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQUVGLE1BQU0sb0JBQW9CLEdBQUcsQ0FDM0IscUJBQTRDLEVBQzVDLG1CQUFnRCxFQUNmLEVBQUU7SUFDbkMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDekIsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVELE1BQU0sRUFDSixRQUFRLEVBQ1IsWUFBWSxFQUFFLGlCQUFpQixFQUMvQixHQUFHLGFBQWEsRUFDakIsR0FBRyxtQkFBbUIsQ0FBQztJQUN4QixPQUFPO1FBQ0wsR0FBRyxhQUFhO1FBQ2hCLFFBQVEsRUFBRSxxQkFBcUIsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsWUFBWSxFQUFFO1FBQ3RFLFlBQVksRUFBRSxxQkFBcUIsQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUM7S0FDckUsQ0FBQztBQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFtYXpvblByb3ZpZGVyUHJvcHMsXG4gIEFwcGxlUHJvdmlkZXJQcm9wcyxcbiAgQXV0aFByb3BzLFxuICBGYWNlYm9va1Byb3ZpZGVyUHJvcHMsXG4gIEdvb2dsZVByb3ZpZGVyUHJvcHMsXG4gIE9pZGNQcm92aWRlclByb3BzLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYXV0aC1jb25zdHJ1Y3QnO1xuaW1wb3J0IHtcbiAgQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBBbWF6b25Qcm92aWRlckZhY3RvcnlQcm9wcyxcbiAgQXBwbGVQcm92aWRlckZhY3RvcnlQcm9wcyxcbiAgQXV0aExvZ2luV2l0aEZhY3RvcnlQcm9wcyxcbiAgRXh0ZXJuYWxQcm92aWRlckdlbmVyYWxGYWN0b3J5UHJvcHMsXG4gIEZhY2Vib29rUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4gIEdvb2dsZVByb3ZpZGVyRmFjdG9yeVByb3BzLFxuICBPaWRjUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG59IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgSUZ1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBBbXBsaWZ5QXV0aFByb3BzIH0gZnJvbSAnLi9mYWN0b3J5LmpzJztcblxuLyoqXG4gKiBUcmFuc2xhdGUgYW4gQXV0aCBmYWN0b3J5J3MgbG9naW5XaXRoIHRvIGl0cyBBdXRoIGNvbnN0cnVjdCBjb3VudGVycGFydC4gQmFja2VuZCBzZWNyZXQgZmllbGRzIHdpbGwgYmUgcmVzb2x2ZWRcbiAqIHRvIGFuIENGTiB0b2tlbiBhbmQgbWFwIHRvIHRoZSByZXF1aXJlZCBjb25zdHJ1Y3QgdHlwZS4gTm90ZSB0aGF0IG5vdCBhbGwgY29uc3RydWN0IHNlY3JldCBmaWVsZHMgYXJlIG9mIHNka1xuICogU2VjcmV0VmFsdWUgdHlwZSwgbWFueSBhcmUgKHdyb25nbHkpIG9mIHR5cGUgc3RyaW5nIGFzIHdlbGwuXG4gKi9cbmV4cG9ydCBjb25zdCB0cmFuc2xhdGVUb0F1dGhDb25zdHJ1Y3RMb2dpbldpdGggPSAoXG4gIGF1dGhGYWN0b3J5TG9naW5XaXRoOiBBdXRoTG9naW5XaXRoRmFjdG9yeVByb3BzLFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbik6IEF1dGhQcm9wc1snbG9naW5XaXRoJ10gPT4ge1xuICBjb25zdCByZXN1bHQ6IEF1dGhQcm9wc1snbG9naW5XaXRoJ10gPVxuICAgIGF1dGhGYWN0b3J5TG9naW5XaXRoIGFzIEF1dGhQcm9wc1snbG9naW5XaXRoJ107XG5cbiAgaWYgKGF1dGhGYWN0b3J5TG9naW5XaXRoLndlYkF1dGhuICE9PSB1bmRlZmluZWQpIHtcbiAgICBpZiAoYXV0aEZhY3RvcnlMb2dpbldpdGgud2ViQXV0aG4gPT09IHRydWUpIHtcbiAgICAgIHJlc3VsdC53ZWJBdXRobiA9IHtcbiAgICAgICAgcmVseWluZ1BhcnR5SWQ6ICdBVVRPJyxcbiAgICAgICAgdXNlclZlcmlmaWNhdGlvbjogJ3ByZWZlcnJlZCcsXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQud2ViQXV0aG4gPSB7XG4gICAgICAgIHJlbHlpbmdQYXJ0eUlkOiBhdXRoRmFjdG9yeUxvZ2luV2l0aC53ZWJBdXRobi5yZWx5aW5nUGFydHlJZCA/PyAnQVVUTycsXG4gICAgICAgIHVzZXJWZXJpZmljYXRpb246XG4gICAgICAgICAgYXV0aEZhY3RvcnlMb2dpbldpdGgud2ViQXV0aG4udXNlclZlcmlmaWNhdGlvbiA/PyAncHJlZmVycmVkJyxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgaWYgKCFhdXRoRmFjdG9yeUxvZ2luV2l0aC5leHRlcm5hbFByb3ZpZGVycykge1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBjb25zdCBleHRlcm5hbFByb3ZpZGVycyA9IGF1dGhGYWN0b3J5TG9naW5XaXRoLmV4dGVybmFsUHJvdmlkZXJzO1xuICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMgPSB7XG4gICAgLi4uKGV4dGVybmFsUHJvdmlkZXJzIGFzIEV4dGVybmFsUHJvdmlkZXJHZW5lcmFsRmFjdG9yeVByb3BzKSxcbiAgfTtcblxuICBjb25zdCBhbWF6b25Qcm9wcyA9IHRyYW5zbGF0ZUFtYXpvblByb3BzKFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBleHRlcm5hbFByb3ZpZGVycy5sb2dpbldpdGhBbWF6b24sXG4gICk7XG4gIGlmIChhbWF6b25Qcm9wcykge1xuICAgIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycy5sb2dpbldpdGhBbWF6b24gPSBhbWF6b25Qcm9wcztcbiAgfVxuXG4gIGNvbnN0IGFwcGxlUHJvcHMgPSB0cmFuc2xhdGVBcHBsZVByb3BzKFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBleHRlcm5hbFByb3ZpZGVycy5zaWduSW5XaXRoQXBwbGUsXG4gICk7XG4gIGlmIChhcHBsZVByb3BzKSB7XG4gICAgcmVzdWx0LmV4dGVybmFsUHJvdmlkZXJzLnNpZ25JbldpdGhBcHBsZSA9IGFwcGxlUHJvcHM7XG4gIH1cblxuICBjb25zdCBmYWNlYm9va1Byb3BzID0gdHJhbnNsYXRlRmFjZWJvb2tQcm9wcyhcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgZXh0ZXJuYWxQcm92aWRlcnMuZmFjZWJvb2ssXG4gICk7XG4gIGlmIChmYWNlYm9va1Byb3BzKSB7XG4gICAgcmVzdWx0LmV4dGVybmFsUHJvdmlkZXJzLmZhY2Vib29rID0gZmFjZWJvb2tQcm9wcztcbiAgfVxuXG4gIGNvbnN0IG9pZGNQcm9wcyA9IHRyYW5zbGF0ZU9pZGNQcm9wcyhcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgZXh0ZXJuYWxQcm92aWRlcnMub2lkYyxcbiAgKTtcbiAgaWYgKG9pZGNQcm9wcykge1xuICAgIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycy5vaWRjID0gb2lkY1Byb3BzO1xuICB9XG5cbiAgY29uc3QgZ29vZ2xlUHJvcHMgPSB0cmFuc2xhdGVHb29nbGVQcm9wcyhcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgZXh0ZXJuYWxQcm92aWRlcnMuZ29vZ2xlLFxuICApO1xuICBpZiAoZ29vZ2xlUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMuZ29vZ2xlID0gZ29vZ2xlUHJvcHM7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcbi8qKlxuICogVHJhbnNsYXRlcyB0aGUgc2VuZGVycyBwcm9wZXJ0eSBmcm9tIEFtcGxpZnlBdXRoUHJvcHMgdG8gQXV0aFByb3BzIGZvcm1hdC5cbiAqIEBwYXJhbSBzZW5kZXJzIC0gVGhlIHNlbmRlcnMgb2JqZWN0IGZyb20gQW1wbGlmeUF1dGhQcm9wcy5cbiAqIEBwYXJhbSBnZXRJbnN0YW5jZVByb3BzIC0gUHJvcGVydGllcyB1c2VkIHRvIGdldCBhbiBpbnN0YW5jZSBvZiB0aGUgc2VuZGVyLlxuICogQHJldHVybnMgVGhlIHRyYW5zbGF0ZWQgc2VuZGVycyBvYmplY3QgaW4gQXV0aFByb3BzIGZvcm1hdCwgb3IgdW5kZWZpbmVkIGlmIG5vIHZhbGlkIHNlbmRlciBpcyBwcm92aWRlZC5cbiAqIEBkZXNjcmlwdGlvblxuICogVGhpcyBmdW5jdGlvbiBoYW5kbGVzIHRoZSB0cmFuc2xhdGlvbiBvZiB0aGUgJ3NlbmRlcnMnIHByb3BlcnR5LCBzcGVjaWZpY2FsbHkgZm9yIGVtYWlsIGFuZCBzbXMgc2VuZGVycy5cbiAqIElmIG5vIHNlbmRlcnMgYXJlIHByb3ZpZGVkLCBpdCByZXR1cm5zIHVuZGVmaW5lZC5cbiAqIElmIGEgc2VuZGVyIGhhcyBhICdnZXRJbnN0YW5jZScgbWV0aG9kLCBpdCByZXRyaWV2ZXMgdGhlIExhbWJkYSBmdW5jdGlvbiBhbmQgcmV0dXJucyBpdC5cbiAqIE90aGVyd2lzZSwgaXQgcmV0dXJucyB0aGUgc2VuZGVyIGFzIGlzLlxuICovXG5leHBvcnQgY29uc3QgdHJhbnNsYXRlVG9BdXRoQ29uc3RydWN0U2VuZGVycyA9IChcbiAgc2VuZGVyczogQW1wbGlmeUF1dGhQcm9wc1snc2VuZGVycyddIHwgdW5kZWZpbmVkLFxuICBnZXRJbnN0YW5jZVByb3BzOiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbik6IEF1dGhQcm9wc1snc2VuZGVycyddIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFzZW5kZXJzIHx8ICEoc2VuZGVycy5lbWFpbCB8fCBzZW5kZXJzLnNtcykpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgYXV0aENvbnN0cnVjdFNlbmRlcnM6IEF1dGhQcm9wc1snc2VuZGVycyddID0ge307XG5cbiAgLy8gSGFuZGxlIEN1c3RvbUVtYWlsU2VuZGVyIHR5cGVcbiAgaWYgKHNlbmRlcnMuZW1haWwgJiYgJ2hhbmRsZXInIGluIHNlbmRlcnMuZW1haWwpIHtcbiAgICBjb25zdCBsYW1iZGE6IElGdW5jdGlvbiA9XG4gICAgICAnZ2V0SW5zdGFuY2UnIGluIHNlbmRlcnMuZW1haWwuaGFuZGxlclxuICAgICAgICA/IHNlbmRlcnMuZW1haWwuaGFuZGxlci5nZXRJbnN0YW5jZShnZXRJbnN0YW5jZVByb3BzKS5yZXNvdXJjZXMubGFtYmRhXG4gICAgICAgIDogc2VuZGVycy5lbWFpbC5oYW5kbGVyO1xuXG4gICAgYXV0aENvbnN0cnVjdFNlbmRlcnMuZW1haWwgPSB7XG4gICAgICBoYW5kbGVyOiBsYW1iZGEsXG4gICAgICBrbXNLZXlBcm46IHNlbmRlcnMuZW1haWwua21zS2V5QXJuLFxuICAgIH07XG4gIH0gZWxzZSBpZiAoc2VuZGVycy5lbWFpbCAmJiAnZnJvbUVtYWlsJyBpbiBzZW5kZXJzLmVtYWlsKSB7XG4gICAgLy8gSGFuZGxlIFNFUyBjb25maWd1cmF0aW9uXG4gICAgYXV0aENvbnN0cnVjdFNlbmRlcnMuZW1haWwgPSB7IC4uLnNlbmRlcnMuZW1haWwgfTtcbiAgfVxuXG4gIC8vIEhhbmRsZSBDdXN0b21TbXNTZW5kZXIgdHlwZVxuICBpZiAoc2VuZGVycy5zbXMgJiYgJ2hhbmRsZXInIGluIHNlbmRlcnMuc21zKSB7XG4gICAgY29uc3QgbGFtYmRhOiBJRnVuY3Rpb24gPVxuICAgICAgJ2dldEluc3RhbmNlJyBpbiBzZW5kZXJzLnNtcy5oYW5kbGVyXG4gICAgICAgID8gc2VuZGVycy5zbXMuaGFuZGxlci5nZXRJbnN0YW5jZShnZXRJbnN0YW5jZVByb3BzKS5yZXNvdXJjZXMubGFtYmRhXG4gICAgICAgIDogc2VuZGVycy5zbXMuaGFuZGxlcjtcblxuICAgIGF1dGhDb25zdHJ1Y3RTZW5kZXJzLnNtcyA9IHtcbiAgICAgIGhhbmRsZXI6IGxhbWJkYSxcbiAgICAgIGttc0tleUFybjogc2VuZGVycy5zbXMua21zS2V5QXJuLFxuICAgIH07XG4gIH0gZWxzZSBpZiAoc2VuZGVycy5zbXMpIHtcbiAgICAvLyBIYW5kbGUgU05TIGNvbmZpZ3VyYXRpb25cbiAgICBhdXRoQ29uc3RydWN0U2VuZGVycy5zbXMgPSB7IC4uLnNlbmRlcnMuc21zIH07XG4gIH1cbiAgcmV0dXJuIGF1dGhDb25zdHJ1Y3RTZW5kZXJzO1xufTtcblxuY29uc3QgdHJhbnNsYXRlQW1hem9uUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBhbWF6b25Qcm92aWRlclByb3BzPzogQW1hem9uUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4pOiBBbWF6b25Qcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFhbWF6b25Qcm92aWRlclByb3BzKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHsgY2xpZW50SWQsIGNsaWVudFNlY3JldCwgLi4ubm9TZWNyZXRQcm9wcyB9ID0gYW1hem9uUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXJcbiAgICAgIC5yZXNvbHZlU2VjcmV0KGNsaWVudFNlY3JldClcbiAgICAgIC51bnNhZmVVbndyYXAoKSxcbiAgfTtcbn07XG5cbmNvbnN0IHRyYW5zbGF0ZUFwcGxlUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBhbWF6b25Qcm92aWRlclByb3BzPzogQXBwbGVQcm92aWRlckZhY3RvcnlQcm9wcyxcbik6IEFwcGxlUHJvdmlkZXJQcm9wcyB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmICghYW1hem9uUHJvdmlkZXJQcm9wcykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCB7IGNsaWVudElkLCB0ZWFtSWQsIGtleUlkLCBwcml2YXRlS2V5LCAuLi5ub1NlY3JldFByb3BzIH0gPVxuICAgIGFtYXpvblByb3ZpZGVyUHJvcHM7XG4gIHJldHVybiB7XG4gICAgLi4ubm9TZWNyZXRQcm9wcyxcbiAgICBjbGllbnRJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIHRlYW1JZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQodGVhbUlkKS51bnNhZmVVbndyYXAoKSxcbiAgICBrZXlJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoa2V5SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIHByaXZhdGVLZXk6IGJhY2tlbmRTZWNyZXRSZXNvbHZlci5yZXNvbHZlU2VjcmV0KHByaXZhdGVLZXkpLnVuc2FmZVVud3JhcCgpLFxuICB9O1xufTtcblxuY29uc3QgdHJhbnNsYXRlRmFjZWJvb2tQcm9wcyA9IChcbiAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIGZhY2Vib29rUHJvdmlkZXJQcm9wcz86IEZhY2Vib29rUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4pOiBGYWNlYm9va1Byb3ZpZGVyUHJvcHMgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIWZhY2Vib29rUHJvdmlkZXJQcm9wcykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCB7IGNsaWVudElkLCBjbGllbnRTZWNyZXQsIC4uLm5vU2VjcmV0UHJvcHMgfSA9IGZhY2Vib29rUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXJcbiAgICAgIC5yZXNvbHZlU2VjcmV0KGNsaWVudFNlY3JldClcbiAgICAgIC51bnNhZmVVbndyYXAoKSxcbiAgfTtcbn07XG5cbmNvbnN0IHRyYW5zbGF0ZU9pZGNQcm9wcyA9IChcbiAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIG9pZGNQcm92aWRlclByb3BzPzogT2lkY1Byb3ZpZGVyRmFjdG9yeVByb3BzW10sXG4pOiBPaWRjUHJvdmlkZXJQcm9wc1tdIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFvaWRjUHJvdmlkZXJQcm9wcyB8fCBvaWRjUHJvdmlkZXJQcm9wcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIGZvciAoY29uc3QgcHJvdmlkZXIgb2Ygb2lkY1Byb3ZpZGVyUHJvcHMpIHtcbiAgICBjb25zdCB7IGNsaWVudElkLCBjbGllbnRTZWNyZXQsIC4uLm5vU2VjcmV0UHJvcHMgfSA9IHByb3ZpZGVyO1xuICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgIC4uLm5vU2VjcmV0UHJvcHMsXG4gICAgICBjbGllbnRJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXJcbiAgICAgICAgLnJlc29sdmVTZWNyZXQoY2xpZW50U2VjcmV0KVxuICAgICAgICAudW5zYWZlVW53cmFwKCksXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgdHJhbnNsYXRlR29vZ2xlUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBnb29nbGVQcm92aWRlclByb3BzPzogR29vZ2xlUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4pOiBHb29nbGVQcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFnb29nbGVQcm92aWRlclByb3BzKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICBjbGllbnRJZCxcbiAgICBjbGllbnRTZWNyZXQ6IGNsaWVudFNlY3JldFZhbHVlLFxuICAgIC4uLm5vU2VjcmV0UHJvcHNcbiAgfSA9IGdvb2dsZVByb3ZpZGVyUHJvcHM7XG4gIHJldHVybiB7XG4gICAgLi4ubm9TZWNyZXRQcm9wcyxcbiAgICBjbGllbnRJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIGNsaWVudFNlY3JldDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50U2VjcmV0VmFsdWUpLFxuICB9O1xufTtcbiJdfQ==