import * as path from 'path';
import { UserPoolOperation, } from 'aws-cdk-lib/aws-cognito';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { AmplifyAuth, } from '@aws-amplify/auth-construct';
import { translateToAuthConstructLoginWith, translateToAuthConstructSenders, } from './translate_auth_props.js';
import { authAccessBuilder as _authAccessBuilder } from './access_builder.js';
import { AuthAccessPolicyArbiterFactory } from './auth_access_policy_arbiter.js';
import { UserPoolAccessPolicyFactory } from './userpool_access_policy_factory.js';
import { Stack, Tags } from 'aws-cdk-lib';
/**
 * Singleton factory for AmplifyAuth that can be used in Amplify project files.
 *
 * Exported for testing purpose only & should NOT be exported out of the package.
 */
export class AmplifyAuthFactory {
    props;
    importStack;
    // publicly accessible for testing purpose only.
    static factoryCount = 0;
    provides = 'AuthResources';
    generator;
    /**
     * Set the properties that will be used to initialize AmplifyAuth
     */
    constructor(props, 
    // eslint-disable-next-line @aws-amplify/amplify-backend-rules/prefer-amplify-errors
    importStack = new Error().stack) {
        this.props = props;
        this.importStack = importStack;
        if (AmplifyAuthFactory.factoryCount > 0) {
            throw new AmplifyUserError('MultipleSingletonResourcesError', {
                message: 'Multiple `defineAuth` or `referenceAuth` calls are not allowed within an Amplify backend',
                resolution: 'Remove all but one `defineAuth` or `referenceAuth` call',
            });
        }
        AmplifyAuthFactory.factoryCount++;
        const validationResult = validatePasswordlessConfig(props);
        if (validationResult.warnings && validationResult.warnings.length > 0) {
            process.stderr.write('\nWARNINGS:\n');
            validationResult.warnings.forEach((warning) => {
                process.stderr.write(`  â€¢ ${warning}\n`);
            });
        }
        if (!validationResult.valid) {
            throw new AmplifyUserError('InvalidPasswordlessConfigError', {
                message: 'Invalid passwordless authentication configuration',
                details: validationResult.errors.join('\n\n'),
                resolution: 'Fix the configuration errors listed above',
            });
        }
    }
    /**
     * Get a singleton instance of AmplifyAuth
     */
    getInstance = (getInstanceProps) => {
        const { constructContainer, importPathVerifier, resourceNameValidator } = getInstanceProps;
        importPathVerifier?.verify(this.importStack, path.join('amplify', 'auth', 'resource'), 'Amplify Auth must be defined in amplify/auth/resource.ts');
        if (this.props.name) {
            resourceNameValidator?.validate(this.props.name);
        }
        if (!this.generator) {
            this.generator = new AmplifyAuthGenerator(this.props, getInstanceProps);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class AmplifyAuthGenerator {
    props;
    getInstanceProps;
    authAccessBuilder;
    authAccessPolicyArbiterFactory;
    resourceGroupName = 'auth';
    name;
    constructor(props, getInstanceProps, authAccessBuilder = _authAccessBuilder, authAccessPolicyArbiterFactory = new AuthAccessPolicyArbiterFactory()) {
        this.props = props;
        this.getInstanceProps = getInstanceProps;
        this.authAccessBuilder = authAccessBuilder;
        this.authAccessPolicyArbiterFactory = authAccessPolicyArbiterFactory;
        this.name = props.name ?? 'amplifyAuth';
    }
    generateContainerEntry = ({ scope, backendSecretResolver, ssmEnvironmentEntriesGenerator, stableBackendIdentifiers, }) => {
        const authProps = {
            ...this.props,
            loginWith: translateToAuthConstructLoginWith(this.props.loginWith, backendSecretResolver),
            senders: translateToAuthConstructSenders(this.props.senders, this.getInstanceProps),
            outputStorageStrategy: this.getInstanceProps.outputStorageStrategy,
        };
        if (authProps.loginWith.externalProviders) {
            authProps.loginWith.externalProviders.domainPrefix =
                stableBackendIdentifiers.getStableBackendHash();
        }
        let authConstruct;
        try {
            authConstruct = new AmplifyAuth(scope, this.name, authProps);
        }
        catch (error) {
            throw new AmplifyUserError('AmplifyAuthConstructInitializationError', {
                message: 'Failed to instantiate auth construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(authConstruct).add(TagName.FRIENDLY_NAME, this.name);
        Object.entries(this.props.triggers || {}).forEach(([triggerEvent, handlerFactory]) => {
            authConstruct.resources.userPool.addTrigger(UserPoolOperation.of(triggerEvent), handlerFactory.getInstance(this.getInstanceProps).resources.lambda);
        });
        const authConstructMixin = {
            ...authConstruct,
            /**
             * Returns a resourceAccessAcceptor for the given role
             * @param roleIdentifier Either the auth or unauth role name or the name of a UserPool group
             */
            getResourceAccessAcceptor: (roleIdentifier) => ({
                identifier: `${roleIdentifier}ResourceAccessAcceptor`,
                acceptResourceAccess: (policy) => {
                    const role = roleNameIsAuthRoleName(roleIdentifier)
                        ? authConstruct.resources[roleIdentifier]
                        : authConstruct.resources.groups?.[roleIdentifier]?.role;
                    if (!role) {
                        throw new AmplifyUserError('InvalidResourceAccessConfigError', {
                            message: `No auth IAM role found for "${roleIdentifier}".`,
                            resolution: `If you are trying to configure UserPool group access, ensure that the group name is specified correctly.`,
                        });
                    }
                    policy.attachToRole(role);
                },
            }),
            stack: Stack.of(authConstruct),
        };
        if (!this.props.access) {
            return authConstructMixin;
        }
        // props.access is the access callback defined by the customer
        // here we inject the authAccessBuilder into the callback and run it
        // this produces the access definition that will be used to create the auth access policies
        const accessDefinition = this.props.access(this.authAccessBuilder);
        const ssmEnvironmentEntries = ssmEnvironmentEntriesGenerator.generateSsmEnvironmentEntries({
            [`${this.name}_USERPOOL_ID`]: authConstructMixin.resources.userPool.userPoolId,
        });
        const authPolicyArbiter = this.authAccessPolicyArbiterFactory.getInstance(accessDefinition, this.getInstanceProps, ssmEnvironmentEntries, new UserPoolAccessPolicyFactory(authConstruct.resources.userPool));
        authPolicyArbiter.arbitratePolicies();
        return authConstructMixin;
    };
}
const roleNameIsAuthRoleName = (roleName) => {
    return (roleName === 'authenticatedUserIamRole' ||
        roleName === 'unauthenticatedUserIamRole');
};
/**
 * Validates the format of a WebAuthn relying party ID.
 * @param relyingPartyId - The relying party ID to validate
 * @returns Error message if invalid, undefined if valid
 */
const validateRelyingPartyId = (relyingPartyId) => {
    if (relyingPartyId === 'AUTO' || relyingPartyId === 'localhost') {
        return undefined;
    }
    if (relyingPartyId.includes('://')) {
        return `Invalid relying party ID: "${relyingPartyId}". Must be a valid domain without protocol (e.g., "example.com"), "localhost" for development, or "AUTO" for Amplify Hosting.

Examples:
  - Valid: "example.com", "app.example.com", "localhost", "AUTO"
  - Invalid: "http://example.com", "https://example.com"`;
    }
    // Must contain at least one dot or be a single word (for local domains)
    const domainPattern = /^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?)*$/;
    if (!domainPattern.test(relyingPartyId)) {
        return `Invalid relying party ID: "${relyingPartyId}". Must be a valid domain format.

Examples:
  - Valid: "example.com", "app.example.com", "localhost", "AUTO"
  - Invalid: "example", "192.168.1.1", "my app.com"`;
    }
    return undefined;
};
/**
 * Validates passwordless authentication configuration.
 * @param props - The auth configuration props to validate
 * @returns Validation result with errors and warnings
 */
const validatePasswordlessConfig = (props) => {
    const errors = [];
    const warnings = [];
    const { loginWith, multifactor } = props;
    const emailEnabled = !!loginWith.email;
    const phoneEnabled = !!loginWith.phone;
    const emailOtpEnabled = typeof loginWith.email === 'object' && loginWith.email.otpLogin === true;
    const smsOtpEnabled = typeof loginWith.phone === 'object' && loginWith.phone.otpLogin === true;
    const webAuthnEnabled = !!loginWith.webAuthn;
    let webAuthnRelyingPartyId;
    if (webAuthnEnabled && typeof loginWith.webAuthn === 'object') {
        webAuthnRelyingPartyId = loginWith.webAuthn.relyingPartyId;
    }
    const anyPasswordlessEnabled = emailOtpEnabled || smsOtpEnabled || webAuthnEnabled;
    if (!emailEnabled && !phoneEnabled && !loginWith.externalProviders) {
        errors.push('At least one authentication method must be enabled. Configure email, phone, or external providers in loginWith.');
    }
    if (webAuthnEnabled && !emailEnabled && !phoneEnabled) {
        errors.push(`Passkeys (WebAuthn) require at least one sign-up method (email or phone).

Email OTP and SMS OTP are valid passwordless sign-up methods.
Passkeys can only be registered after initial account creation.

Resolution: Add email or phone to loginWith configuration.`);
    }
    if (webAuthnEnabled && webAuthnRelyingPartyId) {
        const relyingPartyIdError = validateRelyingPartyId(webAuthnRelyingPartyId);
        if (relyingPartyIdError) {
            errors.push(relyingPartyIdError);
        }
        else if (webAuthnRelyingPartyId !== 'AUTO' &&
            webAuthnRelyingPartyId !== 'localhost') {
            // Warning about immutability for custom domains
            warnings.push(`WebAuthn relying party ID is set to "${webAuthnRelyingPartyId}". Changing this value after deployment will invalidate all existing passkeys. Users will need to re-register their passkeys.`);
        }
    }
    if (anyPasswordlessEnabled && multifactor?.mode === 'REQUIRED') {
        errors.push(`Passwordless authentication (Email OTP, SMS OTP, WebAuthn) cannot be used when MFA is set to REQUIRED. Amazon Cognito does not support combining MFA with passwordless authentication methods.

Resolution: Choose either passwordless authentication or MFA, not both.
Note: WebAuthn passkeys with user verification can provide similar security to MFA without requiring separate MFA configuration.`);
    }
    return {
        valid: errors.length === 0,
        errors,
        warnings: warnings.length > 0 ? warnings : undefined,
    };
};
/**
 * Provide the settings that will be used for authentication.
 */
export const defineAuth = (props) => 
// eslint-disable-next-line @aws-amplify/amplify-backend-rules/prefer-amplify-errors
new AmplifyAuthFactory(props, new Error().stack);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBRTdCLE9BQU8sRUFFTCxpQkFBaUIsR0FFbEIsTUFBTSx5QkFBeUIsQ0FBQztBQUNqQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDdkUsT0FBTyxFQUNMLFdBQVcsR0FJWixNQUFNLDZCQUE2QixDQUFDO0FBZXJDLE9BQU8sRUFDTCxpQ0FBaUMsRUFDakMsK0JBQStCLEdBQ2hDLE1BQU0sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUFFLGlCQUFpQixJQUFJLGtCQUFrQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFRakYsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDbEYsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUEyQzFDOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sa0JBQWtCO0lBWVY7SUFFQTtJQWJuQixnREFBZ0Q7SUFDaEQsTUFBTSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUM7SUFFZixRQUFRLEdBQUcsZUFBZSxDQUFDO0lBRTVCLFNBQVMsQ0FBbUM7SUFFcEQ7O09BRUc7SUFDSCxZQUNtQixLQUF1QjtJQUN4QyxvRkFBb0Y7SUFDbkUsY0FBYyxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUs7UUFGL0IsVUFBSyxHQUFMLEtBQUssQ0FBa0I7UUFFdkIsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBRWhELElBQUksa0JBQWtCLENBQUMsWUFBWSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3hDLE1BQU0sSUFBSSxnQkFBZ0IsQ0FBQyxpQ0FBaUMsRUFBRTtnQkFDNUQsT0FBTyxFQUNMLDBGQUEwRjtnQkFDNUYsVUFBVSxFQUFFLHlEQUF5RDthQUN0RSxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQ0Qsa0JBQWtCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFbEMsTUFBTSxnQkFBZ0IsR0FBRywwQkFBMEIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUUzRCxJQUFJLGdCQUFnQixDQUFDLFFBQVEsSUFBSSxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3RFLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3RDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDNUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxPQUFPLElBQUksQ0FBQyxDQUFDO1lBQzNDLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUM1QixNQUFNLElBQUksZ0JBQWdCLENBQUMsZ0NBQWdDLEVBQUU7Z0JBQzNELE9BQU8sRUFBRSxtREFBbUQ7Z0JBQzVELE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDN0MsVUFBVSxFQUFFLDJDQUEyQzthQUN4RCxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsV0FBVyxHQUFHLENBQ1osZ0JBQWtELEVBQ3JDLEVBQUU7UUFDZixNQUFNLEVBQUUsa0JBQWtCLEVBQUUsa0JBQWtCLEVBQUUscUJBQXFCLEVBQUUsR0FDckUsZ0JBQWdCLENBQUM7UUFDbkIsa0JBQWtCLEVBQUUsTUFBTSxDQUN4QixJQUFJLENBQUMsV0FBVyxFQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxNQUFNLEVBQUUsVUFBVSxDQUFDLEVBQ3hDLDBEQUEwRCxDQUMzRCxDQUFDO1FBQ0YsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3BCLHFCQUFxQixFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25ELENBQUM7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3BCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDMUUsQ0FBQztRQUNELE9BQU8sa0JBQWtCLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQWdCLENBQUM7SUFDeEUsQ0FBQyxDQUFDOztBQUdKLE1BQU0sb0JBQW9CO0lBS0w7SUFDQTtJQUNBO0lBQ0E7SUFQVixpQkFBaUIsR0FBNkIsTUFBTSxDQUFDO0lBQzdDLElBQUksQ0FBUztJQUU5QixZQUNtQixLQUF1QixFQUN2QixnQkFBa0QsRUFDbEQsb0JBQW9CLGtCQUFrQixFQUN0QyxpQ0FBaUMsSUFBSSw4QkFBOEIsRUFBRTtRQUhyRSxVQUFLLEdBQUwsS0FBSyxDQUFrQjtRQUN2QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtDO1FBQ2xELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBcUI7UUFDdEMsbUNBQThCLEdBQTlCLDhCQUE4QixDQUF1QztRQUV0RixJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLElBQUksYUFBYSxDQUFDO0lBQzFDLENBQUM7SUFFRCxzQkFBc0IsR0FBRyxDQUFDLEVBQ3hCLEtBQUssRUFDTCxxQkFBcUIsRUFDckIsOEJBQThCLEVBQzlCLHdCQUF3QixHQUNJLEVBQUUsRUFBRTtRQUNoQyxNQUFNLFNBQVMsR0FBYztZQUMzQixHQUFHLElBQUksQ0FBQyxLQUFLO1lBQ2IsU0FBUyxFQUFFLGlDQUFpQyxDQUMxQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFDcEIscUJBQXFCLENBQ3RCO1lBQ0QsT0FBTyxFQUFFLCtCQUErQixDQUN0QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFDbEIsSUFBSSxDQUFDLGdCQUFnQixDQUN0QjtZQUNELHFCQUFxQixFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxxQkFBcUI7U0FDbkUsQ0FBQztRQUNGLElBQUksU0FBUyxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBQzFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsWUFBWTtnQkFDaEQsd0JBQXdCLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUNwRCxDQUFDO1FBRUQsSUFBSSxhQUEwQixDQUFDO1FBQy9CLElBQUksQ0FBQztZQUNILGFBQWEsR0FBRyxJQUFJLFdBQVcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztRQUMvRCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIseUNBQXlDLEVBQ3pDO2dCQUNFLE9BQU8sRUFBRSxzQ0FBc0M7Z0JBQy9DLFVBQVUsRUFBRSxvREFBb0Q7YUFDakUsRUFDRCxLQUFjLENBQ2YsQ0FBQztRQUNKLENBQUM7UUFFRCxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3RCxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FDL0MsQ0FBQyxDQUFDLFlBQVksRUFBRSxjQUFjLENBQUMsRUFBRSxFQUFFO1lBQ2hDLGFBQWEsQ0FBQyxTQUFTLENBQUMsUUFBcUIsQ0FBQyxVQUFVLENBQ3ZELGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsRUFDbEMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUNuRSxDQUFDO1FBQ0osQ0FBQyxDQUNGLENBQUM7UUFFRixNQUFNLGtCQUFrQixHQUFnQjtZQUN0QyxHQUFHLGFBQWE7WUFDaEI7OztlQUdHO1lBQ0gseUJBQXlCLEVBQUUsQ0FDekIsY0FBcUMsRUFDYixFQUFFLENBQUMsQ0FBQztnQkFDNUIsVUFBVSxFQUFFLEdBQUcsY0FBYyx3QkFBd0I7Z0JBQ3JELG9CQUFvQixFQUFFLENBQUMsTUFBYyxFQUFFLEVBQUU7b0JBQ3ZDLE1BQU0sSUFBSSxHQUFHLHNCQUFzQixDQUFDLGNBQWMsQ0FBQzt3QkFDakQsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDO3dCQUN6QyxDQUFDLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxjQUFjLENBQUMsRUFBRSxJQUFJLENBQUM7b0JBQzNELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQzt3QkFDVixNQUFNLElBQUksZ0JBQWdCLENBQUMsa0NBQWtDLEVBQUU7NEJBQzdELE9BQU8sRUFBRSwrQkFBK0IsY0FBYyxJQUFJOzRCQUMxRCxVQUFVLEVBQUUsMEdBQTBHO3lCQUN2SCxDQUFDLENBQUM7b0JBQ0wsQ0FBQztvQkFDRCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUM1QixDQUFDO2FBQ0YsQ0FBQztZQUNGLEtBQUssRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQztTQUMvQixDQUFDO1FBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDdkIsT0FBTyxrQkFBa0IsQ0FBQztRQUM1QixDQUFDO1FBQ0QsOERBQThEO1FBQzlELG9FQUFvRTtRQUNwRSwyRkFBMkY7UUFDM0YsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUVuRSxNQUFNLHFCQUFxQixHQUN6Qiw4QkFBOEIsQ0FBQyw2QkFBNkIsQ0FBQztZQUMzRCxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksY0FBYyxDQUFDLEVBQzFCLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsVUFBVTtTQUNuRCxDQUFDLENBQUM7UUFFTCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxXQUFXLENBQ3ZFLGdCQUFnQixFQUNoQixJQUFJLENBQUMsZ0JBQWdCLEVBQ3JCLHFCQUFxQixFQUNyQixJQUFJLDJCQUEyQixDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQ2xFLENBQUM7UUFFRixpQkFBaUIsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBRXRDLE9BQU8sa0JBQWtCLENBQUM7SUFDNUIsQ0FBQyxDQUFDO0NBQ0g7QUFFRCxNQUFNLHNCQUFzQixHQUFHLENBQUMsUUFBZ0IsRUFBNEIsRUFBRTtJQUM1RSxPQUFPLENBQ0wsUUFBUSxLQUFLLDBCQUEwQjtRQUN2QyxRQUFRLEtBQUssNEJBQTRCLENBQzFDLENBQUM7QUFDSixDQUFDLENBQUM7QUFRRjs7OztHQUlHO0FBQ0gsTUFBTSxzQkFBc0IsR0FBRyxDQUFDLGNBQXNCLEVBQXNCLEVBQUU7SUFDNUUsSUFBSSxjQUFjLEtBQUssTUFBTSxJQUFJLGNBQWMsS0FBSyxXQUFXLEVBQUUsQ0FBQztRQUNoRSxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQsSUFBSSxjQUFjLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDbkMsT0FBTyw4QkFBOEIsY0FBYzs7Ozt5REFJRSxDQUFDO0lBQ3hELENBQUM7SUFFRCx3RUFBd0U7SUFDeEUsTUFBTSxhQUFhLEdBQ2pCLHFGQUFxRixDQUFDO0lBRXhGLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUM7UUFDeEMsT0FBTyw4QkFBOEIsY0FBYzs7OztvREFJSCxDQUFDO0lBQ25ELENBQUM7SUFFRCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDLENBQUM7QUFFRjs7OztHQUlHO0FBQ0gsTUFBTSwwQkFBMEIsR0FBRyxDQUNqQyxLQUF1QixFQUNMLEVBQUU7SUFDcEIsTUFBTSxNQUFNLEdBQWEsRUFBRSxDQUFDO0lBQzVCLE1BQU0sUUFBUSxHQUFhLEVBQUUsQ0FBQztJQUU5QixNQUFNLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxHQUFHLEtBQUssQ0FBQztJQUV6QyxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztJQUN2QyxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztJQUN2QyxNQUFNLGVBQWUsR0FDbkIsT0FBTyxTQUFTLENBQUMsS0FBSyxLQUFLLFFBQVEsSUFBSSxTQUFTLENBQUMsS0FBSyxDQUFDLFFBQVEsS0FBSyxJQUFJLENBQUM7SUFDM0UsTUFBTSxhQUFhLEdBQ2pCLE9BQU8sU0FBUyxDQUFDLEtBQUssS0FBSyxRQUFRLElBQUksU0FBUyxDQUFDLEtBQUssQ0FBQyxRQUFRLEtBQUssSUFBSSxDQUFDO0lBQzNFLE1BQU0sZUFBZSxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO0lBRTdDLElBQUksc0JBQTBDLENBQUM7SUFDL0MsSUFBSSxlQUFlLElBQUksT0FBTyxTQUFTLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQzlELHNCQUFzQixHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDO0lBQzdELENBQUM7SUFFRCxNQUFNLHNCQUFzQixHQUMxQixlQUFlLElBQUksYUFBYSxJQUFJLGVBQWUsQ0FBQztJQUV0RCxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDbkUsTUFBTSxDQUFDLElBQUksQ0FDVCxpSEFBaUgsQ0FDbEgsQ0FBQztJQUNKLENBQUM7SUFFRCxJQUFJLGVBQWUsSUFBSSxDQUFDLFlBQVksSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RELE1BQU0sQ0FBQyxJQUFJLENBQ1Q7Ozs7OzJEQUtxRCxDQUN0RCxDQUFDO0lBQ0osQ0FBQztJQUVELElBQUksZUFBZSxJQUFJLHNCQUFzQixFQUFFLENBQUM7UUFDOUMsTUFBTSxtQkFBbUIsR0FBRyxzQkFBc0IsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBQzNFLElBQUksbUJBQW1CLEVBQUUsQ0FBQztZQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDbkMsQ0FBQzthQUFNLElBQ0wsc0JBQXNCLEtBQUssTUFBTTtZQUNqQyxzQkFBc0IsS0FBSyxXQUFXLEVBQ3RDLENBQUM7WUFDRCxnREFBZ0Q7WUFDaEQsUUFBUSxDQUFDLElBQUksQ0FDWCx3Q0FBd0Msc0JBQXNCLCtIQUErSCxDQUM5TCxDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7SUFFRCxJQUFJLHNCQUFzQixJQUFJLFdBQVcsRUFBRSxJQUFJLEtBQUssVUFBVSxFQUFFLENBQUM7UUFDL0QsTUFBTSxDQUFDLElBQUksQ0FDVDs7O2lJQUcySCxDQUM1SCxDQUFDO0lBQ0osQ0FBQztJQUVELE9BQU87UUFDTCxLQUFLLEVBQUUsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDO1FBQzFCLE1BQU07UUFDTixRQUFRLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsU0FBUztLQUNyRCxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUY7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUcsQ0FDeEIsS0FBdUIsRUFDUSxFQUFFO0FBQ2pDLG9GQUFvRjtBQUNwRixJQUFJLGtCQUFrQixDQUFDLEtBQUssRUFBRSxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFBvbGljeSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHtcbiAgVXNlclBvb2wsXG4gIFVzZXJQb29sT3BlcmF0aW9uLFxuICBVc2VyUG9vbFNFU09wdGlvbnMsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1jb2duaXRvJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IsIFRhZ05hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBBbXBsaWZ5QXV0aCxcbiAgQXV0aFByb3BzLFxuICBUcmlnZ2VyRXZlbnQsXG4gIFVzZXJQb29sU25zT3B0aW9ucyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2F1dGgtY29uc3RydWN0JztcbmltcG9ydCB7XG4gIEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSxcbiAgQXV0aFJlc291cmNlcyxcbiAgQXV0aFJvbGVOYW1lLFxuICBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcixcbiAgQ29uc3RydWN0RmFjdG9yeSxcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIEZ1bmN0aW9uUmVzb3VyY2VzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3IsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5LFxuICBSZXNvdXJjZVByb3ZpZGVyLFxuICBTdGFja1Byb3ZpZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIHRyYW5zbGF0ZVRvQXV0aENvbnN0cnVjdExvZ2luV2l0aCxcbiAgdHJhbnNsYXRlVG9BdXRoQ29uc3RydWN0U2VuZGVycyxcbn0gZnJvbSAnLi90cmFuc2xhdGVfYXV0aF9wcm9wcy5qcyc7XG5pbXBvcnQgeyBhdXRoQWNjZXNzQnVpbGRlciBhcyBfYXV0aEFjY2Vzc0J1aWxkZXIgfSBmcm9tICcuL2FjY2Vzc19idWlsZGVyLmpzJztcbmltcG9ydCB7IEF1dGhBY2Nlc3NQb2xpY3lBcmJpdGVyRmFjdG9yeSB9IGZyb20gJy4vYXV0aF9hY2Nlc3NfcG9saWN5X2FyYml0ZXIuanMnO1xuaW1wb3J0IHtcbiAgQXV0aEFjY2Vzc0dlbmVyYXRvcixcbiAgQXV0aExvZ2luV2l0aEZhY3RvcnlQcm9wcyxcbiAgQ3VzdG9tRW1haWxTZW5kZXIsXG4gIEN1c3RvbVNtc1NlbmRlcixcbiAgRXhwYW5kLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IFVzZXJQb29sQWNjZXNzUG9saWN5RmFjdG9yeSB9IGZyb20gJy4vdXNlcnBvb2xfYWNjZXNzX3BvbGljeV9mYWN0b3J5LmpzJztcbmltcG9ydCB7IFN0YWNrLCBUYWdzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuXG5leHBvcnQgdHlwZSBCYWNrZW5kQXV0aCA9IFJlc291cmNlUHJvdmlkZXI8QXV0aFJlc291cmNlcz4gJlxuICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yRmFjdG9yeTxBdXRoUm9sZU5hbWUgfCBzdHJpbmc+ICZcbiAgU3RhY2tQcm92aWRlcjtcblxuZXhwb3J0IHR5cGUgQW1wbGlmeUF1dGhQcm9wcyA9IEV4cGFuZDxcbiAgT21pdDxBdXRoUHJvcHMsICdvdXRwdXRTdG9yYWdlU3RyYXRlZ3knIHwgJ2xvZ2luV2l0aCcgfCAnc2VuZGVycyc+ICYge1xuICAgIC8qKlxuICAgICAqIFNwZWNpZnkgaG93IHlvdSB3b3VsZCBsaWtlIHVzZXJzIHRvIGxvZyBpbi4gWW91IGNhbiBjaG9vc2UgZnJvbSBlbWFpbCwgcGhvbmUsIGFuZCBldmVuIGV4dGVybmFsIHByb3ZpZGVycyBzdWNoIGFzIExvZ2luV2l0aEFtYXpvbi5cbiAgICAgKi9cbiAgICBsb2dpbldpdGg6IEV4cGFuZDxBdXRoTG9naW5XaXRoRmFjdG9yeVByb3BzPjtcbiAgICAvKipcbiAgICAgKiBDb25maWd1cmUgY3VzdG9tIGF1dGggdHJpZ2dlcnNcbiAgICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvYXV0aC9jdXN0b21pemUtYXV0aC1saWZlY3ljbGUvdHJpZ2dlcnMvXG4gICAgICovXG4gICAgdHJpZ2dlcnM/OiBQYXJ0aWFsPFxuICAgICAgUmVjb3JkPFxuICAgICAgICBUcmlnZ2VyRXZlbnQsXG4gICAgICAgIENvbnN0cnVjdEZhY3Rvcnk8UmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4+XG4gICAgICA+XG4gICAgPjtcbiAgICAvKipcbiAgICAgKiBDb25maWd1cmUgYWNjZXNzIHRvIGF1dGggZm9yIG90aGVyIEFtcGxpZnkgcmVzb3VyY2VzXG4gICAgICogQHNlZSBodHRwczovL2RvY3MuYW1wbGlmeS5hd3MvcmVhY3QvYnVpbGQtYS1iYWNrZW5kL2F1dGgvZ3JhbnQtYWNjZXNzLXRvLWF1dGgtcmVzb3VyY2VzL1xuICAgICAqIEBleGFtcGxlXG4gICAgICogYWNjZXNzOiAoYWxsb3cpID0+IFthbGxvdy5yZXNvdXJjZShwb3N0Q29uZmlybWF0aW9uKS50byhbXCJhZGRVc2VyVG9Hcm91cFwiXSldXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBhY2Nlc3M6IChhbGxvdykgPT4gW2FsbG93LnJlc291cmNlKGdyb3VwTWFuYWdlcikudG8oW1wibWFuYWdlR3JvdXBzXCJdKV1cbiAgICAgKi9cbiAgICBhY2Nlc3M/OiBBdXRoQWNjZXNzR2VuZXJhdG9yO1xuICAgIC8qKlxuICAgICAqIENvbmZpZ3VyZSBlbWFpbCBzZW5kZXIgb3B0aW9uc1xuICAgICAqL1xuICAgIHNlbmRlcnM/OiB7XG4gICAgICBlbWFpbD86XG4gICAgICAgIHwgUGljazxVc2VyUG9vbFNFU09wdGlvbnMsICdmcm9tRW1haWwnIHwgJ2Zyb21OYW1lJyB8ICdyZXBseVRvJz5cbiAgICAgICAgfCBDdXN0b21FbWFpbFNlbmRlcjtcbiAgICAgIHNtcz86IFVzZXJQb29sU25zT3B0aW9ucyB8IEN1c3RvbVNtc1NlbmRlcjtcbiAgICB9O1xuICB9XG4+O1xuXG4vKipcbiAqIFNpbmdsZXRvbiBmYWN0b3J5IGZvciBBbXBsaWZ5QXV0aCB0aGF0IGNhbiBiZSB1c2VkIGluIEFtcGxpZnkgcHJvamVjdCBmaWxlcy5cbiAqXG4gKiBFeHBvcnRlZCBmb3IgdGVzdGluZyBwdXJwb3NlIG9ubHkgJiBzaG91bGQgTk9UIGJlIGV4cG9ydGVkIG91dCBvZiB0aGUgcGFja2FnZS5cbiAqL1xuZXhwb3J0IGNsYXNzIEFtcGxpZnlBdXRoRmFjdG9yeSBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QmFja2VuZEF1dGg+IHtcbiAgLy8gcHVibGljbHkgYWNjZXNzaWJsZSBmb3IgdGVzdGluZyBwdXJwb3NlIG9ubHkuXG4gIHN0YXRpYyBmYWN0b3J5Q291bnQgPSAwO1xuXG4gIHJlYWRvbmx5IHByb3ZpZGVzID0gJ0F1dGhSZXNvdXJjZXMnO1xuXG4gIHByaXZhdGUgZ2VuZXJhdG9yOiBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcjtcblxuICAvKipcbiAgICogU2V0IHRoZSBwcm9wZXJ0aWVzIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGluaXRpYWxpemUgQW1wbGlmeUF1dGhcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEFtcGxpZnlBdXRoUHJvcHMsXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhd3MtYW1wbGlmeS9hbXBsaWZ5LWJhY2tlbmQtcnVsZXMvcHJlZmVyLWFtcGxpZnktZXJyb3JzXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbXBvcnRTdGFjayA9IG5ldyBFcnJvcigpLnN0YWNrLFxuICApIHtcbiAgICBpZiAoQW1wbGlmeUF1dGhGYWN0b3J5LmZhY3RvcnlDb3VudCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdNdWx0aXBsZVNpbmdsZXRvblJlc291cmNlc0Vycm9yJywge1xuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICdNdWx0aXBsZSBgZGVmaW5lQXV0aGAgb3IgYHJlZmVyZW5jZUF1dGhgIGNhbGxzIGFyZSBub3QgYWxsb3dlZCB3aXRoaW4gYW4gQW1wbGlmeSBiYWNrZW5kJyxcbiAgICAgICAgcmVzb2x1dGlvbjogJ1JlbW92ZSBhbGwgYnV0IG9uZSBgZGVmaW5lQXV0aGAgb3IgYHJlZmVyZW5jZUF1dGhgIGNhbGwnLFxuICAgICAgfSk7XG4gICAgfVxuICAgIEFtcGxpZnlBdXRoRmFjdG9yeS5mYWN0b3J5Q291bnQrKztcblxuICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSB2YWxpZGF0ZVBhc3N3b3JkbGVzc0NvbmZpZyhwcm9wcyk7XG5cbiAgICBpZiAodmFsaWRhdGlvblJlc3VsdC53YXJuaW5ncyAmJiB2YWxpZGF0aW9uUmVzdWx0Lndhcm5pbmdzLmxlbmd0aCA+IDApIHtcbiAgICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlKCdcXG5XQVJOSU5HUzpcXG4nKTtcbiAgICAgIHZhbGlkYXRpb25SZXN1bHQud2FybmluZ3MuZm9yRWFjaCgod2FybmluZykgPT4ge1xuICAgICAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShgICDigKIgJHt3YXJuaW5nfVxcbmApO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKCF2YWxpZGF0aW9uUmVzdWx0LnZhbGlkKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZFBhc3N3b3JkbGVzc0NvbmZpZ0Vycm9yJywge1xuICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBwYXNzd29yZGxlc3MgYXV0aGVudGljYXRpb24gY29uZmlndXJhdGlvbicsXG4gICAgICAgIGRldGFpbHM6IHZhbGlkYXRpb25SZXN1bHQuZXJyb3JzLmpvaW4oJ1xcblxcbicpLFxuICAgICAgICByZXNvbHV0aW9uOiAnRml4IHRoZSBjb25maWd1cmF0aW9uIGVycm9ycyBsaXN0ZWQgYWJvdmUnLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhIHNpbmdsZXRvbiBpbnN0YW5jZSBvZiBBbXBsaWZ5QXV0aFxuICAgKi9cbiAgZ2V0SW5zdGFuY2UgPSAoXG4gICAgZ2V0SW5zdGFuY2VQcm9wczogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gICk6IEJhY2tlbmRBdXRoID0+IHtcbiAgICBjb25zdCB7IGNvbnN0cnVjdENvbnRhaW5lciwgaW1wb3J0UGF0aFZlcmlmaWVyLCByZXNvdXJjZU5hbWVWYWxpZGF0b3IgfSA9XG4gICAgICBnZXRJbnN0YW5jZVByb3BzO1xuICAgIGltcG9ydFBhdGhWZXJpZmllcj8udmVyaWZ5KFxuICAgICAgdGhpcy5pbXBvcnRTdGFjayxcbiAgICAgIHBhdGguam9pbignYW1wbGlmeScsICdhdXRoJywgJ3Jlc291cmNlJyksXG4gICAgICAnQW1wbGlmeSBBdXRoIG11c3QgYmUgZGVmaW5lZCBpbiBhbXBsaWZ5L2F1dGgvcmVzb3VyY2UudHMnLFxuICAgICk7XG4gICAgaWYgKHRoaXMucHJvcHMubmFtZSkge1xuICAgICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yPy52YWxpZGF0ZSh0aGlzLnByb3BzLm5hbWUpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuZ2VuZXJhdG9yKSB7XG4gICAgICB0aGlzLmdlbmVyYXRvciA9IG5ldyBBbXBsaWZ5QXV0aEdlbmVyYXRvcih0aGlzLnByb3BzLCBnZXRJbnN0YW5jZVByb3BzKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnN0cnVjdENvbnRhaW5lci5nZXRPckNvbXB1dGUodGhpcy5nZW5lcmF0b3IpIGFzIEJhY2tlbmRBdXRoO1xuICB9O1xufVxuXG5jbGFzcyBBbXBsaWZ5QXV0aEdlbmVyYXRvciBpbXBsZW1lbnRzIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yIHtcbiAgcmVhZG9ubHkgcmVzb3VyY2VHcm91cE5hbWU6IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSA9ICdhdXRoJztcbiAgcHJpdmF0ZSByZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogQW1wbGlmeUF1dGhQcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXV0aEFjY2Vzc0J1aWxkZXIgPSBfYXV0aEFjY2Vzc0J1aWxkZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdXRoQWNjZXNzUG9saWN5QXJiaXRlckZhY3RvcnkgPSBuZXcgQXV0aEFjY2Vzc1BvbGljeUFyYml0ZXJGYWN0b3J5KCksXG4gICkge1xuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWUgPz8gJ2FtcGxpZnlBdXRoJztcbiAgfVxuXG4gIGdlbmVyYXRlQ29udGFpbmVyRW50cnkgPSAoe1xuICAgIHNjb3BlLFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBzc21FbnZpcm9ubWVudEVudHJpZXNHZW5lcmF0b3IsXG4gICAgc3RhYmxlQmFja2VuZElkZW50aWZpZXJzLFxuICB9OiBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMpID0+IHtcbiAgICBjb25zdCBhdXRoUHJvcHM6IEF1dGhQcm9wcyA9IHtcbiAgICAgIC4uLnRoaXMucHJvcHMsXG4gICAgICBsb2dpbldpdGg6IHRyYW5zbGF0ZVRvQXV0aENvbnN0cnVjdExvZ2luV2l0aChcbiAgICAgICAgdGhpcy5wcm9wcy5sb2dpbldpdGgsXG4gICAgICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICAgICksXG4gICAgICBzZW5kZXJzOiB0cmFuc2xhdGVUb0F1dGhDb25zdHJ1Y3RTZW5kZXJzKFxuICAgICAgICB0aGlzLnByb3BzLnNlbmRlcnMsXG4gICAgICAgIHRoaXMuZ2V0SW5zdGFuY2VQcm9wcyxcbiAgICAgICksXG4gICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IHRoaXMuZ2V0SW5zdGFuY2VQcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gICAgfTtcbiAgICBpZiAoYXV0aFByb3BzLmxvZ2luV2l0aC5leHRlcm5hbFByb3ZpZGVycykge1xuICAgICAgYXV0aFByb3BzLmxvZ2luV2l0aC5leHRlcm5hbFByb3ZpZGVycy5kb21haW5QcmVmaXggPVxuICAgICAgICBzdGFibGVCYWNrZW5kSWRlbnRpZmllcnMuZ2V0U3RhYmxlQmFja2VuZEhhc2goKTtcbiAgICB9XG5cbiAgICBsZXQgYXV0aENvbnN0cnVjdDogQW1wbGlmeUF1dGg7XG4gICAgdHJ5IHtcbiAgICAgIGF1dGhDb25zdHJ1Y3QgPSBuZXcgQW1wbGlmeUF1dGgoc2NvcGUsIHRoaXMubmFtZSwgYXV0aFByb3BzKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdBbXBsaWZ5QXV0aENvbnN0cnVjdEluaXRpYWxpemF0aW9uRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBpbnN0YW50aWF0ZSBhdXRoIGNvbnN0cnVjdCcsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3IsXG4gICAgICApO1xuICAgIH1cblxuICAgIFRhZ3Mub2YoYXV0aENvbnN0cnVjdCkuYWRkKFRhZ05hbWUuRlJJRU5ETFlfTkFNRSwgdGhpcy5uYW1lKTtcblxuICAgIE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMudHJpZ2dlcnMgfHwge30pLmZvckVhY2goXG4gICAgICAoW3RyaWdnZXJFdmVudCwgaGFuZGxlckZhY3RvcnldKSA9PiB7XG4gICAgICAgIChhdXRoQ29uc3RydWN0LnJlc291cmNlcy51c2VyUG9vbCBhcyBVc2VyUG9vbCkuYWRkVHJpZ2dlcihcbiAgICAgICAgICBVc2VyUG9vbE9wZXJhdGlvbi5vZih0cmlnZ2VyRXZlbnQpLFxuICAgICAgICAgIGhhbmRsZXJGYWN0b3J5LmdldEluc3RhbmNlKHRoaXMuZ2V0SW5zdGFuY2VQcm9wcykucmVzb3VyY2VzLmxhbWJkYSxcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbnN0IGF1dGhDb25zdHJ1Y3RNaXhpbjogQmFja2VuZEF1dGggPSB7XG4gICAgICAuLi5hdXRoQ29uc3RydWN0LFxuICAgICAgLyoqXG4gICAgICAgKiBSZXR1cm5zIGEgcmVzb3VyY2VBY2Nlc3NBY2NlcHRvciBmb3IgdGhlIGdpdmVuIHJvbGVcbiAgICAgICAqIEBwYXJhbSByb2xlSWRlbnRpZmllciBFaXRoZXIgdGhlIGF1dGggb3IgdW5hdXRoIHJvbGUgbmFtZSBvciB0aGUgbmFtZSBvZiBhIFVzZXJQb29sIGdyb3VwXG4gICAgICAgKi9cbiAgICAgIGdldFJlc291cmNlQWNjZXNzQWNjZXB0b3I6IChcbiAgICAgICAgcm9sZUlkZW50aWZpZXI6IEF1dGhSb2xlTmFtZSB8IHN0cmluZyxcbiAgICAgICk6IFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPT4gKHtcbiAgICAgICAgaWRlbnRpZmllcjogYCR7cm9sZUlkZW50aWZpZXJ9UmVzb3VyY2VBY2Nlc3NBY2NlcHRvcmAsXG4gICAgICAgIGFjY2VwdFJlc291cmNlQWNjZXNzOiAocG9saWN5OiBQb2xpY3kpID0+IHtcbiAgICAgICAgICBjb25zdCByb2xlID0gcm9sZU5hbWVJc0F1dGhSb2xlTmFtZShyb2xlSWRlbnRpZmllcilcbiAgICAgICAgICAgID8gYXV0aENvbnN0cnVjdC5yZXNvdXJjZXNbcm9sZUlkZW50aWZpZXJdXG4gICAgICAgICAgICA6IGF1dGhDb25zdHJ1Y3QucmVzb3VyY2VzLmdyb3Vwcz8uW3JvbGVJZGVudGlmaWVyXT8ucm9sZTtcbiAgICAgICAgICBpZiAoIXJvbGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkUmVzb3VyY2VBY2Nlc3NDb25maWdFcnJvcicsIHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogYE5vIGF1dGggSUFNIHJvbGUgZm91bmQgZm9yIFwiJHtyb2xlSWRlbnRpZmllcn1cIi5gLFxuICAgICAgICAgICAgICByZXNvbHV0aW9uOiBgSWYgeW91IGFyZSB0cnlpbmcgdG8gY29uZmlndXJlIFVzZXJQb29sIGdyb3VwIGFjY2VzcywgZW5zdXJlIHRoYXQgdGhlIGdyb3VwIG5hbWUgaXMgc3BlY2lmaWVkIGNvcnJlY3RseS5gLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHBvbGljeS5hdHRhY2hUb1JvbGUocm9sZSk7XG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICAgIHN0YWNrOiBTdGFjay5vZihhdXRoQ29uc3RydWN0KSxcbiAgICB9O1xuICAgIGlmICghdGhpcy5wcm9wcy5hY2Nlc3MpIHtcbiAgICAgIHJldHVybiBhdXRoQ29uc3RydWN0TWl4aW47XG4gICAgfVxuICAgIC8vIHByb3BzLmFjY2VzcyBpcyB0aGUgYWNjZXNzIGNhbGxiYWNrIGRlZmluZWQgYnkgdGhlIGN1c3RvbWVyXG4gICAgLy8gaGVyZSB3ZSBpbmplY3QgdGhlIGF1dGhBY2Nlc3NCdWlsZGVyIGludG8gdGhlIGNhbGxiYWNrIGFuZCBydW4gaXRcbiAgICAvLyB0aGlzIHByb2R1Y2VzIHRoZSBhY2Nlc3MgZGVmaW5pdGlvbiB0aGF0IHdpbGwgYmUgdXNlZCB0byBjcmVhdGUgdGhlIGF1dGggYWNjZXNzIHBvbGljaWVzXG4gICAgY29uc3QgYWNjZXNzRGVmaW5pdGlvbiA9IHRoaXMucHJvcHMuYWNjZXNzKHRoaXMuYXV0aEFjY2Vzc0J1aWxkZXIpO1xuXG4gICAgY29uc3Qgc3NtRW52aXJvbm1lbnRFbnRyaWVzID1cbiAgICAgIHNzbUVudmlyb25tZW50RW50cmllc0dlbmVyYXRvci5nZW5lcmF0ZVNzbUVudmlyb25tZW50RW50cmllcyh7XG4gICAgICAgIFtgJHt0aGlzLm5hbWV9X1VTRVJQT09MX0lEYF06XG4gICAgICAgICAgYXV0aENvbnN0cnVjdE1peGluLnJlc291cmNlcy51c2VyUG9vbC51c2VyUG9vbElkLFxuICAgICAgfSk7XG5cbiAgICBjb25zdCBhdXRoUG9saWN5QXJiaXRlciA9IHRoaXMuYXV0aEFjY2Vzc1BvbGljeUFyYml0ZXJGYWN0b3J5LmdldEluc3RhbmNlKFxuICAgICAgYWNjZXNzRGVmaW5pdGlvbixcbiAgICAgIHRoaXMuZ2V0SW5zdGFuY2VQcm9wcyxcbiAgICAgIHNzbUVudmlyb25tZW50RW50cmllcyxcbiAgICAgIG5ldyBVc2VyUG9vbEFjY2Vzc1BvbGljeUZhY3RvcnkoYXV0aENvbnN0cnVjdC5yZXNvdXJjZXMudXNlclBvb2wpLFxuICAgICk7XG5cbiAgICBhdXRoUG9saWN5QXJiaXRlci5hcmJpdHJhdGVQb2xpY2llcygpO1xuXG4gICAgcmV0dXJuIGF1dGhDb25zdHJ1Y3RNaXhpbjtcbiAgfTtcbn1cblxuY29uc3Qgcm9sZU5hbWVJc0F1dGhSb2xlTmFtZSA9IChyb2xlTmFtZTogc3RyaW5nKTogcm9sZU5hbWUgaXMgQXV0aFJvbGVOYW1lID0+IHtcbiAgcmV0dXJuIChcbiAgICByb2xlTmFtZSA9PT0gJ2F1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZScgfHxcbiAgICByb2xlTmFtZSA9PT0gJ3VuYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlJ1xuICApO1xufTtcblxudHlwZSBWYWxpZGF0aW9uUmVzdWx0ID0ge1xuICB2YWxpZDogYm9vbGVhbjtcbiAgZXJyb3JzOiBzdHJpbmdbXTtcbiAgd2FybmluZ3M/OiBzdHJpbmdbXTtcbn07XG5cbi8qKlxuICogVmFsaWRhdGVzIHRoZSBmb3JtYXQgb2YgYSBXZWJBdXRobiByZWx5aW5nIHBhcnR5IElELlxuICogQHBhcmFtIHJlbHlpbmdQYXJ0eUlkIC0gVGhlIHJlbHlpbmcgcGFydHkgSUQgdG8gdmFsaWRhdGVcbiAqIEByZXR1cm5zIEVycm9yIG1lc3NhZ2UgaWYgaW52YWxpZCwgdW5kZWZpbmVkIGlmIHZhbGlkXG4gKi9cbmNvbnN0IHZhbGlkYXRlUmVseWluZ1BhcnR5SWQgPSAocmVseWluZ1BhcnR5SWQ6IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmIChyZWx5aW5nUGFydHlJZCA9PT0gJ0FVVE8nIHx8IHJlbHlpbmdQYXJ0eUlkID09PSAnbG9jYWxob3N0Jykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBpZiAocmVseWluZ1BhcnR5SWQuaW5jbHVkZXMoJzovLycpKSB7XG4gICAgcmV0dXJuIGBJbnZhbGlkIHJlbHlpbmcgcGFydHkgSUQ6IFwiJHtyZWx5aW5nUGFydHlJZH1cIi4gTXVzdCBiZSBhIHZhbGlkIGRvbWFpbiB3aXRob3V0IHByb3RvY29sIChlLmcuLCBcImV4YW1wbGUuY29tXCIpLCBcImxvY2FsaG9zdFwiIGZvciBkZXZlbG9wbWVudCwgb3IgXCJBVVRPXCIgZm9yIEFtcGxpZnkgSG9zdGluZy5cblxuRXhhbXBsZXM6XG4gIC0gVmFsaWQ6IFwiZXhhbXBsZS5jb21cIiwgXCJhcHAuZXhhbXBsZS5jb21cIiwgXCJsb2NhbGhvc3RcIiwgXCJBVVRPXCJcbiAgLSBJbnZhbGlkOiBcImh0dHA6Ly9leGFtcGxlLmNvbVwiLCBcImh0dHBzOi8vZXhhbXBsZS5jb21cImA7XG4gIH1cblxuICAvLyBNdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIGRvdCBvciBiZSBhIHNpbmdsZSB3b3JkIChmb3IgbG9jYWwgZG9tYWlucylcbiAgY29uc3QgZG9tYWluUGF0dGVybiA9XG4gICAgL15bYS16QS1aMC05XShbYS16QS1aMC05LV0qW2EtekEtWjAtOV0pPyhcXC5bYS16QS1aMC05XShbYS16QS1aMC05LV0qW2EtekEtWjAtOV0pPykqJC87XG5cbiAgaWYgKCFkb21haW5QYXR0ZXJuLnRlc3QocmVseWluZ1BhcnR5SWQpKSB7XG4gICAgcmV0dXJuIGBJbnZhbGlkIHJlbHlpbmcgcGFydHkgSUQ6IFwiJHtyZWx5aW5nUGFydHlJZH1cIi4gTXVzdCBiZSBhIHZhbGlkIGRvbWFpbiBmb3JtYXQuXG5cbkV4YW1wbGVzOlxuICAtIFZhbGlkOiBcImV4YW1wbGUuY29tXCIsIFwiYXBwLmV4YW1wbGUuY29tXCIsIFwibG9jYWxob3N0XCIsIFwiQVVUT1wiXG4gIC0gSW52YWxpZDogXCJleGFtcGxlXCIsIFwiMTkyLjE2OC4xLjFcIiwgXCJteSBhcHAuY29tXCJgO1xuICB9XG5cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn07XG5cbi8qKlxuICogVmFsaWRhdGVzIHBhc3N3b3JkbGVzcyBhdXRoZW50aWNhdGlvbiBjb25maWd1cmF0aW9uLlxuICogQHBhcmFtIHByb3BzIC0gVGhlIGF1dGggY29uZmlndXJhdGlvbiBwcm9wcyB0byB2YWxpZGF0ZVxuICogQHJldHVybnMgVmFsaWRhdGlvbiByZXN1bHQgd2l0aCBlcnJvcnMgYW5kIHdhcm5pbmdzXG4gKi9cbmNvbnN0IHZhbGlkYXRlUGFzc3dvcmRsZXNzQ29uZmlnID0gKFxuICBwcm9wczogQW1wbGlmeUF1dGhQcm9wcyxcbik6IFZhbGlkYXRpb25SZXN1bHQgPT4ge1xuICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IHdhcm5pbmdzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIGNvbnN0IHsgbG9naW5XaXRoLCBtdWx0aWZhY3RvciB9ID0gcHJvcHM7XG5cbiAgY29uc3QgZW1haWxFbmFibGVkID0gISFsb2dpbldpdGguZW1haWw7XG4gIGNvbnN0IHBob25lRW5hYmxlZCA9ICEhbG9naW5XaXRoLnBob25lO1xuICBjb25zdCBlbWFpbE90cEVuYWJsZWQgPVxuICAgIHR5cGVvZiBsb2dpbldpdGguZW1haWwgPT09ICdvYmplY3QnICYmIGxvZ2luV2l0aC5lbWFpbC5vdHBMb2dpbiA9PT0gdHJ1ZTtcbiAgY29uc3Qgc21zT3RwRW5hYmxlZCA9XG4gICAgdHlwZW9mIGxvZ2luV2l0aC5waG9uZSA9PT0gJ29iamVjdCcgJiYgbG9naW5XaXRoLnBob25lLm90cExvZ2luID09PSB0cnVlO1xuICBjb25zdCB3ZWJBdXRobkVuYWJsZWQgPSAhIWxvZ2luV2l0aC53ZWJBdXRobjtcblxuICBsZXQgd2ViQXV0aG5SZWx5aW5nUGFydHlJZDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBpZiAod2ViQXV0aG5FbmFibGVkICYmIHR5cGVvZiBsb2dpbldpdGgud2ViQXV0aG4gPT09ICdvYmplY3QnKSB7XG4gICAgd2ViQXV0aG5SZWx5aW5nUGFydHlJZCA9IGxvZ2luV2l0aC53ZWJBdXRobi5yZWx5aW5nUGFydHlJZDtcbiAgfVxuXG4gIGNvbnN0IGFueVBhc3N3b3JkbGVzc0VuYWJsZWQgPVxuICAgIGVtYWlsT3RwRW5hYmxlZCB8fCBzbXNPdHBFbmFibGVkIHx8IHdlYkF1dGhuRW5hYmxlZDtcblxuICBpZiAoIWVtYWlsRW5hYmxlZCAmJiAhcGhvbmVFbmFibGVkICYmICFsb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnMpIHtcbiAgICBlcnJvcnMucHVzaChcbiAgICAgICdBdCBsZWFzdCBvbmUgYXV0aGVudGljYXRpb24gbWV0aG9kIG11c3QgYmUgZW5hYmxlZC4gQ29uZmlndXJlIGVtYWlsLCBwaG9uZSwgb3IgZXh0ZXJuYWwgcHJvdmlkZXJzIGluIGxvZ2luV2l0aC4nLFxuICAgICk7XG4gIH1cblxuICBpZiAod2ViQXV0aG5FbmFibGVkICYmICFlbWFpbEVuYWJsZWQgJiYgIXBob25lRW5hYmxlZCkge1xuICAgIGVycm9ycy5wdXNoKFxuICAgICAgYFBhc3NrZXlzIChXZWJBdXRobikgcmVxdWlyZSBhdCBsZWFzdCBvbmUgc2lnbi11cCBtZXRob2QgKGVtYWlsIG9yIHBob25lKS5cblxuRW1haWwgT1RQIGFuZCBTTVMgT1RQIGFyZSB2YWxpZCBwYXNzd29yZGxlc3Mgc2lnbi11cCBtZXRob2RzLlxuUGFzc2tleXMgY2FuIG9ubHkgYmUgcmVnaXN0ZXJlZCBhZnRlciBpbml0aWFsIGFjY291bnQgY3JlYXRpb24uXG5cblJlc29sdXRpb246IEFkZCBlbWFpbCBvciBwaG9uZSB0byBsb2dpbldpdGggY29uZmlndXJhdGlvbi5gLFxuICAgICk7XG4gIH1cblxuICBpZiAod2ViQXV0aG5FbmFibGVkICYmIHdlYkF1dGhuUmVseWluZ1BhcnR5SWQpIHtcbiAgICBjb25zdCByZWx5aW5nUGFydHlJZEVycm9yID0gdmFsaWRhdGVSZWx5aW5nUGFydHlJZCh3ZWJBdXRoblJlbHlpbmdQYXJ0eUlkKTtcbiAgICBpZiAocmVseWluZ1BhcnR5SWRFcnJvcikge1xuICAgICAgZXJyb3JzLnB1c2gocmVseWluZ1BhcnR5SWRFcnJvcik7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHdlYkF1dGhuUmVseWluZ1BhcnR5SWQgIT09ICdBVVRPJyAmJlxuICAgICAgd2ViQXV0aG5SZWx5aW5nUGFydHlJZCAhPT0gJ2xvY2FsaG9zdCdcbiAgICApIHtcbiAgICAgIC8vIFdhcm5pbmcgYWJvdXQgaW1tdXRhYmlsaXR5IGZvciBjdXN0b20gZG9tYWluc1xuICAgICAgd2FybmluZ3MucHVzaChcbiAgICAgICAgYFdlYkF1dGhuIHJlbHlpbmcgcGFydHkgSUQgaXMgc2V0IHRvIFwiJHt3ZWJBdXRoblJlbHlpbmdQYXJ0eUlkfVwiLiBDaGFuZ2luZyB0aGlzIHZhbHVlIGFmdGVyIGRlcGxveW1lbnQgd2lsbCBpbnZhbGlkYXRlIGFsbCBleGlzdGluZyBwYXNza2V5cy4gVXNlcnMgd2lsbCBuZWVkIHRvIHJlLXJlZ2lzdGVyIHRoZWlyIHBhc3NrZXlzLmAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGlmIChhbnlQYXNzd29yZGxlc3NFbmFibGVkICYmIG11bHRpZmFjdG9yPy5tb2RlID09PSAnUkVRVUlSRUQnKSB7XG4gICAgZXJyb3JzLnB1c2goXG4gICAgICBgUGFzc3dvcmRsZXNzIGF1dGhlbnRpY2F0aW9uIChFbWFpbCBPVFAsIFNNUyBPVFAsIFdlYkF1dGhuKSBjYW5ub3QgYmUgdXNlZCB3aGVuIE1GQSBpcyBzZXQgdG8gUkVRVUlSRUQuIEFtYXpvbiBDb2duaXRvIGRvZXMgbm90IHN1cHBvcnQgY29tYmluaW5nIE1GQSB3aXRoIHBhc3N3b3JkbGVzcyBhdXRoZW50aWNhdGlvbiBtZXRob2RzLlxuXG5SZXNvbHV0aW9uOiBDaG9vc2UgZWl0aGVyIHBhc3N3b3JkbGVzcyBhdXRoZW50aWNhdGlvbiBvciBNRkEsIG5vdCBib3RoLlxuTm90ZTogV2ViQXV0aG4gcGFzc2tleXMgd2l0aCB1c2VyIHZlcmlmaWNhdGlvbiBjYW4gcHJvdmlkZSBzaW1pbGFyIHNlY3VyaXR5IHRvIE1GQSB3aXRob3V0IHJlcXVpcmluZyBzZXBhcmF0ZSBNRkEgY29uZmlndXJhdGlvbi5gLFxuICAgICk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLFxuICAgIGVycm9ycyxcbiAgICB3YXJuaW5nczogd2FybmluZ3MubGVuZ3RoID4gMCA/IHdhcm5pbmdzIDogdW5kZWZpbmVkLFxuICB9O1xufTtcblxuLyoqXG4gKiBQcm92aWRlIHRoZSBzZXR0aW5ncyB0aGF0IHdpbGwgYmUgdXNlZCBmb3IgYXV0aGVudGljYXRpb24uXG4gKi9cbmV4cG9ydCBjb25zdCBkZWZpbmVBdXRoID0gKFxuICBwcm9wczogQW1wbGlmeUF1dGhQcm9wcyxcbik6IENvbnN0cnVjdEZhY3Rvcnk8QmFja2VuZEF1dGg+ID0+XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYXdzLWFtcGxpZnkvYW1wbGlmeS1iYWNrZW5kLXJ1bGVzL3ByZWZlci1hbXBsaWZ5LWVycm9yc1xuICBuZXcgQW1wbGlmeUF1dGhGYWN0b3J5KHByb3BzLCBuZXcgRXJyb3IoKS5zdGFjayk7XG4iXX0=