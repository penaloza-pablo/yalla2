"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmplifyAuth = void 0;
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_cognito_1 = require("aws-cdk-lib/aws-cognito");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const backend_output_schemas_1 = require("@aws-amplify/backend-output-schemas");
const defaults_js_1 = require("./defaults.js");
const backend_output_storage_1 = require("@aws-amplify/backend-output-storage");
const path = __importStar(require("path"));
const aws_kms_1 = require("aws-cdk-lib/aws-kms");
const platform_core_1 = require("@aws-amplify/platform-core");
const oauthProviderToProviderDomainMap = {
    facebook: 'graph.facebook.com',
    google: 'accounts.google.com',
    amazon: 'www.amazon.com',
    apple: 'appleid.apple.com',
};
const INVITATION_PLACEHOLDERS = {
    CODE: '{####}',
    USERNAME: '{username}',
};
const VERIFICATION_EMAIL_PLACEHOLDERS = {
    CODE: '{####}',
    LINK: '{##Verify Email##}',
};
const VERIFICATION_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const MFA_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const DEFAULT_OAUTH_SCOPES = [
    aws_cognito_1.OAuthScope.PHONE,
    aws_cognito_1.OAuthScope.EMAIL,
    aws_cognito_1.OAuthScope.OPENID,
    aws_cognito_1.OAuthScope.PROFILE,
    aws_cognito_1.OAuthScope.COGNITO_ADMIN,
];
// Be very careful editing this value. It is the string that is used to attribute stacks to Amplify Auth in BI metrics
const authStackType = 'auth-Cognito';
/**
 * Amplify Auth CDK Construct
 */
class AmplifyAuth extends constructs_1.Construct {
    /**
     * Create a new Auth construct with AuthProps.
     * If no props are provided, email login and defaults will be used.
     */
    constructor(scope, id, props = defaults_js_1.DEFAULTS.IF_NO_PROPS_PROVIDED) {
        var _a, _b, _c, _d, _e;
        super(scope, id);
        this.groups = {};
        /**
         * Create Auth/UnAuth Roles
         * @returns DefaultRoles
         */
        this.setupAuthAndUnAuthRoles = (identityPoolId) => {
            const result = {
                auth: new aws_iam_1.Role(this, `${this.name}authenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
                unAuth: new aws_iam_1.Role(this, `${this.name}unauthenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'unauthenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
            };
            return result;
        };
        /**
         * Auto generate the user pool groups and group roles
         */
        this.setupUserPoolGroups = (groups, identityPool) => {
            (groups || []).forEach((groupName, index) => {
                const groupRole = new aws_iam_1.Role(this, `${this.name}${groupName}GroupRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPool.ref,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                });
                const currentGroup = new aws_cognito_1.CfnUserPoolGroup(this, `${this.name}${groupName}Group`, {
                    userPoolId: this.userPool.userPoolId,
                    groupName: groupName,
                    roleArn: groupRole.roleArn,
                    precedence: index,
                });
                this.groups[groupName] = {
                    cfnUserGroup: currentGroup,
                    role: groupRole,
                };
            });
        };
        /**
         * Setup Identity Pool with default roles/role mappings, and register providers
         */
        this.setupIdentityPool = (userPool, userPoolClient, providerSetupResult) => {
            // setup identity pool
            const region = aws_cdk_lib_1.Stack.of(this).region;
            const identityPool = new aws_cdk_lib_1.aws_cognito.CfnIdentityPool(this, `${this.name}IdentityPool`, {
                allowUnauthenticatedIdentities: defaults_js_1.DEFAULTS.ALLOW_UNAUTHENTICATED_IDENTITIES,
            });
            const roles = this.setupAuthAndUnAuthRoles(identityPool.ref);
            const identityPoolRoleAttachment = new aws_cdk_lib_1.aws_cognito.CfnIdentityPoolRoleAttachment(this, `${this.name}IdentityPoolRoleAttachment`, {
                identityPoolId: identityPool.ref,
                roles: {
                    unauthenticated: roles.unAuth.roleArn,
                    authenticated: roles.auth.roleArn,
                },
                roleMappings: {
                    UserPoolWebClientRoleMapping: {
                        type: 'Token',
                        ambiguousRoleResolution: 'AuthenticatedRole',
                        identityProvider: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}:${userPoolClient.userPoolClientId}`,
                    },
                },
            });
            identityPoolRoleAttachment.addDependency(identityPool);
            identityPoolRoleAttachment.node.addDependency(userPoolClient);
            // add cognito provider
            identityPool.cognitoIdentityProviders = [
                {
                    clientId: userPoolClient.userPoolClientId,
                    providerName: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}`,
                },
            ];
            // add other providers
            identityPool.supportedLoginProviders = providerSetupResult.oAuthMappings;
            return {
                identityPool,
                identityPoolRoleAttachment,
                roles,
            };
        };
        /**
         * Define bindCustomAttribute to meet requirements of the Cognito API to call the bind method
         */
        this.bindCustomAttribute = (key, attribute) => {
            var _a;
            const baseConfig = {
                dataType: attribute.dataType,
                mutable: (_a = attribute.mutable) !== null && _a !== void 0 ? _a : true,
            };
            let constraints = {};
            // Conditionally add constraint properties based on dataType.
            if (attribute.dataType === 'String') {
                constraints = {
                    stringConstraints: {
                        minLen: attribute.minLen,
                        maxLen: attribute.maxLen,
                    },
                };
            }
            else if (attribute.dataType === 'Number') {
                constraints = {
                    numberConstraints: {
                        min: attribute.min,
                        max: attribute.max,
                    },
                };
            }
            //The final config object includes baseConfig and conditionally added constraint properties.
            const config = {
                ...baseConfig,
                ...constraints,
            };
            return {
                ...config,
                bind: () => config,
            };
        };
        /**
         * Process props into UserPoolProps (set defaults if needed)
         */
        this.getUserPoolProps = (props) => {
            var _a, _b, _c, _d, _e;
            const emailEnabled = props.loginWith.email ? true : false;
            const phoneEnabled = props.loginWith.phone ? true : false;
            const oneOfEmailOrPhone = emailEnabled || phoneEnabled;
            if (!oneOfEmailOrPhone) {
                throw Error('At least one of email or phone must be enabled.');
            }
            let userVerificationSettings = {};
            // extract email settings if settings object is defined
            if (typeof props.loginWith.email === 'object') {
                const emailSettings = props.loginWith.email;
                // verify email body and inject the actual template values which cognito uses
                const emailBody = this.verifyEmailBody(emailSettings);
                userVerificationSettings = {
                    emailBody: emailBody,
                    emailStyle: this.getEmailVerificationStyle(emailSettings.verificationEmailStyle),
                    emailSubject: emailSettings.verificationEmailSubject,
                };
            }
            // extract phone settings if settings object is defined
            if (typeof props.loginWith.phone === 'object') {
                const phoneSettings = props.loginWith.phone;
                let smsMessage;
                if (phoneSettings.verificationMessage &&
                    typeof phoneSettings.verificationMessage === 'function') {
                    // validate sms message structure
                    smsMessage = phoneSettings.verificationMessage(() => VERIFICATION_SMS_PLACEHOLDERS.CODE);
                    if (!smsMessage.includes(VERIFICATION_SMS_PLACEHOLDERS.CODE)) {
                        throw Error("Invalid phone settings. Property 'verificationMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                    }
                }
                userVerificationSettings = {
                    ...userVerificationSettings,
                    smsMessage: smsMessage,
                };
            }
            const mfaType = this.getMFAType(props.multifactor);
            const mfaMode = this.getMFAMode(props.multifactor);
            // If phone login is enabled along with MFA, cognito requires that mfa SMS type to be enabled.
            if (phoneEnabled && mfaMode && mfaMode !== 'OFF' && !(mfaType === null || mfaType === void 0 ? void 0 : mfaType.sms)) {
                throw Error('Invalid MFA settings. SMS must be enabled in multiFactor if loginWith phone is enabled');
            }
            const { standardAttributes, customAttributes } = Object.entries((_a = props.userAttributes) !== null && _a !== void 0 ? _a : {}).reduce((acc, [key, value]) => {
                if (key.startsWith('custom:')) {
                    const attributeKey = key.replace(/^custom:/i, '');
                    acc.customAttributes[attributeKey] = this.bindCustomAttribute(attributeKey, value);
                }
                else {
                    acc.standardAttributes[key] = value;
                }
                return acc;
            }, { standardAttributes: {}, customAttributes: {} });
            /**
             * Handle KMS key for custom email and sms senders
             * If a custom sender is provided, we either use the provided KMS key ARN
             * or create a new KMS key if one is not provided.
             *
             * If KMS key is provided in both senders, we throw an error
             */
            if (props.senders) {
                const customSmsSender = props.senders.sms && 'handler' in props.senders.sms
                    ? props.senders.sms
                    : undefined;
                const customEmailSender = props.senders.email && 'handler' in props.senders.email
                    ? props.senders.email
                    : undefined;
                // If both custom senders are configured and don't provide same KMS Key, then throw
                if (customSmsSender &&
                    customEmailSender &&
                    customSmsSender.kmsKeyArn &&
                    customEmailSender.kmsKeyArn &&
                    customSmsSender.kmsKeyArn !== customEmailSender.kmsKeyArn) {
                    throw new Error('KMS key ARN must be the same for both email and sms senders');
                }
                else if ((customSmsSender && customSmsSender.kmsKeyArn) ||
                    (customEmailSender && customEmailSender.kmsKeyArn)) {
                    // If at least one custom sender is configured with KMS key, we use it
                    const kmsKeyArn = (_b = customSmsSender === null || customSmsSender === void 0 ? void 0 : customSmsSender.kmsKeyArn) !== null && _b !== void 0 ? _b : customEmailSender === null || customEmailSender === void 0 ? void 0 : customEmailSender.kmsKeyArn;
                    this.customSenderKMSkey = aws_kms_1.Key.fromKeyArn(this, `${this.name}CustomSenderKey`, kmsKeyArn);
                }
                else if (customSmsSender || customEmailSender) {
                    {
                        // If at least one custom sender is configured but no KMS key provided, we create one.
                        this.customSenderKMSkey = new aws_kms_1.Key(customSmsSender
                            ? customSmsSender.handler.stack
                            : customEmailSender.handler.stack, // In if condition we ensure that at lest one of the handler is available
                        `${this.name}CustomSenderKey`, {
                            enableKeyRotation: true,
                        });
                    }
                }
            }
            const smsConfiguration = this.getSmsConfiguration((_c = props.senders) === null || _c === void 0 ? void 0 : _c.sms);
            const signInPolicy = this.getSignInPolicy(props);
            const passkeyConfig = this.getPasskeyConfig(props);
            const userPoolProps = {
                signInCaseSensitive: defaults_js_1.DEFAULTS.SIGN_IN_CASE_SENSITIVE,
                signInAliases: {
                    phone: phoneEnabled,
                    email: emailEnabled,
                },
                ...(signInPolicy && { signInPolicy }),
                ...(passkeyConfig.relyingPartyId && {
                    passkeyRelyingPartyId: passkeyConfig.relyingPartyId,
                }),
                ...(passkeyConfig.userVerification && {
                    passkeyUserVerification: passkeyConfig.userVerification,
                }),
                keepOriginal: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                autoVerify: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                userVerification: userVerificationSettings,
                passwordPolicy: defaults_js_1.DEFAULTS.PASSWORD_POLICY,
                standardAttributes: {
                    email: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.email(emailEnabled),
                    phoneNumber: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.phoneNumber(phoneEnabled),
                    ...standardAttributes,
                },
                customAttributes: {
                    ...customAttributes,
                },
                email: ((_d = props.senders) === null || _d === void 0 ? void 0 : _d.email) && 'fromEmail' in props.senders.email
                    ? aws_cdk_lib_1.aws_cognito.UserPoolEmail.withSES({
                        fromEmail: props.senders.email.fromEmail,
                        fromName: props.senders.email.fromName,
                        replyTo: props.senders.email.replyTo,
                        sesRegion: aws_cdk_lib_1.Stack.of(this).region,
                    })
                    : undefined,
                smsRole: smsConfiguration === null || smsConfiguration === void 0 ? void 0 : smsConfiguration.snsCallerArn,
                smsRoleExternalId: smsConfiguration === null || smsConfiguration === void 0 ? void 0 : smsConfiguration.externalId,
                snsRegion: smsConfiguration === null || smsConfiguration === void 0 ? void 0 : smsConfiguration.snsRegion,
                enableSmsRole: smsConfiguration === null || smsConfiguration === void 0 ? void 0 : smsConfiguration.enableSMSRole,
                selfSignUpEnabled: defaults_js_1.DEFAULTS.ALLOW_SELF_SIGN_UP,
                mfa: mfaMode,
                mfaMessage: this.getMFAMessage(props.multifactor),
                mfaSecondFactor: mfaType,
                accountRecovery: this.getAccountRecoverySetting(emailEnabled, phoneEnabled, props.accountRecovery),
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                userInvitation: typeof props.loginWith.email !== 'boolean'
                    ? this.getUserInvitationSettings((_e = props.loginWith.email) === null || _e === void 0 ? void 0 : _e.userInvitation)
                    : undefined,
                customSenderKmsKey: this.customSenderKMSkey,
                userPoolName: props.name || undefined,
            };
            return userPoolProps;
        };
        /**
         * Get email verification style from user props
         * @param verificationEmailStyle - string value
         * @returns verificationEmailStyle - enum value
         */
        this.getEmailVerificationStyle = (verificationEmailStyle) => {
            if (verificationEmailStyle === 'CODE') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.CODE;
            }
            else if (verificationEmailStyle === 'LINK') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.LINK;
            }
            return undefined;
        };
        /**
         * Determine the account recovery option based on enabled login methods.
         * @param emailEnabled - is email enabled
         * @param phoneEnabled - is phone enabled
         * @param accountRecoveryMethodAsString - the user provided account recovery setting
         * @returns account recovery setting enum value
         */
        this.getAccountRecoverySetting = (emailEnabled, phoneEnabled, accountRecoveryMethodAsString) => {
            const accountRecovery = this.convertAccountRecoveryStringToEnum(accountRecoveryMethodAsString);
            if (accountRecovery !== undefined) {
                return accountRecovery;
            }
            // set default based on enabled login methods
            if (phoneEnabled && emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            if (phoneEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.PHONE_ONLY_WITHOUT_MFA;
            }
            if (emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa mode to cognito Mfa Mode.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA enforcement mode
         */
        this.getMFAMode = (mfa) => {
            if (mfa) {
                switch (mfa.mode) {
                    case 'OFF':
                        return aws_cognito_1.Mfa.OFF;
                    case 'OPTIONAL':
                        return aws_cognito_1.Mfa.OPTIONAL;
                    case 'REQUIRED':
                        return aws_cognito_1.Mfa.REQUIRED;
                }
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa type to cognito Mfa type.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA type (sms, totp, or email)
         */
        this.getMFAType = (mfa) => {
            return typeof mfa === 'object' && mfa.mode !== 'OFF'
                ? {
                    sms: mfa.sms ? true : false,
                    otp: mfa.totp ? true : false,
                    email: mfa.email ? true : false,
                }
                : undefined;
        };
        /**
         * Convert user friendly account recovery method to cognito AccountRecover enum.
         * This eliminates the need for users to import cognito.AccountRecovery.
         * @param method - account recovery method as a string value
         * @returns cognito.AccountRecovery enum value
         */
        this.convertAccountRecoveryStringToEnum = (method) => {
            if (method !== undefined) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery[method];
            }
            return undefined;
        };
        /**
         * Extract the MFA message settings and perform validation.
         * @param mfa - MFA settings
         * @returns mfa message
         */
        this.getMFAMessage = (mfa) => {
            if (mfa && mfa.mode !== 'OFF' && typeof mfa.sms === 'object') {
                const message = mfa.sms.smsMessage(() => MFA_SMS_PLACEHOLDERS.CODE);
                if (!message.includes(MFA_SMS_PLACEHOLDERS.CODE)) {
                    throw Error("Invalid MFA settings. Property 'smsMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                }
                return message;
            }
            return undefined;
        };
        /**
         * Setup External Providers (OAuth/OIDC/SAML) and related settings
         * such as OAuth settings and User Pool Domains
         */
        this.setupExternalProviders = (userPool, loginOptions) => {
            /**
             * If email is enabled, and is the only required attribute, we are able to
             * automatically map the email attribute from external providers, excluding SAML.
             */
            const shouldMapEmailAttributes = loginOptions.email && !loginOptions.phone;
            const result = {
                oAuthMappings: {},
                oAuthSettings: {
                    flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
                },
            };
            // external providers
            const external = loginOptions.externalProviders;
            if (!external) {
                return result;
            }
            // make sure logout/callback urls are not empty
            if (external.logoutUrls && external.logoutUrls.length === 0) {
                throw Error('You must define logoutUrls when configuring external login providers.');
            }
            if (external.callbackUrls && external.callbackUrls.length === 0) {
                throw Error('You must define callbackUrls when configuring external login providers.');
            }
            if (external.google) {
                const googleProps = external.google;
                result.google = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderGoogle(this, `${this.name}GoogleIdP`, {
                    userPool,
                    clientId: googleProps.clientId,
                    clientSecretValue: googleProps.clientSecret,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.GOOGLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(googleProps.attributeMapping),
                    },
                    scopes: googleProps.scopes,
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.google] =
                    external.google.clientId;
            }
            if (external.facebook) {
                result.facebook = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderFacebook(this, `${this.name}FacebookIDP`, {
                    userPool,
                    ...external.facebook,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.FACEBOOK_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.facebook.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.facebook] =
                    external.facebook.clientId;
            }
            if (external.loginWithAmazon) {
                result.amazon = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderAmazon(this, `${this.name}AmazonIDP`, {
                    userPool,
                    ...external.loginWithAmazon,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.AMAZON_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.loginWithAmazon.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.amazon] =
                    external.loginWithAmazon.clientId;
            }
            if (external.signInWithApple) {
                result.apple = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderApple(this, `${this.name}AppleIDP`, {
                    userPool,
                    ...external.signInWithApple,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.APPLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.signInWithApple.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.apple] =
                    external.signInWithApple.clientId;
            }
            if (external.oidc && external.oidc.length > 0) {
                result.oidc = [];
                external.oidc.forEach((provider, index) => {
                    var _a, _b;
                    const requestMethod = provider.attributeRequestMethod === undefined
                        ? 'GET' // default if not defined
                        : provider.attributeRequestMethod;
                    const generatedProvider = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderOidc(this, `${this.name}${(_a = provider.name) !== null && _a !== void 0 ? _a : index}OidcIDP`, {
                        userPool,
                        attributeRequestMethod: requestMethod === 'GET'
                            ? aws_cognito_1.OidcAttributeRequestMethod.GET
                            : aws_cognito_1.OidcAttributeRequestMethod.POST,
                        clientId: provider.clientId,
                        clientSecret: provider.clientSecret,
                        endpoints: provider.endpoints,
                        identifiers: provider.identifiers,
                        issuerUrl: provider.issuerUrl,
                        name: provider.name,
                        scopes: provider.scopes,
                        attributeMapping: {
                            ...(shouldMapEmailAttributes
                                ? {
                                    email: {
                                        attributeName: 'email',
                                    },
                                }
                                : undefined),
                            ...this.convertToCognitoAttributeMapping(provider.attributeMapping),
                        },
                    });
                    (_b = result.oidc) === null || _b === void 0 ? void 0 : _b.push(generatedProvider);
                });
            }
            if (external.saml) {
                const saml = external.saml;
                result.saml = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderSaml(this, `${this.name}SamlIDP`, {
                    userPool,
                    attributeMapping: this.convertToCognitoAttributeMapping(saml.attributeMapping),
                    identifiers: saml.identifiers,
                    idpSignout: saml.idpSignout,
                    metadata: {
                        metadataContent: saml.metadata.metadataContent,
                        metadataType: saml.metadata.metadataType === 'FILE'
                            ? aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.FILE
                            : aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.URL,
                    },
                    name: saml.name,
                });
            }
            // Always generate a domain prefix if external provider is configured
            if (this.domainPrefix) {
                this.userPool.addDomain(`${this.name}UserPoolDomain`, {
                    cognitoDomain: { domainPrefix: this.domainPrefix },
                });
            }
            else {
                throw new Error('Cognito Domain Prefix is missing when external providers are configured.');
            }
            // oauth settings for the UserPool client
            result.oAuthSettings = {
                callbackUrls: external.callbackUrls,
                logoutUrls: external.logoutUrls,
                scopes: external.scopes
                    ? this.getOAuthScopes(external.scopes)
                    : DEFAULT_OAUTH_SCOPES,
                flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
            };
            return result;
        };
        /**
         * Converts the simplified mapping type to cognito.AttributeMapping.
         * @param mapping the AttributeMapping to convert to a cognito.AttributeMapping
         * @returns cognito.AttributeMapping
         */
        this.convertToCognitoAttributeMapping = (mapping) => {
            if (!mapping) {
                return undefined;
            }
            const result = {};
            for (const [attrName, value] of Object.entries(mapping)) {
                if (typeof value === 'string') {
                    result[attrName] = {
                        attributeName: value,
                    };
                }
                if (typeof value === 'object' && attrName === 'custom') {
                    // dealing with custom attributes
                    const customAttributes = {};
                    for (const [customKey, attrName] of Object.entries(value)) {
                        customAttributes[customKey] = {
                            attributeName: attrName,
                        };
                    }
                    result[attrName] = customAttributes;
                }
            }
            return result;
        };
        /**
         * Convert scopes from string list to OAuthScopes.
         * @param scopes - scope list
         * @returns cognito OAuthScopes
         */
        this.getOAuthScopes = (scopes) => {
            if (scopes === undefined) {
                return [];
            }
            const result = [];
            for (const scope of scopes) {
                result.push(aws_cdk_lib_1.aws_cognito.OAuthScope[scope]);
            }
            return result;
        };
        /**
         * Get sign-in policy configuration for passwordless authentication.
         */
        this.getSignInPolicy = (props) => {
            const emailOtpEnabled = typeof props.loginWith.email === 'object' &&
                props.loginWith.email.otpLogin === true;
            const smsOtpEnabled = typeof props.loginWith.phone === 'object' &&
                props.loginWith.phone.otpLogin === true;
            const webAuthnEnabled = props.loginWith.webAuthn !== undefined;
            if (!emailOtpEnabled && !smsOtpEnabled && !webAuthnEnabled) {
                return undefined;
            }
            return {
                allowedFirstAuthFactors: {
                    // PASSWORD is always included per Cognito requirements
                    password: true,
                    emailOtp: emailOtpEnabled,
                    smsOtp: smsOtpEnabled,
                    passkey: webAuthnEnabled,
                },
            };
        };
        /**
         * Get passkey configuration for WebAuthn.
         */
        this.getPasskeyConfig = (props) => {
            const webAuthnEnabled = props.loginWith.webAuthn !== undefined;
            if (!webAuthnEnabled) {
                return {};
            }
            const webAuthnConfig = props.loginWith.webAuthn;
            let relyingPartyId;
            let userVerification;
            if (webAuthnConfig === true) {
                relyingPartyId = this.resolveRelyingPartyId('AUTO');
                userVerification = aws_cognito_1.PasskeyUserVerification.PREFERRED;
            }
            else {
                relyingPartyId = this.resolveRelyingPartyId(webAuthnConfig.relyingPartyId);
                userVerification =
                    webAuthnConfig.userVerification === 'required'
                        ? aws_cognito_1.PasskeyUserVerification.REQUIRED
                        : aws_cognito_1.PasskeyUserVerification.PREFERRED;
            }
            return { relyingPartyId, userVerification };
        };
        /**
         * Resolve the relying party ID for WebAuthn configuration.
         * Handles AUTO resolution based on deployment context.
         */
        this.resolveRelyingPartyId = (relyingPartyId) => {
            if (relyingPartyId !== 'AUTO') {
                return relyingPartyId;
            }
            const deploymentType = this.node.tryGetContext(platform_core_1.CDKContextKey.DEPLOYMENT_TYPE);
            if (deploymentType === 'branch') {
                const appId = this.node.tryGetContext(platform_core_1.CDKContextKey.BACKEND_NAMESPACE);
                const branchName = this.node.tryGetContext(platform_core_1.CDKContextKey.BACKEND_NAME);
                if (appId && branchName) {
                    return `${branchName}.${appId}.amplifyapp.com`;
                }
            }
            return 'localhost';
        };
        /**
         * Apply USER_AUTH flow to UserPoolClient when passwordless factors are enabled.
         */
        this.applyUserAuthFlow = (userPoolClient, props) => {
            const emailOtpEnabled = typeof props.loginWith.email === 'object' &&
                props.loginWith.email.otpLogin === true;
            const smsOtpEnabled = typeof props.loginWith.phone === 'object' &&
                props.loginWith.phone.otpLogin === true;
            const webAuthnEnabled = props.loginWith.webAuthn !== undefined;
            const hasPasswordlessFactors = emailOtpEnabled || smsOtpEnabled || webAuthnEnabled;
            if (!hasPasswordlessFactors) {
                return;
            }
            const cfnUserPoolClient = userPoolClient.node.findChild('Resource');
            if (!(cfnUserPoolClient instanceof aws_cognito_1.CfnUserPoolClient)) {
                throw Error('Could not find CfnUserPoolClient resource in stack.');
            }
            const existingFlows = cfnUserPoolClient.explicitAuthFlows || [];
            cfnUserPoolClient.explicitAuthFlows = [...existingFlows, 'ALLOW_USER_AUTH'];
        };
        /**
         * Validates that the preferredChallenge matches enabled authentication methods
         */
        this.validatePreferredChallenge = (props) => {
            var _a;
            const preferredChallenge = (_a = props.passwordlessOptions) === null || _a === void 0 ? void 0 : _a.preferredChallenge;
            if (!preferredChallenge) {
                return; // No validation needed if preferredChallenge is not set
            }
            const enabledChallenges = ['PASSWORD']; // PASSWORD is always available
            // Check for EMAIL_OTP
            if (props.loginWith.email &&
                typeof props.loginWith.email === 'object' &&
                props.loginWith.email.otpLogin) {
                enabledChallenges.push('EMAIL_OTP');
            }
            // Check for SMS_OTP
            if (props.loginWith.phone &&
                typeof props.loginWith.phone === 'object' &&
                props.loginWith.phone.otpLogin) {
                enabledChallenges.push('SMS_OTP');
            }
            // Check for WEB_AUTHN
            if (props.loginWith.webAuthn) {
                enabledChallenges.push('WEB_AUTHN');
            }
            if (!enabledChallenges.includes(preferredChallenge)) {
                throw new Error(`Preferred challenge "${preferredChallenge}" is not enabled in your authentication configuration. ` +
                    `Enabled challenges: ${enabledChallenges.join(', ')}. ` +
                    `This will result in a broken authentication flow in the frontend.`);
            }
        };
        /**
         * Stores auth output using the provided strategy
         */
        this.storeOutput = (outputStorageStrategy = new backend_output_storage_1.StackMetadataBackendOutputStorageStrategy(aws_cdk_lib_1.Stack.of(this))) => {
            const cfnUserPool = this.resources.cfnResources.cfnUserPool;
            const cfnUserPoolClient = this.resources.cfnResources.cfnUserPoolClient;
            const cfnIdentityPool = this.resources.cfnResources.cfnIdentityPool;
            // these properties cannot be overwritten
            const output = {
                userPoolId: this.resources.userPool.userPoolId,
                webClientId: this.resources.userPoolClient.userPoolClientId,
                identityPoolId: cfnIdentityPool.ref,
                authRegion: aws_cdk_lib_1.Stack.of(this).region,
            };
            // the properties below this line can be overwritten, so they are exposed via cdk LAZY
            output.allowUnauthenticatedIdentities = aws_cdk_lib_1.Lazy.string({
                produce: () => cfnIdentityPool.allowUnauthenticatedIdentities === true
                    ? 'true'
                    : 'false',
            });
            // extract signupAttributes from UserPool schema's required attributes
            output.signupAttributes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    if (!cfnUserPool.schema) {
                        return '[]';
                    }
                    return JSON.stringify(cfnUserPool.schema
                        .filter((attribute) => attribute.required && attribute.name)
                        .map((attribute) => { var _a; return (_a = attribute.name) === null || _a === void 0 ? void 0 : _a.toLowerCase(); }));
                },
            });
            // extract usernameAttributes from UserPool's usernameAttributes
            output.usernameAttributes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify(((_a = cfnUserPool.usernameAttributes) === null || _a === void 0 ? void 0 : _a.map((attr) => attr.toLowerCase())) ||
                        []);
                },
            });
            // extract verificationMechanisms from UserPool's autoVerifiedAttributes
            output.verificationMechanisms = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify((_a = cfnUserPool.autoVerifiedAttributes) !== null && _a !== void 0 ? _a : []);
                },
            });
            // extract the passwordPolicy from the UserPool policies
            output.passwordPolicyMinLength = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    if (!cfnUserPool.policies) {
                        return '';
                    }
                    const policy = cfnUserPool.policies
                        .passwordPolicy;
                    return (_a = policy.minimumLength) === null || _a === void 0 ? void 0 : _a.toString();
                },
            });
            output.passwordPolicyRequirements = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    if (!cfnUserPool.policies) {
                        return '';
                    }
                    const policy = cfnUserPool.policies
                        .passwordPolicy;
                    const requirements = [];
                    policy.requireNumbers && requirements.push('REQUIRES_NUMBERS');
                    policy.requireLowercase && requirements.push('REQUIRES_LOWERCASE');
                    policy.requireUppercase && requirements.push('REQUIRES_UPPERCASE');
                    policy.requireSymbols && requirements.push('REQUIRES_SYMBOLS');
                    return JSON.stringify(requirements);
                },
            });
            // extract the MFA configuration setting from the UserPool resource
            output.mfaConfiguration = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return (_a = cfnUserPool.mfaConfiguration) !== null && _a !== void 0 ? _a : 'OFF';
                },
            });
            // extract the MFA types from the UserPool resource
            output.mfaTypes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    const enabledMfas = (_a = cfnUserPool.enabledMfas) !== null && _a !== void 0 ? _a : [];
                    const mfaTypes = [];
                    enabledMfas.forEach((type) => {
                        if (type === 'SMS_MFA') {
                            mfaTypes.push('SMS');
                        }
                        if (type === 'SOFTWARE_TOKEN_MFA') {
                            mfaTypes.push('TOTP');
                        }
                        if (type === 'EMAIL_OTP') {
                            mfaTypes.push('EMAIL');
                        }
                    });
                    return JSON.stringify(mfaTypes);
                },
            });
            // extract passwordless configuration
            output.passwordlessOptions = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    const passwordlessConfig = {};
                    const signInPolicy = (_a = cfnUserPool.policies) === null || _a === void 0 ? void 0 : _a.signInPolicy;
                    if (signInPolicy) {
                        const allowedFactors = signInPolicy
                            .allowedFirstAuthFactors || [];
                        passwordlessConfig.emailOtpEnabled =
                            allowedFactors.includes('EMAIL_OTP');
                        passwordlessConfig.smsOtpEnabled = allowedFactors.includes('SMS_OTP');
                        if (allowedFactors.includes('WEB_AUTHN')) {
                            passwordlessConfig.webAuthn = {
                                relyingPartyId: cfnUserPool.webAuthnRelyingPartyId || '',
                                userVerification: cfnUserPool.webAuthnUserVerification || 'preferred',
                            };
                        }
                    }
                    if (this.preferredChallenge) {
                        passwordlessConfig.preferredChallenge = this.preferredChallenge;
                    }
                    return Object.keys(passwordlessConfig).length > 0
                        ? JSON.stringify(passwordlessConfig)
                        : '';
                },
            });
            // extract social providers from UserPool resource
            output.socialProviders = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const outputProviders = [];
                    const userPoolProviders = this.resources.userPool.identityProviders;
                    if (!userPoolProviders || userPoolProviders.length === 0) {
                        return '';
                    }
                    for (const provider of userPoolProviders) {
                        const providerResource = provider.node.findChild('Resource');
                        if (!(providerResource instanceof aws_cognito_1.CfnUserPoolIdentityProvider)) {
                            throw Error('Could not find the CfnUserPoolIdentityProvider resource in the stack.');
                        }
                        const providerType = providerResource.providerType;
                        const providerName = providerResource.providerName;
                        if (providerType === 'Google') {
                            outputProviders.push('GOOGLE');
                        }
                        if (providerType === 'Facebook') {
                            outputProviders.push('FACEBOOK');
                        }
                        if (providerType === 'SignInWithApple') {
                            outputProviders.push('SIGN_IN_WITH_APPLE');
                        }
                        if (providerType === 'LoginWithAmazon') {
                            outputProviders.push('LOGIN_WITH_AMAZON');
                        }
                        if (providerType === 'OIDC') {
                            outputProviders.push(providerName);
                        }
                        if (providerType === 'SAML') {
                            outputProviders.push(providerName);
                        }
                    }
                    return JSON.stringify(outputProviders);
                },
            });
            output.oauthCognitoDomain = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const userPoolDomain = this.resources.userPool.node.tryFindChild(`${this.name}UserPoolDomain`);
                    if (!userPoolDomain) {
                        return '';
                    }
                    if (!(userPoolDomain instanceof aws_cognito_1.UserPoolDomain)) {
                        throw Error('Could not find UserPoolDomain resource in the stack.');
                    }
                    return `${userPoolDomain.domainName}.auth.${aws_cdk_lib_1.Stack.of(this).region}.amazoncognito.com`;
                },
            });
            output.oauthScope = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify((_a = cfnUserPoolClient.allowedOAuthScopes) !== null && _a !== void 0 ? _a : []);
                },
            });
            output.oauthRedirectSignIn = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.callbackUrLs
                        ? cfnUserPoolClient.callbackUrLs.join(',')
                        : '';
                },
            });
            output.oauthRedirectSignOut = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.logoutUrLs
                        ? cfnUserPoolClient.logoutUrLs.join(',')
                        : '';
                },
            });
            output.oauthResponseType = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.allowedOAuthFlows
                        ? cfnUserPoolClient.allowedOAuthFlows.join(',')
                        : '';
                },
            });
            output.oauthClientId = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.ref;
                },
            });
            // user group precedence can be overwritten, so they are exposed via cdk LAZY
            output.groups = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const groupsArray = [];
                    Object.keys(this.resources.groups).forEach((groupName) => {
                        const precedence = this.resources.groups[groupName].cfnUserGroup.precedence;
                        groupsArray.push({
                            [groupName]: {
                                precedence,
                            },
                        });
                    }, {});
                    return JSON.stringify(groupsArray);
                },
            });
            outputStorageStrategy.addBackendOutputEntry(backend_output_schemas_1.authOutputKey, {
                version: '1',
                payload: output,
            });
        };
        this.name = (_a = props.name) !== null && _a !== void 0 ? _a : '';
        this.domainPrefix = (_b = props.loginWith.externalProviders) === null || _b === void 0 ? void 0 : _b.domainPrefix;
        // Validate preferredChallenge against enabled authentication methods before setting
        this.validatePreferredChallenge(props);
        this.preferredChallenge = (_c = props.passwordlessOptions) === null || _c === void 0 ? void 0 : _c.preferredChallenge;
        // UserPool
        this.computedUserPoolProps = this.getUserPoolProps(props);
        this.userPool = new aws_cdk_lib_1.aws_cognito.UserPool(this, `${this.name}UserPool`, this.computedUserPoolProps);
        /**
         * Configure custom email sender for Cognito User Pool
         * Grant necessary permissions for Lambda function to decrypt emails
         * and allow Cognito to invoke the Lambda function
         */
        if (((_d = props.senders) === null || _d === void 0 ? void 0 : _d.email) &&
            'handler' in props.senders.email &&
            this.customSenderKMSkey) {
            this.customSenderKMSkey.grantDecrypt(props.senders.email.handler);
            this.customSenderKMSkey.grantEncrypt(props.senders.email.handler);
            this.userPool.addTrigger(aws_cognito_1.UserPoolOperation.of('customEmailSender'), props.senders.email.handler);
        }
        /**
         * Configure custom sms sender for Cognito User Pool
         * Grant necessary permissions for Lambda function to decrypt the requests
         * and allow Cognito to invoke the Lambda function
         */
        if (((_e = props.senders) === null || _e === void 0 ? void 0 : _e.sms) &&
            'handler' in props.senders.sms &&
            this.customSenderKMSkey) {
            this.customSenderKMSkey.grantDecrypt(props.senders.sms.handler);
            this.customSenderKMSkey.grantEncrypt(props.senders.sms.handler);
            this.userPool.addTrigger(aws_cognito_1.UserPoolOperation.of('customSmsSender'), props.senders.sms.handler);
        }
        // UserPool - External Providers (Oauth, SAML, OIDC) and User Pool Domain
        this.providerSetupResult = this.setupExternalProviders(this.userPool, props.loginWith);
        // UserPool Client
        const userPoolClient = new aws_cdk_lib_1.aws_cognito.UserPoolClient(this, `${this.name}UserPoolAppClient`, {
            userPool: this.userPool,
            authFlows: defaults_js_1.DEFAULTS.AUTH_FLOWS,
            preventUserExistenceErrors: defaults_js_1.DEFAULTS.PREVENT_USER_EXISTENCE_ERRORS,
            oAuth: this.providerSetupResult.oAuthSettings,
        });
        this.applyUserAuthFlow(userPoolClient, props);
        // Identity Pool
        const { identityPool, identityPoolRoleAttachment, roles: { auth, unAuth }, } = this.setupIdentityPool(this.userPool, userPoolClient, this.providerSetupResult);
        // Setup UserPool groups
        this.setupUserPoolGroups(props.groups, identityPool);
        const cfnUserPool = this.userPool.node.findChild('Resource');
        if (!(cfnUserPool instanceof aws_cognito_1.CfnUserPool)) {
            throw Error('Could not find CfnUserPool resource in stack.');
        }
        const cfnUserPoolClient = userPoolClient.node.findChild('Resource');
        if (!(cfnUserPoolClient instanceof aws_cognito_1.CfnUserPoolClient)) {
            throw Error('Could not find CfnUserPoolClient resource in stack.');
        }
        // expose resources
        this.resources = {
            userPool: this.userPool,
            userPoolClient,
            authenticatedUserIamRole: auth,
            unauthenticatedUserIamRole: unAuth,
            identityPoolId: identityPool.ref,
            cfnResources: {
                cfnUserPool,
                cfnUserPoolClient,
                cfnIdentityPool: identityPool,
                cfnIdentityPoolRoleAttachment: identityPoolRoleAttachment,
            },
            groups: this.groups,
        };
        this.storeOutput(props.outputStorageStrategy);
        new backend_output_storage_1.AttributionMetadataStorage().storeAttributionMetadata(aws_cdk_lib_1.Stack.of(this), authStackType, path.resolve(__dirname, '..', 'package.json'));
    }
    /**
     * Sanitize customer input and return Cognito User pool compatible Sms configurations
     */
    getSmsConfiguration(props) {
        if (!props || 'handler' in props) {
            // Either no configuration or custom sender is configured
            return undefined;
        }
        if ((props.snsCallerArn && !props.externalId) ||
            (!props.snsCallerArn && props.externalId)) {
            throw new Error('Both externalId and snsCallerArn are required when providing a custom IAM role. Ensure that your IAM role trust policy have an sts:ExternalId condition and is equal to the externalId value');
        }
        return {
            externalId: 'externalId' in props ? props.externalId : undefined,
            snsCallerArn: 'snsCallerArn' in props && props.snsCallerArn
                ? aws_iam_1.Role.fromRoleArn(this, `${this.name}SmsSenderRole`, props.snsCallerArn)
                : undefined,
            snsRegion: props.snsRegion,
            enableSMSRole: !!props,
        };
    }
    /**
     * Parses the user invitation settings and inserts codes/usernames where necessary.
     * @param settings the invitation settings
     * @returns cognito.UserInvitationConfig | undefined
     */
    getUserInvitationSettings(settings) {
        if (!settings) {
            return undefined;
        }
        return {
            emailSubject: settings.emailSubject,
            emailBody: settings.emailBody
                ? settings.emailBody(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
            smsMessage: settings.smsMessage
                ? settings.smsMessage(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
        };
    }
    /**
     * Verify the email body depending on if 'CODE' or 'LINK' style is used.
     * This ensures that the template contains the necessary placeholders for Cognito to insert verification codes or links.
     * @param emailSettings the provided email settings
     * @returns emailBody
     */
    verifyEmailBody(emailSettings) {
        let emailBody;
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle !== 'LINK') {
            emailBody = emailSettings.verificationEmailBody(() => VERIFICATION_EMAIL_PLACEHOLDERS.CODE);
            if (!emailBody.includes(VERIFICATION_EMAIL_PLACEHOLDERS.CODE)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
            }
        }
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle === 'LINK') {
            let linkText = '';
            emailBody = emailSettings.verificationEmailBody((text) => {
                linkText = text
                    ? `{##${text}##}`
                    : VERIFICATION_EMAIL_PLACEHOLDERS.LINK;
                return linkText;
            });
            if (linkText === '' || !emailBody.includes(linkText)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'link' parameter at least once as a placeholder for the verification link.");
            }
        }
        return emailBody;
    }
}
exports.AmplifyAuth = AmplifyAuth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBdUM7QUFDdkMsNkNBS3FCO0FBTXJCLHlEQTJCaUM7QUFDakMsaURBQStEO0FBQy9ELGdGQUFnRjtBQVVoRiwrQ0FBeUM7QUFDekMsZ0ZBRzZDO0FBQzdDLDJDQUE2QjtBQUM3QixpREFBZ0Q7QUFDaEQsOERBQTJEO0FBbUIzRCxNQUFNLGdDQUFnQyxHQUF5QjtJQUM3RCxRQUFRLEVBQUUsb0JBQW9CO0lBQzlCLE1BQU0sRUFBRSxxQkFBcUI7SUFDN0IsTUFBTSxFQUFFLGdCQUFnQjtJQUN4QixLQUFLLEVBQUUsbUJBQW1CO0NBQzNCLENBQUM7QUFDRixNQUFNLHVCQUF1QixHQUFHO0lBQzlCLElBQUksRUFBRSxRQUFRO0lBQ2QsUUFBUSxFQUFFLFlBQVk7Q0FDdkIsQ0FBQztBQUNGLE1BQU0sK0JBQStCLEdBQUc7SUFDdEMsSUFBSSxFQUFFLFFBQVE7SUFDZCxJQUFJLEVBQUUsb0JBQW9CO0NBQzNCLENBQUM7QUFDRixNQUFNLDZCQUE2QixHQUFHO0lBQ3BDLElBQUksRUFBRSxRQUFRO0NBQ2YsQ0FBQztBQUNGLE1BQU0sb0JBQW9CLEdBQUc7SUFDM0IsSUFBSSxFQUFFLFFBQVE7Q0FDZixDQUFDO0FBQ0YsTUFBTSxvQkFBb0IsR0FBRztJQUMzQix3QkFBVSxDQUFDLEtBQUs7SUFDaEIsd0JBQVUsQ0FBQyxLQUFLO0lBQ2hCLHdCQUFVLENBQUMsTUFBTTtJQUNqQix3QkFBVSxDQUFDLE9BQU87SUFDbEIsd0JBQVUsQ0FBQyxhQUFhO0NBQ3pCLENBQUM7QUFFRixzSEFBc0g7QUFDdEgsTUFBTSxhQUFhLEdBQUcsY0FBYyxDQUFDO0FBRXJDOztHQUVHO0FBQ0gsTUFBYSxXQUNYLFNBQVEsc0JBQVM7SUFxQ2pCOzs7T0FHRztJQUNILFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLFFBQW1CLHNCQUFRLENBQUMsb0JBQW9COztRQUVoRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBMUJGLFdBQU0sR0FLbkIsRUFBRSxDQUFDO1FBNklQOzs7V0FHRztRQUNLLDRCQUF1QixHQUFHLENBQUMsY0FBc0IsRUFBZ0IsRUFBRTtZQUN6RSxNQUFNLE1BQU0sR0FBaUI7Z0JBQzNCLElBQUksRUFBRSxJQUFJLGNBQUksQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSx1QkFBdUIsRUFBRTtvQkFDeEQsU0FBUyxFQUFFLElBQUksNEJBQWtCLENBQy9CLGdDQUFnQyxFQUNoQzt3QkFDRSxZQUFZLEVBQUU7NEJBQ1osb0NBQW9DLEVBQUUsY0FBYzt5QkFDckQ7d0JBQ0Qsd0JBQXdCLEVBQUU7NEJBQ3hCLG9DQUFvQyxFQUFFLGVBQWU7eUJBQ3REO3FCQUNGLEVBQ0QsK0JBQStCLENBQ2hDO2lCQUNGLENBQUM7Z0JBQ0YsTUFBTSxFQUFFLElBQUksY0FBSSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLHlCQUF5QixFQUFFO29CQUM1RCxTQUFTLEVBQUUsSUFBSSw0QkFBa0IsQ0FDL0IsZ0NBQWdDLEVBQ2hDO3dCQUNFLFlBQVksRUFBRTs0QkFDWixvQ0FBb0MsRUFBRSxjQUFjO3lCQUNyRDt3QkFDRCx3QkFBd0IsRUFBRTs0QkFDeEIsb0NBQW9DLEVBQUUsaUJBQWlCO3lCQUN4RDtxQkFDRixFQUNELCtCQUErQixDQUNoQztpQkFDRixDQUFDO2FBQ0gsQ0FBQztZQUNGLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztRQUVGOztXQUVHO1FBQ0ssd0JBQW1CLEdBQUcsQ0FDNUIsTUFBNEIsRUFDNUIsWUFBNkIsRUFDN0IsRUFBRTtZQUNGLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsRUFBRTtnQkFDMUMsTUFBTSxTQUFTLEdBQUcsSUFBSSxjQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxTQUFTLFdBQVcsRUFBRTtvQkFDcEUsU0FBUyxFQUFFLElBQUksNEJBQWtCLENBQy9CLGdDQUFnQyxFQUNoQzt3QkFDRSxZQUFZLEVBQUU7NEJBQ1osb0NBQW9DLEVBQUUsWUFBWSxDQUFDLEdBQUc7eUJBQ3ZEO3dCQUNELHdCQUF3QixFQUFFOzRCQUN4QixvQ0FBb0MsRUFBRSxlQUFlO3lCQUN0RDtxQkFDRixFQUNELCtCQUErQixDQUNoQztpQkFDRixDQUFDLENBQUM7Z0JBQ0gsTUFBTSxZQUFZLEdBQUcsSUFBSSw4QkFBZ0IsQ0FDdkMsSUFBSSxFQUNKLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxTQUFTLE9BQU8sRUFDL0I7b0JBQ0UsVUFBVSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVTtvQkFDcEMsU0FBUyxFQUFFLFNBQVM7b0JBQ3BCLE9BQU8sRUFBRSxTQUFTLENBQUMsT0FBTztvQkFDMUIsVUFBVSxFQUFFLEtBQUs7aUJBQ2xCLENBQ0YsQ0FBQztnQkFDRixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHO29CQUN2QixZQUFZLEVBQUUsWUFBWTtvQkFDMUIsSUFBSSxFQUFFLFNBQVM7aUJBQ2hCLENBQUM7WUFDSixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQztRQUVGOztXQUVHO1FBQ0ssc0JBQWlCLEdBQUcsQ0FDMUIsUUFBa0IsRUFDbEIsY0FBOEIsRUFDOUIsbUJBQWdELEVBQ2hELEVBQUU7WUFDRixzQkFBc0I7WUFDdEIsTUFBTSxNQUFNLEdBQUcsbUJBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQ3JDLE1BQU0sWUFBWSxHQUFHLElBQUkseUJBQU8sQ0FBQyxlQUFlLENBQzlDLElBQUksRUFDSixHQUFHLElBQUksQ0FBQyxJQUFJLGNBQWMsRUFDMUI7Z0JBQ0UsOEJBQThCLEVBQzVCLHNCQUFRLENBQUMsZ0NBQWdDO2FBQzVDLENBQ0YsQ0FBQztZQUNGLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDN0QsTUFBTSwwQkFBMEIsR0FDOUIsSUFBSSx5QkFBTyxDQUFDLDZCQUE2QixDQUN2QyxJQUFJLEVBQ0osR0FBRyxJQUFJLENBQUMsSUFBSSw0QkFBNEIsRUFDeEM7Z0JBQ0UsY0FBYyxFQUFFLFlBQVksQ0FBQyxHQUFHO2dCQUNoQyxLQUFLLEVBQUU7b0JBQ0wsZUFBZSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTztvQkFDckMsYUFBYSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTztpQkFDbEM7Z0JBQ0QsWUFBWSxFQUFFO29CQUNaLDRCQUE0QixFQUFFO3dCQUM1QixJQUFJLEVBQUUsT0FBTzt3QkFDYix1QkFBdUIsRUFBRSxtQkFBbUI7d0JBQzVDLGdCQUFnQixFQUFFLGVBQWUsTUFBTSxrQkFBa0IsUUFBUSxDQUFDLFVBQVUsSUFBSSxjQUFjLENBQUMsZ0JBQWdCLEVBQUU7cUJBQ2xIO2lCQUNGO2FBQ0YsQ0FDRixDQUFDO1lBQ0osMEJBQTBCLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3ZELDBCQUEwQixDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDOUQsdUJBQXVCO1lBQ3ZCLFlBQVksQ0FBQyx3QkFBd0IsR0FBRztnQkFDdEM7b0JBQ0UsUUFBUSxFQUFFLGNBQWMsQ0FBQyxnQkFBZ0I7b0JBQ3pDLFlBQVksRUFBRSxlQUFlLE1BQU0sa0JBQWtCLFFBQVEsQ0FBQyxVQUFVLEVBQUU7aUJBQzNFO2FBQ0YsQ0FBQztZQUNGLHNCQUFzQjtZQUN0QixZQUFZLENBQUMsdUJBQXVCLEdBQUcsbUJBQW1CLENBQUMsYUFBYSxDQUFDO1lBQ3pFLE9BQU87Z0JBQ0wsWUFBWTtnQkFDWiwwQkFBMEI7Z0JBQzFCLEtBQUs7YUFDTixDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRUY7O1dBRUc7UUFDSyx3QkFBbUIsR0FBRyxDQUM1QixHQUFXLEVBQ1gsU0FBMEIsRUFDZ0IsRUFBRTs7WUFDNUMsTUFBTSxVQUFVLEdBQTBCO2dCQUN4QyxRQUFRLEVBQUUsU0FBUyxDQUFDLFFBQVE7Z0JBRTVCLE9BQU8sRUFBRSxNQUFBLFNBQVMsQ0FBQyxPQUFPLG1DQUFJLElBQUk7YUFDbkMsQ0FBQztZQUVGLElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQztZQUNyQiw2REFBNkQ7WUFDN0QsSUFBSSxTQUFTLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO2dCQUNwQyxXQUFXLEdBQUc7b0JBQ1osaUJBQWlCLEVBQUU7d0JBQ2pCLE1BQU0sRUFBRSxTQUFTLENBQUMsTUFBTTt3QkFFeEIsTUFBTSxFQUFFLFNBQVMsQ0FBQyxNQUFNO3FCQUN6QjtpQkFDRixDQUFDO1lBQ0osQ0FBQztpQkFBTSxJQUFJLFNBQVMsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzNDLFdBQVcsR0FBRztvQkFDWixpQkFBaUIsRUFBRTt3QkFDakIsR0FBRyxFQUFFLFNBQVMsQ0FBQyxHQUFHO3dCQUVsQixHQUFHLEVBQUUsU0FBUyxDQUFDLEdBQUc7cUJBQ25CO2lCQUNGLENBQUM7WUFDSixDQUFDO1lBQ0QsNEZBQTRGO1lBQzVGLE1BQU0sTUFBTSxHQUFHO2dCQUNiLEdBQUcsVUFBVTtnQkFFYixHQUFHLFdBQVc7YUFDZixDQUFDO1lBRUYsT0FBTztnQkFDTCxHQUFHLE1BQU07Z0JBRVQsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLE1BQU07YUFDbkIsQ0FBQztRQUNKLENBQUMsQ0FBQztRQUNGOztXQUVHO1FBQ0sscUJBQWdCLEdBQUcsQ0FBQyxLQUFnQixFQUFpQixFQUFFOztZQUM3RCxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDMUQsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQzFELE1BQU0saUJBQWlCLEdBQUcsWUFBWSxJQUFJLFlBQVksQ0FBQztZQUN2RCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztnQkFDdkIsTUFBTSxLQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQztZQUNqRSxDQUFDO1lBQ0QsSUFBSSx3QkFBd0IsR0FBbUMsRUFBRSxDQUFDO1lBQ2xFLHVEQUF1RDtZQUN2RCxJQUFJLE9BQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzlDLE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO2dCQUM1Qyw2RUFBNkU7Z0JBQzdFLE1BQU0sU0FBUyxHQUF1QixJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUMxRSx3QkFBd0IsR0FBRztvQkFDekIsU0FBUyxFQUFFLFNBQVM7b0JBQ3BCLFVBQVUsRUFBRSxJQUFJLENBQUMseUJBQXlCLENBQ3hDLGFBQWEsQ0FBQyxzQkFBc0IsQ0FDckM7b0JBQ0QsWUFBWSxFQUFFLGFBQWEsQ0FBQyx3QkFBd0I7aUJBQ3JELENBQUM7WUFDSixDQUFDO1lBQ0QsdURBQXVEO1lBQ3ZELElBQUksT0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssS0FBSyxRQUFRLEVBQUUsQ0FBQztnQkFDOUMsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUM7Z0JBQzVDLElBQUksVUFBOEIsQ0FBQztnQkFDbkMsSUFDRSxhQUFhLENBQUMsbUJBQW1CO29CQUNqQyxPQUFPLGFBQWEsQ0FBQyxtQkFBbUIsS0FBSyxVQUFVLEVBQ3ZELENBQUM7b0JBQ0QsaUNBQWlDO29CQUNqQyxVQUFVLEdBQUcsYUFBYSxDQUFDLG1CQUFtQixDQUM1QyxHQUFHLEVBQUUsQ0FBQyw2QkFBNkIsQ0FBQyxJQUFJLENBQ3pDLENBQUM7b0JBQ0YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsNkJBQTZCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQzt3QkFDN0QsTUFBTSxLQUFLLENBQ1Qsb0pBQW9KLENBQ3JKLENBQUM7b0JBQ0osQ0FBQztnQkFDSCxDQUFDO2dCQUNELHdCQUF3QixHQUFHO29CQUN6QixHQUFHLHdCQUF3QjtvQkFDM0IsVUFBVSxFQUFFLFVBQVU7aUJBQ3ZCLENBQUM7WUFDSixDQUFDO1lBQ0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDbkQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFbkQsOEZBQThGO1lBQzlGLElBQUksWUFBWSxJQUFJLE9BQU8sSUFBSSxPQUFPLEtBQUssS0FBSyxJQUFJLENBQUMsQ0FBQSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsR0FBRyxDQUFBLEVBQUUsQ0FBQztnQkFDbEUsTUFBTSxLQUFLLENBQ1Qsd0ZBQXdGLENBQ3pGLENBQUM7WUFDSixDQUFDO1lBRUQsTUFBTSxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FDN0QsTUFBQSxLQUFLLENBQUMsY0FBYyxtQ0FBSSxFQUFFLENBQzNCLENBQUMsTUFBTSxDQUNOLENBQ0UsR0FLQyxFQUNELENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUNaLEVBQUU7Z0JBQ0YsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7b0JBQzlCLE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUNsRCxHQUFHLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUMzRCxZQUFZLEVBQ1osS0FBSyxDQUNOLENBQUM7Z0JBQ0osQ0FBQztxQkFBTSxDQUFDO29CQUNOLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7Z0JBQ3RDLENBQUM7Z0JBQ0QsT0FBTyxHQUFHLENBQUM7WUFDYixDQUFDLEVBQ0QsRUFBRSxrQkFBa0IsRUFBRSxFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRSxFQUFFLENBQ2pELENBQUM7WUFDRjs7Ozs7O2VBTUc7WUFDSCxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDbEIsTUFBTSxlQUFlLEdBQ25CLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLFNBQVMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUc7b0JBQ2pELENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUc7b0JBQ25CLENBQUMsQ0FBQyxTQUFTLENBQUM7Z0JBQ2hCLE1BQU0saUJBQWlCLEdBQ3JCLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLFNBQVMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUs7b0JBQ3JELENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUs7b0JBQ3JCLENBQUMsQ0FBQyxTQUFTLENBQUM7Z0JBQ2hCLG1GQUFtRjtnQkFDbkYsSUFDRSxlQUFlO29CQUNmLGlCQUFpQjtvQkFDakIsZUFBZSxDQUFDLFNBQVM7b0JBQ3pCLGlCQUFpQixDQUFDLFNBQVM7b0JBQzNCLGVBQWUsQ0FBQyxTQUFTLEtBQUssaUJBQWlCLENBQUMsU0FBUyxFQUN6RCxDQUFDO29CQUNELE1BQU0sSUFBSSxLQUFLLENBQ2IsNkRBQTZELENBQzlELENBQUM7Z0JBQ0osQ0FBQztxQkFBTSxJQUNMLENBQUMsZUFBZSxJQUFJLGVBQWUsQ0FBQyxTQUFTLENBQUM7b0JBQzlDLENBQUMsaUJBQWlCLElBQUksaUJBQWlCLENBQUMsU0FBUyxDQUFDLEVBQ2xELENBQUM7b0JBQ0Qsc0VBQXNFO29CQUN0RSxNQUFNLFNBQVMsR0FDYixNQUFBLGVBQWUsYUFBZixlQUFlLHVCQUFmLGVBQWUsQ0FBRSxTQUFTLG1DQUFJLGlCQUFpQixhQUFqQixpQkFBaUIsdUJBQWpCLGlCQUFpQixDQUFFLFNBQVMsQ0FBQztvQkFDN0QsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGFBQUcsQ0FBQyxVQUFVLENBQ3RDLElBQUksRUFDSixHQUFHLElBQUksQ0FBQyxJQUFJLGlCQUFpQixFQUM3QixTQUFVLENBQ1gsQ0FBQztnQkFDSixDQUFDO3FCQUFNLElBQUksZUFBZSxJQUFJLGlCQUFpQixFQUFFLENBQUM7b0JBQ2hELENBQUM7d0JBQ0Msc0ZBQXNGO3dCQUN0RixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxhQUFHLENBQy9CLGVBQWU7NEJBQ2IsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsS0FBSzs0QkFDL0IsQ0FBQyxDQUFDLGlCQUFrQixDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUseUVBQXlFO3dCQUMvRyxHQUFHLElBQUksQ0FBQyxJQUFJLGlCQUFpQixFQUM3Qjs0QkFDRSxpQkFBaUIsRUFBRSxJQUFJO3lCQUN4QixDQUNGLENBQUM7b0JBQ0osQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQztZQUNELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQUEsS0FBSyxDQUFDLE9BQU8sMENBQUUsR0FBRyxDQUFDLENBQUM7WUFDdEUsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNqRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkQsTUFBTSxhQUFhLEdBQWtCO2dCQUNuQyxtQkFBbUIsRUFBRSxzQkFBUSxDQUFDLHNCQUFzQjtnQkFDcEQsYUFBYSxFQUFFO29CQUNiLEtBQUssRUFBRSxZQUFZO29CQUNuQixLQUFLLEVBQUUsWUFBWTtpQkFDcEI7Z0JBQ0QsR0FBRyxDQUFDLFlBQVksSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDO2dCQUNyQyxHQUFHLENBQUMsYUFBYSxDQUFDLGNBQWMsSUFBSTtvQkFDbEMscUJBQXFCLEVBQUUsYUFBYSxDQUFDLGNBQWM7aUJBQ3BELENBQUM7Z0JBQ0YsR0FBRyxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsSUFBSTtvQkFDcEMsdUJBQXVCLEVBQUUsYUFBYSxDQUFDLGdCQUFnQjtpQkFDeEQsQ0FBQztnQkFDRixZQUFZLEVBQUU7b0JBQ1osS0FBSyxFQUFFLFlBQVk7b0JBQ25CLEtBQUssRUFBRSxZQUFZO2lCQUNwQjtnQkFDRCxVQUFVLEVBQUU7b0JBQ1YsS0FBSyxFQUFFLFlBQVk7b0JBQ25CLEtBQUssRUFBRSxZQUFZO2lCQUNwQjtnQkFDRCxnQkFBZ0IsRUFBRSx3QkFBd0I7Z0JBQzFDLGNBQWMsRUFBRSxzQkFBUSxDQUFDLGVBQWU7Z0JBQ3hDLGtCQUFrQixFQUFFO29CQUNsQixLQUFLLEVBQUUsc0JBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDO29CQUN6RCxXQUFXLEVBQUUsc0JBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDO29CQUNyRSxHQUFHLGtCQUFrQjtpQkFDdEI7Z0JBQ0QsZ0JBQWdCLEVBQUU7b0JBQ2hCLEdBQUcsZ0JBQWdCO2lCQUNwQjtnQkFDRCxLQUFLLEVBQ0gsQ0FBQSxNQUFBLEtBQUssQ0FBQyxPQUFPLDBDQUFFLEtBQUssS0FBSSxXQUFXLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLO29CQUN4RCxDQUFDLENBQUMseUJBQU8sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDO3dCQUM1QixTQUFTLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUzt3QkFDeEMsUUFBUSxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVE7d0JBQ3RDLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPO3dCQUNwQyxTQUFTLEVBQUUsbUJBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTTtxQkFDakMsQ0FBQztvQkFDSixDQUFDLENBQUMsU0FBUztnQkFDZixPQUFPLEVBQUUsZ0JBQWdCLGFBQWhCLGdCQUFnQix1QkFBaEIsZ0JBQWdCLENBQUUsWUFBWTtnQkFDdkMsaUJBQWlCLEVBQUUsZ0JBQWdCLGFBQWhCLGdCQUFnQix1QkFBaEIsZ0JBQWdCLENBQUUsVUFBVTtnQkFDL0MsU0FBUyxFQUFFLGdCQUFnQixhQUFoQixnQkFBZ0IsdUJBQWhCLGdCQUFnQixDQUFFLFNBQVM7Z0JBQ3RDLGFBQWEsRUFBRSxnQkFBZ0IsYUFBaEIsZ0JBQWdCLHVCQUFoQixnQkFBZ0IsQ0FBRSxhQUFhO2dCQUM5QyxpQkFBaUIsRUFBRSxzQkFBUSxDQUFDLGtCQUFrQjtnQkFDOUMsR0FBRyxFQUFFLE9BQU87Z0JBQ1osVUFBVSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQztnQkFDakQsZUFBZSxFQUFFLE9BQU87Z0JBQ3hCLGVBQWUsRUFBRSxJQUFJLENBQUMseUJBQXlCLENBQzdDLFlBQVksRUFDWixZQUFZLEVBQ1osS0FBSyxDQUFDLGVBQWUsQ0FDdEI7Z0JBQ0QsYUFBYSxFQUFFLDJCQUFhLENBQUMsT0FBTztnQkFDcEMsY0FBYyxFQUNaLE9BQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEtBQUssU0FBUztvQkFDeEMsQ0FBQyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsQ0FDNUIsTUFBQSxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssMENBQUUsY0FBYyxDQUN0QztvQkFDSCxDQUFDLENBQUMsU0FBUztnQkFDZixrQkFBa0IsRUFBRSxJQUFJLENBQUMsa0JBQWtCO2dCQUMzQyxZQUFZLEVBQUUsS0FBSyxDQUFDLElBQUksSUFBSSxTQUFTO2FBQ3RDLENBQUM7WUFDRixPQUFPLGFBQWEsQ0FBQztRQUN2QixDQUFDLENBQUM7UUEwR0Y7Ozs7V0FJRztRQUNLLDhCQUF5QixHQUFHLENBQ2xDLHNCQUFtRCxFQUNQLEVBQUU7WUFDOUMsSUFBSSxzQkFBc0IsS0FBSyxNQUFNLEVBQUUsQ0FBQztnQkFDdEMsT0FBTyx5QkFBTyxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQztZQUM3QyxDQUFDO2lCQUFNLElBQUksc0JBQXNCLEtBQUssTUFBTSxFQUFFLENBQUM7Z0JBQzdDLE9BQU8seUJBQU8sQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUM7WUFDN0MsQ0FBQztZQUNELE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUMsQ0FBQztRQUVGOzs7Ozs7V0FNRztRQUNLLDhCQUF5QixHQUFHLENBQ2xDLFlBQXFCLEVBQ3JCLFlBQXFCLEVBQ3JCLDZCQUEyRCxFQUN0QixFQUFFO1lBQ3ZDLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxrQ0FBa0MsQ0FDN0QsNkJBQTZCLENBQzlCLENBQUM7WUFDRixJQUFJLGVBQWUsS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDbEMsT0FBTyxlQUFlLENBQUM7WUFDekIsQ0FBQztZQUNELDZDQUE2QztZQUM3QyxJQUFJLFlBQVksSUFBSSxZQUFZLEVBQUUsQ0FBQztnQkFDakMsT0FBTyx5QkFBTyxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUM7WUFDNUMsQ0FBQztZQUNELElBQUksWUFBWSxFQUFFLENBQUM7Z0JBQ2pCLE9BQU8seUJBQU8sQ0FBQyxlQUFlLENBQUMsc0JBQXNCLENBQUM7WUFDeEQsQ0FBQztZQUNELElBQUksWUFBWSxFQUFFLENBQUM7Z0JBQ2pCLE9BQU8seUJBQU8sQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDO1lBQzVDLENBQUM7WUFDRCxPQUFPLFNBQVMsQ0FBQztRQUNuQixDQUFDLENBQUM7UUFFRjs7Ozs7V0FLRztRQUNLLGVBQVUsR0FBRyxDQUFDLEdBQTZCLEVBQW1CLEVBQUU7WUFDdEUsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDUixRQUFRLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztvQkFDakIsS0FBSyxLQUFLO3dCQUNSLE9BQU8saUJBQUcsQ0FBQyxHQUFHLENBQUM7b0JBQ2pCLEtBQUssVUFBVTt3QkFDYixPQUFPLGlCQUFHLENBQUMsUUFBUSxDQUFDO29CQUN0QixLQUFLLFVBQVU7d0JBQ2IsT0FBTyxpQkFBRyxDQUFDLFFBQVEsQ0FBQztnQkFDeEIsQ0FBQztZQUNILENBQUM7WUFDRCxPQUFPLFNBQVMsQ0FBQztRQUNuQixDQUFDLENBQUM7UUFFRjs7Ozs7V0FLRztRQUNLLGVBQVUsR0FBRyxDQUNuQixHQUE2QixFQUNBLEVBQUU7WUFDL0IsT0FBTyxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksR0FBRyxDQUFDLElBQUksS0FBSyxLQUFLO2dCQUNsRCxDQUFDLENBQUM7b0JBQ0UsR0FBRyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSztvQkFDM0IsR0FBRyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSztvQkFDNUIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSztpQkFDaEM7Z0JBQ0gsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNoQixDQUFDLENBQUM7UUFFRjs7Ozs7V0FLRztRQUNLLHVDQUFrQyxHQUFHLENBQzNDLE1BQW9DLEVBQ0MsRUFBRTtZQUN2QyxJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDekIsT0FBTyx5QkFBTyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN6QyxDQUFDO1lBQ0QsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQyxDQUFDO1FBRUY7Ozs7V0FJRztRQUNLLGtCQUFhLEdBQUcsQ0FDdEIsR0FBNkIsRUFDVCxFQUFFO1lBQ3RCLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssS0FBSyxJQUFJLE9BQU8sR0FBRyxDQUFDLEdBQUcsS0FBSyxRQUFRLEVBQUUsQ0FBQztnQkFDN0QsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3BFLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7b0JBQ2pELE1BQU0sS0FBSyxDQUNULHlJQUF5SSxDQUMxSSxDQUFDO2dCQUNKLENBQUM7Z0JBQ0QsT0FBTyxPQUFPLENBQUM7WUFDakIsQ0FBQztZQUNELE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUMsQ0FBQztRQUVGOzs7V0FHRztRQUNLLDJCQUFzQixHQUFHLENBQy9CLFFBQWtCLEVBQ2xCLFlBQW9DLEVBQ1AsRUFBRTtZQUMvQjs7O2VBR0c7WUFDSCxNQUFNLHdCQUF3QixHQUFHLFlBQVksQ0FBQyxLQUFLLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDO1lBQzNFLE1BQU0sTUFBTSxHQUFnQztnQkFDMUMsYUFBYSxFQUFFLEVBQUU7Z0JBQ2pCLGFBQWEsRUFBRTtvQkFDYixLQUFLLEVBQUUsc0JBQVEsQ0FBQyxXQUFXO2lCQUM1QjthQUNGLENBQUM7WUFDRixxQkFBcUI7WUFDckIsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDLGlCQUFpQixDQUFDO1lBQ2hELElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDZCxPQUFPLE1BQU0sQ0FBQztZQUNoQixDQUFDO1lBQ0QsK0NBQStDO1lBQy9DLElBQUksUUFBUSxDQUFDLFVBQVUsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDNUQsTUFBTSxLQUFLLENBQ1QsdUVBQXVFLENBQ3hFLENBQUM7WUFDSixDQUFDO1lBQ0QsSUFBSSxRQUFRLENBQUMsWUFBWSxJQUFJLFFBQVEsQ0FBQyxZQUFZLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNoRSxNQUFNLEtBQUssQ0FDVCx5RUFBeUUsQ0FDMUUsQ0FBQztZQUNKLENBQUM7WUFDRCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDcEIsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQztnQkFDcEMsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLHlCQUFPLENBQUMsOEJBQThCLENBQ3hELElBQUksRUFDSixHQUFHLElBQUksQ0FBQyxJQUFJLFdBQVcsRUFDdkI7b0JBQ0UsUUFBUTtvQkFDUixRQUFRLEVBQUUsV0FBVyxDQUFDLFFBQVE7b0JBQzlCLGlCQUFpQixFQUFFLFdBQVcsQ0FBQyxZQUFZO29CQUMzQyxnQkFBZ0IsRUFBRTt3QkFDaEIsR0FBRyxDQUFDLHdCQUF3Qjs0QkFDMUIsQ0FBQyxDQUFDO2dDQUNFLEtBQUssRUFBRSwrQkFBaUIsQ0FBQyxZQUFZOzZCQUN0Qzs0QkFDSCxDQUFDLENBQUMsU0FBUyxDQUFDO3dCQUNkLEdBQUcsSUFBSSxDQUFDLGdDQUFnQyxDQUN0QyxXQUFXLENBQUMsZ0JBQWdCLENBQzdCO3FCQUNGO29CQUNELE1BQU0sRUFBRSxXQUFXLENBQUMsTUFBTTtpQkFDM0IsQ0FDRixDQUFDO2dCQUNGLE1BQU0sQ0FBQyxhQUFhLENBQUMsZ0NBQWdDLENBQUMsTUFBTSxDQUFDO29CQUMzRCxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztZQUM3QixDQUFDO1lBQ0QsSUFBSSxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3RCLE1BQU0sQ0FBQyxRQUFRLEdBQUcsSUFBSSx5QkFBTyxDQUFDLGdDQUFnQyxDQUM1RCxJQUFJLEVBQ0osR0FBRyxJQUFJLENBQUMsSUFBSSxhQUFhLEVBQ3pCO29CQUNFLFFBQVE7b0JBQ1IsR0FBRyxRQUFRLENBQUMsUUFBUTtvQkFDcEIsZ0JBQWdCLEVBQUU7d0JBQ2hCLEdBQUcsQ0FBQyx3QkFBd0I7NEJBQzFCLENBQUMsQ0FBQztnQ0FDRSxLQUFLLEVBQUUsK0JBQWlCLENBQUMsY0FBYzs2QkFDeEM7NEJBQ0gsQ0FBQyxDQUFDLFNBQVMsQ0FBQzt3QkFDZCxHQUFHLElBQUksQ0FBQyxnQ0FBZ0MsQ0FDdEMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FDbkM7cUJBQ0Y7aUJBQ0YsQ0FDRixDQUFDO2dCQUNGLE1BQU0sQ0FBQyxhQUFhLENBQUMsZ0NBQWdDLENBQUMsUUFBUSxDQUFDO29CQUM3RCxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztZQUMvQixDQUFDO1lBQ0QsSUFBSSxRQUFRLENBQUMsZUFBZSxFQUFFLENBQUM7Z0JBQzdCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsSUFBSSx5QkFBTyxDQUFDLDhCQUE4QixDQUN4RCxJQUFJLEVBQ0osR0FBRyxJQUFJLENBQUMsSUFBSSxXQUFXLEVBQ3ZCO29CQUNFLFFBQVE7b0JBQ1IsR0FBRyxRQUFRLENBQUMsZUFBZTtvQkFDM0IsZ0JBQWdCLEVBQUU7d0JBQ2hCLEdBQUcsQ0FBQyx3QkFBd0I7NEJBQzFCLENBQUMsQ0FBQztnQ0FDRSxLQUFLLEVBQUUsK0JBQWlCLENBQUMsWUFBWTs2QkFDdEM7NEJBQ0gsQ0FBQyxDQUFDLFNBQVMsQ0FBQzt3QkFDZCxHQUFHLElBQUksQ0FBQyxnQ0FBZ0MsQ0FDdEMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FDMUM7cUJBQ0Y7aUJBQ0YsQ0FDRixDQUFDO2dCQUNGLE1BQU0sQ0FBQyxhQUFhLENBQUMsZ0NBQWdDLENBQUMsTUFBTSxDQUFDO29CQUMzRCxRQUFRLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQztZQUN0QyxDQUFDO1lBQ0QsSUFBSSxRQUFRLENBQUMsZUFBZSxFQUFFLENBQUM7Z0JBQzdCLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSx5QkFBTyxDQUFDLDZCQUE2QixDQUN0RCxJQUFJLEVBQ0osR0FBRyxJQUFJLENBQUMsSUFBSSxVQUFVLEVBQ3RCO29CQUNFLFFBQVE7b0JBQ1IsR0FBRyxRQUFRLENBQUMsZUFBZTtvQkFDM0IsZ0JBQWdCLEVBQUU7d0JBQ2hCLEdBQUcsQ0FBQyx3QkFBd0I7NEJBQzFCLENBQUMsQ0FBQztnQ0FDRSxLQUFLLEVBQUUsK0JBQWlCLENBQUMsV0FBVzs2QkFDckM7NEJBQ0gsQ0FBQyxDQUFDLFNBQVMsQ0FBQzt3QkFDZCxHQUFHLElBQUksQ0FBQyxnQ0FBZ0MsQ0FDdEMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FDMUM7cUJBQ0Y7aUJBQ0YsQ0FDRixDQUFDO2dCQUNGLE1BQU0sQ0FBQyxhQUFhLENBQUMsZ0NBQWdDLENBQUMsS0FBSyxDQUFDO29CQUMxRCxRQUFRLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQztZQUN0QyxDQUFDO1lBQ0QsSUFBSSxRQUFRLENBQUMsSUFBSSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUM5QyxNQUFNLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDakIsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEVBQUU7O29CQUN4QyxNQUFNLGFBQWEsR0FDakIsUUFBUSxDQUFDLHNCQUFzQixLQUFLLFNBQVM7d0JBQzNDLENBQUMsQ0FBQyxLQUFLLENBQUMseUJBQXlCO3dCQUNqQyxDQUFDLENBQUMsUUFBUSxDQUFDLHNCQUFzQixDQUFDO29CQUN0QyxNQUFNLGlCQUFpQixHQUFHLElBQUkseUJBQU8sQ0FBQyw0QkFBNEIsQ0FDaEUsSUFBSSxFQUNKLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFBLFFBQVEsQ0FBQyxJQUFJLG1DQUFJLEtBQUssU0FBUyxFQUM5Qzt3QkFDRSxRQUFRO3dCQUNSLHNCQUFzQixFQUNwQixhQUFhLEtBQUssS0FBSzs0QkFDckIsQ0FBQyxDQUFDLHdDQUEwQixDQUFDLEdBQUc7NEJBQ2hDLENBQUMsQ0FBQyx3Q0FBMEIsQ0FBQyxJQUFJO3dCQUNyQyxRQUFRLEVBQUUsUUFBUSxDQUFDLFFBQVE7d0JBQzNCLFlBQVksRUFBRSxRQUFRLENBQUMsWUFBWTt3QkFDbkMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxTQUFTO3dCQUM3QixXQUFXLEVBQUUsUUFBUSxDQUFDLFdBQVc7d0JBQ2pDLFNBQVMsRUFBRSxRQUFRLENBQUMsU0FBUzt3QkFDN0IsSUFBSSxFQUFFLFFBQVEsQ0FBQyxJQUFJO3dCQUNuQixNQUFNLEVBQUUsUUFBUSxDQUFDLE1BQU07d0JBQ3ZCLGdCQUFnQixFQUFFOzRCQUNoQixHQUFHLENBQUMsd0JBQXdCO2dDQUMxQixDQUFDLENBQUM7b0NBQ0UsS0FBSyxFQUFFO3dDQUNMLGFBQWEsRUFBRSxPQUFPO3FDQUN2QjtpQ0FDRjtnQ0FDSCxDQUFDLENBQUMsU0FBUyxDQUFDOzRCQUNkLEdBQUcsSUFBSSxDQUFDLGdDQUFnQyxDQUN0QyxRQUFRLENBQUMsZ0JBQWdCLENBQzFCO3lCQUNGO3FCQUNGLENBQ0YsQ0FBQztvQkFDRixNQUFBLE1BQU0sQ0FBQyxJQUFJLDBDQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2dCQUN2QyxDQUFDLENBQUMsQ0FBQztZQUNMLENBQUM7WUFDRCxJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDbEIsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztnQkFDM0IsTUFBTSxDQUFDLElBQUksR0FBRyxJQUFJLHlCQUFPLENBQUMsNEJBQTRCLENBQ3BELElBQUksRUFDSixHQUFHLElBQUksQ0FBQyxJQUFJLFNBQVMsRUFDckI7b0JBQ0UsUUFBUTtvQkFDUixnQkFBZ0IsRUFBRSxJQUFJLENBQUMsZ0NBQWdDLENBQ3JELElBQUksQ0FBQyxnQkFBZ0IsQ0FDdEI7b0JBQ0QsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO29CQUM3QixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7b0JBQzNCLFFBQVEsRUFBRTt3QkFDUixlQUFlLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlO3dCQUM5QyxZQUFZLEVBQ1YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEtBQUssTUFBTTs0QkFDbkMsQ0FBQyxDQUFDLHNEQUF3QyxDQUFDLElBQUk7NEJBQy9DLENBQUMsQ0FBQyxzREFBd0MsQ0FBQyxHQUFHO3FCQUNuRDtvQkFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7aUJBQ2hCLENBQ0YsQ0FBQztZQUNKLENBQUM7WUFFRCxxRUFBcUU7WUFDckUsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksZ0JBQWdCLEVBQUU7b0JBQ3BELGFBQWEsRUFBRSxFQUFFLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFO2lCQUNuRCxDQUFDLENBQUM7WUFDTCxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sTUFBTSxJQUFJLEtBQUssQ0FDYiwwRUFBMEUsQ0FDM0UsQ0FBQztZQUNKLENBQUM7WUFFRCx5Q0FBeUM7WUFDekMsTUFBTSxDQUFDLGFBQWEsR0FBRztnQkFDckIsWUFBWSxFQUFFLFFBQVEsQ0FBQyxZQUFZO2dCQUNuQyxVQUFVLEVBQUUsUUFBUSxDQUFDLFVBQVU7Z0JBQy9CLE1BQU0sRUFBRSxRQUFRLENBQUMsTUFBTTtvQkFDckIsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztvQkFDdEMsQ0FBQyxDQUFDLG9CQUFvQjtnQkFDeEIsS0FBSyxFQUFFLHNCQUFRLENBQUMsV0FBVzthQUM1QixDQUFDO1lBRUYsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQyxDQUFDO1FBRUY7Ozs7V0FJRztRQUNLLHFDQUFnQyxHQUFHLENBQ3pDLE9BQTBCLEVBQ1ksRUFBRTtZQUN4QyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ2IsT0FBTyxTQUFTLENBQUM7WUFDbkIsQ0FBQztZQUNELE1BQU0sTUFBTSxHQU1SLEVBQUUsQ0FBQztZQUNQLEtBQUssTUFBTSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7Z0JBQ3hELElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7b0JBQzlCLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRzt3QkFDakIsYUFBYSxFQUFFLEtBQUs7cUJBQ3JCLENBQUM7Z0JBQ0osQ0FBQztnQkFDRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxRQUFRLEtBQUssUUFBUSxFQUFFLENBQUM7b0JBQ3ZELGlDQUFpQztvQkFDakMsTUFBTSxnQkFBZ0IsR0FBc0MsRUFBRSxDQUFDO29CQUMvRCxLQUFLLE1BQU0sQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO3dCQUMxRCxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsR0FBRzs0QkFDNUIsYUFBYSxFQUFFLFFBQVE7eUJBQ3hCLENBQUM7b0JBQ0osQ0FBQztvQkFDRCxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsZ0JBQWdCLENBQUM7Z0JBQ3RDLENBQUM7WUFDSCxDQUFDO1lBQ0QsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQyxDQUFDO1FBQ0Y7Ozs7V0FJRztRQUNLLG1CQUFjLEdBQUcsQ0FDdkIsTUFBeUMsRUFDbkIsRUFBRTtZQUN4QixJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDekIsT0FBTyxFQUFFLENBQUM7WUFDWixDQUFDO1lBQ0QsTUFBTSxNQUFNLEdBQXlCLEVBQUUsQ0FBQztZQUN4QyxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDO2dCQUMzQixNQUFNLENBQUMsSUFBSSxDQUFDLHlCQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDekMsQ0FBQztZQUNELE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztRQUVGOztXQUVHO1FBQ0ssb0JBQWUsR0FBRyxDQUFDLEtBQWdCLEVBQUUsRUFBRTtZQUM3QyxNQUFNLGVBQWUsR0FDbkIsT0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssS0FBSyxRQUFRO2dCQUN6QyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxRQUFRLEtBQUssSUFBSSxDQUFDO1lBQzFDLE1BQU0sYUFBYSxHQUNqQixPQUFPLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxLQUFLLFFBQVE7Z0JBQ3pDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFFBQVEsS0FBSyxJQUFJLENBQUM7WUFDMUMsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDO1lBRS9ELElBQUksQ0FBQyxlQUFlLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztnQkFDM0QsT0FBTyxTQUFTLENBQUM7WUFDbkIsQ0FBQztZQUVELE9BQU87Z0JBQ0wsdUJBQXVCLEVBQUU7b0JBQ3ZCLHVEQUF1RDtvQkFDdkQsUUFBUSxFQUFFLElBQUk7b0JBQ2QsUUFBUSxFQUFFLGVBQWU7b0JBQ3pCLE1BQU0sRUFBRSxhQUFhO29CQUNyQixPQUFPLEVBQUUsZUFBZTtpQkFDekI7YUFDRixDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRUY7O1dBRUc7UUFDSyxxQkFBZ0IsR0FBRyxDQUFDLEtBQWdCLEVBQUUsRUFBRTtZQUM5QyxNQUFNLGVBQWUsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUM7WUFFL0QsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUNyQixPQUFPLEVBQUUsQ0FBQztZQUNaLENBQUM7WUFFRCxNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVMsQ0FBQztZQUNqRCxJQUFJLGNBQXNCLENBQUM7WUFDM0IsSUFBSSxnQkFBeUMsQ0FBQztZQUU5QyxJQUFJLGNBQWMsS0FBSyxJQUFJLEVBQUUsQ0FBQztnQkFDNUIsY0FBYyxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDcEQsZ0JBQWdCLEdBQUcscUNBQXVCLENBQUMsU0FBUyxDQUFDO1lBQ3ZELENBQUM7aUJBQU0sQ0FBQztnQkFDTixjQUFjLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUN6QyxjQUFjLENBQUMsY0FBYyxDQUM5QixDQUFDO2dCQUNGLGdCQUFnQjtvQkFDZCxjQUFjLENBQUMsZ0JBQWdCLEtBQUssVUFBVTt3QkFDNUMsQ0FBQyxDQUFDLHFDQUF1QixDQUFDLFFBQVE7d0JBQ2xDLENBQUMsQ0FBQyxxQ0FBdUIsQ0FBQyxTQUFTLENBQUM7WUFDMUMsQ0FBQztZQUVELE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQztRQUM5QyxDQUFDLENBQUM7UUFFRjs7O1dBR0c7UUFDSywwQkFBcUIsR0FBRyxDQUFDLGNBQXNCLEVBQVUsRUFBRTtZQUNqRSxJQUFJLGNBQWMsS0FBSyxNQUFNLEVBQUUsQ0FBQztnQkFDOUIsT0FBTyxjQUFjLENBQUM7WUFDeEIsQ0FBQztZQUVELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUM1Qyw2QkFBYSxDQUFDLGVBQWUsQ0FDOUIsQ0FBQztZQUVGLElBQUksY0FBYyxLQUFLLFFBQVEsRUFBRSxDQUFDO2dCQUNoQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyw2QkFBYSxDQUFDLGlCQUFpQixDQUFDLENBQUM7Z0JBQ3ZFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLDZCQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBRXZFLElBQUksS0FBSyxJQUFJLFVBQVUsRUFBRSxDQUFDO29CQUN4QixPQUFPLEdBQUcsVUFBVSxJQUFJLEtBQUssaUJBQWlCLENBQUM7Z0JBQ2pELENBQUM7WUFDSCxDQUFDO1lBRUQsT0FBTyxXQUFXLENBQUM7UUFDckIsQ0FBQyxDQUFDO1FBRUY7O1dBRUc7UUFDSyxzQkFBaUIsR0FBRyxDQUMxQixjQUE4QixFQUM5QixLQUFnQixFQUNWLEVBQUU7WUFDUixNQUFNLGVBQWUsR0FDbkIsT0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssS0FBSyxRQUFRO2dCQUN6QyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxRQUFRLEtBQUssSUFBSSxDQUFDO1lBQzFDLE1BQU0sYUFBYSxHQUNqQixPQUFPLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxLQUFLLFFBQVE7Z0JBQ3pDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFFBQVEsS0FBSyxJQUFJLENBQUM7WUFDMUMsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDO1lBRS9ELE1BQU0sc0JBQXNCLEdBQzFCLGVBQWUsSUFBSSxhQUFhLElBQUksZUFBZSxDQUFDO1lBRXRELElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO2dCQUM1QixPQUFPO1lBQ1QsQ0FBQztZQUVELE1BQU0saUJBQWlCLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQ3JELFVBQVUsQ0FDVSxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxDQUFDLGlCQUFpQixZQUFZLCtCQUFpQixDQUFDLEVBQUUsQ0FBQztnQkFDdEQsTUFBTSxLQUFLLENBQUMscURBQXFELENBQUMsQ0FBQztZQUNyRSxDQUFDO1lBRUQsTUFBTSxhQUFhLEdBQUcsaUJBQWlCLENBQUMsaUJBQWlCLElBQUksRUFBRSxDQUFDO1lBQ2hFLGlCQUFpQixDQUFDLGlCQUFpQixHQUFHLENBQUMsR0FBRyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUM5RSxDQUFDLENBQUM7UUFFRjs7V0FFRztRQUNLLCtCQUEwQixHQUFHLENBQUMsS0FBZ0IsRUFBUSxFQUFFOztZQUM5RCxNQUFNLGtCQUFrQixHQUFHLE1BQUEsS0FBSyxDQUFDLG1CQUFtQiwwQ0FBRSxrQkFBa0IsQ0FBQztZQUN6RSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztnQkFDeEIsT0FBTyxDQUFDLHdEQUF3RDtZQUNsRSxDQUFDO1lBRUQsTUFBTSxpQkFBaUIsR0FBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsK0JBQStCO1lBRWpGLHNCQUFzQjtZQUN0QixJQUNFLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSztnQkFDckIsT0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssS0FBSyxRQUFRO2dCQUN6QyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQzlCLENBQUM7Z0JBQ0QsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3RDLENBQUM7WUFFRCxvQkFBb0I7WUFDcEIsSUFDRSxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUs7Z0JBQ3JCLE9BQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEtBQUssUUFBUTtnQkFDekMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUM5QixDQUFDO2dCQUNELGlCQUFpQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNwQyxDQUFDO1lBRUQsc0JBQXNCO1lBQ3RCLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDN0IsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3RDLENBQUM7WUFFRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLGtCQUFrQixDQUFDLEVBQUUsQ0FBQztnQkFDcEQsTUFBTSxJQUFJLEtBQUssQ0FDYix3QkFBd0Isa0JBQWtCLHlEQUF5RDtvQkFDakcsdUJBQXVCLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSTtvQkFDdkQsbUVBQW1FLENBQ3RFLENBQUM7WUFDSixDQUFDO1FBQ0gsQ0FBQyxDQUFDO1FBRUY7O1dBRUc7UUFDSyxnQkFBVyxHQUFHLENBQ3BCLHdCQUFrRSxJQUFJLGtFQUF5QyxDQUM3RyxtQkFBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FDZixFQUNLLEVBQUU7WUFDUixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7WUFDNUQsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQztZQUN4RSxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUM7WUFDcEUseUNBQXlDO1lBQ3pDLE1BQU0sTUFBTSxHQUEwQjtnQkFDcEMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFVBQVU7Z0JBQzlDLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0I7Z0JBQzNELGNBQWMsRUFBRSxlQUFlLENBQUMsR0FBRztnQkFDbkMsVUFBVSxFQUFFLG1CQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU07YUFDbEMsQ0FBQztZQUVGLHNGQUFzRjtZQUN0RixNQUFNLENBQUMsOEJBQThCLEdBQUcsa0JBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQ2xELE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FDWixlQUFlLENBQUMsOEJBQThCLEtBQUssSUFBSTtvQkFDckQsQ0FBQyxDQUFDLE1BQU07b0JBQ1IsQ0FBQyxDQUFDLE9BQU87YUFDZCxDQUFDLENBQUM7WUFFSCxzRUFBc0U7WUFDdEUsTUFBTSxDQUFDLGdCQUFnQixHQUFHLGtCQUFJLENBQUMsTUFBTSxDQUFDO2dCQUNwQyxPQUFPLEVBQUUsR0FBRyxFQUFFO29CQUNaLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7d0JBQ3hCLE9BQU8sSUFBSSxDQUFDO29CQUNkLENBQUM7b0JBQ0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUNsQixXQUFXLENBQUMsTUFBZ0Q7eUJBQzFELE1BQU0sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLFFBQVEsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDO3lCQUMzRCxHQUFHLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxXQUFDLE9BQUEsTUFBQSxTQUFTLENBQUMsSUFBSSwwQ0FBRSxXQUFXLEVBQUUsQ0FBQSxFQUFBLENBQUMsQ0FDckQsQ0FBQztnQkFDSixDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsZ0VBQWdFO1lBQ2hFLE1BQU0sQ0FBQyxrQkFBa0IsR0FBRyxrQkFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRTs7b0JBQ1osT0FBTyxJQUFJLENBQUMsU0FBUyxDQUNuQixDQUFBLE1BQUEsV0FBVyxDQUFDLGtCQUFrQiwwQ0FBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQzt3QkFDL0QsRUFBRSxDQUNMLENBQUM7Z0JBQ0osQ0FBQzthQUNGLENBQUMsQ0FBQztZQUVILHdFQUF3RTtZQUN4RSxNQUFNLENBQUMsc0JBQXNCLEdBQUcsa0JBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQzFDLE9BQU8sRUFBRSxHQUFHLEVBQUU7O29CQUNaLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFBLFdBQVcsQ0FBQyxzQkFBc0IsbUNBQUksRUFBRSxDQUFDLENBQUM7Z0JBQ2xFLENBQUM7YUFDRixDQUFDLENBQUM7WUFFSCx3REFBd0Q7WUFDeEQsTUFBTSxDQUFDLHVCQUF1QixHQUFHLGtCQUFJLENBQUMsTUFBTSxDQUFDO2dCQUMzQyxPQUFPLEVBQUUsR0FBRyxFQUFFOztvQkFDWixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDO3dCQUMxQixPQUFPLEVBQUUsQ0FBQztvQkFDWixDQUFDO29CQUNELE1BQU0sTUFBTSxHQUFJLFdBQVcsQ0FBQyxRQUF5Qzt5QkFDbEUsY0FBb0QsQ0FBQztvQkFDeEQsT0FBTyxNQUFBLE1BQU0sQ0FBQyxhQUFhLDBDQUFFLFFBQVEsRUFBRSxDQUFDO2dCQUMxQyxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLDBCQUEwQixHQUFHLGtCQUFJLENBQUMsTUFBTSxDQUFDO2dCQUM5QyxPQUFPLEVBQUUsR0FBRyxFQUFFO29CQUNaLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7d0JBQzFCLE9BQU8sRUFBRSxDQUFDO29CQUNaLENBQUM7b0JBQ0QsTUFBTSxNQUFNLEdBQUksV0FBVyxDQUFDLFFBQXlDO3lCQUNsRSxjQUFvRCxDQUFDO29CQUN4RCxNQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7b0JBQ3hCLE1BQU0sQ0FBQyxjQUFjLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO29CQUMvRCxNQUFNLENBQUMsZ0JBQWdCLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO29CQUNuRSxNQUFNLENBQUMsZ0JBQWdCLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO29CQUNuRSxNQUFNLENBQUMsY0FBYyxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztvQkFDL0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUN0QyxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsbUVBQW1FO1lBQ25FLE1BQU0sQ0FBQyxnQkFBZ0IsR0FBRyxrQkFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDcEMsT0FBTyxFQUFFLEdBQUcsRUFBRTs7b0JBQ1osT0FBTyxNQUFBLFdBQVcsQ0FBQyxnQkFBZ0IsbUNBQUksS0FBSyxDQUFDO2dCQUMvQyxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBQ0gsbURBQW1EO1lBQ25ELE1BQU0sQ0FBQyxRQUFRLEdBQUcsa0JBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQzVCLE9BQU8sRUFBRSxHQUFHLEVBQUU7O29CQUNaLE1BQU0sV0FBVyxHQUFHLE1BQUEsV0FBVyxDQUFDLFdBQVcsbUNBQUksRUFBRSxDQUFDO29CQUNsRCxNQUFNLFFBQVEsR0FBYSxFQUFFLENBQUM7b0JBQzlCLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTt3QkFDM0IsSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFLENBQUM7NEJBQ3ZCLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQ3ZCLENBQUM7d0JBQ0QsSUFBSSxJQUFJLEtBQUssb0JBQW9CLEVBQUUsQ0FBQzs0QkFDbEMsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQzt3QkFDeEIsQ0FBQzt3QkFDRCxJQUFJLElBQUksS0FBSyxXQUFXLEVBQUUsQ0FBQzs0QkFDekIsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzt3QkFDekIsQ0FBQztvQkFDSCxDQUFDLENBQUMsQ0FBQztvQkFDSCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ2xDLENBQUM7YUFDRixDQUFDLENBQUM7WUFFSCxxQ0FBcUM7WUFDckMsTUFBTSxDQUFDLG1CQUFtQixHQUFHLGtCQUFJLENBQUMsTUFBTSxDQUFDO2dCQUN2QyxPQUFPLEVBQUUsR0FBRyxFQUFFOztvQkFDWixNQUFNLGtCQUFrQixHQVFwQixFQUFFLENBQUM7b0JBRVAsTUFBTSxZQUFZLEdBQUcsTUFDbkIsV0FBVyxDQUFDLFFBQ2IsMENBQUUsWUFBWSxDQUFDO29CQUNoQixJQUFJLFlBQVksRUFBRSxDQUFDO3dCQUNqQixNQUFNLGNBQWMsR0FDakIsWUFBaUQ7NkJBQy9DLHVCQUF1QixJQUFJLEVBQUUsQ0FBQzt3QkFDbkMsa0JBQWtCLENBQUMsZUFBZTs0QkFDaEMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQzt3QkFDdkMsa0JBQWtCLENBQUMsYUFBYSxHQUFHLGNBQWMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7d0JBRXRFLElBQUksY0FBYyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDOzRCQUN6QyxrQkFBa0IsQ0FBQyxRQUFRLEdBQUc7Z0NBQzVCLGNBQWMsRUFBRSxXQUFXLENBQUMsc0JBQXNCLElBQUksRUFBRTtnQ0FDeEQsZ0JBQWdCLEVBQ2IsV0FBVyxDQUFDLHdCQUVHLElBQUksV0FBVzs2QkFDbEMsQ0FBQzt3QkFDSixDQUFDO29CQUNILENBQUM7b0JBRUQsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQzt3QkFDNUIsa0JBQWtCLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDO29CQUNsRSxDQUFDO29CQUVELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDO3dCQUMvQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQzt3QkFDcEMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDVCxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsa0RBQWtEO1lBQ2xELE1BQU0sQ0FBQyxlQUFlLEdBQUcsa0JBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQ25DLE9BQU8sRUFBRSxHQUFHLEVBQUU7b0JBQ1osTUFBTSxlQUFlLEdBQWEsRUFBRSxDQUFDO29CQUNyQyxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDO29CQUNwRSxJQUFJLENBQUMsaUJBQWlCLElBQUksaUJBQWlCLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO3dCQUN6RCxPQUFPLEVBQUUsQ0FBQztvQkFDWixDQUFDO29CQUNELEtBQUssTUFBTSxRQUFRLElBQUksaUJBQWlCLEVBQUUsQ0FBQzt3QkFDekMsTUFBTSxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FDOUMsVUFBVSxDQUNvQixDQUFDO3dCQUNqQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsWUFBWSx5Q0FBMkIsQ0FBQyxFQUFFLENBQUM7NEJBQy9ELE1BQU0sS0FBSyxDQUNULHVFQUF1RSxDQUN4RSxDQUFDO3dCQUNKLENBQUM7d0JBQ0QsTUFBTSxZQUFZLEdBQUcsZ0JBQWdCLENBQUMsWUFBWSxDQUFDO3dCQUNuRCxNQUFNLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUM7d0JBQ25ELElBQUksWUFBWSxLQUFLLFFBQVEsRUFBRSxDQUFDOzRCQUM5QixlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO3dCQUNqQyxDQUFDO3dCQUNELElBQUksWUFBWSxLQUFLLFVBQVUsRUFBRSxDQUFDOzRCQUNoQyxlQUFlLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO3dCQUNuQyxDQUFDO3dCQUNELElBQUksWUFBWSxLQUFLLGlCQUFpQixFQUFFLENBQUM7NEJBQ3ZDLGVBQWUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQzt3QkFDN0MsQ0FBQzt3QkFDRCxJQUFJLFlBQVksS0FBSyxpQkFBaUIsRUFBRSxDQUFDOzRCQUN2QyxlQUFlLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7d0JBQzVDLENBQUM7d0JBQ0QsSUFBSSxZQUFZLEtBQUssTUFBTSxFQUFFLENBQUM7NEJBQzVCLGVBQWUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7d0JBQ3JDLENBQUM7d0JBQ0QsSUFBSSxZQUFZLEtBQUssTUFBTSxFQUFFLENBQUM7NEJBQzVCLGVBQWUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7d0JBQ3JDLENBQUM7b0JBQ0gsQ0FBQztvQkFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBQ3pDLENBQUM7YUFDRixDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsa0JBQWtCLEdBQUcsa0JBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUU7b0JBQ1osTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FDOUQsR0FBRyxJQUFJLENBQUMsSUFBSSxnQkFBZ0IsQ0FDN0IsQ0FBQztvQkFDRixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7d0JBQ3BCLE9BQU8sRUFBRSxDQUFDO29CQUNaLENBQUM7b0JBQ0QsSUFBSSxDQUFDLENBQUMsY0FBYyxZQUFZLDRCQUFjLENBQUMsRUFBRSxDQUFDO3dCQUNoRCxNQUFNLEtBQUssQ0FBQyxzREFBc0QsQ0FBQyxDQUFDO29CQUN0RSxDQUFDO29CQUNELE9BQU8sR0FBRyxjQUFjLENBQUMsVUFBVSxTQUNqQyxtQkFBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUNqQixvQkFBb0IsQ0FBQztnQkFDdkIsQ0FBQzthQUNGLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxVQUFVLEdBQUcsa0JBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQzlCLE9BQU8sRUFBRSxHQUFHLEVBQUU7O29CQUNaLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFBLGlCQUFpQixDQUFDLGtCQUFrQixtQ0FBSSxFQUFFLENBQUMsQ0FBQztnQkFDcEUsQ0FBQzthQUNGLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxtQkFBbUIsR0FBRyxrQkFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDdkMsT0FBTyxFQUFFLEdBQUcsRUFBRTtvQkFDWixPQUFPLGlCQUFpQixDQUFDLFlBQVk7d0JBQ25DLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQzt3QkFDMUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDVCxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLG9CQUFvQixHQUFHLGtCQUFJLENBQUMsTUFBTSxDQUFDO2dCQUN4QyxPQUFPLEVBQUUsR0FBRyxFQUFFO29CQUNaLE9BQU8saUJBQWlCLENBQUMsVUFBVTt3QkFDakMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO3dCQUN4QyxDQUFDLENBQUMsRUFBRSxDQUFDO2dCQUNULENBQUM7YUFDRixDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsaUJBQWlCLEdBQUcsa0JBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQ3JDLE9BQU8sRUFBRSxHQUFHLEVBQUU7b0JBQ1osT0FBTyxpQkFBaUIsQ0FBQyxpQkFBaUI7d0JBQ3hDLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO3dCQUMvQyxDQUFDLENBQUMsRUFBRSxDQUFDO2dCQUNULENBQUM7YUFDRixDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsYUFBYSxHQUFHLGtCQUFJLENBQUMsTUFBTSxDQUFDO2dCQUNqQyxPQUFPLEVBQUUsR0FBRyxFQUFFO29CQUNaLE9BQU8saUJBQWlCLENBQUMsR0FBRyxDQUFDO2dCQUMvQixDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsNkVBQTZFO1lBQzdFLE1BQU0sQ0FBQyxNQUFNLEdBQUcsa0JBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQzFCLE9BQU8sRUFBRSxHQUFHLEVBQUU7b0JBQ1osTUFBTSxXQUFXLEdBSVgsRUFBRSxDQUFDO29CQUNULE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQ3hDLENBQUMsU0FBUyxFQUFFLEVBQUU7d0JBQ1osTUFBTSxVQUFVLEdBQ2QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQzt3QkFDM0QsV0FBVyxDQUFDLElBQUksQ0FBQzs0QkFDZixDQUFDLFNBQVMsQ0FBQyxFQUFFO2dDQUNYLFVBQVU7NkJBQ1g7eUJBQ0YsQ0FBQyxDQUFDO29CQUNMLENBQUMsRUFDRCxFQUE2QyxDQUM5QyxDQUFDO29CQUVGLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDckMsQ0FBQzthQUNGLENBQUMsQ0FBQztZQUVILHFCQUFxQixDQUFDLHFCQUFxQixDQUFDLHNDQUFhLEVBQUU7Z0JBQ3pELE9BQU8sRUFBRSxHQUFHO2dCQUNaLE9BQU8sRUFBRSxNQUFNO2FBQ2hCLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQztRQTE1Q0EsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFBLEtBQUssQ0FBQyxJQUFJLG1DQUFJLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsWUFBWSxHQUFHLE1BQUEsS0FBSyxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsMENBQUUsWUFBWSxDQUFDO1FBQ3BFLG9GQUFvRjtRQUNwRixJQUFJLENBQUMsMEJBQTBCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFdkMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLE1BQUEsS0FBSyxDQUFDLG1CQUFtQiwwQ0FBRSxrQkFBa0IsQ0FBQztRQUV4RSxXQUFXO1FBQ1gsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUUxRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUkseUJBQU8sQ0FBQyxRQUFRLENBQ2xDLElBQUksRUFDSixHQUFHLElBQUksQ0FBQyxJQUFJLFVBQVUsRUFDdEIsSUFBSSxDQUFDLHFCQUFxQixDQUMzQixDQUFDO1FBQ0Y7Ozs7V0FJRztRQUNILElBQ0UsQ0FBQSxNQUFBLEtBQUssQ0FBQyxPQUFPLDBDQUFFLEtBQUs7WUFDcEIsU0FBUyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSztZQUNoQyxJQUFJLENBQUMsa0JBQWtCLEVBQ3ZCLENBQUM7WUFDRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2xFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQ3RCLCtCQUFpQixDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxFQUN6QyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQzVCLENBQUM7UUFDSixDQUFDO1FBRUQ7Ozs7V0FJRztRQUNILElBQ0UsQ0FBQSxNQUFBLEtBQUssQ0FBQyxPQUFPLDBDQUFFLEdBQUc7WUFDbEIsU0FBUyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRztZQUM5QixJQUFJLENBQUMsa0JBQWtCLEVBQ3ZCLENBQUM7WUFDRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2hFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQ3RCLCtCQUFpQixDQUFDLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUN2QyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQzFCLENBQUM7UUFDSixDQUFDO1FBRUQseUVBQXlFO1FBQ3pFLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQ3BELElBQUksQ0FBQyxRQUFRLEVBQ2IsS0FBSyxDQUFDLFNBQVMsQ0FDaEIsQ0FBQztRQUNGLGtCQUFrQjtRQUNsQixNQUFNLGNBQWMsR0FBRyxJQUFJLHlCQUFPLENBQUMsY0FBYyxDQUMvQyxJQUFJLEVBQ0osR0FBRyxJQUFJLENBQUMsSUFBSSxtQkFBbUIsRUFDL0I7WUFDRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDdkIsU0FBUyxFQUFFLHNCQUFRLENBQUMsVUFBVTtZQUM5QiwwQkFBMEIsRUFBRSxzQkFBUSxDQUFDLDZCQUE2QjtZQUNsRSxLQUFLLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGFBQWE7U0FDOUMsQ0FDRixDQUFDO1FBRUYsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUU5QyxnQkFBZ0I7UUFDaEIsTUFBTSxFQUNKLFlBQVksRUFDWiwwQkFBMEIsRUFDMUIsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUN4QixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FDeEIsSUFBSSxDQUFDLFFBQVEsRUFDYixjQUFjLEVBQ2QsSUFBSSxDQUFDLG1CQUFtQixDQUN6QixDQUFDO1FBRUYsd0JBQXdCO1FBQ3hCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRXJELE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQWdCLENBQUM7UUFDNUUsSUFBSSxDQUFDLENBQUMsV0FBVyxZQUFZLHlCQUFXLENBQUMsRUFBRSxDQUFDO1lBQzFDLE1BQU0sS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7UUFDL0QsQ0FBQztRQUVELE1BQU0saUJBQWlCLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQ3JELFVBQVUsQ0FDVSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxDQUFDLGlCQUFpQixZQUFZLCtCQUFpQixDQUFDLEVBQUUsQ0FBQztZQUN0RCxNQUFNLEtBQUssQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7UUFDRCxtQkFBbUI7UUFDbkIsSUFBSSxDQUFDLFNBQVMsR0FBRztZQUNmLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixjQUFjO1lBQ2Qsd0JBQXdCLEVBQUUsSUFBSTtZQUM5QiwwQkFBMEIsRUFBRSxNQUFNO1lBQ2xDLGNBQWMsRUFBRSxZQUFZLENBQUMsR0FBRztZQUNoQyxZQUFZLEVBQUU7Z0JBQ1osV0FBVztnQkFDWCxpQkFBaUI7Z0JBQ2pCLGVBQWUsRUFBRSxZQUFZO2dCQUM3Qiw2QkFBNkIsRUFBRSwwQkFBMEI7YUFDMUQ7WUFDRCxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07U0FDcEIsQ0FBQztRQUNGLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFFOUMsSUFBSSxtREFBMEIsRUFBRSxDQUFDLHdCQUF3QixDQUN2RCxtQkFBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFDZCxhQUFhLEVBQ2IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLGNBQWMsQ0FBQyxDQUM5QyxDQUFDO0lBQ0osQ0FBQztJQWlZRDs7T0FFRztJQUNLLG1CQUFtQixDQUN6QixLQUF1RDtRQUV2RCxJQUFJLENBQUMsS0FBSyxJQUFJLFNBQVMsSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUNqQyx5REFBeUQ7WUFDekQsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQztRQUNELElBQ0UsQ0FBQyxLQUFLLENBQUMsWUFBWSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQztZQUN6QyxDQUFDLENBQUMsS0FBSyxDQUFDLFlBQVksSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLEVBQ3pDLENBQUM7WUFDRCxNQUFNLElBQUksS0FBSyxDQUNiLDhMQUE4TCxDQUMvTCxDQUFDO1FBQ0osQ0FBQztRQUNELE9BQU87WUFDTCxVQUFVLEVBQUUsWUFBWSxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsU0FBUztZQUNoRSxZQUFZLEVBQ1YsY0FBYyxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsWUFBWTtnQkFDM0MsQ0FBQyxDQUFDLGNBQUksQ0FBQyxXQUFXLENBQ2QsSUFBSSxFQUNKLEdBQUcsSUFBSSxDQUFDLElBQUksZUFBZSxFQUMzQixLQUFLLENBQUMsWUFBWSxDQUNuQjtnQkFDSCxDQUFDLENBQUMsU0FBUztZQUNmLFNBQVMsRUFBRSxLQUFLLENBQUMsU0FBUztZQUMxQixhQUFhLEVBQUUsQ0FBQyxDQUFDLEtBQUs7U0FDdkIsQ0FBQztJQUNKLENBQUM7SUFFRDs7OztPQUlHO0lBQ0sseUJBQXlCLENBQy9CLFFBQThDO1FBRTlDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNkLE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUM7UUFDRCxPQUFPO1lBQ0wsWUFBWSxFQUFFLFFBQVEsQ0FBQyxZQUFZO1lBQ25DLFNBQVMsRUFBRSxRQUFRLENBQUMsU0FBUztnQkFDM0IsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQ2hCLEdBQUcsRUFBRSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsRUFDdEMsR0FBRyxFQUFFLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUNuQztnQkFDSCxDQUFDLENBQUMsU0FBUztZQUNiLFVBQVUsRUFBRSxRQUFRLENBQUMsVUFBVTtnQkFDN0IsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQ2pCLEdBQUcsRUFBRSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsRUFDdEMsR0FBRyxFQUFFLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUNuQztnQkFDSCxDQUFDLENBQUMsU0FBUztTQUNkLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSyxlQUFlLENBQ3JCLGFBQWlDO1FBRWpDLElBQUksU0FBNkIsQ0FBQztRQUNsQyxJQUNFLGFBQWEsQ0FBQyxxQkFBcUI7WUFDbkMsYUFBYSxDQUFDLHNCQUFzQixLQUFLLE1BQU0sRUFDL0MsQ0FBQztZQUNELFNBQVMsR0FBRyxhQUFhLENBQUMscUJBQXFCLENBQzdDLEdBQUcsRUFBRSxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FDM0MsQ0FBQztZQUNGLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQzlELE1BQU0sS0FBSyxDQUNULHNKQUFzSixDQUN2SixDQUFDO1lBQ0osQ0FBQztRQUNILENBQUM7UUFDRCxJQUNFLGFBQWEsQ0FBQyxxQkFBcUI7WUFDbkMsYUFBYSxDQUFDLHNCQUFzQixLQUFLLE1BQU0sRUFDL0MsQ0FBQztZQUNELElBQUksUUFBUSxHQUFXLEVBQUUsQ0FBQztZQUMxQixTQUFTLEdBQUcsYUFBYSxDQUFDLHFCQUFxQixDQUFDLENBQUMsSUFBYSxFQUFFLEVBQUU7Z0JBQ2hFLFFBQVEsR0FBRyxJQUFJO29CQUNiLENBQUMsQ0FBQyxNQUFNLElBQUksS0FBSztvQkFDakIsQ0FBQyxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FBQztnQkFDekMsT0FBTyxRQUFRLENBQUM7WUFDbEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxJQUFJLFFBQVEsS0FBSyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7Z0JBQ3JELE1BQU0sS0FBSyxDQUNULHNKQUFzSixDQUN2SixDQUFDO1lBQ0osQ0FBQztRQUNILENBQUM7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0NBK3pCRjtBQTM4Q0Qsa0NBMjhDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgTGF6eSxcbiAgUmVtb3ZhbFBvbGljeSxcbiAgU3RhY2ssXG4gIGF3c19jb2duaXRvIGFzIGNvZ25pdG8sXG59IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7XG4gIEF1dGhSZXNvdXJjZXMsXG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIFJlc291cmNlUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQ2ZuSWRlbnRpdHlQb29sLFxuICBDZm5Vc2VyUG9vbCxcbiAgQ2ZuVXNlclBvb2xDbGllbnQsXG4gIENmblVzZXJQb29sR3JvdXAsXG4gIENmblVzZXJQb29sSWRlbnRpdHlQcm92aWRlcixcbiAgQ3VzdG9tQXR0cmlidXRlQ29uZmlnLFxuICBJQ3VzdG9tQXR0cmlidXRlLFxuICBNZmEsXG4gIE1mYVNlY29uZEZhY3RvcixcbiAgT0F1dGhTY29wZSxcbiAgT2lkY0F0dHJpYnV0ZVJlcXVlc3RNZXRob2QsXG4gIFBhc3NrZXlVc2VyVmVyaWZpY2F0aW9uLFxuICBQcm92aWRlckF0dHJpYnV0ZSxcbiAgU3RhbmRhcmRBdHRyaWJ1dGUsXG4gIFVzZXJQb29sLFxuICBVc2VyUG9vbENsaWVudCxcbiAgVXNlclBvb2xEb21haW4sXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFtYXpvbixcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQXBwbGUsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckZhY2Vib29rLFxuICBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJHb29nbGUsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlck9pZGMsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWwsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWxNZXRhZGF0YVR5cGUsXG4gIFVzZXJQb29sT3BlcmF0aW9uLFxuICBVc2VyUG9vbFByb3BzLFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY29nbml0byc7XG5pbXBvcnQgeyBGZWRlcmF0ZWRQcmluY2lwYWwsIFJvbGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IEF1dGhPdXRwdXQsIGF1dGhPdXRwdXRLZXkgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQge1xuICBBdHRyaWJ1dGVNYXBwaW5nLFxuICBBdXRoUHJvcHMsXG4gIEN1c3RvbUF0dHJpYnV0ZSxcbiAgQ3VzdG9tU21zU2VuZGVyLFxuICBFbWFpbExvZ2luU2V0dGluZ3MsXG4gIEV4dGVybmFsUHJvdmlkZXJPcHRpb25zLFxuICBVc2VyUG9vbFNuc09wdGlvbnMsXG59IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgREVGQVVMVFMgfSBmcm9tICcuL2RlZmF1bHRzLmpzJztcbmltcG9ydCB7XG4gIEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlLFxuICBTdGFja01ldGFkYXRhQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXN0b3JhZ2UnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IElLZXksIEtleSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1rbXMnO1xuaW1wb3J0IHsgQ0RLQ29udGV4dEtleSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxudHlwZSBEZWZhdWx0Um9sZXMgPSB7IGF1dGg6IFJvbGU7IHVuQXV0aDogUm9sZSB9O1xudHlwZSBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQgPSB7XG4gIG9BdXRoTWFwcGluZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIG9BdXRoU2V0dGluZ3M6IGNvZ25pdG8uT0F1dGhTZXR0aW5ncyB8IHVuZGVmaW5lZDtcbiAgZ29vZ2xlPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyR29vZ2xlO1xuICBmYWNlYm9vaz86IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckZhY2Vib29rO1xuICBhbWF6b24/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBbWF6b247XG4gIGFwcGxlPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQXBwbGU7XG4gIG9pZGM/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJPaWRjW107XG4gIHNhbWw/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJTYW1sO1xufTtcbnR5cGUgT0F1dGhQcm92aWRlck1hcHBpbmcgPSB7XG4gIGZhY2Vib29rOiBzdHJpbmc7XG4gIGdvb2dsZTogc3RyaW5nO1xuICBhbWF6b246IHN0cmluZztcbiAgYXBwbGU6IHN0cmluZztcbn07XG5jb25zdCBvYXV0aFByb3ZpZGVyVG9Qcm92aWRlckRvbWFpbk1hcDogT0F1dGhQcm92aWRlck1hcHBpbmcgPSB7XG4gIGZhY2Vib29rOiAnZ3JhcGguZmFjZWJvb2suY29tJyxcbiAgZ29vZ2xlOiAnYWNjb3VudHMuZ29vZ2xlLmNvbScsXG4gIGFtYXpvbjogJ3d3dy5hbWF6b24uY29tJyxcbiAgYXBwbGU6ICdhcHBsZWlkLmFwcGxlLmNvbScsXG59O1xuY29uc3QgSU5WSVRBVElPTl9QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxuICBVU0VSTkFNRTogJ3t1c2VybmFtZX0nLFxufTtcbmNvbnN0IFZFUklGSUNBVElPTl9FTUFJTF9QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxuICBMSU5LOiAneyMjVmVyaWZ5IEVtYWlsIyN9Jyxcbn07XG5jb25zdCBWRVJJRklDQVRJT05fU01TX1BMQUNFSE9MREVSUyA9IHtcbiAgQ09ERTogJ3sjIyMjfScsXG59O1xuY29uc3QgTUZBX1NNU19QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxufTtcbmNvbnN0IERFRkFVTFRfT0FVVEhfU0NPUEVTID0gW1xuICBPQXV0aFNjb3BlLlBIT05FLFxuICBPQXV0aFNjb3BlLkVNQUlMLFxuICBPQXV0aFNjb3BlLk9QRU5JRCxcbiAgT0F1dGhTY29wZS5QUk9GSUxFLFxuICBPQXV0aFNjb3BlLkNPR05JVE9fQURNSU4sXG5dO1xuXG4vLyBCZSB2ZXJ5IGNhcmVmdWwgZWRpdGluZyB0aGlzIHZhbHVlLiBJdCBpcyB0aGUgc3RyaW5nIHRoYXQgaXMgdXNlZCB0byBhdHRyaWJ1dGUgc3RhY2tzIHRvIEFtcGxpZnkgQXV0aCBpbiBCSSBtZXRyaWNzXG5jb25zdCBhdXRoU3RhY2tUeXBlID0gJ2F1dGgtQ29nbml0byc7XG5cbi8qKlxuICogQW1wbGlmeSBBdXRoIENESyBDb25zdHJ1Y3RcbiAqL1xuZXhwb3J0IGNsYXNzIEFtcGxpZnlBdXRoXG4gIGV4dGVuZHMgQ29uc3RydWN0XG4gIGltcGxlbWVudHMgUmVzb3VyY2VQcm92aWRlcjxBdXRoUmVzb3VyY2VzPlxue1xuICAvKipcbiAgICogVGhlIHJlc291cmNlcyBnZW5lcmF0ZWQgYnkgdGhlIGNvbnN0cnVjdC5cbiAgICovXG4gIHJlYWRvbmx5IHJlc291cmNlczogQXV0aFJlc291cmNlcztcbiAgLyoqXG4gICAqIEV4dGVybmFsIHByb3ZpZGVyIHNldHRpbmdzXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHByb3ZpZGVyU2V0dXBSZXN1bHQ6IElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdDtcblxuICBwcml2YXRlIHJlYWRvbmx5IHVzZXJQb29sOiBVc2VyUG9vbDtcblxuICBwcml2YXRlIHJlYWRvbmx5IGNvbXB1dGVkVXNlclBvb2xQcm9wczogVXNlclBvb2xQcm9wcztcblxuICBwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICBwcml2YXRlIHJlYWRvbmx5IGRvbWFpblByZWZpeDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZ3JvdXBzOiB7XG4gICAgW2tleTogc3RyaW5nXToge1xuICAgICAgY2ZuVXNlckdyb3VwOiBDZm5Vc2VyUG9vbEdyb3VwO1xuICAgICAgcm9sZTogUm9sZTtcbiAgICB9O1xuICB9ID0ge307XG4gIC8qKlxuICAgKiBUaGUgS01TIGtleSB1c2VkIGZvciBlbmNyeXB0aW5nIGN1c3RvbSBlbWFpbCBzZW5kZXIgZGF0YS5cbiAgICogVGhpcyBpcyBvbmx5IHNldCB3aGVuIHVzaW5nIGEgY3VzdG9tIGVtYWlsIHNlbmRlci5cbiAgICovXG4gIHByaXZhdGUgY3VzdG9tU2VuZGVyS01Ta2V5OiBJS2V5IHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBUaGUgcHJlZmVycmVkIGF1dGhlbnRpY2F0aW9uIGNoYWxsZW5nZVxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBwcmVmZXJyZWRDaGFsbGVuZ2U6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IEF1dGggY29uc3RydWN0IHdpdGggQXV0aFByb3BzLlxuICAgKiBJZiBubyBwcm9wcyBhcmUgcHJvdmlkZWQsIGVtYWlsIGxvZ2luIGFuZCBkZWZhdWx0cyB3aWxsIGJlIHVzZWQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IEF1dGhQcm9wcyA9IERFRkFVTFRTLklGX05PX1BST1BTX1BST1ZJREVELFxuICApIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWUgPz8gJyc7XG4gICAgdGhpcy5kb21haW5QcmVmaXggPSBwcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnM/LmRvbWFpblByZWZpeDtcbiAgICAvLyBWYWxpZGF0ZSBwcmVmZXJyZWRDaGFsbGVuZ2UgYWdhaW5zdCBlbmFibGVkIGF1dGhlbnRpY2F0aW9uIG1ldGhvZHMgYmVmb3JlIHNldHRpbmdcbiAgICB0aGlzLnZhbGlkYXRlUHJlZmVycmVkQ2hhbGxlbmdlKHByb3BzKTtcblxuICAgIHRoaXMucHJlZmVycmVkQ2hhbGxlbmdlID0gcHJvcHMucGFzc3dvcmRsZXNzT3B0aW9ucz8ucHJlZmVycmVkQ2hhbGxlbmdlO1xuXG4gICAgLy8gVXNlclBvb2xcbiAgICB0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcyA9IHRoaXMuZ2V0VXNlclBvb2xQcm9wcyhwcm9wcyk7XG5cbiAgICB0aGlzLnVzZXJQb29sID0gbmV3IGNvZ25pdG8uVXNlclBvb2woXG4gICAgICB0aGlzLFxuICAgICAgYCR7dGhpcy5uYW1lfVVzZXJQb29sYCxcbiAgICAgIHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLFxuICAgICk7XG4gICAgLyoqXG4gICAgICogQ29uZmlndXJlIGN1c3RvbSBlbWFpbCBzZW5kZXIgZm9yIENvZ25pdG8gVXNlciBQb29sXG4gICAgICogR3JhbnQgbmVjZXNzYXJ5IHBlcm1pc3Npb25zIGZvciBMYW1iZGEgZnVuY3Rpb24gdG8gZGVjcnlwdCBlbWFpbHNcbiAgICAgKiBhbmQgYWxsb3cgQ29nbml0byB0byBpbnZva2UgdGhlIExhbWJkYSBmdW5jdGlvblxuICAgICAqL1xuICAgIGlmIChcbiAgICAgIHByb3BzLnNlbmRlcnM/LmVtYWlsICYmXG4gICAgICAnaGFuZGxlcicgaW4gcHJvcHMuc2VuZGVycy5lbWFpbCAmJlxuICAgICAgdGhpcy5jdXN0b21TZW5kZXJLTVNrZXlcbiAgICApIHtcbiAgICAgIHRoaXMuY3VzdG9tU2VuZGVyS01Ta2V5LmdyYW50RGVjcnlwdChwcm9wcy5zZW5kZXJzLmVtYWlsLmhhbmRsZXIpO1xuICAgICAgdGhpcy5jdXN0b21TZW5kZXJLTVNrZXkuZ3JhbnRFbmNyeXB0KHByb3BzLnNlbmRlcnMuZW1haWwuaGFuZGxlcik7XG4gICAgICB0aGlzLnVzZXJQb29sLmFkZFRyaWdnZXIoXG4gICAgICAgIFVzZXJQb29sT3BlcmF0aW9uLm9mKCdjdXN0b21FbWFpbFNlbmRlcicpLFxuICAgICAgICBwcm9wcy5zZW5kZXJzLmVtYWlsLmhhbmRsZXIsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENvbmZpZ3VyZSBjdXN0b20gc21zIHNlbmRlciBmb3IgQ29nbml0byBVc2VyIFBvb2xcbiAgICAgKiBHcmFudCBuZWNlc3NhcnkgcGVybWlzc2lvbnMgZm9yIExhbWJkYSBmdW5jdGlvbiB0byBkZWNyeXB0IHRoZSByZXF1ZXN0c1xuICAgICAqIGFuZCBhbGxvdyBDb2duaXRvIHRvIGludm9rZSB0aGUgTGFtYmRhIGZ1bmN0aW9uXG4gICAgICovXG4gICAgaWYgKFxuICAgICAgcHJvcHMuc2VuZGVycz8uc21zICYmXG4gICAgICAnaGFuZGxlcicgaW4gcHJvcHMuc2VuZGVycy5zbXMgJiZcbiAgICAgIHRoaXMuY3VzdG9tU2VuZGVyS01Ta2V5XG4gICAgKSB7XG4gICAgICB0aGlzLmN1c3RvbVNlbmRlcktNU2tleS5ncmFudERlY3J5cHQocHJvcHMuc2VuZGVycy5zbXMuaGFuZGxlcik7XG4gICAgICB0aGlzLmN1c3RvbVNlbmRlcktNU2tleS5ncmFudEVuY3J5cHQocHJvcHMuc2VuZGVycy5zbXMuaGFuZGxlcik7XG4gICAgICB0aGlzLnVzZXJQb29sLmFkZFRyaWdnZXIoXG4gICAgICAgIFVzZXJQb29sT3BlcmF0aW9uLm9mKCdjdXN0b21TbXNTZW5kZXInKSxcbiAgICAgICAgcHJvcHMuc2VuZGVycy5zbXMuaGFuZGxlcixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVXNlclBvb2wgLSBFeHRlcm5hbCBQcm92aWRlcnMgKE9hdXRoLCBTQU1MLCBPSURDKSBhbmQgVXNlciBQb29sIERvbWFpblxuICAgIHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdCA9IHRoaXMuc2V0dXBFeHRlcm5hbFByb3ZpZGVycyhcbiAgICAgIHRoaXMudXNlclBvb2wsXG4gICAgICBwcm9wcy5sb2dpbldpdGgsXG4gICAgKTtcbiAgICAvLyBVc2VyUG9vbCBDbGllbnRcbiAgICBjb25zdCB1c2VyUG9vbENsaWVudCA9IG5ldyBjb2duaXRvLlVzZXJQb29sQ2xpZW50KFxuICAgICAgdGhpcyxcbiAgICAgIGAke3RoaXMubmFtZX1Vc2VyUG9vbEFwcENsaWVudGAsXG4gICAgICB7XG4gICAgICAgIHVzZXJQb29sOiB0aGlzLnVzZXJQb29sLFxuICAgICAgICBhdXRoRmxvd3M6IERFRkFVTFRTLkFVVEhfRkxPV1MsXG4gICAgICAgIHByZXZlbnRVc2VyRXhpc3RlbmNlRXJyb3JzOiBERUZBVUxUUy5QUkVWRU5UX1VTRVJfRVhJU1RFTkNFX0VSUk9SUyxcbiAgICAgICAgb0F1dGg6IHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdC5vQXV0aFNldHRpbmdzLFxuICAgICAgfSxcbiAgICApO1xuXG4gICAgdGhpcy5hcHBseVVzZXJBdXRoRmxvdyh1c2VyUG9vbENsaWVudCwgcHJvcHMpO1xuXG4gICAgLy8gSWRlbnRpdHkgUG9vbFxuICAgIGNvbnN0IHtcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgcm9sZXM6IHsgYXV0aCwgdW5BdXRoIH0sXG4gICAgfSA9IHRoaXMuc2V0dXBJZGVudGl0eVBvb2woXG4gICAgICB0aGlzLnVzZXJQb29sLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHQsXG4gICAgKTtcblxuICAgIC8vIFNldHVwIFVzZXJQb29sIGdyb3Vwc1xuICAgIHRoaXMuc2V0dXBVc2VyUG9vbEdyb3Vwcyhwcm9wcy5ncm91cHMsIGlkZW50aXR5UG9vbCk7XG5cbiAgICBjb25zdCBjZm5Vc2VyUG9vbCA9IHRoaXMudXNlclBvb2wubm9kZS5maW5kQ2hpbGQoJ1Jlc291cmNlJykgYXMgQ2ZuVXNlclBvb2w7XG4gICAgaWYgKCEoY2ZuVXNlclBvb2wgaW5zdGFuY2VvZiBDZm5Vc2VyUG9vbCkpIHtcbiAgICAgIHRocm93IEVycm9yKCdDb3VsZCBub3QgZmluZCBDZm5Vc2VyUG9vbCByZXNvdXJjZSBpbiBzdGFjay4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBjZm5Vc2VyUG9vbENsaWVudCA9IHVzZXJQb29sQ2xpZW50Lm5vZGUuZmluZENoaWxkKFxuICAgICAgJ1Jlc291cmNlJyxcbiAgICApIGFzIENmblVzZXJQb29sQ2xpZW50O1xuICAgIGlmICghKGNmblVzZXJQb29sQ2xpZW50IGluc3RhbmNlb2YgQ2ZuVXNlclBvb2xDbGllbnQpKSB7XG4gICAgICB0aHJvdyBFcnJvcignQ291bGQgbm90IGZpbmQgQ2ZuVXNlclBvb2xDbGllbnQgcmVzb3VyY2UgaW4gc3RhY2suJyk7XG4gICAgfVxuICAgIC8vIGV4cG9zZSByZXNvdXJjZXNcbiAgICB0aGlzLnJlc291cmNlcyA9IHtcbiAgICAgIHVzZXJQb29sOiB0aGlzLnVzZXJQb29sLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICBhdXRoZW50aWNhdGVkVXNlcklhbVJvbGU6IGF1dGgsXG4gICAgICB1bmF1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZTogdW5BdXRoLFxuICAgICAgaWRlbnRpdHlQb29sSWQ6IGlkZW50aXR5UG9vbC5yZWYsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuVXNlclBvb2wsXG4gICAgICAgIGNmblVzZXJQb29sQ2xpZW50LFxuICAgICAgICBjZm5JZGVudGl0eVBvb2w6IGlkZW50aXR5UG9vbCxcbiAgICAgICAgY2ZuSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQ6IGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgfSxcbiAgICAgIGdyb3VwczogdGhpcy5ncm91cHMsXG4gICAgfTtcbiAgICB0aGlzLnN0b3JlT3V0cHV0KHByb3BzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSk7XG5cbiAgICBuZXcgQXR0cmlidXRpb25NZXRhZGF0YVN0b3JhZ2UoKS5zdG9yZUF0dHJpYnV0aW9uTWV0YWRhdGEoXG4gICAgICBTdGFjay5vZih0aGlzKSxcbiAgICAgIGF1dGhTdGFja1R5cGUsXG4gICAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAncGFja2FnZS5qc29uJyksXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgQXV0aC9VbkF1dGggUm9sZXNcbiAgICogQHJldHVybnMgRGVmYXVsdFJvbGVzXG4gICAqL1xuICBwcml2YXRlIHNldHVwQXV0aEFuZFVuQXV0aFJvbGVzID0gKGlkZW50aXR5UG9vbElkOiBzdHJpbmcpOiBEZWZhdWx0Um9sZXMgPT4ge1xuICAgIGNvbnN0IHJlc3VsdDogRGVmYXVsdFJvbGVzID0ge1xuICAgICAgYXV0aDogbmV3IFJvbGUodGhpcywgYCR7dGhpcy5uYW1lfWF1dGhlbnRpY2F0ZWRVc2VyUm9sZWAsIHtcbiAgICAgICAgYXNzdW1lZEJ5OiBuZXcgRmVkZXJhdGVkUHJpbmNpcGFsKFxuICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20nLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZCc6IGlkZW50aXR5UG9vbElkLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdGb3JBbnlWYWx1ZTpTdHJpbmdMaWtlJzoge1xuICAgICAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmFtcic6ICdhdXRoZW50aWNhdGVkJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnc3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknLFxuICAgICAgICApLFxuICAgICAgfSksXG4gICAgICB1bkF1dGg6IG5ldyBSb2xlKHRoaXMsIGAke3RoaXMubmFtZX11bmF1dGhlbnRpY2F0ZWRVc2VyUm9sZWAsIHtcbiAgICAgICAgYXNzdW1lZEJ5OiBuZXcgRmVkZXJhdGVkUHJpbmNpcGFsKFxuICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20nLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZCc6IGlkZW50aXR5UG9vbElkLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdGb3JBbnlWYWx1ZTpTdHJpbmdMaWtlJzoge1xuICAgICAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmFtcic6ICd1bmF1dGhlbnRpY2F0ZWQnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgICdzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eScsXG4gICAgICAgICksXG4gICAgICB9KSxcbiAgICB9O1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIEF1dG8gZ2VuZXJhdGUgdGhlIHVzZXIgcG9vbCBncm91cHMgYW5kIGdyb3VwIHJvbGVzXG4gICAqL1xuICBwcml2YXRlIHNldHVwVXNlclBvb2xHcm91cHMgPSAoXG4gICAgZ3JvdXBzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCxcbiAgICBpZGVudGl0eVBvb2w6IENmbklkZW50aXR5UG9vbCxcbiAgKSA9PiB7XG4gICAgKGdyb3VwcyB8fCBbXSkuZm9yRWFjaCgoZ3JvdXBOYW1lLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgZ3JvdXBSb2xlID0gbmV3IFJvbGUodGhpcywgYCR7dGhpcy5uYW1lfSR7Z3JvdXBOYW1lfUdyb3VwUm9sZWAsIHtcbiAgICAgICAgYXNzdW1lZEJ5OiBuZXcgRmVkZXJhdGVkUHJpbmNpcGFsKFxuICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20nLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZCc6IGlkZW50aXR5UG9vbC5yZWYsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0xpa2UnOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yJzogJ2F1dGhlbnRpY2F0ZWQnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgICdzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eScsXG4gICAgICAgICksXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGN1cnJlbnRHcm91cCA9IG5ldyBDZm5Vc2VyUG9vbEdyb3VwKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9JHtncm91cE5hbWV9R3JvdXBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2xJZDogdGhpcy51c2VyUG9vbC51c2VyUG9vbElkLFxuICAgICAgICAgIGdyb3VwTmFtZTogZ3JvdXBOYW1lLFxuICAgICAgICAgIHJvbGVBcm46IGdyb3VwUm9sZS5yb2xlQXJuLFxuICAgICAgICAgIHByZWNlZGVuY2U6IGluZGV4LFxuICAgICAgICB9LFxuICAgICAgKTtcbiAgICAgIHRoaXMuZ3JvdXBzW2dyb3VwTmFtZV0gPSB7XG4gICAgICAgIGNmblVzZXJHcm91cDogY3VycmVudEdyb3VwLFxuICAgICAgICByb2xlOiBncm91cFJvbGUsXG4gICAgICB9O1xuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXR1cCBJZGVudGl0eSBQb29sIHdpdGggZGVmYXVsdCByb2xlcy9yb2xlIG1hcHBpbmdzLCBhbmQgcmVnaXN0ZXIgcHJvdmlkZXJzXG4gICAqL1xuICBwcml2YXRlIHNldHVwSWRlbnRpdHlQb29sID0gKFxuICAgIHVzZXJQb29sOiBVc2VyUG9vbCxcbiAgICB1c2VyUG9vbENsaWVudDogVXNlclBvb2xDbGllbnQsXG4gICAgcHJvdmlkZXJTZXR1cFJlc3VsdDogSWRlbnRpdHlQcm92aWRlclNldHVwUmVzdWx0LFxuICApID0+IHtcbiAgICAvLyBzZXR1cCBpZGVudGl0eSBwb29sXG4gICAgY29uc3QgcmVnaW9uID0gU3RhY2sub2YodGhpcykucmVnaW9uO1xuICAgIGNvbnN0IGlkZW50aXR5UG9vbCA9IG5ldyBjb2duaXRvLkNmbklkZW50aXR5UG9vbChcbiAgICAgIHRoaXMsXG4gICAgICBgJHt0aGlzLm5hbWV9SWRlbnRpdHlQb29sYCxcbiAgICAgIHtcbiAgICAgICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOlxuICAgICAgICAgIERFRkFVTFRTLkFMTE9XX1VOQVVUSEVOVElDQVRFRF9JREVOVElUSUVTLFxuICAgICAgfSxcbiAgICApO1xuICAgIGNvbnN0IHJvbGVzID0gdGhpcy5zZXR1cEF1dGhBbmRVbkF1dGhSb2xlcyhpZGVudGl0eVBvb2wucmVmKTtcbiAgICBjb25zdCBpZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudCA9XG4gICAgICBuZXcgY29nbml0by5DZm5JZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfUlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50YCxcbiAgICAgICAge1xuICAgICAgICAgIGlkZW50aXR5UG9vbElkOiBpZGVudGl0eVBvb2wucmVmLFxuICAgICAgICAgIHJvbGVzOiB7XG4gICAgICAgICAgICB1bmF1dGhlbnRpY2F0ZWQ6IHJvbGVzLnVuQXV0aC5yb2xlQXJuLFxuICAgICAgICAgICAgYXV0aGVudGljYXRlZDogcm9sZXMuYXV0aC5yb2xlQXJuLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcm9sZU1hcHBpbmdzOiB7XG4gICAgICAgICAgICBVc2VyUG9vbFdlYkNsaWVudFJvbGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAgIHR5cGU6ICdUb2tlbicsXG4gICAgICAgICAgICAgIGFtYmlndW91c1JvbGVSZXNvbHV0aW9uOiAnQXV0aGVudGljYXRlZFJvbGUnLFxuICAgICAgICAgICAgICBpZGVudGl0eVByb3ZpZGVyOiBgY29nbml0by1pZHAuJHtyZWdpb259LmFtYXpvbmF3cy5jb20vJHt1c2VyUG9vbC51c2VyUG9vbElkfToke3VzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWR9YCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQuYWRkRGVwZW5kZW5jeShpZGVudGl0eVBvb2wpO1xuICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50Lm5vZGUuYWRkRGVwZW5kZW5jeSh1c2VyUG9vbENsaWVudCk7XG4gICAgLy8gYWRkIGNvZ25pdG8gcHJvdmlkZXJcbiAgICBpZGVudGl0eVBvb2wuY29nbml0b0lkZW50aXR5UHJvdmlkZXJzID0gW1xuICAgICAge1xuICAgICAgICBjbGllbnRJZDogdXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRJZCxcbiAgICAgICAgcHJvdmlkZXJOYW1lOiBgY29nbml0by1pZHAuJHtyZWdpb259LmFtYXpvbmF3cy5jb20vJHt1c2VyUG9vbC51c2VyUG9vbElkfWAsXG4gICAgICB9LFxuICAgIF07XG4gICAgLy8gYWRkIG90aGVyIHByb3ZpZGVyc1xuICAgIGlkZW50aXR5UG9vbC5zdXBwb3J0ZWRMb2dpblByb3ZpZGVycyA9IHByb3ZpZGVyU2V0dXBSZXN1bHQub0F1dGhNYXBwaW5ncztcbiAgICByZXR1cm4ge1xuICAgICAgaWRlbnRpdHlQb29sLFxuICAgICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQsXG4gICAgICByb2xlcyxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBEZWZpbmUgYmluZEN1c3RvbUF0dHJpYnV0ZSB0byBtZWV0IHJlcXVpcmVtZW50cyBvZiB0aGUgQ29nbml0byBBUEkgdG8gY2FsbCB0aGUgYmluZCBtZXRob2RcbiAgICovXG4gIHByaXZhdGUgYmluZEN1c3RvbUF0dHJpYnV0ZSA9IChcbiAgICBrZXk6IHN0cmluZyxcbiAgICBhdHRyaWJ1dGU6IEN1c3RvbUF0dHJpYnV0ZSxcbiAgKTogQ3VzdG9tQXR0cmlidXRlQ29uZmlnICYgSUN1c3RvbUF0dHJpYnV0ZSA9PiB7XG4gICAgY29uc3QgYmFzZUNvbmZpZzogQ3VzdG9tQXR0cmlidXRlQ29uZmlnID0ge1xuICAgICAgZGF0YVR5cGU6IGF0dHJpYnV0ZS5kYXRhVHlwZSxcblxuICAgICAgbXV0YWJsZTogYXR0cmlidXRlLm11dGFibGUgPz8gdHJ1ZSxcbiAgICB9O1xuXG4gICAgbGV0IGNvbnN0cmFpbnRzID0ge307XG4gICAgLy8gQ29uZGl0aW9uYWxseSBhZGQgY29uc3RyYWludCBwcm9wZXJ0aWVzIGJhc2VkIG9uIGRhdGFUeXBlLlxuICAgIGlmIChhdHRyaWJ1dGUuZGF0YVR5cGUgPT09ICdTdHJpbmcnKSB7XG4gICAgICBjb25zdHJhaW50cyA9IHtcbiAgICAgICAgc3RyaW5nQ29uc3RyYWludHM6IHtcbiAgICAgICAgICBtaW5MZW46IGF0dHJpYnV0ZS5taW5MZW4sXG5cbiAgICAgICAgICBtYXhMZW46IGF0dHJpYnV0ZS5tYXhMZW4sXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAoYXR0cmlidXRlLmRhdGFUeXBlID09PSAnTnVtYmVyJykge1xuICAgICAgY29uc3RyYWludHMgPSB7XG4gICAgICAgIG51bWJlckNvbnN0cmFpbnRzOiB7XG4gICAgICAgICAgbWluOiBhdHRyaWJ1dGUubWluLFxuXG4gICAgICAgICAgbWF4OiBhdHRyaWJ1dGUubWF4LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG4gICAgLy9UaGUgZmluYWwgY29uZmlnIG9iamVjdCBpbmNsdWRlcyBiYXNlQ29uZmlnIGFuZCBjb25kaXRpb25hbGx5IGFkZGVkIGNvbnN0cmFpbnQgcHJvcGVydGllcy5cbiAgICBjb25zdCBjb25maWcgPSB7XG4gICAgICAuLi5iYXNlQ29uZmlnLFxuXG4gICAgICAuLi5jb25zdHJhaW50cyxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmNvbmZpZyxcblxuICAgICAgYmluZDogKCkgPT4gY29uZmlnLFxuICAgIH07XG4gIH07XG4gIC8qKlxuICAgKiBQcm9jZXNzIHByb3BzIGludG8gVXNlclBvb2xQcm9wcyAoc2V0IGRlZmF1bHRzIGlmIG5lZWRlZClcbiAgICovXG4gIHByaXZhdGUgZ2V0VXNlclBvb2xQcm9wcyA9IChwcm9wczogQXV0aFByb3BzKTogVXNlclBvb2xQcm9wcyA9PiB7XG4gICAgY29uc3QgZW1haWxFbmFibGVkID0gcHJvcHMubG9naW5XaXRoLmVtYWlsID8gdHJ1ZSA6IGZhbHNlO1xuICAgIGNvbnN0IHBob25lRW5hYmxlZCA9IHByb3BzLmxvZ2luV2l0aC5waG9uZSA/IHRydWUgOiBmYWxzZTtcbiAgICBjb25zdCBvbmVPZkVtYWlsT3JQaG9uZSA9IGVtYWlsRW5hYmxlZCB8fCBwaG9uZUVuYWJsZWQ7XG4gICAgaWYgKCFvbmVPZkVtYWlsT3JQaG9uZSkge1xuICAgICAgdGhyb3cgRXJyb3IoJ0F0IGxlYXN0IG9uZSBvZiBlbWFpbCBvciBwaG9uZSBtdXN0IGJlIGVuYWJsZWQuJyk7XG4gICAgfVxuICAgIGxldCB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3M6IGNvZ25pdG8uVXNlclZlcmlmaWNhdGlvbkNvbmZpZyA9IHt9O1xuICAgIC8vIGV4dHJhY3QgZW1haWwgc2V0dGluZ3MgaWYgc2V0dGluZ3Mgb2JqZWN0IGlzIGRlZmluZWRcbiAgICBpZiAodHlwZW9mIHByb3BzLmxvZ2luV2l0aC5lbWFpbCA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IGVtYWlsU2V0dGluZ3MgPSBwcm9wcy5sb2dpbldpdGguZW1haWw7XG4gICAgICAvLyB2ZXJpZnkgZW1haWwgYm9keSBhbmQgaW5qZWN0IHRoZSBhY3R1YWwgdGVtcGxhdGUgdmFsdWVzIHdoaWNoIGNvZ25pdG8gdXNlc1xuICAgICAgY29uc3QgZW1haWxCb2R5OiBzdHJpbmcgfCB1bmRlZmluZWQgPSB0aGlzLnZlcmlmeUVtYWlsQm9keShlbWFpbFNldHRpbmdzKTtcbiAgICAgIHVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyA9IHtcbiAgICAgICAgZW1haWxCb2R5OiBlbWFpbEJvZHksXG4gICAgICAgIGVtYWlsU3R5bGU6IHRoaXMuZ2V0RW1haWxWZXJpZmljYXRpb25TdHlsZShcbiAgICAgICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3R5bGUsXG4gICAgICAgICksXG4gICAgICAgIGVtYWlsU3ViamVjdDogZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbFN1YmplY3QsXG4gICAgICB9O1xuICAgIH1cbiAgICAvLyBleHRyYWN0IHBob25lIHNldHRpbmdzIGlmIHNldHRpbmdzIG9iamVjdCBpcyBkZWZpbmVkXG4gICAgaWYgKHR5cGVvZiBwcm9wcy5sb2dpbldpdGgucGhvbmUgPT09ICdvYmplY3QnKSB7XG4gICAgICBjb25zdCBwaG9uZVNldHRpbmdzID0gcHJvcHMubG9naW5XaXRoLnBob25lO1xuICAgICAgbGV0IHNtc01lc3NhZ2U6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgIGlmIChcbiAgICAgICAgcGhvbmVTZXR0aW5ncy52ZXJpZmljYXRpb25NZXNzYWdlICYmXG4gICAgICAgIHR5cGVvZiBwaG9uZVNldHRpbmdzLnZlcmlmaWNhdGlvbk1lc3NhZ2UgPT09ICdmdW5jdGlvbidcbiAgICAgICkge1xuICAgICAgICAvLyB2YWxpZGF0ZSBzbXMgbWVzc2FnZSBzdHJ1Y3R1cmVcbiAgICAgICAgc21zTWVzc2FnZSA9IHBob25lU2V0dGluZ3MudmVyaWZpY2F0aW9uTWVzc2FnZShcbiAgICAgICAgICAoKSA9PiBWRVJJRklDQVRJT05fU01TX1BMQUNFSE9MREVSUy5DT0RFLFxuICAgICAgICApO1xuICAgICAgICBpZiAoIXNtc01lc3NhZ2UuaW5jbHVkZXMoVkVSSUZJQ0FUSU9OX1NNU19QTEFDRUhPTERFUlMuQ09ERSkpIHtcbiAgICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICAgIFwiSW52YWxpZCBwaG9uZSBzZXR0aW5ncy4gUHJvcGVydHkgJ3ZlcmlmaWNhdGlvbk1lc3NhZ2UnIG11c3QgdXRpbGl6ZSB0aGUgJ2NvZGUnIHBhcmFtZXRlciBhdCBsZWFzdCBvbmNlIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSB2ZXJpZmljYXRpb24gY29kZS5cIixcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3MgPSB7XG4gICAgICAgIC4uLnVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyxcbiAgICAgICAgc21zTWVzc2FnZTogc21zTWVzc2FnZSxcbiAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IG1mYVR5cGUgPSB0aGlzLmdldE1GQVR5cGUocHJvcHMubXVsdGlmYWN0b3IpO1xuICAgIGNvbnN0IG1mYU1vZGUgPSB0aGlzLmdldE1GQU1vZGUocHJvcHMubXVsdGlmYWN0b3IpO1xuXG4gICAgLy8gSWYgcGhvbmUgbG9naW4gaXMgZW5hYmxlZCBhbG9uZyB3aXRoIE1GQSwgY29nbml0byByZXF1aXJlcyB0aGF0IG1mYSBTTVMgdHlwZSB0byBiZSBlbmFibGVkLlxuICAgIGlmIChwaG9uZUVuYWJsZWQgJiYgbWZhTW9kZSAmJiBtZmFNb2RlICE9PSAnT0ZGJyAmJiAhbWZhVHlwZT8uc21zKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgJ0ludmFsaWQgTUZBIHNldHRpbmdzLiBTTVMgbXVzdCBiZSBlbmFibGVkIGluIG11bHRpRmFjdG9yIGlmIGxvZ2luV2l0aCBwaG9uZSBpcyBlbmFibGVkJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBzdGFuZGFyZEF0dHJpYnV0ZXMsIGN1c3RvbUF0dHJpYnV0ZXMgfSA9IE9iamVjdC5lbnRyaWVzKFxuICAgICAgcHJvcHMudXNlckF0dHJpYnV0ZXMgPz8ge30sXG4gICAgKS5yZWR1Y2UoXG4gICAgICAoXG4gICAgICAgIGFjYzoge1xuICAgICAgICAgIHN0YW5kYXJkQXR0cmlidXRlczogeyBba2V5OiBzdHJpbmddOiBTdGFuZGFyZEF0dHJpYnV0ZSB9O1xuICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXM6IHtcbiAgICAgICAgICAgIFtrZXk6IHN0cmluZ106IEN1c3RvbUF0dHJpYnV0ZUNvbmZpZyAmIElDdXN0b21BdHRyaWJ1dGU7XG4gICAgICAgICAgfTtcbiAgICAgICAgfSxcbiAgICAgICAgW2tleSwgdmFsdWVdLFxuICAgICAgKSA9PiB7XG4gICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnY3VzdG9tOicpKSB7XG4gICAgICAgICAgY29uc3QgYXR0cmlidXRlS2V5ID0ga2V5LnJlcGxhY2UoL15jdXN0b206L2ksICcnKTtcbiAgICAgICAgICBhY2MuY3VzdG9tQXR0cmlidXRlc1thdHRyaWJ1dGVLZXldID0gdGhpcy5iaW5kQ3VzdG9tQXR0cmlidXRlKFxuICAgICAgICAgICAgYXR0cmlidXRlS2V5LFxuICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhY2Muc3RhbmRhcmRBdHRyaWJ1dGVzW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSxcbiAgICAgIHsgc3RhbmRhcmRBdHRyaWJ1dGVzOiB7fSwgY3VzdG9tQXR0cmlidXRlczoge30gfSxcbiAgICApO1xuICAgIC8qKlxuICAgICAqIEhhbmRsZSBLTVMga2V5IGZvciBjdXN0b20gZW1haWwgYW5kIHNtcyBzZW5kZXJzXG4gICAgICogSWYgYSBjdXN0b20gc2VuZGVyIGlzIHByb3ZpZGVkLCB3ZSBlaXRoZXIgdXNlIHRoZSBwcm92aWRlZCBLTVMga2V5IEFSTlxuICAgICAqIG9yIGNyZWF0ZSBhIG5ldyBLTVMga2V5IGlmIG9uZSBpcyBub3QgcHJvdmlkZWQuXG4gICAgICpcbiAgICAgKiBJZiBLTVMga2V5IGlzIHByb3ZpZGVkIGluIGJvdGggc2VuZGVycywgd2UgdGhyb3cgYW4gZXJyb3JcbiAgICAgKi9cbiAgICBpZiAocHJvcHMuc2VuZGVycykge1xuICAgICAgY29uc3QgY3VzdG9tU21zU2VuZGVyID1cbiAgICAgICAgcHJvcHMuc2VuZGVycy5zbXMgJiYgJ2hhbmRsZXInIGluIHByb3BzLnNlbmRlcnMuc21zXG4gICAgICAgICAgPyBwcm9wcy5zZW5kZXJzLnNtc1xuICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgY29uc3QgY3VzdG9tRW1haWxTZW5kZXIgPVxuICAgICAgICBwcm9wcy5zZW5kZXJzLmVtYWlsICYmICdoYW5kbGVyJyBpbiBwcm9wcy5zZW5kZXJzLmVtYWlsXG4gICAgICAgICAgPyBwcm9wcy5zZW5kZXJzLmVtYWlsXG4gICAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgICAvLyBJZiBib3RoIGN1c3RvbSBzZW5kZXJzIGFyZSBjb25maWd1cmVkIGFuZCBkb24ndCBwcm92aWRlIHNhbWUgS01TIEtleSwgdGhlbiB0aHJvd1xuICAgICAgaWYgKFxuICAgICAgICBjdXN0b21TbXNTZW5kZXIgJiZcbiAgICAgICAgY3VzdG9tRW1haWxTZW5kZXIgJiZcbiAgICAgICAgY3VzdG9tU21zU2VuZGVyLmttc0tleUFybiAmJlxuICAgICAgICBjdXN0b21FbWFpbFNlbmRlci5rbXNLZXlBcm4gJiZcbiAgICAgICAgY3VzdG9tU21zU2VuZGVyLmttc0tleUFybiAhPT0gY3VzdG9tRW1haWxTZW5kZXIua21zS2V5QXJuXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdLTVMga2V5IEFSTiBtdXN0IGJlIHRoZSBzYW1lIGZvciBib3RoIGVtYWlsIGFuZCBzbXMgc2VuZGVycycsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAoY3VzdG9tU21zU2VuZGVyICYmIGN1c3RvbVNtc1NlbmRlci5rbXNLZXlBcm4pIHx8XG4gICAgICAgIChjdXN0b21FbWFpbFNlbmRlciAmJiBjdXN0b21FbWFpbFNlbmRlci5rbXNLZXlBcm4pXG4gICAgICApIHtcbiAgICAgICAgLy8gSWYgYXQgbGVhc3Qgb25lIGN1c3RvbSBzZW5kZXIgaXMgY29uZmlndXJlZCB3aXRoIEtNUyBrZXksIHdlIHVzZSBpdFxuICAgICAgICBjb25zdCBrbXNLZXlBcm4gPVxuICAgICAgICAgIGN1c3RvbVNtc1NlbmRlcj8ua21zS2V5QXJuID8/IGN1c3RvbUVtYWlsU2VuZGVyPy5rbXNLZXlBcm47XG4gICAgICAgIHRoaXMuY3VzdG9tU2VuZGVyS01Ta2V5ID0gS2V5LmZyb21LZXlBcm4oXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBgJHt0aGlzLm5hbWV9Q3VzdG9tU2VuZGVyS2V5YCxcbiAgICAgICAgICBrbXNLZXlBcm4hLCAvLyBJbiBpZiBjb25kaXRpb24gd2UgZW5zdXJlIHRoYXQgYXQgbGVzdCBvbmUgb2YgdGhlIGtleSBpcyBhdmFpbGFibGVcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoY3VzdG9tU21zU2VuZGVyIHx8IGN1c3RvbUVtYWlsU2VuZGVyKSB7XG4gICAgICAgIHtcbiAgICAgICAgICAvLyBJZiBhdCBsZWFzdCBvbmUgY3VzdG9tIHNlbmRlciBpcyBjb25maWd1cmVkIGJ1dCBubyBLTVMga2V5IHByb3ZpZGVkLCB3ZSBjcmVhdGUgb25lLlxuICAgICAgICAgIHRoaXMuY3VzdG9tU2VuZGVyS01Ta2V5ID0gbmV3IEtleShcbiAgICAgICAgICAgIGN1c3RvbVNtc1NlbmRlclxuICAgICAgICAgICAgICA/IGN1c3RvbVNtc1NlbmRlci5oYW5kbGVyLnN0YWNrXG4gICAgICAgICAgICAgIDogY3VzdG9tRW1haWxTZW5kZXIhLmhhbmRsZXIuc3RhY2ssIC8vIEluIGlmIGNvbmRpdGlvbiB3ZSBlbnN1cmUgdGhhdCBhdCBsZXN0IG9uZSBvZiB0aGUgaGFuZGxlciBpcyBhdmFpbGFibGVcbiAgICAgICAgICAgIGAke3RoaXMubmFtZX1DdXN0b21TZW5kZXJLZXlgLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBlbmFibGVLZXlSb3RhdGlvbjogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBzbXNDb25maWd1cmF0aW9uID0gdGhpcy5nZXRTbXNDb25maWd1cmF0aW9uKHByb3BzLnNlbmRlcnM/LnNtcyk7XG4gICAgY29uc3Qgc2lnbkluUG9saWN5ID0gdGhpcy5nZXRTaWduSW5Qb2xpY3kocHJvcHMpO1xuICAgIGNvbnN0IHBhc3NrZXlDb25maWcgPSB0aGlzLmdldFBhc3NrZXlDb25maWcocHJvcHMpO1xuICAgIGNvbnN0IHVzZXJQb29sUHJvcHM6IFVzZXJQb29sUHJvcHMgPSB7XG4gICAgICBzaWduSW5DYXNlU2Vuc2l0aXZlOiBERUZBVUxUUy5TSUdOX0lOX0NBU0VfU0VOU0lUSVZFLFxuICAgICAgc2lnbkluQWxpYXNlczoge1xuICAgICAgICBwaG9uZTogcGhvbmVFbmFibGVkLFxuICAgICAgICBlbWFpbDogZW1haWxFbmFibGVkLFxuICAgICAgfSxcbiAgICAgIC4uLihzaWduSW5Qb2xpY3kgJiYgeyBzaWduSW5Qb2xpY3kgfSksXG4gICAgICAuLi4ocGFzc2tleUNvbmZpZy5yZWx5aW5nUGFydHlJZCAmJiB7XG4gICAgICAgIHBhc3NrZXlSZWx5aW5nUGFydHlJZDogcGFzc2tleUNvbmZpZy5yZWx5aW5nUGFydHlJZCxcbiAgICAgIH0pLFxuICAgICAgLi4uKHBhc3NrZXlDb25maWcudXNlclZlcmlmaWNhdGlvbiAmJiB7XG4gICAgICAgIHBhc3NrZXlVc2VyVmVyaWZpY2F0aW9uOiBwYXNza2V5Q29uZmlnLnVzZXJWZXJpZmljYXRpb24sXG4gICAgICB9KSxcbiAgICAgIGtlZXBPcmlnaW5hbDoge1xuICAgICAgICBlbWFpbDogZW1haWxFbmFibGVkLFxuICAgICAgICBwaG9uZTogcGhvbmVFbmFibGVkLFxuICAgICAgfSxcbiAgICAgIGF1dG9WZXJpZnk6IHtcbiAgICAgICAgZW1haWw6IGVtYWlsRW5hYmxlZCxcbiAgICAgICAgcGhvbmU6IHBob25lRW5hYmxlZCxcbiAgICAgIH0sXG4gICAgICB1c2VyVmVyaWZpY2F0aW9uOiB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3MsXG4gICAgICBwYXNzd29yZFBvbGljeTogREVGQVVMVFMuUEFTU1dPUkRfUE9MSUNZLFxuICAgICAgc3RhbmRhcmRBdHRyaWJ1dGVzOiB7XG4gICAgICAgIGVtYWlsOiBERUZBVUxUUy5JU19SRVFVSVJFRF9BVFRSSUJVVEUuZW1haWwoZW1haWxFbmFibGVkKSxcbiAgICAgICAgcGhvbmVOdW1iZXI6IERFRkFVTFRTLklTX1JFUVVJUkVEX0FUVFJJQlVURS5waG9uZU51bWJlcihwaG9uZUVuYWJsZWQpLFxuICAgICAgICAuLi5zdGFuZGFyZEF0dHJpYnV0ZXMsXG4gICAgICB9LFxuICAgICAgY3VzdG9tQXR0cmlidXRlczoge1xuICAgICAgICAuLi5jdXN0b21BdHRyaWJ1dGVzLFxuICAgICAgfSxcbiAgICAgIGVtYWlsOlxuICAgICAgICBwcm9wcy5zZW5kZXJzPy5lbWFpbCAmJiAnZnJvbUVtYWlsJyBpbiBwcm9wcy5zZW5kZXJzLmVtYWlsXG4gICAgICAgICAgPyBjb2duaXRvLlVzZXJQb29sRW1haWwud2l0aFNFUyh7XG4gICAgICAgICAgICAgIGZyb21FbWFpbDogcHJvcHMuc2VuZGVycy5lbWFpbC5mcm9tRW1haWwsXG4gICAgICAgICAgICAgIGZyb21OYW1lOiBwcm9wcy5zZW5kZXJzLmVtYWlsLmZyb21OYW1lLFxuICAgICAgICAgICAgICByZXBseVRvOiBwcm9wcy5zZW5kZXJzLmVtYWlsLnJlcGx5VG8sXG4gICAgICAgICAgICAgIHNlc1JlZ2lvbjogU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIHNtc1JvbGU6IHNtc0NvbmZpZ3VyYXRpb24/LnNuc0NhbGxlckFybixcbiAgICAgIHNtc1JvbGVFeHRlcm5hbElkOiBzbXNDb25maWd1cmF0aW9uPy5leHRlcm5hbElkLFxuICAgICAgc25zUmVnaW9uOiBzbXNDb25maWd1cmF0aW9uPy5zbnNSZWdpb24sXG4gICAgICBlbmFibGVTbXNSb2xlOiBzbXNDb25maWd1cmF0aW9uPy5lbmFibGVTTVNSb2xlLFxuICAgICAgc2VsZlNpZ25VcEVuYWJsZWQ6IERFRkFVTFRTLkFMTE9XX1NFTEZfU0lHTl9VUCxcbiAgICAgIG1mYTogbWZhTW9kZSxcbiAgICAgIG1mYU1lc3NhZ2U6IHRoaXMuZ2V0TUZBTWVzc2FnZShwcm9wcy5tdWx0aWZhY3RvciksXG4gICAgICBtZmFTZWNvbmRGYWN0b3I6IG1mYVR5cGUsXG4gICAgICBhY2NvdW50UmVjb3Zlcnk6IHRoaXMuZ2V0QWNjb3VudFJlY292ZXJ5U2V0dGluZyhcbiAgICAgICAgZW1haWxFbmFibGVkLFxuICAgICAgICBwaG9uZUVuYWJsZWQsXG4gICAgICAgIHByb3BzLmFjY291bnRSZWNvdmVyeSxcbiAgICAgICksXG4gICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICB1c2VySW52aXRhdGlvbjpcbiAgICAgICAgdHlwZW9mIHByb3BzLmxvZ2luV2l0aC5lbWFpbCAhPT0gJ2Jvb2xlYW4nXG4gICAgICAgICAgPyB0aGlzLmdldFVzZXJJbnZpdGF0aW9uU2V0dGluZ3MoXG4gICAgICAgICAgICAgIHByb3BzLmxvZ2luV2l0aC5lbWFpbD8udXNlckludml0YXRpb24sXG4gICAgICAgICAgICApXG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICBjdXN0b21TZW5kZXJLbXNLZXk6IHRoaXMuY3VzdG9tU2VuZGVyS01Ta2V5LFxuICAgICAgdXNlclBvb2xOYW1lOiBwcm9wcy5uYW1lIHx8IHVuZGVmaW5lZCxcbiAgICB9O1xuICAgIHJldHVybiB1c2VyUG9vbFByb3BzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTYW5pdGl6ZSBjdXN0b21lciBpbnB1dCBhbmQgcmV0dXJuIENvZ25pdG8gVXNlciBwb29sIGNvbXBhdGlibGUgU21zIGNvbmZpZ3VyYXRpb25zXG4gICAqL1xuICBwcml2YXRlIGdldFNtc0NvbmZpZ3VyYXRpb24oXG4gICAgcHJvcHM6IFVzZXJQb29sU25zT3B0aW9ucyB8IEN1c3RvbVNtc1NlbmRlciB8IHVuZGVmaW5lZCxcbiAgKSB7XG4gICAgaWYgKCFwcm9wcyB8fCAnaGFuZGxlcicgaW4gcHJvcHMpIHtcbiAgICAgIC8vIEVpdGhlciBubyBjb25maWd1cmF0aW9uIG9yIGN1c3RvbSBzZW5kZXIgaXMgY29uZmlndXJlZFxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgKHByb3BzLnNuc0NhbGxlckFybiAmJiAhcHJvcHMuZXh0ZXJuYWxJZCkgfHxcbiAgICAgICghcHJvcHMuc25zQ2FsbGVyQXJuICYmIHByb3BzLmV4dGVybmFsSWQpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdCb3RoIGV4dGVybmFsSWQgYW5kIHNuc0NhbGxlckFybiBhcmUgcmVxdWlyZWQgd2hlbiBwcm92aWRpbmcgYSBjdXN0b20gSUFNIHJvbGUuIEVuc3VyZSB0aGF0IHlvdXIgSUFNIHJvbGUgdHJ1c3QgcG9saWN5IGhhdmUgYW4gc3RzOkV4dGVybmFsSWQgY29uZGl0aW9uIGFuZCBpcyBlcXVhbCB0byB0aGUgZXh0ZXJuYWxJZCB2YWx1ZScsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgZXh0ZXJuYWxJZDogJ2V4dGVybmFsSWQnIGluIHByb3BzID8gcHJvcHMuZXh0ZXJuYWxJZCA6IHVuZGVmaW5lZCxcbiAgICAgIHNuc0NhbGxlckFybjpcbiAgICAgICAgJ3Nuc0NhbGxlckFybicgaW4gcHJvcHMgJiYgcHJvcHMuc25zQ2FsbGVyQXJuXG4gICAgICAgICAgPyBSb2xlLmZyb21Sb2xlQXJuKFxuICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICBgJHt0aGlzLm5hbWV9U21zU2VuZGVyUm9sZWAsXG4gICAgICAgICAgICAgIHByb3BzLnNuc0NhbGxlckFybixcbiAgICAgICAgICAgIClcbiAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIHNuc1JlZ2lvbjogcHJvcHMuc25zUmVnaW9uLFxuICAgICAgZW5hYmxlU01TUm9sZTogISFwcm9wcyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlcyB0aGUgdXNlciBpbnZpdGF0aW9uIHNldHRpbmdzIGFuZCBpbnNlcnRzIGNvZGVzL3VzZXJuYW1lcyB3aGVyZSBuZWNlc3NhcnkuXG4gICAqIEBwYXJhbSBzZXR0aW5ncyB0aGUgaW52aXRhdGlvbiBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBjb2duaXRvLlVzZXJJbnZpdGF0aW9uQ29uZmlnIHwgdW5kZWZpbmVkXG4gICAqL1xuICBwcml2YXRlIGdldFVzZXJJbnZpdGF0aW9uU2V0dGluZ3MoXG4gICAgc2V0dGluZ3M6IEVtYWlsTG9naW5TZXR0aW5nc1sndXNlckludml0YXRpb24nXSxcbiAgKTogY29nbml0by5Vc2VySW52aXRhdGlvbkNvbmZpZyB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCFzZXR0aW5ncykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGVtYWlsU3ViamVjdDogc2V0dGluZ3MuZW1haWxTdWJqZWN0LFxuICAgICAgZW1haWxCb2R5OiBzZXR0aW5ncy5lbWFpbEJvZHlcbiAgICAgICAgPyBzZXR0aW5ncy5lbWFpbEJvZHkoXG4gICAgICAgICAgICAoKSA9PiBJTlZJVEFUSU9OX1BMQUNFSE9MREVSUy5VU0VSTkFNRSxcbiAgICAgICAgICAgICgpID0+IElOVklUQVRJT05fUExBQ0VIT0xERVJTLkNPREUsXG4gICAgICAgICAgKVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIHNtc01lc3NhZ2U6IHNldHRpbmdzLnNtc01lc3NhZ2VcbiAgICAgICAgPyBzZXR0aW5ncy5zbXNNZXNzYWdlKFxuICAgICAgICAgICAgKCkgPT4gSU5WSVRBVElPTl9QTEFDRUhPTERFUlMuVVNFUk5BTUUsXG4gICAgICAgICAgICAoKSA9PiBJTlZJVEFUSU9OX1BMQUNFSE9MREVSUy5DT0RFLFxuICAgICAgICAgIClcbiAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgdGhlIGVtYWlsIGJvZHkgZGVwZW5kaW5nIG9uIGlmICdDT0RFJyBvciAnTElOSycgc3R5bGUgaXMgdXNlZC5cbiAgICogVGhpcyBlbnN1cmVzIHRoYXQgdGhlIHRlbXBsYXRlIGNvbnRhaW5zIHRoZSBuZWNlc3NhcnkgcGxhY2Vob2xkZXJzIGZvciBDb2duaXRvIHRvIGluc2VydCB2ZXJpZmljYXRpb24gY29kZXMgb3IgbGlua3MuXG4gICAqIEBwYXJhbSBlbWFpbFNldHRpbmdzIHRoZSBwcm92aWRlZCBlbWFpbCBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBlbWFpbEJvZHlcbiAgICovXG4gIHByaXZhdGUgdmVyaWZ5RW1haWxCb2R5KFxuICAgIGVtYWlsU2V0dGluZ3M6IEVtYWlsTG9naW5TZXR0aW5ncyxcbiAgKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBsZXQgZW1haWxCb2R5OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgaWYgKFxuICAgICAgZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbEJvZHkgJiZcbiAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxTdHlsZSAhPT0gJ0xJTksnXG4gICAgKSB7XG4gICAgICBlbWFpbEJvZHkgPSBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsQm9keShcbiAgICAgICAgKCkgPT4gVkVSSUZJQ0FUSU9OX0VNQUlMX1BMQUNFSE9MREVSUy5DT0RFLFxuICAgICAgKTtcbiAgICAgIGlmICghZW1haWxCb2R5LmluY2x1ZGVzKFZFUklGSUNBVElPTl9FTUFJTF9QTEFDRUhPTERFUlMuQ09ERSkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgXCJJbnZhbGlkIGVtYWlsIHNldHRpbmdzLiBQcm9wZXJ0eSAndmVyaWZpY2F0aW9uRW1haWxCb2R5JyBtdXN0IHV0aWxpemUgdGhlICdjb2RlJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGNvZGUuXCIsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChcbiAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxCb2R5ICYmXG4gICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgPT09ICdMSU5LJ1xuICAgICkge1xuICAgICAgbGV0IGxpbmtUZXh0OiBzdHJpbmcgPSAnJztcbiAgICAgIGVtYWlsQm9keSA9IGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxCb2R5KCh0ZXh0Pzogc3RyaW5nKSA9PiB7XG4gICAgICAgIGxpbmtUZXh0ID0gdGV4dFxuICAgICAgICAgID8gYHsjIyR7dGV4dH0jI31gXG4gICAgICAgICAgOiBWRVJJRklDQVRJT05fRU1BSUxfUExBQ0VIT0xERVJTLkxJTks7XG4gICAgICAgIHJldHVybiBsaW5rVGV4dDtcbiAgICAgIH0pO1xuICAgICAgaWYgKGxpbmtUZXh0ID09PSAnJyB8fCAhZW1haWxCb2R5LmluY2x1ZGVzKGxpbmtUZXh0KSkge1xuICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICBcIkludmFsaWQgZW1haWwgc2V0dGluZ3MuIFByb3BlcnR5ICd2ZXJpZmljYXRpb25FbWFpbEJvZHknIG11c3QgdXRpbGl6ZSB0aGUgJ2xpbmsnIHBhcmFtZXRlciBhdCBsZWFzdCBvbmNlIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSB2ZXJpZmljYXRpb24gbGluay5cIixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGVtYWlsQm9keTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZW1haWwgdmVyaWZpY2F0aW9uIHN0eWxlIGZyb20gdXNlciBwcm9wc1xuICAgKiBAcGFyYW0gdmVyaWZpY2F0aW9uRW1haWxTdHlsZSAtIHN0cmluZyB2YWx1ZVxuICAgKiBAcmV0dXJucyB2ZXJpZmljYXRpb25FbWFpbFN0eWxlIC0gZW51bSB2YWx1ZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRFbWFpbFZlcmlmaWNhdGlvblN0eWxlID0gKFxuICAgIHZlcmlmaWNhdGlvbkVtYWlsU3R5bGU6ICdDT0RFJyB8ICdMSU5LJyB8IHVuZGVmaW5lZCxcbiAgKTogY29nbml0by5WZXJpZmljYXRpb25FbWFpbFN0eWxlIHwgdW5kZWZpbmVkID0+IHtcbiAgICBpZiAodmVyaWZpY2F0aW9uRW1haWxTdHlsZSA9PT0gJ0NPREUnKSB7XG4gICAgICByZXR1cm4gY29nbml0by5WZXJpZmljYXRpb25FbWFpbFN0eWxlLkNPREU7XG4gICAgfSBlbHNlIGlmICh2ZXJpZmljYXRpb25FbWFpbFN0eWxlID09PSAnTElOSycpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLlZlcmlmaWNhdGlvbkVtYWlsU3R5bGUuTElOSztcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogRGV0ZXJtaW5lIHRoZSBhY2NvdW50IHJlY292ZXJ5IG9wdGlvbiBiYXNlZCBvbiBlbmFibGVkIGxvZ2luIG1ldGhvZHMuXG4gICAqIEBwYXJhbSBlbWFpbEVuYWJsZWQgLSBpcyBlbWFpbCBlbmFibGVkXG4gICAqIEBwYXJhbSBwaG9uZUVuYWJsZWQgLSBpcyBwaG9uZSBlbmFibGVkXG4gICAqIEBwYXJhbSBhY2NvdW50UmVjb3ZlcnlNZXRob2RBc1N0cmluZyAtIHRoZSB1c2VyIHByb3ZpZGVkIGFjY291bnQgcmVjb3Zlcnkgc2V0dGluZ1xuICAgKiBAcmV0dXJucyBhY2NvdW50IHJlY292ZXJ5IHNldHRpbmcgZW51bSB2YWx1ZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRBY2NvdW50UmVjb3ZlcnlTZXR0aW5nID0gKFxuICAgIGVtYWlsRW5hYmxlZDogYm9vbGVhbixcbiAgICBwaG9uZUVuYWJsZWQ6IGJvb2xlYW4sXG4gICAgYWNjb3VudFJlY292ZXJ5TWV0aG9kQXNTdHJpbmc6IEF1dGhQcm9wc1snYWNjb3VudFJlY292ZXJ5J10sXG4gICk6IGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5IHwgdW5kZWZpbmVkID0+IHtcbiAgICBjb25zdCBhY2NvdW50UmVjb3ZlcnkgPSB0aGlzLmNvbnZlcnRBY2NvdW50UmVjb3ZlcnlTdHJpbmdUb0VudW0oXG4gICAgICBhY2NvdW50UmVjb3ZlcnlNZXRob2RBc1N0cmluZyxcbiAgICApO1xuICAgIGlmIChhY2NvdW50UmVjb3ZlcnkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGFjY291bnRSZWNvdmVyeTtcbiAgICB9XG4gICAgLy8gc2V0IGRlZmF1bHQgYmFzZWQgb24gZW5hYmxlZCBsb2dpbiBtZXRob2RzXG4gICAgaWYgKHBob25lRW5hYmxlZCAmJiBlbWFpbEVuYWJsZWQpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLkFjY291bnRSZWNvdmVyeS5FTUFJTF9PTkxZO1xuICAgIH1cbiAgICBpZiAocGhvbmVFbmFibGVkKSB7XG4gICAgICByZXR1cm4gY29nbml0by5BY2NvdW50UmVjb3ZlcnkuUEhPTkVfT05MWV9XSVRIT1VUX01GQTtcbiAgICB9XG4gICAgaWYgKGVtYWlsRW5hYmxlZCkge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5LkVNQUlMX09OTFk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgdXNlciBmcmllbmRseSBNZmEgbW9kZSB0byBjb2duaXRvIE1mYSBNb2RlLlxuICAgKiBUaGlzIGVsaW1pbmF0ZXMgdGhlIG5lZWQgZm9yIHVzZXJzIHRvIGltcG9ydCBjb2duaXRvLk1mYS5cbiAgICogQHBhcmFtIG1mYSAtIE1GQSBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBjb2duaXRvIE1GQSBlbmZvcmNlbWVudCBtb2RlXG4gICAqL1xuICBwcml2YXRlIGdldE1GQU1vZGUgPSAobWZhOiBBdXRoUHJvcHNbJ211bHRpZmFjdG9yJ10pOiBNZmEgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmIChtZmEpIHtcbiAgICAgIHN3aXRjaCAobWZhLm1vZGUpIHtcbiAgICAgICAgY2FzZSAnT0ZGJzpcbiAgICAgICAgICByZXR1cm4gTWZhLk9GRjtcbiAgICAgICAgY2FzZSAnT1BUSU9OQUwnOlxuICAgICAgICAgIHJldHVybiBNZmEuT1BUSU9OQUw7XG4gICAgICAgIGNhc2UgJ1JFUVVJUkVEJzpcbiAgICAgICAgICByZXR1cm4gTWZhLlJFUVVJUkVEO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0IHVzZXIgZnJpZW5kbHkgTWZhIHR5cGUgdG8gY29nbml0byBNZmEgdHlwZS5cbiAgICogVGhpcyBlbGltaW5hdGVzIHRoZSBuZWVkIGZvciB1c2VycyB0byBpbXBvcnQgY29nbml0by5NZmEuXG4gICAqIEBwYXJhbSBtZmEgLSBNRkEgc2V0dGluZ3NcbiAgICogQHJldHVybnMgY29nbml0byBNRkEgdHlwZSAoc21zLCB0b3RwLCBvciBlbWFpbClcbiAgICovXG4gIHByaXZhdGUgZ2V0TUZBVHlwZSA9IChcbiAgICBtZmE6IEF1dGhQcm9wc1snbXVsdGlmYWN0b3InXSxcbiAgKTogTWZhU2Vjb25kRmFjdG9yIHwgdW5kZWZpbmVkID0+IHtcbiAgICByZXR1cm4gdHlwZW9mIG1mYSA9PT0gJ29iamVjdCcgJiYgbWZhLm1vZGUgIT09ICdPRkYnXG4gICAgICA/IHtcbiAgICAgICAgICBzbXM6IG1mYS5zbXMgPyB0cnVlIDogZmFsc2UsXG4gICAgICAgICAgb3RwOiBtZmEudG90cCA/IHRydWUgOiBmYWxzZSxcbiAgICAgICAgICBlbWFpbDogbWZhLmVtYWlsID8gdHJ1ZSA6IGZhbHNlLFxuICAgICAgICB9XG4gICAgICA6IHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogQ29udmVydCB1c2VyIGZyaWVuZGx5IGFjY291bnQgcmVjb3ZlcnkgbWV0aG9kIHRvIGNvZ25pdG8gQWNjb3VudFJlY292ZXIgZW51bS5cbiAgICogVGhpcyBlbGltaW5hdGVzIHRoZSBuZWVkIGZvciB1c2VycyB0byBpbXBvcnQgY29nbml0by5BY2NvdW50UmVjb3ZlcnkuXG4gICAqIEBwYXJhbSBtZXRob2QgLSBhY2NvdW50IHJlY292ZXJ5IG1ldGhvZCBhcyBhIHN0cmluZyB2YWx1ZVxuICAgKiBAcmV0dXJucyBjb2duaXRvLkFjY291bnRSZWNvdmVyeSBlbnVtIHZhbHVlXG4gICAqL1xuICBwcml2YXRlIGNvbnZlcnRBY2NvdW50UmVjb3ZlcnlTdHJpbmdUb0VudW0gPSAoXG4gICAgbWV0aG9kOiBBdXRoUHJvcHNbJ2FjY291bnRSZWNvdmVyeSddLFxuICApOiBjb2duaXRvLkFjY291bnRSZWNvdmVyeSB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKG1ldGhvZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gY29nbml0by5BY2NvdW50UmVjb3ZlcnlbbWV0aG9kXTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogRXh0cmFjdCB0aGUgTUZBIG1lc3NhZ2Ugc2V0dGluZ3MgYW5kIHBlcmZvcm0gdmFsaWRhdGlvbi5cbiAgICogQHBhcmFtIG1mYSAtIE1GQSBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBtZmEgbWVzc2FnZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRNRkFNZXNzYWdlID0gKFxuICAgIG1mYTogQXV0aFByb3BzWydtdWx0aWZhY3RvciddLFxuICApOiBzdHJpbmcgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmIChtZmEgJiYgbWZhLm1vZGUgIT09ICdPRkYnICYmIHR5cGVvZiBtZmEuc21zID09PSAnb2JqZWN0Jykge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IG1mYS5zbXMuc21zTWVzc2FnZSgoKSA9PiBNRkFfU01TX1BMQUNFSE9MREVSUy5DT0RFKTtcbiAgICAgIGlmICghbWVzc2FnZS5pbmNsdWRlcyhNRkFfU01TX1BMQUNFSE9MREVSUy5DT0RFKSkge1xuICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICBcIkludmFsaWQgTUZBIHNldHRpbmdzLiBQcm9wZXJ0eSAnc21zTWVzc2FnZScgbXVzdCB1dGlsaXplIHRoZSAnY29kZScgcGFyYW1ldGVyIGF0IGxlYXN0IG9uY2UgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIHZlcmlmaWNhdGlvbiBjb2RlLlwiLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIG1lc3NhZ2U7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldHVwIEV4dGVybmFsIFByb3ZpZGVycyAoT0F1dGgvT0lEQy9TQU1MKSBhbmQgcmVsYXRlZCBzZXR0aW5nc1xuICAgKiBzdWNoIGFzIE9BdXRoIHNldHRpbmdzIGFuZCBVc2VyIFBvb2wgRG9tYWluc1xuICAgKi9cbiAgcHJpdmF0ZSBzZXR1cEV4dGVybmFsUHJvdmlkZXJzID0gKFxuICAgIHVzZXJQb29sOiBVc2VyUG9vbCxcbiAgICBsb2dpbk9wdGlvbnM6IEF1dGhQcm9wc1snbG9naW5XaXRoJ10sXG4gICk6IElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdCA9PiB7XG4gICAgLyoqXG4gICAgICogSWYgZW1haWwgaXMgZW5hYmxlZCwgYW5kIGlzIHRoZSBvbmx5IHJlcXVpcmVkIGF0dHJpYnV0ZSwgd2UgYXJlIGFibGUgdG9cbiAgICAgKiBhdXRvbWF0aWNhbGx5IG1hcCB0aGUgZW1haWwgYXR0cmlidXRlIGZyb20gZXh0ZXJuYWwgcHJvdmlkZXJzLCBleGNsdWRpbmcgU0FNTC5cbiAgICAgKi9cbiAgICBjb25zdCBzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXMgPSBsb2dpbk9wdGlvbnMuZW1haWwgJiYgIWxvZ2luT3B0aW9ucy5waG9uZTtcbiAgICBjb25zdCByZXN1bHQ6IElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdCA9IHtcbiAgICAgIG9BdXRoTWFwcGluZ3M6IHt9LFxuICAgICAgb0F1dGhTZXR0aW5nczoge1xuICAgICAgICBmbG93czogREVGQVVMVFMuT0FVVEhfRkxPV1MsXG4gICAgICB9LFxuICAgIH07XG4gICAgLy8gZXh0ZXJuYWwgcHJvdmlkZXJzXG4gICAgY29uc3QgZXh0ZXJuYWwgPSBsb2dpbk9wdGlvbnMuZXh0ZXJuYWxQcm92aWRlcnM7XG4gICAgaWYgKCFleHRlcm5hbCkge1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgLy8gbWFrZSBzdXJlIGxvZ291dC9jYWxsYmFjayB1cmxzIGFyZSBub3QgZW1wdHlcbiAgICBpZiAoZXh0ZXJuYWwubG9nb3V0VXJscyAmJiBleHRlcm5hbC5sb2dvdXRVcmxzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICdZb3UgbXVzdCBkZWZpbmUgbG9nb3V0VXJscyB3aGVuIGNvbmZpZ3VyaW5nIGV4dGVybmFsIGxvZ2luIHByb3ZpZGVycy4nLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLmNhbGxiYWNrVXJscyAmJiBleHRlcm5hbC5jYWxsYmFja1VybHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgJ1lvdSBtdXN0IGRlZmluZSBjYWxsYmFja1VybHMgd2hlbiBjb25maWd1cmluZyBleHRlcm5hbCBsb2dpbiBwcm92aWRlcnMuJyxcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5nb29nbGUpIHtcbiAgICAgIGNvbnN0IGdvb2dsZVByb3BzID0gZXh0ZXJuYWwuZ29vZ2xlO1xuICAgICAgcmVzdWx0Lmdvb2dsZSA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlckdvb2dsZShcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfUdvb2dsZUlkUGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICBjbGllbnRJZDogZ29vZ2xlUHJvcHMuY2xpZW50SWQsXG4gICAgICAgICAgY2xpZW50U2VjcmV0VmFsdWU6IGdvb2dsZVByb3BzLmNsaWVudFNlY3JldCxcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IFByb3ZpZGVyQXR0cmlidXRlLkdPT0dMRV9FTUFJTCxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgIC4uLnRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICAgIGdvb2dsZVByb3BzLmF0dHJpYnV0ZU1hcHBpbmcsXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2NvcGVzOiBnb29nbGVQcm9wcy5zY29wZXMsXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgICAgcmVzdWx0Lm9BdXRoTWFwcGluZ3Nbb2F1dGhQcm92aWRlclRvUHJvdmlkZXJEb21haW5NYXAuZ29vZ2xlXSA9XG4gICAgICAgIGV4dGVybmFsLmdvb2dsZS5jbGllbnRJZDtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLmZhY2Vib29rKSB7XG4gICAgICByZXN1bHQuZmFjZWJvb2sgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJGYWNlYm9vayhcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfUZhY2Vib29rSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIC4uLmV4dGVybmFsLmZhY2Vib29rLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHtcbiAgICAgICAgICAgIC4uLihzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBlbWFpbDogUHJvdmlkZXJBdHRyaWJ1dGUuRkFDRUJPT0tfRU1BSUwsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAuLi50aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgICBleHRlcm5hbC5mYWNlYm9vay5hdHRyaWJ1dGVNYXBwaW5nLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgKTtcbiAgICAgIHJlc3VsdC5vQXV0aE1hcHBpbmdzW29hdXRoUHJvdmlkZXJUb1Byb3ZpZGVyRG9tYWluTWFwLmZhY2Vib29rXSA9XG4gICAgICAgIGV4dGVybmFsLmZhY2Vib29rLmNsaWVudElkO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwubG9naW5XaXRoQW1hem9uKSB7XG4gICAgICByZXN1bHQuYW1hem9uID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9QW1hem9uSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIC4uLmV4dGVybmFsLmxvZ2luV2l0aEFtYXpvbixcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IFByb3ZpZGVyQXR0cmlidXRlLkFNQVpPTl9FTUFJTCxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgIC4uLnRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICAgIGV4dGVybmFsLmxvZ2luV2l0aEFtYXpvbi5hdHRyaWJ1dGVNYXBwaW5nLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgKTtcbiAgICAgIHJlc3VsdC5vQXV0aE1hcHBpbmdzW29hdXRoUHJvdmlkZXJUb1Byb3ZpZGVyRG9tYWluTWFwLmFtYXpvbl0gPVxuICAgICAgICBleHRlcm5hbC5sb2dpbldpdGhBbWF6b24uY2xpZW50SWQ7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5zaWduSW5XaXRoQXBwbGUpIHtcbiAgICAgIHJlc3VsdC5hcHBsZSA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFwcGxlKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9QXBwbGVJRFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgLi4uZXh0ZXJuYWwuc2lnbkluV2l0aEFwcGxlLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHtcbiAgICAgICAgICAgIC4uLihzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBlbWFpbDogUHJvdmlkZXJBdHRyaWJ1dGUuQVBQTEVfRU1BSUwsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAuLi50aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgICBleHRlcm5hbC5zaWduSW5XaXRoQXBwbGUuYXR0cmlidXRlTWFwcGluZyxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgICByZXN1bHQub0F1dGhNYXBwaW5nc1tvYXV0aFByb3ZpZGVyVG9Qcm92aWRlckRvbWFpbk1hcC5hcHBsZV0gPVxuICAgICAgICBleHRlcm5hbC5zaWduSW5XaXRoQXBwbGUuY2xpZW50SWQ7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5vaWRjICYmIGV4dGVybmFsLm9pZGMubGVuZ3RoID4gMCkge1xuICAgICAgcmVzdWx0Lm9pZGMgPSBbXTtcbiAgICAgIGV4dGVybmFsLm9pZGMuZm9yRWFjaCgocHJvdmlkZXIsIGluZGV4KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RNZXRob2QgPVxuICAgICAgICAgIHByb3ZpZGVyLmF0dHJpYnV0ZVJlcXVlc3RNZXRob2QgPT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgPyAnR0VUJyAvLyBkZWZhdWx0IGlmIG5vdCBkZWZpbmVkXG4gICAgICAgICAgICA6IHByb3ZpZGVyLmF0dHJpYnV0ZVJlcXVlc3RNZXRob2Q7XG4gICAgICAgIGNvbnN0IGdlbmVyYXRlZFByb3ZpZGVyID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyT2lkYyhcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIGAke3RoaXMubmFtZX0ke3Byb3ZpZGVyLm5hbWUgPz8gaW5kZXh9T2lkY0lEUGAsXG4gICAgICAgICAge1xuICAgICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgICBhdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kOlxuICAgICAgICAgICAgICByZXF1ZXN0TWV0aG9kID09PSAnR0VUJ1xuICAgICAgICAgICAgICAgID8gT2lkY0F0dHJpYnV0ZVJlcXVlc3RNZXRob2QuR0VUXG4gICAgICAgICAgICAgICAgOiBPaWRjQXR0cmlidXRlUmVxdWVzdE1ldGhvZC5QT1NULFxuICAgICAgICAgICAgY2xpZW50SWQ6IHByb3ZpZGVyLmNsaWVudElkLFxuICAgICAgICAgICAgY2xpZW50U2VjcmV0OiBwcm92aWRlci5jbGllbnRTZWNyZXQsXG4gICAgICAgICAgICBlbmRwb2ludHM6IHByb3ZpZGVyLmVuZHBvaW50cyxcbiAgICAgICAgICAgIGlkZW50aWZpZXJzOiBwcm92aWRlci5pZGVudGlmaWVycyxcbiAgICAgICAgICAgIGlzc3VlclVybDogcHJvdmlkZXIuaXNzdWVyVXJsLFxuICAgICAgICAgICAgbmFtZTogcHJvdmlkZXIubmFtZSxcbiAgICAgICAgICAgIHNjb3BlczogcHJvdmlkZXIuc2NvcGVzLFxuICAgICAgICAgICAgYXR0cmlidXRlTWFwcGluZzoge1xuICAgICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICAgIGVtYWlsOiB7XG4gICAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlTmFtZTogJ2VtYWlsJyxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAgIC4uLnRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICAgICAgcHJvdmlkZXIuYXR0cmlidXRlTWFwcGluZyxcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgKTtcbiAgICAgICAgcmVzdWx0Lm9pZGM/LnB1c2goZ2VuZXJhdGVkUHJvdmlkZXIpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5zYW1sKSB7XG4gICAgICBjb25zdCBzYW1sID0gZXh0ZXJuYWwuc2FtbDtcbiAgICAgIHJlc3VsdC5zYW1sID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfVNhbWxJRFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzogdGhpcy5jb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyhcbiAgICAgICAgICAgIHNhbWwuYXR0cmlidXRlTWFwcGluZyxcbiAgICAgICAgICApLFxuICAgICAgICAgIGlkZW50aWZpZXJzOiBzYW1sLmlkZW50aWZpZXJzLFxuICAgICAgICAgIGlkcFNpZ25vdXQ6IHNhbWwuaWRwU2lnbm91dCxcbiAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgbWV0YWRhdGFDb250ZW50OiBzYW1sLm1ldGFkYXRhLm1ldGFkYXRhQ29udGVudCxcbiAgICAgICAgICAgIG1ldGFkYXRhVHlwZTpcbiAgICAgICAgICAgICAgc2FtbC5tZXRhZGF0YS5tZXRhZGF0YVR5cGUgPT09ICdGSUxFJ1xuICAgICAgICAgICAgICAgID8gVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbE1ldGFkYXRhVHlwZS5GSUxFXG4gICAgICAgICAgICAgICAgOiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJTYW1sTWV0YWRhdGFUeXBlLlVSTCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG5hbWU6IHNhbWwubmFtZSxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQWx3YXlzIGdlbmVyYXRlIGEgZG9tYWluIHByZWZpeCBpZiBleHRlcm5hbCBwcm92aWRlciBpcyBjb25maWd1cmVkXG4gICAgaWYgKHRoaXMuZG9tYWluUHJlZml4KSB7XG4gICAgICB0aGlzLnVzZXJQb29sLmFkZERvbWFpbihgJHt0aGlzLm5hbWV9VXNlclBvb2xEb21haW5gLCB7XG4gICAgICAgIGNvZ25pdG9Eb21haW46IHsgZG9tYWluUHJlZml4OiB0aGlzLmRvbWFpblByZWZpeCB9LFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0NvZ25pdG8gRG9tYWluIFByZWZpeCBpcyBtaXNzaW5nIHdoZW4gZXh0ZXJuYWwgcHJvdmlkZXJzIGFyZSBjb25maWd1cmVkLicsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIG9hdXRoIHNldHRpbmdzIGZvciB0aGUgVXNlclBvb2wgY2xpZW50XG4gICAgcmVzdWx0Lm9BdXRoU2V0dGluZ3MgPSB7XG4gICAgICBjYWxsYmFja1VybHM6IGV4dGVybmFsLmNhbGxiYWNrVXJscyxcbiAgICAgIGxvZ291dFVybHM6IGV4dGVybmFsLmxvZ291dFVybHMsXG4gICAgICBzY29wZXM6IGV4dGVybmFsLnNjb3Blc1xuICAgICAgICA/IHRoaXMuZ2V0T0F1dGhTY29wZXMoZXh0ZXJuYWwuc2NvcGVzKVxuICAgICAgICA6IERFRkFVTFRfT0FVVEhfU0NPUEVTLFxuICAgICAgZmxvd3M6IERFRkFVTFRTLk9BVVRIX0ZMT1dTLFxuICAgIH07XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyB0aGUgc2ltcGxpZmllZCBtYXBwaW5nIHR5cGUgdG8gY29nbml0by5BdHRyaWJ1dGVNYXBwaW5nLlxuICAgKiBAcGFyYW0gbWFwcGluZyB0aGUgQXR0cmlidXRlTWFwcGluZyB0byBjb252ZXJ0IHRvIGEgY29nbml0by5BdHRyaWJ1dGVNYXBwaW5nXG4gICAqIEByZXR1cm5zIGNvZ25pdG8uQXR0cmlidXRlTWFwcGluZ1xuICAgKi9cbiAgcHJpdmF0ZSBjb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyA9IChcbiAgICBtYXBwaW5nPzogQXR0cmlidXRlTWFwcGluZyxcbiAgKTogY29nbml0by5BdHRyaWJ1dGVNYXBwaW5nIHwgdW5kZWZpbmVkID0+IHtcbiAgICBpZiAoIW1hcHBpbmcpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdDogUmVjb3JkPFxuICAgICAgc3RyaW5nLFxuICAgICAgfCBQcm92aWRlckF0dHJpYnV0ZVxuICAgICAgfCB7XG4gICAgICAgICAgW2tleTogc3RyaW5nXTogUHJvdmlkZXJBdHRyaWJ1dGU7XG4gICAgICAgIH1cbiAgICA+ID0ge307XG4gICAgZm9yIChjb25zdCBbYXR0ck5hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhtYXBwaW5nKSkge1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmVzdWx0W2F0dHJOYW1lXSA9IHtcbiAgICAgICAgICBhdHRyaWJ1dGVOYW1lOiB2YWx1ZSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIGF0dHJOYW1lID09PSAnY3VzdG9tJykge1xuICAgICAgICAvLyBkZWFsaW5nIHdpdGggY3VzdG9tIGF0dHJpYnV0ZXNcbiAgICAgICAgY29uc3QgY3VzdG9tQXR0cmlidXRlczogUmVjb3JkPHN0cmluZywgUHJvdmlkZXJBdHRyaWJ1dGU+ID0ge307XG4gICAgICAgIGZvciAoY29uc3QgW2N1c3RvbUtleSwgYXR0ck5hbWVdIG9mIE9iamVjdC5lbnRyaWVzKHZhbHVlKSkge1xuICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNbY3VzdG9tS2V5XSA9IHtcbiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWU6IGF0dHJOYW1lLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0W2F0dHJOYW1lXSA9IGN1c3RvbUF0dHJpYnV0ZXM7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG4gIC8qKlxuICAgKiBDb252ZXJ0IHNjb3BlcyBmcm9tIHN0cmluZyBsaXN0IHRvIE9BdXRoU2NvcGVzLlxuICAgKiBAcGFyYW0gc2NvcGVzIC0gc2NvcGUgbGlzdFxuICAgKiBAcmV0dXJucyBjb2duaXRvIE9BdXRoU2NvcGVzXG4gICAqL1xuICBwcml2YXRlIGdldE9BdXRoU2NvcGVzID0gKFxuICAgIHNjb3BlczogRXh0ZXJuYWxQcm92aWRlck9wdGlvbnNbJ3Njb3BlcyddLFxuICApOiBjb2duaXRvLk9BdXRoU2NvcGVbXSA9PiB7XG4gICAgaWYgKHNjb3BlcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdDogY29nbml0by5PQXV0aFNjb3BlW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHNjb3BlIG9mIHNjb3Blcykge1xuICAgICAgcmVzdWx0LnB1c2goY29nbml0by5PQXV0aFNjb3BlW3Njb3BlXSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIEdldCBzaWduLWluIHBvbGljeSBjb25maWd1cmF0aW9uIGZvciBwYXNzd29yZGxlc3MgYXV0aGVudGljYXRpb24uXG4gICAqL1xuICBwcml2YXRlIGdldFNpZ25JblBvbGljeSA9IChwcm9wczogQXV0aFByb3BzKSA9PiB7XG4gICAgY29uc3QgZW1haWxPdHBFbmFibGVkID1cbiAgICAgIHR5cGVvZiBwcm9wcy5sb2dpbldpdGguZW1haWwgPT09ICdvYmplY3QnICYmXG4gICAgICBwcm9wcy5sb2dpbldpdGguZW1haWwub3RwTG9naW4gPT09IHRydWU7XG4gICAgY29uc3Qgc21zT3RwRW5hYmxlZCA9XG4gICAgICB0eXBlb2YgcHJvcHMubG9naW5XaXRoLnBob25lID09PSAnb2JqZWN0JyAmJlxuICAgICAgcHJvcHMubG9naW5XaXRoLnBob25lLm90cExvZ2luID09PSB0cnVlO1xuICAgIGNvbnN0IHdlYkF1dGhuRW5hYmxlZCA9IHByb3BzLmxvZ2luV2l0aC53ZWJBdXRobiAhPT0gdW5kZWZpbmVkO1xuXG4gICAgaWYgKCFlbWFpbE90cEVuYWJsZWQgJiYgIXNtc090cEVuYWJsZWQgJiYgIXdlYkF1dGhuRW5hYmxlZCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgYWxsb3dlZEZpcnN0QXV0aEZhY3RvcnM6IHtcbiAgICAgICAgLy8gUEFTU1dPUkQgaXMgYWx3YXlzIGluY2x1ZGVkIHBlciBDb2duaXRvIHJlcXVpcmVtZW50c1xuICAgICAgICBwYXNzd29yZDogdHJ1ZSxcbiAgICAgICAgZW1haWxPdHA6IGVtYWlsT3RwRW5hYmxlZCxcbiAgICAgICAgc21zT3RwOiBzbXNPdHBFbmFibGVkLFxuICAgICAgICBwYXNza2V5OiB3ZWJBdXRobkVuYWJsZWQsXG4gICAgICB9LFxuICAgIH07XG4gIH07XG5cbiAgLyoqXG4gICAqIEdldCBwYXNza2V5IGNvbmZpZ3VyYXRpb24gZm9yIFdlYkF1dGhuLlxuICAgKi9cbiAgcHJpdmF0ZSBnZXRQYXNza2V5Q29uZmlnID0gKHByb3BzOiBBdXRoUHJvcHMpID0+IHtcbiAgICBjb25zdCB3ZWJBdXRobkVuYWJsZWQgPSBwcm9wcy5sb2dpbldpdGgud2ViQXV0aG4gIT09IHVuZGVmaW5lZDtcblxuICAgIGlmICghd2ViQXV0aG5FbmFibGVkKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgY29uc3Qgd2ViQXV0aG5Db25maWcgPSBwcm9wcy5sb2dpbldpdGgud2ViQXV0aG4hO1xuICAgIGxldCByZWx5aW5nUGFydHlJZDogc3RyaW5nO1xuICAgIGxldCB1c2VyVmVyaWZpY2F0aW9uOiBQYXNza2V5VXNlclZlcmlmaWNhdGlvbjtcblxuICAgIGlmICh3ZWJBdXRobkNvbmZpZyA9PT0gdHJ1ZSkge1xuICAgICAgcmVseWluZ1BhcnR5SWQgPSB0aGlzLnJlc29sdmVSZWx5aW5nUGFydHlJZCgnQVVUTycpO1xuICAgICAgdXNlclZlcmlmaWNhdGlvbiA9IFBhc3NrZXlVc2VyVmVyaWZpY2F0aW9uLlBSRUZFUlJFRDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVseWluZ1BhcnR5SWQgPSB0aGlzLnJlc29sdmVSZWx5aW5nUGFydHlJZChcbiAgICAgICAgd2ViQXV0aG5Db25maWcucmVseWluZ1BhcnR5SWQsXG4gICAgICApO1xuICAgICAgdXNlclZlcmlmaWNhdGlvbiA9XG4gICAgICAgIHdlYkF1dGhuQ29uZmlnLnVzZXJWZXJpZmljYXRpb24gPT09ICdyZXF1aXJlZCdcbiAgICAgICAgICA/IFBhc3NrZXlVc2VyVmVyaWZpY2F0aW9uLlJFUVVJUkVEXG4gICAgICAgICAgOiBQYXNza2V5VXNlclZlcmlmaWNhdGlvbi5QUkVGRVJSRUQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcmVseWluZ1BhcnR5SWQsIHVzZXJWZXJpZmljYXRpb24gfTtcbiAgfTtcblxuICAvKipcbiAgICogUmVzb2x2ZSB0aGUgcmVseWluZyBwYXJ0eSBJRCBmb3IgV2ViQXV0aG4gY29uZmlndXJhdGlvbi5cbiAgICogSGFuZGxlcyBBVVRPIHJlc29sdXRpb24gYmFzZWQgb24gZGVwbG95bWVudCBjb250ZXh0LlxuICAgKi9cbiAgcHJpdmF0ZSByZXNvbHZlUmVseWluZ1BhcnR5SWQgPSAocmVseWluZ1BhcnR5SWQ6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gICAgaWYgKHJlbHlpbmdQYXJ0eUlkICE9PSAnQVVUTycpIHtcbiAgICAgIHJldHVybiByZWx5aW5nUGFydHlJZDtcbiAgICB9XG5cbiAgICBjb25zdCBkZXBsb3ltZW50VHlwZSA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KFxuICAgICAgQ0RLQ29udGV4dEtleS5ERVBMT1lNRU5UX1RZUEUsXG4gICAgKTtcblxuICAgIGlmIChkZXBsb3ltZW50VHlwZSA9PT0gJ2JyYW5jaCcpIHtcbiAgICAgIGNvbnN0IGFwcElkID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoQ0RLQ29udGV4dEtleS5CQUNLRU5EX05BTUVTUEFDRSk7XG4gICAgICBjb25zdCBicmFuY2hOYW1lID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoQ0RLQ29udGV4dEtleS5CQUNLRU5EX05BTUUpO1xuXG4gICAgICBpZiAoYXBwSWQgJiYgYnJhbmNoTmFtZSkge1xuICAgICAgICByZXR1cm4gYCR7YnJhbmNoTmFtZX0uJHthcHBJZH0uYW1wbGlmeWFwcC5jb21gO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiAnbG9jYWxob3N0JztcbiAgfTtcblxuICAvKipcbiAgICogQXBwbHkgVVNFUl9BVVRIIGZsb3cgdG8gVXNlclBvb2xDbGllbnQgd2hlbiBwYXNzd29yZGxlc3MgZmFjdG9ycyBhcmUgZW5hYmxlZC5cbiAgICovXG4gIHByaXZhdGUgYXBwbHlVc2VyQXV0aEZsb3cgPSAoXG4gICAgdXNlclBvb2xDbGllbnQ6IFVzZXJQb29sQ2xpZW50LFxuICAgIHByb3BzOiBBdXRoUHJvcHMsXG4gICk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IGVtYWlsT3RwRW5hYmxlZCA9XG4gICAgICB0eXBlb2YgcHJvcHMubG9naW5XaXRoLmVtYWlsID09PSAnb2JqZWN0JyAmJlxuICAgICAgcHJvcHMubG9naW5XaXRoLmVtYWlsLm90cExvZ2luID09PSB0cnVlO1xuICAgIGNvbnN0IHNtc090cEVuYWJsZWQgPVxuICAgICAgdHlwZW9mIHByb3BzLmxvZ2luV2l0aC5waG9uZSA9PT0gJ29iamVjdCcgJiZcbiAgICAgIHByb3BzLmxvZ2luV2l0aC5waG9uZS5vdHBMb2dpbiA9PT0gdHJ1ZTtcbiAgICBjb25zdCB3ZWJBdXRobkVuYWJsZWQgPSBwcm9wcy5sb2dpbldpdGgud2ViQXV0aG4gIT09IHVuZGVmaW5lZDtcblxuICAgIGNvbnN0IGhhc1Bhc3N3b3JkbGVzc0ZhY3RvcnMgPVxuICAgICAgZW1haWxPdHBFbmFibGVkIHx8IHNtc090cEVuYWJsZWQgfHwgd2ViQXV0aG5FbmFibGVkO1xuXG4gICAgaWYgKCFoYXNQYXNzd29yZGxlc3NGYWN0b3JzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgY2ZuVXNlclBvb2xDbGllbnQgPSB1c2VyUG9vbENsaWVudC5ub2RlLmZpbmRDaGlsZChcbiAgICAgICdSZXNvdXJjZScsXG4gICAgKSBhcyBDZm5Vc2VyUG9vbENsaWVudDtcbiAgICBpZiAoIShjZm5Vc2VyUG9vbENsaWVudCBpbnN0YW5jZW9mIENmblVzZXJQb29sQ2xpZW50KSkge1xuICAgICAgdGhyb3cgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIENmblVzZXJQb29sQ2xpZW50IHJlc291cmNlIGluIHN0YWNrLicpO1xuICAgIH1cblxuICAgIGNvbnN0IGV4aXN0aW5nRmxvd3MgPSBjZm5Vc2VyUG9vbENsaWVudC5leHBsaWNpdEF1dGhGbG93cyB8fCBbXTtcbiAgICBjZm5Vc2VyUG9vbENsaWVudC5leHBsaWNpdEF1dGhGbG93cyA9IFsuLi5leGlzdGluZ0Zsb3dzLCAnQUxMT1dfVVNFUl9BVVRIJ107XG4gIH07XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlcyB0aGF0IHRoZSBwcmVmZXJyZWRDaGFsbGVuZ2UgbWF0Y2hlcyBlbmFibGVkIGF1dGhlbnRpY2F0aW9uIG1ldGhvZHNcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVQcmVmZXJyZWRDaGFsbGVuZ2UgPSAocHJvcHM6IEF1dGhQcm9wcyk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IHByZWZlcnJlZENoYWxsZW5nZSA9IHByb3BzLnBhc3N3b3JkbGVzc09wdGlvbnM/LnByZWZlcnJlZENoYWxsZW5nZTtcbiAgICBpZiAoIXByZWZlcnJlZENoYWxsZW5nZSkge1xuICAgICAgcmV0dXJuOyAvLyBObyB2YWxpZGF0aW9uIG5lZWRlZCBpZiBwcmVmZXJyZWRDaGFsbGVuZ2UgaXMgbm90IHNldFxuICAgIH1cblxuICAgIGNvbnN0IGVuYWJsZWRDaGFsbGVuZ2VzOiBzdHJpbmdbXSA9IFsnUEFTU1dPUkQnXTsgLy8gUEFTU1dPUkQgaXMgYWx3YXlzIGF2YWlsYWJsZVxuXG4gICAgLy8gQ2hlY2sgZm9yIEVNQUlMX09UUFxuICAgIGlmIChcbiAgICAgIHByb3BzLmxvZ2luV2l0aC5lbWFpbCAmJlxuICAgICAgdHlwZW9mIHByb3BzLmxvZ2luV2l0aC5lbWFpbCA9PT0gJ29iamVjdCcgJiZcbiAgICAgIHByb3BzLmxvZ2luV2l0aC5lbWFpbC5vdHBMb2dpblxuICAgICkge1xuICAgICAgZW5hYmxlZENoYWxsZW5nZXMucHVzaCgnRU1BSUxfT1RQJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIFNNU19PVFBcbiAgICBpZiAoXG4gICAgICBwcm9wcy5sb2dpbldpdGgucGhvbmUgJiZcbiAgICAgIHR5cGVvZiBwcm9wcy5sb2dpbldpdGgucGhvbmUgPT09ICdvYmplY3QnICYmXG4gICAgICBwcm9wcy5sb2dpbldpdGgucGhvbmUub3RwTG9naW5cbiAgICApIHtcbiAgICAgIGVuYWJsZWRDaGFsbGVuZ2VzLnB1c2goJ1NNU19PVFAnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgV0VCX0FVVEhOXG4gICAgaWYgKHByb3BzLmxvZ2luV2l0aC53ZWJBdXRobikge1xuICAgICAgZW5hYmxlZENoYWxsZW5nZXMucHVzaCgnV0VCX0FVVEhOJyk7XG4gICAgfVxuXG4gICAgaWYgKCFlbmFibGVkQ2hhbGxlbmdlcy5pbmNsdWRlcyhwcmVmZXJyZWRDaGFsbGVuZ2UpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBQcmVmZXJyZWQgY2hhbGxlbmdlIFwiJHtwcmVmZXJyZWRDaGFsbGVuZ2V9XCIgaXMgbm90IGVuYWJsZWQgaW4geW91ciBhdXRoZW50aWNhdGlvbiBjb25maWd1cmF0aW9uLiBgICtcbiAgICAgICAgICBgRW5hYmxlZCBjaGFsbGVuZ2VzOiAke2VuYWJsZWRDaGFsbGVuZ2VzLmpvaW4oJywgJyl9LiBgICtcbiAgICAgICAgICBgVGhpcyB3aWxsIHJlc3VsdCBpbiBhIGJyb2tlbiBhdXRoZW50aWNhdGlvbiBmbG93IGluIHRoZSBmcm9udGVuZC5gLFxuICAgICAgKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFN0b3JlcyBhdXRoIG91dHB1dCB1c2luZyB0aGUgcHJvdmlkZWQgc3RyYXRlZ3lcbiAgICovXG4gIHByaXZhdGUgc3RvcmVPdXRwdXQgPSAoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEF1dGhPdXRwdXQ+ID0gbmV3IFN0YWNrTWV0YWRhdGFCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5KFxuICAgICAgU3RhY2sub2YodGhpcyksXG4gICAgKSxcbiAgKTogdm9pZCA9PiB7XG4gICAgY29uc3QgY2ZuVXNlclBvb2wgPSB0aGlzLnJlc291cmNlcy5jZm5SZXNvdXJjZXMuY2ZuVXNlclBvb2w7XG4gICAgY29uc3QgY2ZuVXNlclBvb2xDbGllbnQgPSB0aGlzLnJlc291cmNlcy5jZm5SZXNvdXJjZXMuY2ZuVXNlclBvb2xDbGllbnQ7XG4gICAgY29uc3QgY2ZuSWRlbnRpdHlQb29sID0gdGhpcy5yZXNvdXJjZXMuY2ZuUmVzb3VyY2VzLmNmbklkZW50aXR5UG9vbDtcbiAgICAvLyB0aGVzZSBwcm9wZXJ0aWVzIGNhbm5vdCBiZSBvdmVyd3JpdHRlblxuICAgIGNvbnN0IG91dHB1dDogQXV0aE91dHB1dFsncGF5bG9hZCddID0ge1xuICAgICAgdXNlclBvb2xJZDogdGhpcy5yZXNvdXJjZXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgIHdlYkNsaWVudElkOiB0aGlzLnJlc291cmNlcy51c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkLFxuICAgICAgaWRlbnRpdHlQb29sSWQ6IGNmbklkZW50aXR5UG9vbC5yZWYsXG4gICAgICBhdXRoUmVnaW9uOiBTdGFjay5vZih0aGlzKS5yZWdpb24sXG4gICAgfTtcblxuICAgIC8vIHRoZSBwcm9wZXJ0aWVzIGJlbG93IHRoaXMgbGluZSBjYW4gYmUgb3ZlcndyaXR0ZW4sIHNvIHRoZXkgYXJlIGV4cG9zZWQgdmlhIGNkayBMQVpZXG4gICAgb3V0cHV0LmFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+XG4gICAgICAgIGNmbklkZW50aXR5UG9vbC5hbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMgPT09IHRydWVcbiAgICAgICAgICA/ICd0cnVlJ1xuICAgICAgICAgIDogJ2ZhbHNlJyxcbiAgICB9KTtcblxuICAgIC8vIGV4dHJhY3Qgc2lnbnVwQXR0cmlidXRlcyBmcm9tIFVzZXJQb29sIHNjaGVtYSdzIHJlcXVpcmVkIGF0dHJpYnV0ZXNcbiAgICBvdXRwdXQuc2lnbnVwQXR0cmlidXRlcyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgaWYgKCFjZm5Vc2VyUG9vbC5zY2hlbWEpIHtcbiAgICAgICAgICByZXR1cm4gJ1tdJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgKGNmblVzZXJQb29sLnNjaGVtYSBhcyBDZm5Vc2VyUG9vbC5TY2hlbWFBdHRyaWJ1dGVQcm9wZXJ0eVtdKVxuICAgICAgICAgICAgLmZpbHRlcigoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUucmVxdWlyZWQgJiYgYXR0cmlidXRlLm5hbWUpXG4gICAgICAgICAgICAubWFwKChhdHRyaWJ1dGUpID0+IGF0dHJpYnV0ZS5uYW1lPy50b0xvd2VyQ2FzZSgpKSxcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBleHRyYWN0IHVzZXJuYW1lQXR0cmlidXRlcyBmcm9tIFVzZXJQb29sJ3MgdXNlcm5hbWVBdHRyaWJ1dGVzXG4gICAgb3V0cHV0LnVzZXJuYW1lQXR0cmlidXRlcyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgIGNmblVzZXJQb29sLnVzZXJuYW1lQXR0cmlidXRlcz8ubWFwKChhdHRyKSA9PiBhdHRyLnRvTG93ZXJDYXNlKCkpIHx8XG4gICAgICAgICAgICBbXSxcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBleHRyYWN0IHZlcmlmaWNhdGlvbk1lY2hhbmlzbXMgZnJvbSBVc2VyUG9vbCdzIGF1dG9WZXJpZmllZEF0dHJpYnV0ZXNcbiAgICBvdXRwdXQudmVyaWZpY2F0aW9uTWVjaGFuaXNtcyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGNmblVzZXJQb29sLmF1dG9WZXJpZmllZEF0dHJpYnV0ZXMgPz8gW10pO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIGV4dHJhY3QgdGhlIHBhc3N3b3JkUG9saWN5IGZyb20gdGhlIFVzZXJQb29sIHBvbGljaWVzXG4gICAgb3V0cHV0LnBhc3N3b3JkUG9saWN5TWluTGVuZ3RoID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBpZiAoIWNmblVzZXJQb29sLnBvbGljaWVzKSB7XG4gICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBvbGljeSA9IChjZm5Vc2VyUG9vbC5wb2xpY2llcyBhcyBDZm5Vc2VyUG9vbC5Qb2xpY2llc1Byb3BlcnR5KVxuICAgICAgICAgIC5wYXNzd29yZFBvbGljeSBhcyBDZm5Vc2VyUG9vbC5QYXNzd29yZFBvbGljeVByb3BlcnR5O1xuICAgICAgICByZXR1cm4gcG9saWN5Lm1pbmltdW1MZW5ndGg/LnRvU3RyaW5nKCk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0LnBhc3N3b3JkUG9saWN5UmVxdWlyZW1lbnRzID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBpZiAoIWNmblVzZXJQb29sLnBvbGljaWVzKSB7XG4gICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBvbGljeSA9IChjZm5Vc2VyUG9vbC5wb2xpY2llcyBhcyBDZm5Vc2VyUG9vbC5Qb2xpY2llc1Byb3BlcnR5KVxuICAgICAgICAgIC5wYXNzd29yZFBvbGljeSBhcyBDZm5Vc2VyUG9vbC5QYXNzd29yZFBvbGljeVByb3BlcnR5O1xuICAgICAgICBjb25zdCByZXF1aXJlbWVudHMgPSBbXTtcbiAgICAgICAgcG9saWN5LnJlcXVpcmVOdW1iZXJzICYmIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19OVU1CRVJTJyk7XG4gICAgICAgIHBvbGljeS5yZXF1aXJlTG93ZXJjYXNlICYmIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19MT1dFUkNBU0UnKTtcbiAgICAgICAgcG9saWN5LnJlcXVpcmVVcHBlcmNhc2UgJiYgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1VQUEVSQ0FTRScpO1xuICAgICAgICBwb2xpY3kucmVxdWlyZVN5bWJvbHMgJiYgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1NZTUJPTFMnKTtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHJlcXVpcmVtZW50cyk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gZXh0cmFjdCB0aGUgTUZBIGNvbmZpZ3VyYXRpb24gc2V0dGluZyBmcm9tIHRoZSBVc2VyUG9vbCByZXNvdXJjZVxuICAgIG91dHB1dC5tZmFDb25maWd1cmF0aW9uID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICByZXR1cm4gY2ZuVXNlclBvb2wubWZhQ29uZmlndXJhdGlvbiA/PyAnT0ZGJztcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgLy8gZXh0cmFjdCB0aGUgTUZBIHR5cGVzIGZyb20gdGhlIFVzZXJQb29sIHJlc291cmNlXG4gICAgb3V0cHV0Lm1mYVR5cGVzID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBjb25zdCBlbmFibGVkTWZhcyA9IGNmblVzZXJQb29sLmVuYWJsZWRNZmFzID8/IFtdO1xuICAgICAgICBjb25zdCBtZmFUeXBlczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgZW5hYmxlZE1mYXMuZm9yRWFjaCgodHlwZSkgPT4ge1xuICAgICAgICAgIGlmICh0eXBlID09PSAnU01TX01GQScpIHtcbiAgICAgICAgICAgIG1mYVR5cGVzLnB1c2goJ1NNUycpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NPRlRXQVJFX1RPS0VOX01GQScpIHtcbiAgICAgICAgICAgIG1mYVR5cGVzLnB1c2goJ1RPVFAnKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHR5cGUgPT09ICdFTUFJTF9PVFAnKSB7XG4gICAgICAgICAgICBtZmFUeXBlcy5wdXNoKCdFTUFJTCcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShtZmFUeXBlcyk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gZXh0cmFjdCBwYXNzd29yZGxlc3MgY29uZmlndXJhdGlvblxuICAgIG91dHB1dC5wYXNzd29yZGxlc3NPcHRpb25zID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBjb25zdCBwYXNzd29yZGxlc3NDb25maWc6IHtcbiAgICAgICAgICBlbWFpbE90cEVuYWJsZWQ/OiBib29sZWFuO1xuICAgICAgICAgIHNtc090cEVuYWJsZWQ/OiBib29sZWFuO1xuICAgICAgICAgIHdlYkF1dGhuPzoge1xuICAgICAgICAgICAgcmVseWluZ1BhcnR5SWQ6IHN0cmluZztcbiAgICAgICAgICAgIHVzZXJWZXJpZmljYXRpb246ICdyZXF1aXJlZCcgfCAncHJlZmVycmVkJztcbiAgICAgICAgICB9O1xuICAgICAgICAgIHByZWZlcnJlZENoYWxsZW5nZT86IHN0cmluZztcbiAgICAgICAgfSA9IHt9O1xuXG4gICAgICAgIGNvbnN0IHNpZ25JblBvbGljeSA9IChcbiAgICAgICAgICBjZm5Vc2VyUG9vbC5wb2xpY2llcyBhcyBDZm5Vc2VyUG9vbC5Qb2xpY2llc1Byb3BlcnR5XG4gICAgICAgICk/LnNpZ25JblBvbGljeTtcbiAgICAgICAgaWYgKHNpZ25JblBvbGljeSkge1xuICAgICAgICAgIGNvbnN0IGFsbG93ZWRGYWN0b3JzID1cbiAgICAgICAgICAgIChzaWduSW5Qb2xpY3kgYXMgQ2ZuVXNlclBvb2wuU2lnbkluUG9saWN5UHJvcGVydHkpXG4gICAgICAgICAgICAgIC5hbGxvd2VkRmlyc3RBdXRoRmFjdG9ycyB8fCBbXTtcbiAgICAgICAgICBwYXNzd29yZGxlc3NDb25maWcuZW1haWxPdHBFbmFibGVkID1cbiAgICAgICAgICAgIGFsbG93ZWRGYWN0b3JzLmluY2x1ZGVzKCdFTUFJTF9PVFAnKTtcbiAgICAgICAgICBwYXNzd29yZGxlc3NDb25maWcuc21zT3RwRW5hYmxlZCA9IGFsbG93ZWRGYWN0b3JzLmluY2x1ZGVzKCdTTVNfT1RQJyk7XG5cbiAgICAgICAgICBpZiAoYWxsb3dlZEZhY3RvcnMuaW5jbHVkZXMoJ1dFQl9BVVRITicpKSB7XG4gICAgICAgICAgICBwYXNzd29yZGxlc3NDb25maWcud2ViQXV0aG4gPSB7XG4gICAgICAgICAgICAgIHJlbHlpbmdQYXJ0eUlkOiBjZm5Vc2VyUG9vbC53ZWJBdXRoblJlbHlpbmdQYXJ0eUlkIHx8ICcnLFxuICAgICAgICAgICAgICB1c2VyVmVyaWZpY2F0aW9uOlxuICAgICAgICAgICAgICAgIChjZm5Vc2VyUG9vbC53ZWJBdXRoblVzZXJWZXJpZmljYXRpb24gYXNcbiAgICAgICAgICAgICAgICAgIHwgJ3JlcXVpcmVkJ1xuICAgICAgICAgICAgICAgICAgfCAncHJlZmVycmVkJykgfHwgJ3ByZWZlcnJlZCcsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnByZWZlcnJlZENoYWxsZW5nZSkge1xuICAgICAgICAgIHBhc3N3b3JkbGVzc0NvbmZpZy5wcmVmZXJyZWRDaGFsbGVuZ2UgPSB0aGlzLnByZWZlcnJlZENoYWxsZW5nZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhwYXNzd29yZGxlc3NDb25maWcpLmxlbmd0aCA+IDBcbiAgICAgICAgICA/IEpTT04uc3RyaW5naWZ5KHBhc3N3b3JkbGVzc0NvbmZpZylcbiAgICAgICAgICA6ICcnO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIGV4dHJhY3Qgc29jaWFsIHByb3ZpZGVycyBmcm9tIFVzZXJQb29sIHJlc291cmNlXG4gICAgb3V0cHV0LnNvY2lhbFByb3ZpZGVycyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgY29uc3Qgb3V0cHV0UHJvdmlkZXJzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBjb25zdCB1c2VyUG9vbFByb3ZpZGVycyA9IHRoaXMucmVzb3VyY2VzLnVzZXJQb29sLmlkZW50aXR5UHJvdmlkZXJzO1xuICAgICAgICBpZiAoIXVzZXJQb29sUHJvdmlkZXJzIHx8IHVzZXJQb29sUHJvdmlkZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IHByb3ZpZGVyIG9mIHVzZXJQb29sUHJvdmlkZXJzKSB7XG4gICAgICAgICAgY29uc3QgcHJvdmlkZXJSZXNvdXJjZSA9IHByb3ZpZGVyLm5vZGUuZmluZENoaWxkKFxuICAgICAgICAgICAgJ1Jlc291cmNlJyxcbiAgICAgICAgICApIGFzIENmblVzZXJQb29sSWRlbnRpdHlQcm92aWRlcjtcbiAgICAgICAgICBpZiAoIShwcm92aWRlclJlc291cmNlIGluc3RhbmNlb2YgQ2ZuVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyKSkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgICAgICdDb3VsZCBub3QgZmluZCB0aGUgQ2ZuVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyIHJlc291cmNlIGluIHRoZSBzdGFjay4nLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgcHJvdmlkZXJUeXBlID0gcHJvdmlkZXJSZXNvdXJjZS5wcm92aWRlclR5cGU7XG4gICAgICAgICAgY29uc3QgcHJvdmlkZXJOYW1lID0gcHJvdmlkZXJSZXNvdXJjZS5wcm92aWRlck5hbWU7XG4gICAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ0dvb2dsZScpIHtcbiAgICAgICAgICAgIG91dHB1dFByb3ZpZGVycy5wdXNoKCdHT09HTEUnKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ0ZhY2Vib29rJykge1xuICAgICAgICAgICAgb3V0cHV0UHJvdmlkZXJzLnB1c2goJ0ZBQ0VCT09LJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdTaWduSW5XaXRoQXBwbGUnKSB7XG4gICAgICAgICAgICBvdXRwdXRQcm92aWRlcnMucHVzaCgnU0lHTl9JTl9XSVRIX0FQUExFJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdMb2dpbldpdGhBbWF6b24nKSB7XG4gICAgICAgICAgICBvdXRwdXRQcm92aWRlcnMucHVzaCgnTE9HSU5fV0lUSF9BTUFaT04nKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ09JREMnKSB7XG4gICAgICAgICAgICBvdXRwdXRQcm92aWRlcnMucHVzaChwcm92aWRlck5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnU0FNTCcpIHtcbiAgICAgICAgICAgIG91dHB1dFByb3ZpZGVycy5wdXNoKHByb3ZpZGVyTmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvdXRwdXRQcm92aWRlcnMpO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIG91dHB1dC5vYXV0aENvZ25pdG9Eb21haW4gPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHVzZXJQb29sRG9tYWluID0gdGhpcy5yZXNvdXJjZXMudXNlclBvb2wubm9kZS50cnlGaW5kQ2hpbGQoXG4gICAgICAgICAgYCR7dGhpcy5uYW1lfVVzZXJQb29sRG9tYWluYCxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCF1c2VyUG9vbERvbWFpbikge1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICBpZiAoISh1c2VyUG9vbERvbWFpbiBpbnN0YW5jZW9mIFVzZXJQb29sRG9tYWluKSkge1xuICAgICAgICAgIHRocm93IEVycm9yKCdDb3VsZCBub3QgZmluZCBVc2VyUG9vbERvbWFpbiByZXNvdXJjZSBpbiB0aGUgc3RhY2suJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGAke3VzZXJQb29sRG9tYWluLmRvbWFpbk5hbWV9LmF1dGguJHtcbiAgICAgICAgICBTdGFjay5vZih0aGlzKS5yZWdpb25cbiAgICAgICAgfS5hbWF6b25jb2duaXRvLmNvbWA7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0Lm9hdXRoU2NvcGUgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShjZm5Vc2VyUG9vbENsaWVudC5hbGxvd2VkT0F1dGhTY29wZXMgPz8gW10pO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIG91dHB1dC5vYXV0aFJlZGlyZWN0U2lnbkluID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICByZXR1cm4gY2ZuVXNlclBvb2xDbGllbnQuY2FsbGJhY2tVckxzXG4gICAgICAgICAgPyBjZm5Vc2VyUG9vbENsaWVudC5jYWxsYmFja1VyTHMuam9pbignLCcpXG4gICAgICAgICAgOiAnJztcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQub2F1dGhSZWRpcmVjdFNpZ25PdXQgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBjZm5Vc2VyUG9vbENsaWVudC5sb2dvdXRVckxzXG4gICAgICAgICAgPyBjZm5Vc2VyUG9vbENsaWVudC5sb2dvdXRVckxzLmpvaW4oJywnKVxuICAgICAgICAgIDogJyc7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0Lm9hdXRoUmVzcG9uc2VUeXBlID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICByZXR1cm4gY2ZuVXNlclBvb2xDbGllbnQuYWxsb3dlZE9BdXRoRmxvd3NcbiAgICAgICAgICA/IGNmblVzZXJQb29sQ2xpZW50LmFsbG93ZWRPQXV0aEZsb3dzLmpvaW4oJywnKVxuICAgICAgICAgIDogJyc7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0Lm9hdXRoQ2xpZW50SWQgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBjZm5Vc2VyUG9vbENsaWVudC5yZWY7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gdXNlciBncm91cCBwcmVjZWRlbmNlIGNhbiBiZSBvdmVyd3JpdHRlbiwgc28gdGhleSBhcmUgZXhwb3NlZCB2aWEgY2RrIExBWllcbiAgICBvdXRwdXQuZ3JvdXBzID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBjb25zdCBncm91cHNBcnJheToge1xuICAgICAgICAgIFtrZXk6IHN0cmluZ106IHtcbiAgICAgICAgICAgIHByZWNlZGVuY2U/OiBudW1iZXI7XG4gICAgICAgICAgfTtcbiAgICAgICAgfVtdID0gW107XG4gICAgICAgIE9iamVjdC5rZXlzKHRoaXMucmVzb3VyY2VzLmdyb3VwcykuZm9yRWFjaChcbiAgICAgICAgICAoZ3JvdXBOYW1lKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcmVjZWRlbmNlID1cbiAgICAgICAgICAgICAgdGhpcy5yZXNvdXJjZXMuZ3JvdXBzW2dyb3VwTmFtZV0uY2ZuVXNlckdyb3VwLnByZWNlZGVuY2U7XG4gICAgICAgICAgICBncm91cHNBcnJheS5wdXNoKHtcbiAgICAgICAgICAgICAgW2dyb3VwTmFtZV06IHtcbiAgICAgICAgICAgICAgICBwcmVjZWRlbmNlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICB7fSBhcyBSZWNvcmQ8c3RyaW5nLCB7IHByZWNlZGVuY2U/OiBudW1iZXIgfT4sXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGdyb3Vwc0FycmF5KTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYWRkQmFja2VuZE91dHB1dEVudHJ5KGF1dGhPdXRwdXRLZXksIHtcbiAgICAgIHZlcnNpb246ICcxJyxcbiAgICAgIHBheWxvYWQ6IG91dHB1dCxcbiAgICB9KTtcbiAgfTtcbn1cbiJdfQ==