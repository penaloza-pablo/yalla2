import { ScheduleExpression, } from 'aws-cdk-lib/aws-scheduler';
import { TimeZone } from 'aws-cdk-lib';
import os from 'os';
const DEFAULT_TIMEZONE = 'UTC';
const hydrateDefaults = (schedule) => {
    if (typeof schedule === 'string') {
        return schedule.includes('every')
            ? { rate: schedule, timezone: DEFAULT_TIMEZONE }
            : {
                cron: schedule,
                timezone: DEFAULT_TIMEZONE,
            };
    }
    else if ('rate' in schedule) {
        return { ...schedule, timezone: schedule.timezone ?? DEFAULT_TIMEZONE };
    }
    else if ('cron' in schedule) {
        return { ...schedule, timezone: schedule.timezone ?? DEFAULT_TIMEZONE };
    }
    throw new Error("Could not determine the function's schedule type");
};
/**
 * Converts function schedules to schedule props.
 * @param lambda The Lambda function to associate with the schedules.
 * @param functionSchedules The function schedules to convert.
 * @returns An array of schedule props.
 */
export const convertFunctionSchedulesToScheduleProps = (lambda, functionSchedules) => {
    const errors = [];
    const scheduleProps = [];
    const schedules = Array.isArray(functionSchedules)
        ? functionSchedules
        : [functionSchedules];
    const zonedSchedules = schedules.map(hydrateDefaults);
    zonedSchedules.forEach((schedule) => {
        if (isTimeInterval(schedule)) {
            const { value, unit } = parseTimeInterval(schedule.rate);
            if (value && !isPositiveWholeNumber(value)) {
                errors.push('Function schedule rate must be set with a positive whole number');
            }
            else if (value &&
                lambda.timeout &&
                unit === 'm' &&
                value * 60 < lambda.timeout.toSeconds()) {
                const timeout = lambda.timeout.toSeconds();
                errors.push(`Function schedule rate must be greater than the function timeout of ${timeout} ${timeout > 1 ? 'seconds' : 'second'}`);
            }
        }
        else {
            const cronErrors = validateCron(schedule.cron);
            if (cronErrors.length > 0) {
                errors.push(...cronErrors);
            }
        }
        if (errors.length === 0) {
            scheduleProps.push({
                schedule: ScheduleExpression.cron(translateToCronOptionsWithTimezone(schedule)),
                description: schedule.description,
            });
        }
    });
    if (errors.length > 0) {
        throw new Error(errors.join(os.EOL));
    }
    return scheduleProps;
};
const isTimeInterval = (schedule) => {
    const expression = 'rate' in schedule ? schedule.rate : '';
    const parts = expression.split(' ');
    return (parts[0] === 'every' &&
        ['m', 'h', 'day', 'week', 'month', 'year'].some((a) => parts[1].endsWith(a)) &&
        parts.length === 2);
};
const parseTimeInterval = (timeInterval) => {
    const part = timeInterval.split(' ')[1];
    const value = part.match(/-?\d+\.?\d*/);
    const unit = part.match(/[a-zA-Z]+/);
    return {
        value: value ? Number(value[0]) : undefined,
        unit: unit ? unit[0] : undefined,
    };
};
const isPositiveWholeNumber = (test) => test > 0 && test % 1 === 0;
const validateCron = (cron) => {
    const errors = [];
    const cronParts = cron.split(' ');
    const [minute, hour, dayOfMonth, month, dayOfWeek, year] = cronParts;
    const minuteValidationErrors = validateCronPart('minutes', minute, 0, 59);
    const hourValidationErrors = validateCronPart('hours', hour, 0, 23);
    const dayOfMonthValidationErrors = dayOfMonth === '?'
        ? []
        : validateCronPart('day-of-month', dayOfMonth, 1, 31);
    const monthValidationErrors = validateCronPart('month', month, 1, 12);
    const dayOfWeekValidationErrors = dayOfWeek === '?' ? [] : validateCronPart('day-of-week', dayOfWeek, 1, 7);
    const yearValidationErrors = year
        ? validateCronPart('year', year, 1970, 2199)
        : [];
    errors.push(...minuteValidationErrors, ...hourValidationErrors, ...dayOfMonthValidationErrors, ...monthValidationErrors, ...dayOfWeekValidationErrors, ...yearValidationErrors);
    if (dayOfMonth !== '?' && dayOfWeek !== '?') {
        errors.push('Cron expressions cannot have both day-of-month and day-of-week defined, you must use a ? in one of the fields');
    }
    return errors;
};
const validateCronPart = (cronPart, value, min, max) => {
    const errors = [];
    if (value === '*') {
        return errors;
    }
    const hasStep = value.includes('/');
    const hasRange = value.includes('-');
    const hasList = value.includes(',');
    if (hasList) {
        const listError = validateList(cronPart, value, min, max);
        if (listError) {
            errors.push(listError);
        }
        const listItems = value.split(',');
        listItems.forEach((listItem) => {
            if (listItem.includes('/')) {
                const stepError = validateStepValue(cronPart, listItem, min, max);
                if (stepError) {
                    errors.push(stepError);
                }
            }
            else if (listItem.includes('-')) {
                const rangeError = validateRange(cronPart, listItem, min, max);
                if (rangeError) {
                    errors.push(rangeError);
                }
            }
        });
    }
    else if (hasStep) {
        const stepError = validateStepValue(cronPart, value, min, max);
        if (stepError) {
            errors.push(stepError);
        }
    }
    else if (hasRange) {
        const rangeError = validateRange(cronPart, value, min, max);
        if (rangeError) {
            errors.push(rangeError);
        }
    }
    if (!hasStep &&
        !hasRange &&
        !hasList &&
        !isWholeNumberBetweenInclusive(Number(value), min, max)) {
        errors.push(`Cron field for ${cronPart} must be a whole number between ${min} and ${max}`);
    }
    return errors;
};
const validateStepValue = (cronPart, value, min, max) => {
    const originalBase = value.split('/')[0];
    const [base, step] = value.split('/').map(Number);
    if (originalBase === '*') {
        if (isNaN(step) || step <= 0 || !isPositiveWholeNumber(step)) {
            return `Cron step values for ${cronPart} must be positive whole numbers`;
        }
    }
    else if (isNaN(base) ||
        isNaN(step) ||
        !isWholeNumberBetweenInclusive(base, min, max) ||
        step <= 0) {
        return `Cron step values for ${cronPart} must be whole numbers between ${min} and ${max}`;
    }
    return;
};
const validateRange = (cronPart, value, min, max) => {
    const [start, end] = value.split('-').map(Number);
    if (isNaN(start) ||
        isNaN(end) ||
        !isWholeNumberBetweenInclusive(start, min, max) ||
        !isWholeNumberBetweenInclusive(end, min, max) ||
        start > end) {
        return `Cron range for ${cronPart} must be whole numbers between ${min} and ${max}`;
    }
    return;
};
const validateList = (cronPart, value, min, max) => {
    if (!value
        .split(',')
        .every((v) => isWholeNumberBetweenInclusive(Number(v), min, max))) {
        return `Cron list for ${cronPart} must contain whole numbers between ${min} and ${max}`;
    }
    return;
};
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const translateToCronOptionsWithTimezone = (schedule) => {
    if (isTimeInterval(schedule)) {
        const { value, unit } = parseTimeInterval(schedule.rate);
        switch (unit) {
            case 'm':
                return {
                    minute: `*/${value}`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'h':
                return {
                    minute: '0',
                    hour: `*/${value}`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'day':
                return {
                    minute: '0',
                    hour: '0',
                    day: `*`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'week':
                return {
                    minute: '0',
                    hour: '0',
                    weekDay: `1`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'month':
                return {
                    minute: '0',
                    hour: '0',
                    day: '1',
                    month: `*`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'year':
                return {
                    minute: '0',
                    hour: '0',
                    day: '1',
                    month: '1',
                    year: `*`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            default:
                // This should never happen with strict types
                throw new Error('Could not determine the schedule rate for the function');
        }
    }
    else {
        const cronArray = schedule.cron.split(' ');
        const result = {
            minute: cronArray[0],
            hour: cronArray[1],
            month: cronArray[3],
            year: cronArray.length === 6 ? cronArray[5] : '*',
            timeZone: TimeZone.of(schedule.timezone),
        };
        // Branching logic here is because we cannot supply both day and weekDay
        if (cronArray[2] === '?') {
            result.weekDay = cronArray[4];
        }
        else {
            result.day = cronArray[2];
        }
        return result;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGVfcGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NjaGVkdWxlX3BhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsa0JBQWtCLEdBRW5CLE1BQU0sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQVN2QyxPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFnQnBCLE1BQU0sZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO0FBRS9CLE1BQU0sZUFBZSxHQUFHLENBQUMsUUFBMEIsRUFBaUIsRUFBRTtJQUNwRSxJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQ2pDLE9BQU8sUUFBUSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7WUFDL0IsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQWtDLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFO1lBQzFFLENBQUMsQ0FBQztnQkFDRSxJQUFJLEVBQUUsUUFBa0M7Z0JBQ3hDLFFBQVEsRUFBRSxnQkFBZ0I7YUFDM0IsQ0FBQztJQUNSLENBQUM7U0FBTSxJQUFJLE1BQU0sSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUM5QixPQUFPLEVBQUUsR0FBRyxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxRQUFRLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztJQUMxRSxDQUFDO1NBQU0sSUFBSSxNQUFNLElBQUksUUFBUSxFQUFFLENBQUM7UUFDOUIsT0FBTyxFQUFFLEdBQUcsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUSxJQUFJLGdCQUFnQixFQUFFLENBQUM7SUFDMUUsQ0FBQztJQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztBQUN0RSxDQUFDLENBQUM7QUFJRjs7Ozs7R0FLRztBQUNILE1BQU0sQ0FBQyxNQUFNLHVDQUF1QyxHQUFHLENBQ3JE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QUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzQyxNQUFNLE1BQU0sR0FBeUQ7WUFDbkUsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDbEIsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxFQUFFLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUc7WUFDakQsUUFBUSxFQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztTQUN6QyxDQUFDO1FBRUYsd0VBQXdFO1FBQ3hFLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hDLENBQUM7YUFBTSxDQUFDO1lBQ04sTUFBTSxDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUIsQ0FBQztRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDcm9uT3B0aW9uc1dpdGhUaW1lem9uZSxcbiAgU2NoZWR1bGVFeHByZXNzaW9uLFxuICBTY2hlZHVsZVByb3BzLFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc2NoZWR1bGVyJztcbmltcG9ydCB7IFRpbWVab25lIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgTm9kZWpzRnVuY3Rpb24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLW5vZGVqcyc7XG5pbXBvcnQgdHlwZSB7XG4gIENyb25TY2hlZHVsZUV4cHJlc3Npb24sXG4gIEZ1bmN0aW9uU2NoZWR1bGUsXG4gIFRpbWVJbnRlcnZhbEV4cHJlc3Npb24sXG4gIFpvbmVkQ3JvblNjaGVkdWxlLFxuICBab25lZFRpbWVJbnRlcnZhbCxcbn0gZnJvbSAnLi9mYWN0b3J5LmpzJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5cbnR5cGUgQ3JvblBhcnQgPVxuICB8ICdtaW51dGVzJ1xuICB8ICdob3VycydcbiAgfCAnZGF5LW9mLW1vbnRoJ1xuICB8ICdtb250aCdcbiAgfCAnZGF5LW9mLXdlZWsnXG4gIHwgJ3llYXInO1xuXG50eXBlIFpvbmVkU2NoZWR1bGUgPSBab25lZENyb25TY2hlZHVsZSB8IFpvbmVkVGltZUludGVydmFsO1xuXG50eXBlIFdyaXRhYmxlPFQsIEsgZXh0ZW5kcyBrZXlvZiBUPiA9IHtcbiAgLXJlYWRvbmx5IFtQIGluIEtdOiBUW1BdO1xufSAmIE9taXQ8VCwgSz47XG5cbmNvbnN0IERFRkFVTFRfVElNRVpPTkUgPSAnVVRDJztcblxuY29uc3QgaHlkcmF0ZURlZmF1bHRzID0gKHNjaGVkdWxlOiBGdW5jdGlvblNjaGVkdWxlKTogWm9uZWRTY2hlZHVsZSA9PiB7XG4gIGlmICh0eXBlb2Ygc2NoZWR1bGUgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIHNjaGVkdWxlLmluY2x1ZGVzKCdldmVyeScpXG4gICAgICA/IHsgcmF0ZTogc2NoZWR1bGUgYXMgVGltZUludGVydmFsRXhwcmVzc2lvbiwgdGltZXpvbmU6IERFRkFVTFRfVElNRVpPTkUgfVxuICAgICAgOiB7XG4gICAgICAgICAgY3Jvbjogc2NoZWR1bGUgYXMgQ3JvblNjaGVkdWxlRXhwcmVzc2lvbixcbiAgICAgICAgICB0aW1lem9uZTogREVGQVVMVF9USU1FWk9ORSxcbiAgICAgICAgfTtcbiAgfSBlbHNlIGlmICgncmF0ZScgaW4gc2NoZWR1bGUpIHtcbiAgICByZXR1cm4geyAuLi5zY2hlZHVsZSwgdGltZXpvbmU6IHNjaGVkdWxlLnRpbWV6b25lID8/IERFRkFVTFRfVElNRVpPTkUgfTtcbiAgfSBlbHNlIGlmICgnY3JvbicgaW4gc2NoZWR1bGUpIHtcbiAgICByZXR1cm4geyAuLi5zY2hlZHVsZSwgdGltZXpvbmU6IHNjaGVkdWxlLnRpbWV6b25lID8/IERFRkFVTFRfVElNRVpPTkUgfTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgZGV0ZXJtaW5lIHRoZSBmdW5jdGlvbidzIHNjaGVkdWxlIHR5cGVcIik7XG59O1xuXG50eXBlIFNjaGVkdWxlQ29uZmlnID0gUGljazxTY2hlZHVsZVByb3BzLCAnc2NoZWR1bGUnIHwgJ2Rlc2NyaXB0aW9uJz47XG5cbi8qKlxuICogQ29udmVydHMgZnVuY3Rpb24gc2NoZWR1bGVzIHRvIHNjaGVkdWxlIHByb3BzLlxuICogQHBhcmFtIGxhbWJkYSBUaGUgTGFtYmRhIGZ1bmN0aW9uIHRvIGFzc29jaWF0ZSB3aXRoIHRoZSBzY2hlZHVsZXMuXG4gKiBAcGFyYW0gZnVuY3Rpb25TY2hlZHVsZXMgVGhlIGZ1bmN0aW9uIHNjaGVkdWxlcyB0byBjb252ZXJ0LlxuICogQHJldHVybnMgQW4gYXJyYXkgb2Ygc2NoZWR1bGUgcHJvcHMuXG4gKi9cbmV4cG9ydCBjb25zdCBjb252ZXJ0RnVuY3Rpb25TY2hlZHVsZXNUb1NjaGVkdWxlUHJvcHMgPSAoXG4gIGxhbWJkYTogTm9kZWpzRnVuY3Rpb24sXG4gIGZ1bmN0aW9uU2NoZWR1bGVzOiBGdW5jdGlvblNjaGVkdWxlIHwgRnVuY3Rpb25TY2hlZHVsZVtdLFxuKTogU2NoZWR1bGVDb25maWdbXSA9PiB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgY29uc3Qgc2NoZWR1bGVQcm9wczogU2NoZWR1bGVDb25maWdbXSA9IFtdO1xuXG4gIGNvbnN0IHNjaGVkdWxlcyA9IEFycmF5LmlzQXJyYXkoZnVuY3Rpb25TY2hlZHVsZXMpXG4gICAgPyBmdW5jdGlvblNjaGVkdWxlc1xuICAgIDogW2Z1bmN0aW9uU2NoZWR1bGVzXTtcblxuICBjb25zdCB6b25lZFNjaGVkdWxlcyA9IHNjaGVkdWxlcy5tYXAoaHlkcmF0ZURlZmF1bHRzKTtcblxuICB6b25lZFNjaGVkdWxlcy5mb3JFYWNoKChzY2hlZHVsZSkgPT4ge1xuICAgIGlmIChpc1RpbWVJbnRlcnZhbChzY2hlZHVsZSkpIHtcbiAgICAgIGNvbnN0IHsgdmFsdWUsIHVuaXQgfSA9IHBhcnNlVGltZUludGVydmFsKHNjaGVkdWxlLnJhdGUpO1xuXG4gICAgICBpZiAodmFsdWUgJiYgIWlzUG9zaXRpdmVXaG9sZU51bWJlcih2YWx1ZSkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgICAgJ0Z1bmN0aW9uIHNjaGVkdWxlIHJhdGUgbXVzdCBiZSBzZXQgd2l0aCBhIHBvc2l0aXZlIHdob2xlIG51bWJlcicsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICB2YWx1ZSAmJlxuICAgICAgICBsYW1iZGEudGltZW91dCAmJlxuICAgICAgICB1bml0ID09PSAnbScgJiZcbiAgICAgICAgdmFsdWUgKiA2MCA8IGxhbWJkYS50aW1lb3V0LnRvU2Vjb25kcygpXG4gICAgICApIHtcbiAgICAgICAgY29uc3QgdGltZW91dCA9IGxhbWJkYS50aW1lb3V0LnRvU2Vjb25kcygpO1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICBgRnVuY3Rpb24gc2NoZWR1bGUgcmF0ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB0aGUgZnVuY3Rpb24gdGltZW91dCBvZiAke3RpbWVvdXR9ICR7XG4gICAgICAgICAgICB0aW1lb3V0ID4gMSA/ICdzZWNvbmRzJyA6ICdzZWNvbmQnXG4gICAgICAgICAgfWAsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGNyb25FcnJvcnMgPSB2YWxpZGF0ZUNyb24oc2NoZWR1bGUuY3Jvbik7XG5cbiAgICAgIGlmIChjcm9uRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goLi4uY3JvbkVycm9ycyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGVycm9ycy5sZW5ndGggPT09IDApIHtcbiAgICAgIHNjaGVkdWxlUHJvcHMucHVzaCh7XG4gICAgICAgIHNjaGVkdWxlOiBTY2hlZHVsZUV4cHJlc3Npb24uY3JvbihcbiAgICAgICAgICB0cmFuc2xhdGVUb0Nyb25PcHRpb25zV2l0aFRpbWV6b25lKHNjaGVkdWxlKSxcbiAgICAgICAgKSxcbiAgICAgICAgZGVzY3JpcHRpb246IHNjaGVkdWxlLmRlc2NyaXB0aW9uLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JzLmpvaW4ob3MuRU9MKSk7XG4gIH1cblxuICByZXR1cm4gc2NoZWR1bGVQcm9wcztcbn07XG5cbmNvbnN0IGlzVGltZUludGVydmFsID0gKFxuICBzY2hlZHVsZTogWm9uZWRTY2hlZHVsZSxcbik6IHNjaGVkdWxlIGlzIFpvbmVkVGltZUludGVydmFsID0+IHtcbiAgY29uc3QgZXhwcmVzc2lvbiA9ICdyYXRlJyBpbiBzY2hlZHVsZSA/IHNjaGVkdWxlLnJhdGUgOiAnJztcbiAgY29uc3QgcGFydHMgPSBleHByZXNzaW9uLnNwbGl0KCcgJyk7XG5cbiAgcmV0dXJuIChcbiAgICBwYXJ0c1swXSA9PT0gJ2V2ZXJ5JyAmJlxuICAgIFsnbScsICdoJywgJ2RheScsICd3ZWVrJywgJ21vbnRoJywgJ3llYXInXS5zb21lKChhKSA9PlxuICAgICAgcGFydHNbMV0uZW5kc1dpdGgoYSksXG4gICAgKSAmJlxuICAgIHBhcnRzLmxlbmd0aCA9PT0gMlxuICApO1xufTtcblxuY29uc3QgcGFyc2VUaW1lSW50ZXJ2YWwgPSAodGltZUludGVydmFsOiBUaW1lSW50ZXJ2YWxFeHByZXNzaW9uKSA9PiB7XG4gIGNvbnN0IHBhcnQgPSB0aW1lSW50ZXJ2YWwuc3BsaXQoJyAnKVsxXTtcbiAgY29uc3QgdmFsdWUgPSBwYXJ0Lm1hdGNoKC8tP1xcZCtcXC4/XFxkKi8pO1xuICBjb25zdCB1bml0ID0gcGFydC5tYXRjaCgvW2EtekEtWl0rLyk7XG5cbiAgcmV0dXJuIHtcbiAgICB2YWx1ZTogdmFsdWUgPyBOdW1iZXIodmFsdWVbMF0pIDogdW5kZWZpbmVkLFxuICAgIHVuaXQ6IHVuaXQgPyB1bml0WzBdIDogdW5kZWZpbmVkLFxuICB9O1xufTtcblxuY29uc3QgaXNQb3NpdGl2ZVdob2xlTnVtYmVyID0gKHRlc3Q6IG51bWJlcikgPT4gdGVzdCA+IDAgJiYgdGVzdCAlIDEgPT09IDA7XG5cbmNvbnN0IHZhbGlkYXRlQ3JvbiA9IChjcm9uOiBDcm9uU2NoZWR1bGVFeHByZXNzaW9uKSA9PiB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgY29uc3QgY3JvblBhcnRzID0gY3Jvbi5zcGxpdCgnICcpO1xuXG4gIGNvbnN0IFttaW51dGUsIGhvdXIsIGRheU9mTW9udGgsIG1vbnRoLCBkYXlPZldlZWssIHllYXJdID0gY3JvblBhcnRzO1xuXG4gIGNvbnN0IG1pbnV0ZVZhbGlkYXRpb25FcnJvcnMgPSB2YWxpZGF0ZUNyb25QYXJ0KCdtaW51dGVzJywgbWludXRlLCAwLCA1OSk7XG4gIGNvbnN0IGhvdXJWYWxpZGF0aW9uRXJyb3JzID0gdmFsaWRhdGVDcm9uUGFydCgnaG91cnMnLCBob3VyLCAwLCAyMyk7XG4gIGNvbnN0IGRheU9mTW9udGhWYWxpZGF0aW9uRXJyb3JzID1cbiAgICBkYXlPZk1vbnRoID09PSAnPydcbiAgICAgID8gW11cbiAgICAgIDogdmFsaWRhdGVDcm9uUGFydCgnZGF5LW9mLW1vbnRoJywgZGF5T2ZNb250aCwgMSwgMzEpO1xuICBjb25zdCBtb250aFZhbGlkYXRpb25FcnJvcnMgPSB2YWxpZGF0ZUNyb25QYXJ0KCdtb250aCcsIG1vbnRoLCAxLCAxMik7XG4gIGNvbnN0IGRheU9mV2Vla1ZhbGlkYXRpb25FcnJvcnMgPVxuICAgIGRheU9mV2VlayA9PT0gJz8nID8gW10gOiB2YWxpZGF0ZUNyb25QYXJ0KCdkYXktb2Ytd2VlaycsIGRheU9mV2VlaywgMSwgNyk7XG4gIGNvbnN0IHllYXJWYWxpZGF0aW9uRXJyb3JzID0geWVhclxuICAgID8gdmFsaWRhdGVDcm9uUGFydCgneWVhcicsIHllYXIsIDE5NzAsIDIxOTkpXG4gICAgOiBbXTtcblxuICBlcnJvcnMucHVzaChcbiAgICAuLi5taW51dGVWYWxpZGF0aW9uRXJyb3JzLFxuICAgIC4uLmhvdXJWYWxpZGF0aW9uRXJyb3JzLFxuICAgIC4uLmRheU9mTW9udGhWYWxpZGF0aW9uRXJyb3JzLFxuICAgIC4uLm1vbnRoVmFsaWRhdGlvbkVycm9ycyxcbiAgICAuLi5kYXlPZldlZWtWYWxpZGF0aW9uRXJyb3JzLFxuICAgIC4uLnllYXJWYWxpZGF0aW9uRXJyb3JzLFxuICApO1xuXG4gIGlmIChkYXlPZk1vbnRoICE9PSAnPycgJiYgZGF5T2ZXZWVrICE9PSAnPycpIHtcbiAgICBlcnJvcnMucHVzaChcbiAgICAgICdDcm9uIGV4cHJlc3Npb25zIGNhbm5vdCBoYXZlIGJvdGggZGF5LW9mLW1vbnRoIGFuZCBkYXktb2Ytd2VlayBkZWZpbmVkLCB5b3UgbXVzdCB1c2UgYSA/IGluIG9uZSBvZiB0aGUgZmllbGRzJyxcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIGVycm9ycztcbn07XG5cbmNvbnN0IHZhbGlkYXRlQ3JvblBhcnQgPSAoXG4gIGNyb25QYXJ0OiBDcm9uUGFydCxcbiAgdmFsdWU6IHN0cmluZyxcbiAgbWluOiBudW1iZXIsXG4gIG1heDogbnVtYmVyLFxuKSA9PiB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAodmFsdWUgPT09ICcqJykge1xuICAgIHJldHVybiBlcnJvcnM7XG4gIH1cblxuICBjb25zdCBoYXNTdGVwID0gdmFsdWUuaW5jbHVkZXMoJy8nKTtcbiAgY29uc3QgaGFzUmFuZ2UgPSB2YWx1ZS5pbmNsdWRlcygnLScpO1xuICBjb25zdCBoYXNMaXN0ID0gdmFsdWUuaW5jbHVkZXMoJywnKTtcblxuICBpZiAoaGFzTGlzdCkge1xuICAgIGNvbnN0IGxpc3RFcnJvciA9IHZhbGlkYXRlTGlzdChjcm9uUGFydCwgdmFsdWUsIG1pbiwgbWF4KTtcblxuICAgIGlmIChsaXN0RXJyb3IpIHtcbiAgICAgIGVycm9ycy5wdXNoKGxpc3RFcnJvcik7XG4gICAgfVxuICAgIGNvbnN0IGxpc3RJdGVtcyA9IHZhbHVlLnNwbGl0KCcsJyk7XG5cbiAgICBsaXN0SXRlbXMuZm9yRWFjaCgobGlzdEl0ZW0pID0+IHtcbiAgICAgIGlmIChsaXN0SXRlbS5pbmNsdWRlcygnLycpKSB7XG4gICAgICAgIGNvbnN0IHN0ZXBFcnJvciA9IHZhbGlkYXRlU3RlcFZhbHVlKGNyb25QYXJ0LCBsaXN0SXRlbSwgbWluLCBtYXgpO1xuXG4gICAgICAgIGlmIChzdGVwRXJyb3IpIHtcbiAgICAgICAgICBlcnJvcnMucHVzaChzdGVwRXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGxpc3RJdGVtLmluY2x1ZGVzKCctJykpIHtcbiAgICAgICAgY29uc3QgcmFuZ2VFcnJvciA9IHZhbGlkYXRlUmFuZ2UoY3JvblBhcnQsIGxpc3RJdGVtLCBtaW4sIG1heCk7XG5cbiAgICAgICAgaWYgKHJhbmdlRXJyb3IpIHtcbiAgICAgICAgICBlcnJvcnMucHVzaChyYW5nZUVycm9yKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9IGVsc2UgaWYgKGhhc1N0ZXApIHtcbiAgICBjb25zdCBzdGVwRXJyb3IgPSB2YWxpZGF0ZVN0ZXBWYWx1ZShjcm9uUGFydCwgdmFsdWUsIG1pbiwgbWF4KTtcblxuICAgIGlmIChzdGVwRXJyb3IpIHtcbiAgICAgIGVycm9ycy5wdXNoKHN0ZXBFcnJvcik7XG4gICAgfVxuICB9IGVsc2UgaWYgKGhhc1JhbmdlKSB7XG4gICAgY29uc3QgcmFuZ2VFcnJvciA9IHZhbGlkYXRlUmFuZ2UoY3JvblBhcnQsIHZhbHVlLCBtaW4sIG1heCk7XG5cbiAgICBpZiAocmFuZ2VFcnJvcikge1xuICAgICAgZXJyb3JzLnB1c2gocmFuZ2VFcnJvcik7XG4gICAgfVxuICB9XG5cbiAgaWYgKFxuICAgICFoYXNTdGVwICYmXG4gICAgIWhhc1JhbmdlICYmXG4gICAgIWhhc0xpc3QgJiZcbiAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoTnVtYmVyKHZhbHVlKSwgbWluLCBtYXgpXG4gICkge1xuICAgIGVycm9ycy5wdXNoKFxuICAgICAgYENyb24gZmllbGQgZm9yICR7Y3JvblBhcnR9IG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke21pbn0gYW5kICR7bWF4fWAsXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBlcnJvcnM7XG59O1xuXG5jb25zdCB2YWxpZGF0ZVN0ZXBWYWx1ZSA9IChcbiAgY3JvblBhcnQ6IENyb25QYXJ0LFxuICB2YWx1ZTogc3RyaW5nLFxuICBtaW46IG51bWJlcixcbiAgbWF4OiBudW1iZXIsXG4pID0+IHtcbiAgY29uc3Qgb3JpZ2luYWxCYXNlID0gdmFsdWUuc3BsaXQoJy8nKVswXTtcbiAgY29uc3QgW2Jhc2UsIHN0ZXBdID0gdmFsdWUuc3BsaXQoJy8nKS5tYXAoTnVtYmVyKTtcblxuICBpZiAob3JpZ2luYWxCYXNlID09PSAnKicpIHtcbiAgICBpZiAoaXNOYU4oc3RlcCkgfHwgc3RlcCA8PSAwIHx8ICFpc1Bvc2l0aXZlV2hvbGVOdW1iZXIoc3RlcCkpIHtcbiAgICAgIHJldHVybiBgQ3JvbiBzdGVwIHZhbHVlcyBmb3IgJHtjcm9uUGFydH0gbXVzdCBiZSBwb3NpdGl2ZSB3aG9sZSBudW1iZXJzYDtcbiAgICB9XG4gIH0gZWxzZSBpZiAoXG4gICAgaXNOYU4oYmFzZSkgfHxcbiAgICBpc05hTihzdGVwKSB8fFxuICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShiYXNlLCBtaW4sIG1heCkgfHxcbiAgICBzdGVwIDw9IDBcbiAgKSB7XG4gICAgcmV0dXJuIGBDcm9uIHN0ZXAgdmFsdWVzIGZvciAke2Nyb25QYXJ0fSBtdXN0IGJlIHdob2xlIG51bWJlcnMgYmV0d2VlbiAke21pbn0gYW5kICR7bWF4fWA7XG4gIH1cblxuICByZXR1cm47XG59O1xuXG5jb25zdCB2YWxpZGF0ZVJhbmdlID0gKFxuICBjcm9uUGFydDogQ3JvblBhcnQsXG4gIHZhbHVlOiBzdHJpbmcsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlcixcbikgPT4ge1xuICBjb25zdCBbc3RhcnQsIGVuZF0gPSB2YWx1ZS5zcGxpdCgnLScpLm1hcChOdW1iZXIpO1xuXG4gIGlmIChcbiAgICBpc05hTihzdGFydCkgfHxcbiAgICBpc05hTihlbmQpIHx8XG4gICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKHN0YXJ0LCBtaW4sIG1heCkgfHxcbiAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoZW5kLCBtaW4sIG1heCkgfHxcbiAgICBzdGFydCA+IGVuZFxuICApIHtcbiAgICByZXR1cm4gYENyb24gcmFuZ2UgZm9yICR7Y3JvblBhcnR9IG11c3QgYmUgd2hvbGUgbnVtYmVycyBiZXR3ZWVuICR7bWlufSBhbmQgJHttYXh9YDtcbiAgfVxuXG4gIHJldHVybjtcbn07XG5cbmNvbnN0IHZhbGlkYXRlTGlzdCA9IChcbiAgY3JvblBhcnQ6IENyb25QYXJ0LFxuICB2YWx1ZTogc3RyaW5nLFxuICBtaW46IG51bWJlcixcbiAgbWF4OiBudW1iZXIsXG4pID0+IHtcbiAgaWYgKFxuICAgICF2YWx1ZVxuICAgICAgLnNwbGl0KCcsJylcbiAgICAgIC5ldmVyeSgodikgPT4gaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoTnVtYmVyKHYpLCBtaW4sIG1heCkpXG4gICkge1xuICAgIHJldHVybiBgQ3JvbiBsaXN0IGZvciAke2Nyb25QYXJ0fSBtdXN0IGNvbnRhaW4gd2hvbGUgbnVtYmVycyBiZXR3ZWVuICR7bWlufSBhbmQgJHttYXh9YDtcbiAgfVxuXG4gIHJldHVybjtcbn07XG5cbmNvbnN0IGlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlID0gKFxuICB0ZXN0OiBudW1iZXIsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlcixcbikgPT4gbWluIDw9IHRlc3QgJiYgdGVzdCA8PSBtYXggJiYgdGVzdCAlIDEgPT09IDA7XG5cbmNvbnN0IHRyYW5zbGF0ZVRvQ3Jvbk9wdGlvbnNXaXRoVGltZXpvbmUgPSAoXG4gIHNjaGVkdWxlOiBab25lZFNjaGVkdWxlLFxuKTogQ3Jvbk9wdGlvbnNXaXRoVGltZXpvbmUgPT4ge1xuICBpZiAoaXNUaW1lSW50ZXJ2YWwoc2NoZWR1bGUpKSB7XG4gICAgY29uc3QgeyB2YWx1ZSwgdW5pdCB9ID0gcGFyc2VUaW1lSW50ZXJ2YWwoc2NoZWR1bGUucmF0ZSk7XG4gICAgc3dpdGNoICh1bml0KSB7XG4gICAgICBjYXNlICdtJzpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtaW51dGU6IGAqLyR7dmFsdWV9YCxcbiAgICAgICAgICB0aW1lWm9uZTogVGltZVpvbmUub2Yoc2NoZWR1bGUudGltZXpvbmUpLFxuICAgICAgICB9O1xuICAgICAgY2FzZSAnaCc6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbWludXRlOiAnMCcsXG4gICAgICAgICAgaG91cjogYCovJHt2YWx1ZX1gLFxuICAgICAgICAgIHRpbWVab25lOiBUaW1lWm9uZS5vZihzY2hlZHVsZS50aW1lem9uZSksXG4gICAgICAgIH07XG4gICAgICBjYXNlICdkYXknOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG1pbnV0ZTogJzAnLFxuICAgICAgICAgIGhvdXI6ICcwJyxcbiAgICAgICAgICBkYXk6IGAqYCxcbiAgICAgICAgICB0aW1lWm9uZTogVGltZVpvbmUub2Yoc2NoZWR1bGUudGltZXpvbmUpLFxuICAgICAgICB9O1xuICAgICAgY2FzZSAnd2Vlayc6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbWludXRlOiAnMCcsXG4gICAgICAgICAgaG91cjogJzAnLFxuICAgICAgICAgIHdlZWtEYXk6IGAxYCxcbiAgICAgICAgICB0aW1lWm9uZTogVGltZVpvbmUub2Yoc2NoZWR1bGUudGltZXpvbmUpLFxuICAgICAgICB9O1xuICAgICAgY2FzZSAnbW9udGgnOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG1pbnV0ZTogJzAnLFxuICAgICAgICAgIGhvdXI6ICcwJyxcbiAgICAgICAgICBkYXk6ICcxJyxcbiAgICAgICAgICBtb250aDogYCpgLFxuICAgICAgICAgIHRpbWVab25lOiBUaW1lWm9uZS5vZihzY2hlZHVsZS50aW1lem9uZSksXG4gICAgICAgIH07XG4gICAgICBjYXNlICd5ZWFyJzpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtaW51dGU6ICcwJyxcbiAgICAgICAgICBob3VyOiAnMCcsXG4gICAgICAgICAgZGF5OiAnMScsXG4gICAgICAgICAgbW9udGg6ICcxJyxcbiAgICAgICAgICB5ZWFyOiBgKmAsXG4gICAgICAgICAgdGltZVpvbmU6IFRpbWVab25lLm9mKHNjaGVkdWxlLnRpbWV6b25lKSxcbiAgICAgICAgfTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIC8vIFRoaXMgc2hvdWxkIG5ldmVyIGhhcHBlbiB3aXRoIHN0cmljdCB0eXBlc1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ0NvdWxkIG5vdCBkZXRlcm1pbmUgdGhlIHNjaGVkdWxlIHJhdGUgZm9yIHRoZSBmdW5jdGlvbicsXG4gICAgICAgICk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IGNyb25BcnJheSA9IHNjaGVkdWxlLmNyb24uc3BsaXQoJyAnKTtcbiAgICBjb25zdCByZXN1bHQ6IFdyaXRhYmxlPENyb25PcHRpb25zV2l0aFRpbWV6b25lLCAnZGF5JyB8ICd3ZWVrRGF5Jz4gPSB7XG4gICAgICBtaW51dGU6IGNyb25BcnJheVswXSxcbiAgICAgIGhvdXI6IGNyb25BcnJheVsxXSxcbiAgICAgIG1vbnRoOiBjcm9uQXJyYXlbM10sXG4gICAgICB5ZWFyOiBjcm9uQXJyYXkubGVuZ3RoID09PSA2ID8gY3JvbkFycmF5WzVdIDogJyonLFxuICAgICAgdGltZVpvbmU6IFRpbWVab25lLm9mKHNjaGVkdWxlLnRpbWV6b25lKSxcbiAgICB9O1xuXG4gICAgLy8gQnJhbmNoaW5nIGxvZ2ljIGhlcmUgaXMgYmVjYXVzZSB3ZSBjYW5ub3Qgc3VwcGx5IGJvdGggZGF5IGFuZCB3ZWVrRGF5XG4gICAgaWYgKGNyb25BcnJheVsyXSA9PT0gJz8nKSB7XG4gICAgICByZXN1bHQud2Vla0RheSA9IGNyb25BcnJheVs0XTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzdWx0LmRheSA9IGNyb25BcnJheVsyXTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59O1xuIl19