import { AmplifyUserError, CallerDirectoryExtractor, TagName, } from '@aws-amplify/platform-core';
import { Duration, Size, Stack, Tags } from 'aws-cdk-lib';
import * as scheduler from 'aws-cdk-lib/aws-scheduler';
import * as targets from 'aws-cdk-lib/aws-scheduler-targets';
import { Architecture, LayerVersion, Runtime, } from 'aws-cdk-lib/aws-lambda';
import { LogLevel as EsBuildLogLevel, NodejsFunction, OutputFormat, } from 'aws-cdk-lib/aws-lambda-nodejs';
import { readFileSync } from 'fs';
import { createRequire } from 'module';
import { EOL } from 'os';
import * as path from 'path';
import { FunctionEnvironmentTranslator } from './function_env_translator.js';
import { FunctionEnvironmentTypeGenerator } from './function_env_type_generator.js';
import { FunctionLayerArnParser } from './layer_parser.js';
import { convertLoggingOptionsToCDK, createLogGroup, } from './logging_options_parser.js';
import { convertFunctionSchedulesToScheduleProps } from './schedule_parser.js';
import { ProvidedFunctionFactory, } from './provided_function_factory.js';
import { AmplifyFunctionBase } from './function_construct_base.js';
import { FunctionResourceAccessAcceptor } from './resource_access_acceptor.js';
/**
 * Entry point for defining a function in the Amplify ecosystem
 */
// This is the "implementation overload", it's not visible in public api.
// We have to use function notation instead of arrow notation.
// Arrow notation does not support overloads.
// eslint-disable-next-line no-restricted-syntax
export function defineFunction(propsOrProvider = {}, providerProps) {
    if (propsOrProvider && typeof propsOrProvider === 'function') {
        return new ProvidedFunctionFactory(propsOrProvider, providerProps);
    }
    return new FunctionFactory(propsOrProvider, new Error().stack);
}
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
class FunctionFactory {
    props;
    callerStack;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props, callerStack) {
        this.props = props;
        this.callerStack = callerStack;
    }
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, outputStorageStrategy, resourceNameValidator, }) => {
        if (!this.generator) {
            this.generator = new FunctionGenerator(this.hydrateDefaults(resourceNameValidator), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
    hydrateDefaults = (resourceNameValidator) => {
        const name = this.resolveName();
        resourceNameValidator?.validate(name);
        return {
            name,
            entry: this.resolveEntry(),
            timeoutSeconds: this.resolveTimeout(),
            memoryMB: this.resolveMemory(),
            ephemeralStorageSizeMB: this.resolveEphemeralStorageSize(),
            environment: this.resolveEnvironment(),
            runtime: this.resolveRuntime(),
            architecture: this.resolveArchitecture(),
            schedule: this.resolveSchedule(),
            bundling: this.resolveBundling(),
            layers: this.props.layers ?? {},
            resourceGroupName: this.props.resourceGroupName ?? 'function',
            logging: this.props.logging ?? {},
            durableConfig: this.resolveDurableConfig(),
        };
    };
    resolveName = () => {
        // If name is set explicitly, use that
        if (this.props.name) {
            return this.props.name;
        }
        // If entry is set, use the basename of the entry path
        if (this.props.entry) {
            return path.parse(this.props.entry).name;
        }
        // Otherwise, use the directory name where the function is defined
        return path.basename(new CallerDirectoryExtractor(this.callerStack).extract());
    };
    resolveEntry = () => {
        // if entry is not set, default to handler.ts
        if (!this.props.entry) {
            return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), 'handler.ts');
        }
        // if entry is absolute use that
        if (path.isAbsolute(this.props.entry)) {
            return this.props.entry;
        }
        // if entry is relative, compute with respect to the caller directory
        return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), this.props.entry);
    };
    resolveTimeout = () => {
        const timeoutMin = 1;
        const timeoutMax = 60 * 15; // 15 minutes in seconds
        const timeoutDefault = 3;
        if (this.props.timeoutSeconds === undefined) {
            return timeoutDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.timeoutSeconds, timeoutMin, timeoutMax)) {
            throw new AmplifyUserError('InvalidTimeoutError', {
                message: `Invalid function timeout of ${this.props.timeoutSeconds}`,
                resolution: `timeoutSeconds must be a whole number between ${timeoutMin} and ${timeoutMax} inclusive`,
            });
        }
        return this.props.timeoutSeconds;
    };
    resolveMemory = () => {
        const memoryMin = 128;
        const memoryMax = 10240;
        const memoryDefault = 512;
        if (this.props.memoryMB === undefined) {
            return memoryDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.memoryMB, memoryMin, memoryMax)) {
            throw new AmplifyUserError('InvalidMemoryMBError', {
                message: `Invalid function memoryMB of ${this.props.memoryMB}`,
                resolution: `memoryMB must be a whole number between ${memoryMin} and ${memoryMax} inclusive`,
            });
        }
        return this.props.memoryMB;
    };
    resolveEphemeralStorageSize = () => {
        const ephemeralStorageSizeMin = 512;
        const ephemeralStorageSizeMax = 10240;
        const ephemeralStorageSizeDefault = 512;
        if (this.props.ephemeralStorageSizeMB === undefined) {
            return ephemeralStorageSizeDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.ephemeralStorageSizeMB, ephemeralStorageSizeMin, ephemeralStorageSizeMax)) {
            throw new AmplifyUserError('InvalidEphemeralStorageSizeMBError', {
                message: `Invalid function ephemeralStorageSizeMB of ${this.props.ephemeralStorageSizeMB}`,
                resolution: `ephemeralStorageSizeMB must be a whole number between ${ephemeralStorageSizeMin} and ${ephemeralStorageSizeMax} inclusive`,
            });
        }
        return this.props.ephemeralStorageSizeMB;
    };
    resolveEnvironment = () => {
        if (this.props.environment === undefined) {
            return {};
        }
        const invalidKeys = [];
        Object.keys(this.props.environment).forEach((key) => {
            // validate using key pattern from https://docs.aws.amazon.com/lambda/latest/api/API_Environment.html
            if (!key.match(/^[a-zA-Z]([a-zA-Z0-9_])+$/)) {
                invalidKeys.push(key);
            }
        });
        if (invalidKeys.length > 0) {
            throw new AmplifyUserError('InvalidEnvironmentKeyError', {
                message: `Invalid function environment key(s): ${invalidKeys.join(', ')}`,
                resolution: 'Environment keys must match [a-zA-Z]([a-zA-Z0-9_])+ and be at least 2 characters',
            });
        }
        return this.props.environment;
    };
    resolveRuntime = () => {
        const runtimeDefault = 20;
        // if runtime is not set, default to the oldest LTS
        if (!this.props.runtime) {
            return runtimeDefault;
        }
        if (!(this.props.runtime in nodeVersionMap)) {
            throw new AmplifyUserError('InvalidRuntimeError', {
                message: `Invalid function runtime of ${this.props.runtime}`,
                resolution: `runtime must be one of the following: ${Object.keys(nodeVersionMap).join(', ')}`,
            });
        }
        return this.props.runtime;
    };
    resolveArchitecture = () => {
        const architectureDefault = 'x86_64';
        if (!this.props.architecture) {
            return architectureDefault;
        }
        if (!(this.props.architecture in architectureMap)) {
            throw new AmplifyUserError('InvalidArchitectureError', {
                message: `Invalid function architecture of ${this.props.architecture}`,
                resolution: `architecture must be one of the following: ${Object.keys(architectureMap).join(', ')}`,
            });
        }
        return this.props.architecture;
    };
    resolveSchedule = () => {
        if (!this.props.schedule) {
            return [];
        }
        return this.props.schedule;
    };
    resolveBundling = () => {
        const bundlingDefault = {
            format: OutputFormat.ESM,
            bundleAwsSDK: true,
            loader: {
                '.node': 'file',
            },
            minify: true,
            sourceMap: true,
        };
        return {
            ...bundlingDefault,
            minify: this.resolveMinify(this.props.bundling),
        };
    };
    resolveMinify = (bundling) => {
        return bundling?.minify === undefined ? true : bundling.minify;
    };
    resolveDurableConfig = () => {
        if (!this.props.durableConfig) {
            return undefined;
        }
        const { executionTimeoutSeconds, retentionPeriodDays } = this.props.durableConfig;
        const executionTimeoutMin = 1;
        const executionTimeoutMax = 31_622_400; // 366 days in seconds
        if (!isWholeNumberBetweenInclusive(executionTimeoutSeconds, executionTimeoutMin, executionTimeoutMax)) {
            throw new AmplifyUserError('InvalidDurableFunctionExecutionTimeoutError', {
                message: `Invalid durable function execution timeout of ${this.props.durableConfig.executionTimeoutSeconds}`,
                resolution: `durableConfig.executionTimeoutSeconds must be a whole number between ${executionTimeoutMin} and ${executionTimeoutMax} inclusive`,
            });
        }
        if (retentionPeriodDays !== undefined) {
            const retentionPeriodMin = 1;
            const retentionPeriodMax = 90;
            if (!isWholeNumberBetweenInclusive(retentionPeriodDays, retentionPeriodMin, retentionPeriodMax)) {
                throw new AmplifyUserError('InvalidDurableFunctionRetentionPeriodError', {
                    message: `Invalid durable function retention period of ${this.props.durableConfig.retentionPeriodDays}`,
                    resolution: `durableConfig.retentionPeriodDays must be a whole number between ${retentionPeriodMin} and ${retentionPeriodMax} inclusive`,
                });
            }
        }
        const runtime = this.resolveRuntime();
        if (runtime < 22) {
            throw new AmplifyUserError('UnsupportedDurableFunctionRuntimeError', {
                message: `Durable functions require runtime 22 or higher. Current runtime is ${runtime}.`,
                resolution: `Set the function runtime to 22 or higher to use durable functions.`,
            });
        }
        return {
            executionTimeoutSeconds: this.props.durableConfig.executionTimeoutSeconds,
            retentionPeriodDays: this.props.durableConfig.retentionPeriodDays ?? 14,
        };
    };
}
class FunctionGenerator {
    props;
    outputStorageStrategy;
    resourceGroupName;
    constructor(props, outputStorageStrategy) {
        this.props = props;
        this.outputStorageStrategy = outputStorageStrategy;
        this.resourceGroupName = props.resourceGroupName;
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        // Move layer resolution here where we have access to scope
        const parser = new FunctionLayerArnParser(Stack.of(scope).region, Stack.of(scope).account);
        const resolvedLayerArns = parser.parseLayers(this.props.layers ?? {}, this.props.name);
        // resolve layers to LayerVersion objects for the NodejsFunction constructor
        const resolvedLayers = Object.entries(resolvedLayerArns).map(([key, arn]) => LayerVersion.fromLayerVersionArn(scope, `${this.props.name}-${key}-layer`, arn));
        return new AmplifyFunction(scope, this.props.name, { ...this.props, resolvedLayers }, backendSecretResolver, this.outputStorageStrategy);
    };
}
class AmplifyFunction extends AmplifyFunctionBase {
    resources;
    functionEnvironmentTranslator;
    constructor(scope, id, props, backendSecretResolver, outputStorageStrategy) {
        super(scope, id, outputStorageStrategy);
        const runtime = nodeVersionMap[props.runtime];
        const require = createRequire(import.meta.url);
        const shims = runtime === Runtime.NODEJS_16_X
            ? []
            : [require.resolve('./lambda-shims/cjs_shim')];
        const ssmResolverFile = runtime === Runtime.NODEJS_16_X
            ? require.resolve('./lambda-shims/resolve_ssm_params_sdk_v2') // use aws cdk v2 in node 16
            : require.resolve('./lambda-shims/resolve_ssm_params');
        const invokeSsmResolverFile = require.resolve('./lambda-shims/invoke_ssm_shim');
        /**
         * This code concatenates the contents of the ssm resolver and invoker into a single line that can be used as the esbuild banner content
         * This banner is responsible for resolving the customer's SSM parameters at runtime
         */
        const bannerCode = readFileSync(ssmResolverFile, 'utf-8')
            .concat(readFileSync(invokeSsmResolverFile, 'utf-8'))
            .split(new RegExp(`${EOL}|\n|\r`, 'g'))
            .map((line) => line.replace(/\/\/.*$/, '')) // strip out inline comments because the banner is going to be flattened into a single line
            .join('');
        const functionEnvironmentTypeGenerator = new FunctionEnvironmentTypeGenerator(id);
        // esbuild runs as part of the NodejsFunction constructor, so we eagerly generate the process env shim without types so it can be included in the function bundle.
        // This will be overwritten with the typed file at the end of synthesis
        functionEnvironmentTypeGenerator.generateProcessEnvShim();
        let functionLambda;
        const cdkLoggingOptions = convertLoggingOptionsToCDK(props.logging);
        // Create a log group if retention is specified (replacing deprecated logRetention property)
        let logGroup = cdkLoggingOptions.logGroup;
        if (props.logging.retention !== undefined && !logGroup) {
            logGroup = createLogGroup(scope, id, props.logging);
        }
        try {
            functionLambda = new NodejsFunction(scope, `${id}-lambda`, {
                entry: props.entry,
                timeout: Duration.seconds(props.timeoutSeconds),
                memorySize: props.memoryMB,
                architecture: architectureMap[props.architecture],
                ephemeralStorageSize: Size.mebibytes(props.ephemeralStorageSizeMB),
                runtime: nodeVersionMap[props.runtime],
                layers: props.resolvedLayers,
                bundling: {
                    ...props.bundling,
                    banner: bannerCode,
                    inject: shims,
                    externalModules: Object.keys(props.layers),
                    logLevel: EsBuildLogLevel.ERROR,
                },
                logGroup: logGroup,
                applicationLogLevelV2: cdkLoggingOptions.level,
                loggingFormat: cdkLoggingOptions.format,
                durableConfig: props.durableConfig
                    ? {
                        executionTimeout: Duration.seconds(props.durableConfig.executionTimeoutSeconds),
                        retentionPeriod: Duration.days(props.durableConfig.retentionPeriodDays),
                    }
                    : undefined,
            });
        }
        catch (error) {
            // If the error is from ES Bundler which is executed as a child process by CDK,
            // then the error from CDK contains the command that was executed along with the exit status.
            // Wrapping it here  would cause the cdk_deployer to re-throw this wrapped exception
            // instead of scraping the stderr for actual ESBuild error.
            if (error instanceof Error &&
                error.message.match(/Failed to bundle asset.*exited with status/)) {
                throw error;
            }
            throw new AmplifyUserError('NodeJSFunctionConstructInitializationError', {
                message: 'Failed to instantiate nodejs function construct',
                resolution: 'See the underlying error message for more details. Use `--debug` for additional debugging information.',
            }, error);
        }
        let version;
        if (props.durableConfig) {
            try {
                version = functionLambda.currentVersion;
            }
            catch (error) {
                throw new AmplifyUserError('DurableFunctionVersionInitializationError', {
                    message: 'Failed to create version for durable function. Durable functions require a versioned Lambda function.',
                    resolution: 'See the underlying error message for more details.',
                }, error);
            }
        }
        try {
            const scheduleProps = convertFunctionSchedulesToScheduleProps(functionLambda, props.schedule);
            const lambdaTarget = new targets.LambdaInvoke(version ?? functionLambda);
            scheduleProps.forEach(({ schedule, description }, index) => {
                // Lambda name will be prepended to schedule id, so only using index here for uniqueness
                new scheduler.Schedule(functionLambda, `schedule-${index}`, {
                    schedule,
                    description,
                    target: lambdaTarget,
                });
            });
        }
        catch (error) {
            throw new AmplifyUserError('FunctionScheduleInitializationError', {
                message: 'Failed to instantiate schedule for nodejs function',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(functionLambda).add(TagName.FRIENDLY_NAME, id);
        this.functionEnvironmentTranslator = new FunctionEnvironmentTranslator(functionLambda, props.environment, backendSecretResolver, functionEnvironmentTypeGenerator);
        this.resources = {
            lambda: functionLambda,
            cfnResources: {
                cfnFunction: functionLambda.node.findChild('Resource'),
            },
        };
        this.storeOutput();
    }
    addEnvironment = (key, value) => {
        this.functionEnvironmentTranslator.addEnvironmentEntry(key, value);
    };
    getResourceAccessAcceptor = () => new FunctionResourceAccessAcceptor(this, this.functionEnvironmentTranslator);
}
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const nodeVersionMap = {
    16: Runtime.NODEJS_16_X,
    18: Runtime.NODEJS_18_X,
    20: Runtime.NODEJS_20_X,
    22: Runtime.NODEJS_22_X,
};
const architectureMap = {
    arm64: Architecture.ARM_64,
    x86_64: Architecture.X86_64,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLE9BQU8sR0FDUixNQUFNLDRCQUE0QixDQUFDO0FBbUJwQyxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzFELE9BQU8sS0FBSyxTQUFTLE1BQU0sMkJBQTJCLENBQUM7QUFDdkQsT0FBTyxLQUFLLE9BQU8sTUFBTSxtQ0FBbUMsQ0FBQztBQUM3RCxPQUFPLEVBQ0wsWUFBWSxFQUtaLFlBQVksRUFDWixPQUFPLEdBQ1IsTUFBTSx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLEVBQ0wsUUFBUSxJQUFJLGVBQWUsRUFDM0IsY0FBYyxFQUNkLFlBQVksR0FDYixNQUFNLCtCQUErQixDQUFDO0FBRXZDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDbEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUN2QyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQzdFLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzNELE9BQU8sRUFDTCwwQkFBMEIsRUFDMUIsY0FBYyxHQUNmLE1BQU0sNkJBQTZCLENBQUM7QUFDckMsT0FBTyxFQUFFLHVDQUF1QyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0UsT0FBTyxFQUNMLHVCQUF1QixHQUV4QixNQUFNLGdDQUFnQyxDQUFDO0FB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QWlDO0lBQ25ELEVBQUUsRUFBRSxPQUFPLENBQUMsV0FBVztJQUN2QixFQUFFLEVBQUUsT0FBTyxDQUFDLFdBQVc7SUFDdkIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0lBQ3ZCLEVBQUUsRUFBRSxPQUFPLENBQUMsV0FBVztDQUN4QixDQUFDO0FBSUYsTUFBTSxlQUFlLEdBQStDO0lBQ2xFLEtBQUssRUFBRSxZQUFZLENBQUMsTUFBTTtJQUMxQixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07Q0FDNUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZ1bmN0aW9uT3V0cHV0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHtcbiAgQW1wbGlmeVVzZXJFcnJvcixcbiAgQ2FsbGVyRGlyZWN0b3J5RXh0cmFjdG9yLFxuICBUYWdOYW1lLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWUsXG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIEJhY2tlbmRTZWNyZXQsXG4gIEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3IsXG4gIENvbnN0cnVjdEZhY3RvcnksXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBGdW5jdGlvblJlc291cmNlcyxcbiAgR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzLFxuICBMb2dMZXZlbCxcbiAgTG9nUmV0ZW50aW9uLFxuICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yLFxuICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yRmFjdG9yeSxcbiAgUmVzb3VyY2VOYW1lVmFsaWRhdG9yLFxuICBSZXNvdXJjZVByb3ZpZGVyLFxuICBTdGFja1Byb3ZpZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IER1cmF0aW9uLCBTaXplLCBTdGFjaywgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIHNjaGVkdWxlciBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc2NoZWR1bGVyJztcbmltcG9ydCAqIGFzIHRhcmdldHMgZnJvbSAnYXdzLWNkay1saWIvYXdzLXNjaGVkdWxlci10YXJnZXRzJztcbmltcG9ydCB7XG4gIEFyY2hpdGVjdHVyZSxcbiAgQ2ZuRnVuY3Rpb24sXG4gIElGdW5jdGlvbixcbiAgSUxheWVyVmVyc2lvbixcbiAgSVZlcnNpb24sXG4gIExheWVyVmVyc2lvbixcbiAgUnVudGltZSxcbn0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQge1xuICBMb2dMZXZlbCBhcyBFc0J1aWxkTG9nTGV2ZWwsXG4gIE5vZGVqc0Z1bmN0aW9uLFxuICBPdXRwdXRGb3JtYXQsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgY3JlYXRlUmVxdWlyZSB9IGZyb20gJ21vZHVsZSc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IgfSBmcm9tICcuL2Z1bmN0aW9uX2Vudl90cmFuc2xhdG9yLmpzJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHlwZV9nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgRnVuY3Rpb25MYXllckFyblBhcnNlciB9IGZyb20gJy4vbGF5ZXJfcGFyc2VyLmpzJztcbmltcG9ydCB7XG4gIGNvbnZlcnRMb2dnaW5nT3B0aW9uc1RvQ0RLLFxuICBjcmVhdGVMb2dHcm91cCxcbn0gZnJvbSAnLi9sb2dnaW5nX29wdGlvbnNfcGFyc2VyLmpzJztcbmltcG9ydCB7IGNvbnZlcnRGdW5jdGlvblNjaGVkdWxlc1RvU2NoZWR1bGVQcm9wcyB9IGZyb20gJy4vc2NoZWR1bGVfcGFyc2VyLmpzJztcbmltcG9ydCB7XG4gIFByb3ZpZGVkRnVuY3Rpb25GYWN0b3J5LFxuICBQcm92aWRlZEZ1bmN0aW9uUHJvcHMsXG59IGZyb20gJy4vcHJvdmlkZWRfZnVuY3Rpb25fZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBBbXBsaWZ5RnVuY3Rpb25CYXNlIH0gZnJvbSAnLi9mdW5jdGlvbl9jb25zdHJ1Y3RfYmFzZS5qcyc7XG5pbXBvcnQgeyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IgfSBmcm9tICcuL3Jlc291cmNlX2FjY2Vzc19hY2NlcHRvci5qcyc7XG5cbmV4cG9ydCB0eXBlIEFkZEVudmlyb25tZW50RmFjdG9yeSA9IHtcbiAgYWRkRW52aXJvbm1lbnQ6IChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IEJhY2tlbmRTZWNyZXQpID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgdHlwZSBDcm9uU2NoZWR1bGVFeHByZXNzaW9uID1cbiAgfCBgJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfWBcbiAgfCBgJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ31gO1xuXG5leHBvcnQgdHlwZSBab25lZENyb25TY2hlZHVsZSA9IHtcbiAgY3JvbjogQ3JvblNjaGVkdWxlRXhwcmVzc2lvbjtcbiAgdGltZXpvbmU6IHN0cmluZztcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG59O1xuXG5leHBvcnQgdHlwZSBDcm9uU2NoZWR1bGUgPSBDcm9uU2NoZWR1bGVFeHByZXNzaW9uIHwgWm9uZWRDcm9uU2NoZWR1bGU7XG5cbmV4cG9ydCB0eXBlIFRpbWVJbnRlcnZhbEV4cHJlc3Npb24gPVxuICB8IGBldmVyeSAke251bWJlcn1tYFxuICB8IGBldmVyeSAke251bWJlcn1oYFxuICB8IGBldmVyeSBkYXlgXG4gIHwgYGV2ZXJ5IHdlZWtgXG4gIHwgYGV2ZXJ5IG1vbnRoYFxuICB8IGBldmVyeSB5ZWFyYDtcblxuZXhwb3J0IHR5cGUgWm9uZWRUaW1lSW50ZXJ2YWwgPSB7XG4gIHJhdGU6IFRpbWVJbnRlcnZhbEV4cHJlc3Npb247XG4gIHRpbWV6b25lOiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xufTtcblxuZXhwb3J0IHR5cGUgVGltZUludGVydmFsID0gWm9uZWRUaW1lSW50ZXJ2YWwgfCBUaW1lSW50ZXJ2YWxFeHByZXNzaW9uO1xuXG5leHBvcnQgdHlwZSBGdW5jdGlvblNjaGVkdWxlID0gVGltZUludGVydmFsIHwgQ3JvblNjaGVkdWxlO1xuXG5leHBvcnQgdHlwZSBGdW5jdGlvbkxvZ0xldmVsID0gRXh0cmFjdDxcbiAgTG9nTGV2ZWwsXG4gICdpbmZvJyB8ICdkZWJ1ZycgfCAnd2FybicgfCAnZXJyb3InIHwgJ2ZhdGFsJyB8ICd0cmFjZSdcbj47XG5leHBvcnQgdHlwZSBGdW5jdGlvbkxvZ1JldGVudGlvbiA9IExvZ1JldGVudGlvbjtcblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZUZ1bmN0aW9uKFxuICBwcm9wcz86IEZ1bmN0aW9uUHJvcHMsXG4pOiBDb25zdHJ1Y3RGYWN0b3J5PFxuICBSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPiAmXG4gICAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnkgJlxuICAgIEFkZEVudmlyb25tZW50RmFjdG9yeSAmXG4gICAgU3RhY2tQcm92aWRlclxuPjtcbmV4cG9ydCBmdW5jdGlvbiBkZWZpbmVGdW5jdGlvbihcbiAgcHJvdmlkZXI6IChzY29wZTogQ29uc3RydWN0KSA9PiBJRnVuY3Rpb24sXG4gIHByb3ZpZGVyUHJvcHM/OiBQcm92aWRlZEZ1bmN0aW9uUHJvcHMsXG4pOiBDb25zdHJ1Y3RGYWN0b3J5PFxuICBSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPiAmXG4gICAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnkgJlxuICAgIEFkZEVudmlyb25tZW50RmFjdG9yeSAmXG4gICAgU3RhY2tQcm92aWRlclxuPjtcbi8qKlxuICogRW50cnkgcG9pbnQgZm9yIGRlZmluaW5nIGEgZnVuY3Rpb24gaW4gdGhlIEFtcGxpZnkgZWNvc3lzdGVtXG4gKi9cbi8vIFRoaXMgaXMgdGhlIFwiaW1wbGVtZW50YXRpb24gb3ZlcmxvYWRcIiwgaXQncyBub3QgdmlzaWJsZSBpbiBwdWJsaWMgYXBpLlxuLy8gV2UgaGF2ZSB0byB1c2UgZnVuY3Rpb24gbm90YXRpb24gaW5zdGVhZCBvZiBhcnJvdyBub3RhdGlvbi5cbi8vIEFycm93IG5vdGF0aW9uIGRvZXMgbm90IHN1cHBvcnQgb3ZlcmxvYWRzLlxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJlc3RyaWN0ZWQtc3ludGF4XG5leHBvcnQgZnVuY3Rpb24gZGVmaW5lRnVuY3Rpb24oXG4gIHByb3BzT3JQcm92aWRlcjogRnVuY3Rpb25Qcm9wcyB8ICgoc2NvcGU6IENvbnN0cnVjdCkgPT4gSUZ1bmN0aW9uKSA9IHt9LFxuICBwcm92aWRlclByb3BzPzogUHJvdmlkZWRGdW5jdGlvblByb3BzLFxuKTogdW5rbm93biB7XG4gIGlmIChwcm9wc09yUHJvdmlkZXIgJiYgdHlwZW9mIHByb3BzT3JQcm92aWRlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBuZXcgUHJvdmlkZWRGdW5jdGlvbkZhY3RvcnkocHJvcHNPclByb3ZpZGVyLCBwcm92aWRlclByb3BzKTtcbiAgfVxuICByZXR1cm4gbmV3IEZ1bmN0aW9uRmFjdG9yeShwcm9wc09yUHJvdmlkZXIsIG5ldyBFcnJvcigpLnN0YWNrKTtcbn1cblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25Qcm9wcyA9IHtcbiAgLyoqXG4gICAqIEEgbmFtZSBmb3IgdGhlIGZ1bmN0aW9uLlxuICAgKiBEZWZhdWx0cyB0byB0aGUgYmFzZW5hbWUgb2YgdGhlIGVudHJ5IHBhdGggaWYgc3BlY2lmaWVkLlxuICAgKiBJZiBubyBlbnRyeSBpcyBzcGVjaWZpZWQsIGRlZmF1bHRzIHRvIHRoZSBkaXJlY3RvcnkgbmFtZSBpbiB3aGljaCB0aGlzIGZ1bmN0aW9uIGlzIGRlZmluZWQuXG4gICAqXG4gICAqIEV4YW1wbGU6XG4gICAqIElmIGVudHJ5IGlzIGAuL3NjaGVkdWxlZC1kYi1iYWNrdXAudHNgIHRoZSBuYW1lIHdpbGwgZGVmYXVsdCB0byBcInNjaGVkdWxlZC1kYi1iYWNrdXBcIlxuICAgKiBJZiBlbnRyeSBpcyBub3Qgc2V0IGFuZCB0aGUgZnVuY3Rpb24gaXMgZGVmaW5lZCBpbiBgYW1wbGlmeS9mdW5jdGlvbnMvZGItYmFja3VwL3Jlc291cmNlLnRzYCB0aGUgbmFtZSB3aWxsIGRlZmF1bHQgdG8gXCJkYi1iYWNrdXBcIlxuICAgKi9cbiAgbmFtZT86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBmaWxlIHRoYXQgY29udGFpbnMgdGhlIGZ1bmN0aW9uIGVudHJ5IHBvaW50LlxuICAgKiBJZiB0aGlzIGlzIGEgcmVsYXRpdmUgcGF0aCwgaXQgaXMgY29tcHV0ZWQgcmVsYXRpdmUgdG8gdGhlIGZpbGUgd2hlcmUgdGhpcyBmdW5jdGlvbiBpcyBkZWZpbmVkXG4gICAqXG4gICAqIERlZmF1bHRzIHRvICcuL2hhbmRsZXIudHMnXG4gICAqL1xuICBlbnRyeT86IHN0cmluZztcblxuICAvKipcbiAgICogQW4gYW1vdW50IG9mIHRpbWUgaW4gc2Vjb25kcyBiZXR3ZWVuIDEgc2Vjb25kIGFuZCAxNSBtaW51dGVzLlxuICAgKiBNdXN0IGJlIGEgd2hvbGUgbnVtYmVyLlxuICAgKiBEZWZhdWx0IGlzIDMgc2Vjb25kcy5cbiAgICovXG4gIHRpbWVvdXRTZWNvbmRzPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBBbiBhbW91bnQgb2YgbWVtb3J5IChSQU0pIHRvIGFsbG9jYXRlIHRvIHRoZSBmdW5jdGlvbiBiZXR3ZWVuIDEyOCBhbmQgMTAyNDAgTUIuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIERlZmF1bHQgaXMgNTEyTUIuXG4gICAqL1xuICBtZW1vcnlNQj86IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIHNpemUgb2YgdGhlIGZ1bmN0aW9uJ3MgL3RtcCBkaXJlY3RvcnkgaW4gTUIuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIEBkZWZhdWx0IDUxMlxuICAgKi9cbiAgZXBoZW1lcmFsU3RvcmFnZVNpemVNQj86IG51bWJlcjtcblxuICAvKipcbiAgICogRW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgZHVyaW5nIGZ1bmN0aW9uIGV4ZWN1dGlvblxuICAgKi9cbiAgZW52aXJvbm1lbnQ/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0PjtcblxuICAvKipcbiAgICogTm9kZSBydW50aW1lIHZlcnNpb24gZm9yIHRoZSBsYW1iZGEgZW52aXJvbm1lbnQuXG4gICAqXG4gICAqIERlZmF1bHRzIHRvIHRoZSBvbGRlc3QgTm9kZUpTIExUUyB2ZXJzaW9uLiBTZWUgaHR0cHM6Ly9ub2RlanMub3JnL2VuL2Fib3V0L3ByZXZpb3VzLXJlbGVhc2VzXG4gICAqL1xuICBydW50aW1lPzogTm9kZVZlcnNpb247XG5cbiAgLyoqXG4gICAqIFRoZSBhcmNoaXRlY3R1cmUgb2YgdGhlIHRhcmdldCBwbGF0Zm9ybSBmb3IgdGhlIGxhbWJkYSBlbnZpcm9ubWVudC5cbiAgICogRGVmYXVsdHMgdG8gWDg2XzY0LlxuICAgKi9cbiAgYXJjaGl0ZWN0dXJlPzogRnVuY3Rpb25BcmNoaXRlY3R1cmU7XG5cbiAgLyoqXG4gICAqIEEgdGltZSBpbnRlcnZhbCBzdHJpbmcgdG8gcGVyaW9kaWNhbGx5IHJ1biB0aGUgZnVuY3Rpb24uXG4gICAqIFRoaXMgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvZiBgXCJldmVyeSA8cG9zaXRpdmUgd2hvbGUgbnVtYmVyPjxtIChtaW51dGUpIG9yIGggKGhvdXIpPlwiYCwgYFwiZXZlcnkgZGF5fHdlZWt8bW9udGh8eWVhclwiYCBvciBjcm9uIGV4cHJlc3Npb24uXG4gICAqIERlZmF1bHRzIHRvIG5vIHNjaGVkdWxpbmcgZm9yIHRoZSBmdW5jdGlvbi5cbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiZXZlcnkgNW1cIlxuICAgKiBAZXhhbXBsZVxuICAgKiBzY2hlZHVsZTogXCJldmVyeSB3ZWVrXCJcbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiMCA5ID8gKiAyICpcIiAvLyBldmVyeSBNb25kYXkgYXQgOWFtXG4gICAqL1xuICBzY2hlZHVsZT86IEZ1bmN0aW9uU2NoZWR1bGUgfCBGdW5jdGlvblNjaGVkdWxlW107XG5cbiAgLyoqXG4gICAqIEF0dGFjaCBMYW1iZGEgbGF5ZXJzIHRvIGEgZnVuY3Rpb25cbiAgICogLSBBIExhbWJkYSBsYXllciBpcyByZXByZXNlbnRlZCBieSBhbiBvYmplY3Qgb2Yga2V5L3ZhbHVlIHBhaXIgd2hlcmUgdGhlIGtleSBpcyB0aGUgbW9kdWxlIG5hbWUgdGhhdCBpcyBleHBvcnRlZCBmcm9tIHlvdXIgbGF5ZXIgYW5kIHRoZSB2YWx1ZSBpcyB0aGUgQVJOIG9mIHRoZSBsYXllci4gVGhlIGtleSAobW9kdWxlIG5hbWUpIGlzIHVzZWQgdG8gZXh0ZXJuYWxpemUgdGhlIG1vZHVsZSBkZXBlbmRlbmN5IHNvIGl0IGRvZXNuJ3QgZ2V0IGJ1bmRsZWQgd2l0aCB5b3VyIGxhbWJkYSBmdW5jdGlvblxuICAgKiAtIE1heGltdW0gb2YgNSBsYXllcnMgY2FuIGJlIGF0dGFjaGVkIHRvIGEgZnVuY3Rpb24gYW5kIG11c3QgYmUgaW4gdGhlIHNhbWUgcmVnaW9uIGFzIHRoZSBmdW5jdGlvbi5cbiAgICogQGV4YW1wbGVcbiAgICogbGF5ZXJzOiB7XG4gICAqICAgIFwiQGF3cy1sYW1iZGEtcG93ZXJ0b29scy9sb2dnZXJcIjogXCJhcm46YXdzOmxhbWJkYTo8Y3VycmVudC1yZWdpb24+OjA5NDI3NDEwNTkxNTpsYXllcjpBV1NMYW1iZGFQb3dlcnRvb2xzVHlwZVNjcmlwdFYyOjExXCJcbiAgICogfSxcbiAgICogb3JcbiAgICogQGV4YW1wbGVcbiAgICogbGF5ZXJzOiB7XG4gICAqICAgIFwiU2hhcnBcIjogXCJTaGFycExheWVyOjFcIlxuICAgKiB9LFxuICAgKiBAc2VlIFtBbXBsaWZ5IGRvY3VtZW50YXRpb24gZm9yIExhbWJkYSBsYXllcnNdKGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvZnVuY3Rpb25zL2FkZC1sYW1iZGEtbGF5ZXJzKVxuICAgKiBAc2VlIFtBV1MgZG9jdW1lbnRhdGlvbiBmb3IgTGFtYmRhIGxheWVyc10oaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvY2hhcHRlci1sYXllcnMuaHRtbClcbiAgICovXG4gIGxheWVycz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgLypcbiAgICogT3B0aW9ucyBmb3IgYnVuZGxpbmcgdGhlIGZ1bmN0aW9uIGNvZGUuXG4gICAqL1xuICBidW5kbGluZz86IEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBHcm91cCB0aGUgZnVuY3Rpb24gd2l0aCBleGlzdGluZyBBbXBsaWZ5IHJlc291cmNlcyBvciBzZXBhcmF0ZSB0aGUgZnVuY3Rpb24gaW50byBpdHMgb3duIGdyb3VwLlxuICAgKiBAZGVmYXVsdCAnZnVuY3Rpb24nIC8vIGdyb3VwaW5nIHdpdGggb3RoZXIgQW1wbGlmeSBmdW5jdGlvbnNcbiAgICogQGV4YW1wbGVcbiAgICogcmVzb3VyY2VHcm91cE5hbWU6ICdhdXRoJyAvLyB0byBncm91cCBhbiBhdXRoIHRyaWdnZXIgd2l0aCBhbiBhdXRoIHJlc291cmNlXG4gICAqL1xuICByZXNvdXJjZUdyb3VwTmFtZT86IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZTtcblxuICBsb2dnaW5nPzogRnVuY3Rpb25Mb2dnaW5nT3B0aW9ucztcblxuICAvKipcbiAgICogQ29uZmlndXJhdGlvbiBmb3IgZHVyYWJsZSBmdW5jdGlvbnMuXG4gICAqXG4gICAqIExhbWJkYSBkdXJhYmxlIGZ1bmN0aW9ucyBhbGxvdyBmb3IgbG9uZy1ydW5uaW5nIGV4ZWN1dGlvbnMgd2l0aCBwZXJzaXN0ZW50IHN0YXRlLlxuICAgKi9cbiAgZHVyYWJsZUNvbmZpZz86IEZ1bmN0aW9uRHVyYWJsZUNvbmZpZ09wdGlvbnM7XG59O1xuXG5leHBvcnQgdHlwZSBGdW5jdGlvbkJ1bmRsaW5nT3B0aW9ucyA9IHtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gbWluaWZ5IHRoZSBmdW5jdGlvbiBjb2RlLlxuICAgKlxuICAgKiBEZWZhdWx0cyB0byB0cnVlLlxuICAgKi9cbiAgbWluaWZ5PzogYm9vbGVhbjtcbn07XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uTG9nZ2luZ09wdGlvbnMgPSAoXG4gIHwge1xuICAgICAgZm9ybWF0OiAnanNvbic7XG4gICAgICBsZXZlbD86IEZ1bmN0aW9uTG9nTGV2ZWw7XG4gICAgfVxuICB8IHtcbiAgICAgIGZvcm1hdD86ICd0ZXh0JztcbiAgICB9XG4pICYge1xuICByZXRlbnRpb24/OiBGdW5jdGlvbkxvZ1JldGVudGlvbjtcbn07XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uRHVyYWJsZUNvbmZpZ09wdGlvbnMgPSB7XG4gIC8qKlxuICAgKiBUaGUgYW1vdW50IG9mIHRpbWUgaW4gc2Vjb25kcyB0aGF0IExhbWJkYSBhbGxvd3MgYSBkdXJhYmxlIGZ1bmN0aW9uIHRvIHJ1biBiZWZvcmUgc3RvcHBpbmcgaXQuXG4gICAqXG4gICAqIE11c3QgYmUgYmV0d2VlbiAxIGFuZCAzMSw2MjIsNDAwIHNlY29uZHMgKDM2NiBkYXlzKS5cbiAgICovXG4gIGV4ZWN1dGlvblRpbWVvdXRTZWNvbmRzOiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgbnVtYmVyIG9mIGRheXMgYWZ0ZXIgYSBkdXJhYmxlIGV4ZWN1dGlvbiBpcyBjbG9zZWQgdGhhdCBMYW1iZGEgcmV0YWlucyBpdHMgaGlzdG9yeS5cbiAgICpcbiAgICogTXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDkwIGRheXMuXG4gICAqIEBkZWZhdWx0IDE0XG4gICAqL1xuICByZXRlbnRpb25QZXJpb2REYXlzPzogbnVtYmVyO1xufTtcblxuLyoqXG4gKiBDcmVhdGUgTGFtYmRhIGZ1bmN0aW9ucyBpbiB0aGUgY29udGV4dCBvZiBhbiBBbXBsaWZ5IGJhY2tlbmQgZGVmaW5pdGlvblxuICovXG5jbGFzcyBGdW5jdGlvbkZhY3RvcnkgaW1wbGVtZW50cyBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlGdW5jdGlvbj4ge1xuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhbGxlclN0YWNrPzogc3RyaW5nLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgQW1wbGlmeUZ1bmN0aW9uIHdpdGhpbiB0aGUgcHJvdmlkZWQgQW1wbGlmeSBjb250ZXh0XG4gICAqL1xuICBnZXRJbnN0YW5jZSA9ICh7XG4gICAgY29uc3RydWN0Q29udGFpbmVyLFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gIH06IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzKTogQW1wbGlmeUZ1bmN0aW9uID0+IHtcbiAgICBpZiAoIXRoaXMuZ2VuZXJhdG9yKSB7XG4gICAgICB0aGlzLmdlbmVyYXRvciA9IG5ldyBGdW5jdGlvbkdlbmVyYXRvcihcbiAgICAgICAgdGhpcy5oeWRyYXRlRGVmYXVsdHMocmVzb3VyY2VOYW1lVmFsaWRhdG9yKSxcbiAgICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnN0cnVjdENvbnRhaW5lci5nZXRPckNvbXB1dGUodGhpcy5nZW5lcmF0b3IpIGFzIEFtcGxpZnlGdW5jdGlvbjtcbiAgfTtcblxuICBwcml2YXRlIGh5ZHJhdGVEZWZhdWx0cyA9IChcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/OiBSZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gICk6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHRoaXMucmVzb2x2ZU5hbWUoKTtcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/LnZhbGlkYXRlKG5hbWUpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBlbnRyeTogdGhpcy5yZXNvbHZlRW50cnkoKSxcbiAgICAgIHRpbWVvdXRTZWNvbmRzOiB0aGlzLnJlc29sdmVUaW1lb3V0KCksXG4gICAgICBtZW1vcnlNQjogdGhpcy5yZXNvbHZlTWVtb3J5KCksXG4gICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1COiB0aGlzLnJlc29sdmVFcGhlbWVyYWxTdG9yYWdlU2l6ZSgpLFxuICAgICAgZW52aXJvbm1lbnQ6IHRoaXMucmVzb2x2ZUVudmlyb25tZW50KCksXG4gICAgICBydW50aW1lOiB0aGlzLnJlc29sdmVSdW50aW1lKCksXG4gICAgICBhcmNoaXRlY3R1cmU6IHRoaXMucmVzb2x2ZUFyY2hpdGVjdHVyZSgpLFxuICAgICAgc2NoZWR1bGU6IHRoaXMucmVzb2x2ZVNjaGVkdWxlKCksXG4gICAgICBidW5kbGluZzogdGhpcy5yZXNvbHZlQnVuZGxpbmcoKSxcbiAgICAgIGxheWVyczogdGhpcy5wcm9wcy5sYXllcnMgPz8ge30sXG4gICAgICByZXNvdXJjZUdyb3VwTmFtZTogdGhpcy5wcm9wcy5yZXNvdXJjZUdyb3VwTmFtZSA/PyAnZnVuY3Rpb24nLFxuICAgICAgbG9nZ2luZzogdGhpcy5wcm9wcy5sb2dnaW5nID8/IHt9LFxuICAgICAgZHVyYWJsZUNvbmZpZzogdGhpcy5yZXNvbHZlRHVyYWJsZUNvbmZpZygpLFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlTmFtZSA9ICgpID0+IHtcbiAgICAvLyBJZiBuYW1lIGlzIHNldCBleHBsaWNpdGx5LCB1c2UgdGhhdFxuICAgIGlmICh0aGlzLnByb3BzLm5hbWUpIHtcbiAgICAgIHJldHVybiB0aGlzLnByb3BzLm5hbWU7XG4gICAgfVxuICAgIC8vIElmIGVudHJ5IGlzIHNldCwgdXNlIHRoZSBiYXNlbmFtZSBvZiB0aGUgZW50cnkgcGF0aFxuICAgIGlmICh0aGlzLnByb3BzLmVudHJ5KSB7XG4gICAgICByZXR1cm4gcGF0aC5wYXJzZSh0aGlzLnByb3BzLmVudHJ5KS5uYW1lO1xuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSwgdXNlIHRoZSBkaXJlY3RvcnkgbmFtZSB3aGVyZSB0aGUgZnVuY3Rpb24gaXMgZGVmaW5lZFxuICAgIHJldHVybiBwYXRoLmJhc2VuYW1lKFxuICAgICAgbmV3IENhbGxlckRpcmVjdG9yeUV4dHJhY3Rvcih0aGlzLmNhbGxlclN0YWNrKS5leHRyYWN0KCksXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVFbnRyeSA9ICgpID0+IHtcbiAgICAvLyBpZiBlbnRyeSBpcyBub3Qgc2V0LCBkZWZhdWx0IHRvIGhhbmRsZXIudHNcbiAgICBpZiAoIXRoaXMucHJvcHMuZW50cnkpIHtcbiAgICAgIHJldHVybiBwYXRoLmpvaW4oXG4gICAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpLFxuICAgICAgICAnaGFuZGxlci50cycsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGlmIGVudHJ5IGlzIGFic29sdXRlIHVzZSB0aGF0XG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZSh0aGlzLnByb3BzLmVudHJ5KSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZW50cnk7XG4gICAgfVxuXG4gICAgLy8gaWYgZW50cnkgaXMgcmVsYXRpdmUsIGNvbXB1dGUgd2l0aCByZXNwZWN0IHRvIHRoZSBjYWxsZXIgZGlyZWN0b3J5XG4gICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpLFxuICAgICAgdGhpcy5wcm9wcy5lbnRyeSxcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVRpbWVvdXQgPSAoKSA9PiB7XG4gICAgY29uc3QgdGltZW91dE1pbiA9IDE7XG4gICAgY29uc3QgdGltZW91dE1heCA9IDYwICogMTU7IC8vIDE1IG1pbnV0ZXMgaW4gc2Vjb25kc1xuICAgIGNvbnN0IHRpbWVvdXREZWZhdWx0ID0gMztcbiAgICBpZiAodGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdGltZW91dERlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKFxuICAgICAgICB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzLFxuICAgICAgICB0aW1lb3V0TWluLFxuICAgICAgICB0aW1lb3V0TWF4LFxuICAgICAgKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRUaW1lb3V0RXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIGZ1bmN0aW9uIHRpbWVvdXQgb2YgJHt0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzfWAsXG4gICAgICAgIHJlc29sdXRpb246IGB0aW1lb3V0U2Vjb25kcyBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHt0aW1lb3V0TWlufSBhbmQgJHt0aW1lb3V0TWF4fSBpbmNsdXNpdmVgLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU1lbW9yeSA9ICgpID0+IHtcbiAgICBjb25zdCBtZW1vcnlNaW4gPSAxMjg7XG4gICAgY29uc3QgbWVtb3J5TWF4ID0gMTAyNDA7XG4gICAgY29uc3QgbWVtb3J5RGVmYXVsdCA9IDUxMjtcbiAgICBpZiAodGhpcy5wcm9wcy5tZW1vcnlNQiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gbWVtb3J5RGVmYXVsdDtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKHRoaXMucHJvcHMubWVtb3J5TUIsIG1lbW9yeU1pbiwgbWVtb3J5TWF4KVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRNZW1vcnlNQkVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBtZW1vcnlNQiBvZiAke3RoaXMucHJvcHMubWVtb3J5TUJ9YCxcbiAgICAgICAgcmVzb2x1dGlvbjogYG1lbW9yeU1CIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke21lbW9yeU1pbn0gYW5kICR7bWVtb3J5TWF4fSBpbmNsdXNpdmVgLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLm1lbW9yeU1CO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUVwaGVtZXJhbFN0b3JhZ2VTaXplID0gKCkgPT4ge1xuICAgIGNvbnN0IGVwaGVtZXJhbFN0b3JhZ2VTaXplTWluID0gNTEyO1xuICAgIGNvbnN0IGVwaGVtZXJhbFN0b3JhZ2VTaXplTWF4ID0gMTAyNDA7XG4gICAgY29uc3QgZXBoZW1lcmFsU3RvcmFnZVNpemVEZWZhdWx0ID0gNTEyO1xuICAgIGlmICh0aGlzLnByb3BzLmVwaGVtZXJhbFN0b3JhZ2VTaXplTUIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGVwaGVtZXJhbFN0b3JhZ2VTaXplRGVmYXVsdDtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKFxuICAgICAgICB0aGlzLnByb3BzLmVwaGVtZXJhbFN0b3JhZ2VTaXplTUIsXG4gICAgICAgIGVwaGVtZXJhbFN0b3JhZ2VTaXplTWluLFxuICAgICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1heCxcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkRXBoZW1lcmFsU3RvcmFnZVNpemVNQkVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1CIG9mICR7dGhpcy5wcm9wcy5lcGhlbWVyYWxTdG9yYWdlU2l6ZU1CfWAsXG4gICAgICAgIHJlc29sdXRpb246IGBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1CIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke2VwaGVtZXJhbFN0b3JhZ2VTaXplTWlufSBhbmQgJHtlcGhlbWVyYWxTdG9yYWdlU2l6ZU1heH0gaW5jbHVzaXZlYCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5lcGhlbWVyYWxTdG9yYWdlU2l6ZU1CO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUVudmlyb25tZW50ID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLnByb3BzLmVudmlyb25tZW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnZhbGlkS2V5czogc3RyaW5nW10gPSBbXTtcblxuICAgIE9iamVjdC5rZXlzKHRoaXMucHJvcHMuZW52aXJvbm1lbnQpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgLy8gdmFsaWRhdGUgdXNpbmcga2V5IHBhdHRlcm4gZnJvbSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vbGFtYmRhL2xhdGVzdC9hcGkvQVBJX0Vudmlyb25tZW50Lmh0bWxcbiAgICAgIGlmICgha2V5Lm1hdGNoKC9eW2EtekEtWl0oW2EtekEtWjAtOV9dKSskLykpIHtcbiAgICAgICAgaW52YWxpZEtleXMucHVzaChrZXkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKGludmFsaWRLZXlzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkRW52aXJvbm1lbnRLZXlFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gZW52aXJvbm1lbnQga2V5KHMpOiAke2ludmFsaWRLZXlzLmpvaW4oXG4gICAgICAgICAgJywgJyxcbiAgICAgICAgKX1gLFxuICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICdFbnZpcm9ubWVudCBrZXlzIG11c3QgbWF0Y2ggW2EtekEtWl0oW2EtekEtWjAtOV9dKSsgYW5kIGJlIGF0IGxlYXN0IDIgY2hhcmFjdGVycycsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5lbnZpcm9ubWVudDtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVSdW50aW1lID0gKCkgPT4ge1xuICAgIGNvbnN0IHJ1bnRpbWVEZWZhdWx0ID0gMjA7XG5cbiAgICAvLyBpZiBydW50aW1lIGlzIG5vdCBzZXQsIGRlZmF1bHQgdG8gdGhlIG9sZGVzdCBMVFNcbiAgICBpZiAoIXRoaXMucHJvcHMucnVudGltZSkge1xuICAgICAgcmV0dXJuIHJ1bnRpbWVEZWZhdWx0O1xuICAgIH1cblxuICAgIGlmICghKHRoaXMucHJvcHMucnVudGltZSBpbiBub2RlVmVyc2lvbk1hcCkpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkUnVudGltZUVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBydW50aW1lIG9mICR7dGhpcy5wcm9wcy5ydW50aW1lfWAsXG4gICAgICAgIHJlc29sdXRpb246IGBydW50aW1lIG11c3QgYmUgb25lIG9mIHRoZSBmb2xsb3dpbmc6ICR7T2JqZWN0LmtleXMoXG4gICAgICAgICAgbm9kZVZlcnNpb25NYXAsXG4gICAgICAgICkuam9pbignLCAnKX1gLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMucnVudGltZTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVBcmNoaXRlY3R1cmUgPSAoKSA9PiB7XG4gICAgY29uc3QgYXJjaGl0ZWN0dXJlRGVmYXVsdCA9ICd4ODZfNjQnO1xuXG4gICAgaWYgKCF0aGlzLnByb3BzLmFyY2hpdGVjdHVyZSkge1xuICAgICAgcmV0dXJuIGFyY2hpdGVjdHVyZURlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKCEodGhpcy5wcm9wcy5hcmNoaXRlY3R1cmUgaW4gYXJjaGl0ZWN0dXJlTWFwKSkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRBcmNoaXRlY3R1cmVFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gYXJjaGl0ZWN0dXJlIG9mICR7dGhpcy5wcm9wcy5hcmNoaXRlY3R1cmV9YCxcbiAgICAgICAgcmVzb2x1dGlvbjogYGFyY2hpdGVjdHVyZSBtdXN0IGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nOiAke09iamVjdC5rZXlzKFxuICAgICAgICAgIGFyY2hpdGVjdHVyZU1hcCxcbiAgICAgICAgKS5qb2luKCcsICcpfWAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5hcmNoaXRlY3R1cmU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlU2NoZWR1bGUgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLnByb3BzLnNjaGVkdWxlKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMuc2NoZWR1bGU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlQnVuZGxpbmcgPSAoKSA9PiB7XG4gICAgY29uc3QgYnVuZGxpbmdEZWZhdWx0ID0ge1xuICAgICAgZm9ybWF0OiBPdXRwdXRGb3JtYXQuRVNNLFxuICAgICAgYnVuZGxlQXdzU0RLOiB0cnVlLFxuICAgICAgbG9hZGVyOiB7XG4gICAgICAgICcubm9kZSc6ICdmaWxlJyxcbiAgICAgIH0sXG4gICAgICBtaW5pZnk6IHRydWUsXG4gICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi5idW5kbGluZ0RlZmF1bHQsXG4gICAgICBtaW5pZnk6IHRoaXMucmVzb2x2ZU1pbmlmeSh0aGlzLnByb3BzLmJ1bmRsaW5nKSxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU1pbmlmeSA9IChidW5kbGluZz86IEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zKSA9PiB7XG4gICAgcmV0dXJuIGJ1bmRsaW5nPy5taW5pZnkgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBidW5kbGluZy5taW5pZnk7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlRHVyYWJsZUNvbmZpZyA9ICgpID0+IHtcbiAgICBpZiAoIXRoaXMucHJvcHMuZHVyYWJsZUNvbmZpZykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgY29uc3QgeyBleGVjdXRpb25UaW1lb3V0U2Vjb25kcywgcmV0ZW50aW9uUGVyaW9kRGF5cyB9ID1cbiAgICAgIHRoaXMucHJvcHMuZHVyYWJsZUNvbmZpZztcbiAgICBjb25zdCBleGVjdXRpb25UaW1lb3V0TWluID0gMTtcbiAgICBjb25zdCBleGVjdXRpb25UaW1lb3V0TWF4ID0gMzFfNjIyXzQwMDsgLy8gMzY2IGRheXMgaW4gc2Vjb25kc1xuICAgIGlmIChcbiAgICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShcbiAgICAgICAgZXhlY3V0aW9uVGltZW91dFNlY29uZHMsXG4gICAgICAgIGV4ZWN1dGlvblRpbWVvdXRNaW4sXG4gICAgICAgIGV4ZWN1dGlvblRpbWVvdXRNYXgsXG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0ludmFsaWREdXJhYmxlRnVuY3Rpb25FeGVjdXRpb25UaW1lb3V0RXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZHVyYWJsZSBmdW5jdGlvbiBleGVjdXRpb24gdGltZW91dCBvZiAke3RoaXMucHJvcHMuZHVyYWJsZUNvbmZpZy5leGVjdXRpb25UaW1lb3V0U2Vjb25kc31gLFxuICAgICAgICAgIHJlc29sdXRpb246IGBkdXJhYmxlQ29uZmlnLmV4ZWN1dGlvblRpbWVvdXRTZWNvbmRzIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke2V4ZWN1dGlvblRpbWVvdXRNaW59IGFuZCAke2V4ZWN1dGlvblRpbWVvdXRNYXh9IGluY2x1c2l2ZWAsXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAocmV0ZW50aW9uUGVyaW9kRGF5cyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCByZXRlbnRpb25QZXJpb2RNaW4gPSAxO1xuICAgICAgY29uc3QgcmV0ZW50aW9uUGVyaW9kTWF4ID0gOTA7XG4gICAgICBpZiAoXG4gICAgICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShcbiAgICAgICAgICByZXRlbnRpb25QZXJpb2REYXlzLFxuICAgICAgICAgIHJldGVudGlvblBlcmlvZE1pbixcbiAgICAgICAgICByZXRlbnRpb25QZXJpb2RNYXgsXG4gICAgICAgIClcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAnSW52YWxpZER1cmFibGVGdW5jdGlvblJldGVudGlvblBlcmlvZEVycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBkdXJhYmxlIGZ1bmN0aW9uIHJldGVudGlvbiBwZXJpb2Qgb2YgJHt0aGlzLnByb3BzLmR1cmFibGVDb25maWcucmV0ZW50aW9uUGVyaW9kRGF5c31gLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjogYGR1cmFibGVDb25maWcucmV0ZW50aW9uUGVyaW9kRGF5cyBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHtyZXRlbnRpb25QZXJpb2RNaW59IGFuZCAke3JldGVudGlvblBlcmlvZE1heH0gaW5jbHVzaXZlYCxcbiAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHJ1bnRpbWUgPSB0aGlzLnJlc29sdmVSdW50aW1lKCk7XG4gICAgaWYgKHJ1bnRpbWUgPCAyMikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ1Vuc3VwcG9ydGVkRHVyYWJsZUZ1bmN0aW9uUnVudGltZUVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgRHVyYWJsZSBmdW5jdGlvbnMgcmVxdWlyZSBydW50aW1lIDIyIG9yIGhpZ2hlci4gQ3VycmVudCBydW50aW1lIGlzICR7cnVudGltZX0uYCxcbiAgICAgICAgcmVzb2x1dGlvbjogYFNldCB0aGUgZnVuY3Rpb24gcnVudGltZSB0byAyMiBvciBoaWdoZXIgdG8gdXNlIGR1cmFibGUgZnVuY3Rpb25zLmAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgZXhlY3V0aW9uVGltZW91dFNlY29uZHM6IHRoaXMucHJvcHMuZHVyYWJsZUNvbmZpZy5leGVjdXRpb25UaW1lb3V0U2Vjb25kcyxcbiAgICAgIHJldGVudGlvblBlcmlvZERheXM6IHRoaXMucHJvcHMuZHVyYWJsZUNvbmZpZy5yZXRlbnRpb25QZXJpb2REYXlzID8/IDE0LFxuICAgIH07XG4gIH07XG59XG5cbnR5cGUgSHlkcmF0ZWRGdW5jdGlvblByb3BzID0ge1xuICBkdXJhYmxlQ29uZmlnPzogUmVxdWlyZWQ8RnVuY3Rpb25Qcm9wc1snZHVyYWJsZUNvbmZpZyddPjtcbn0gJiBSZXF1aXJlZDxPbWl0PEZ1bmN0aW9uUHJvcHMsICdkdXJhYmxlQ29uZmlnJz4+O1xuXG5jbGFzcyBGdW5jdGlvbkdlbmVyYXRvciBpbXBsZW1lbnRzIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yIHtcbiAgcmVhZG9ubHkgcmVzb3VyY2VHcm91cE5hbWU6IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBIeWRyYXRlZEZ1bmN0aW9uUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8RnVuY3Rpb25PdXRwdXQ+LFxuICApIHtcbiAgICB0aGlzLnJlc291cmNlR3JvdXBOYW1lID0gcHJvcHMucmVzb3VyY2VHcm91cE5hbWU7XG4gIH1cblxuICBnZW5lcmF0ZUNvbnRhaW5lckVudHJ5ID0gKHtcbiAgICBzY29wZSxcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIH06IEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcykgPT4ge1xuICAgIC8vIE1vdmUgbGF5ZXIgcmVzb2x1dGlvbiBoZXJlIHdoZXJlIHdlIGhhdmUgYWNjZXNzIHRvIHNjb3BlXG4gICAgY29uc3QgcGFyc2VyID0gbmV3IEZ1bmN0aW9uTGF5ZXJBcm5QYXJzZXIoXG4gICAgICBTdGFjay5vZihzY29wZSkucmVnaW9uLFxuICAgICAgU3RhY2sub2Yoc2NvcGUpLmFjY291bnQsXG4gICAgKTtcbiAgICBjb25zdCByZXNvbHZlZExheWVyQXJucyA9IHBhcnNlci5wYXJzZUxheWVycyhcbiAgICAgIHRoaXMucHJvcHMubGF5ZXJzID8/IHt9LFxuICAgICAgdGhpcy5wcm9wcy5uYW1lLFxuICAgICk7XG5cbiAgICAvLyByZXNvbHZlIGxheWVycyB0byBMYXllclZlcnNpb24gb2JqZWN0cyBmb3IgdGhlIE5vZGVqc0Z1bmN0aW9uIGNvbnN0cnVjdG9yXG4gICAgY29uc3QgcmVzb2x2ZWRMYXllcnMgPSBPYmplY3QuZW50cmllcyhyZXNvbHZlZExheWVyQXJucykubWFwKChba2V5LCBhcm5dKSA9PlxuICAgICAgTGF5ZXJWZXJzaW9uLmZyb21MYXllclZlcnNpb25Bcm4oXG4gICAgICAgIHNjb3BlLFxuICAgICAgICBgJHt0aGlzLnByb3BzLm5hbWV9LSR7a2V5fS1sYXllcmAsXG4gICAgICAgIGFybixcbiAgICAgICksXG4gICAgKTtcblxuICAgIHJldHVybiBuZXcgQW1wbGlmeUZ1bmN0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICB0aGlzLnByb3BzLm5hbWUsXG4gICAgICB7IC4uLnRoaXMucHJvcHMsIHJlc29sdmVkTGF5ZXJzIH0sXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICB0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICApO1xuICB9O1xufVxuXG5jbGFzcyBBbXBsaWZ5RnVuY3Rpb25cbiAgZXh0ZW5kcyBBbXBsaWZ5RnVuY3Rpb25CYXNlXG4gIGltcGxlbWVudHMgQWRkRW52aXJvbm1lbnRGYWN0b3J5XG57XG4gIHJlYWRvbmx5IHJlc291cmNlczogRnVuY3Rpb25SZXNvdXJjZXM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3I6IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yO1xuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyAmIHsgcmVzb2x2ZWRMYXllcnM6IElMYXllclZlcnNpb25bXSB9LFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxGdW5jdGlvbk91dHB1dD4sXG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5KTtcblxuICAgIGNvbnN0IHJ1bnRpbWUgPSBub2RlVmVyc2lvbk1hcFtwcm9wcy5ydW50aW1lXTtcblxuICAgIGNvbnN0IHJlcXVpcmUgPSBjcmVhdGVSZXF1aXJlKGltcG9ydC5tZXRhLnVybCk7XG5cbiAgICBjb25zdCBzaGltcyA9XG4gICAgICBydW50aW1lID09PSBSdW50aW1lLk5PREVKU18xNl9YXG4gICAgICAgID8gW11cbiAgICAgICAgOiBbcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9janNfc2hpbScpXTtcblxuICAgIGNvbnN0IHNzbVJlc29sdmVyRmlsZSA9XG4gICAgICBydW50aW1lID09PSBSdW50aW1lLk5PREVKU18xNl9YXG4gICAgICAgID8gcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9yZXNvbHZlX3NzbV9wYXJhbXNfc2RrX3YyJykgLy8gdXNlIGF3cyBjZGsgdjIgaW4gbm9kZSAxNlxuICAgICAgICA6IHJlcXVpcmUucmVzb2x2ZSgnLi9sYW1iZGEtc2hpbXMvcmVzb2x2ZV9zc21fcGFyYW1zJyk7XG5cbiAgICBjb25zdCBpbnZva2VTc21SZXNvbHZlckZpbGUgPSByZXF1aXJlLnJlc29sdmUoXG4gICAgICAnLi9sYW1iZGEtc2hpbXMvaW52b2tlX3NzbV9zaGltJyxcbiAgICApO1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBjb2RlIGNvbmNhdGVuYXRlcyB0aGUgY29udGVudHMgb2YgdGhlIHNzbSByZXNvbHZlciBhbmQgaW52b2tlciBpbnRvIGEgc2luZ2xlIGxpbmUgdGhhdCBjYW4gYmUgdXNlZCBhcyB0aGUgZXNidWlsZCBiYW5uZXIgY29udGVudFxuICAgICAqIFRoaXMgYmFubmVyIGlzIHJlc3BvbnNpYmxlIGZvciByZXNvbHZpbmcgdGhlIGN1c3RvbWVyJ3MgU1NNIHBhcmFtZXRlcnMgYXQgcnVudGltZVxuICAgICAqL1xuICAgIGNvbnN0IGJhbm5lckNvZGUgPSByZWFkRmlsZVN5bmMoc3NtUmVzb2x2ZXJGaWxlLCAndXRmLTgnKVxuICAgICAgLmNvbmNhdChyZWFkRmlsZVN5bmMoaW52b2tlU3NtUmVzb2x2ZXJGaWxlLCAndXRmLTgnKSlcbiAgICAgIC5zcGxpdChuZXcgUmVnRXhwKGAke0VPTH18XFxufFxccmAsICdnJykpXG4gICAgICAubWFwKChsaW5lKSA9PiBsaW5lLnJlcGxhY2UoL1xcL1xcLy4qJC8sICcnKSkgLy8gc3RyaXAgb3V0IGlubGluZSBjb21tZW50cyBiZWNhdXNlIHRoZSBiYW5uZXIgaXMgZ29pbmcgdG8gYmUgZmxhdHRlbmVkIGludG8gYSBzaW5nbGUgbGluZVxuICAgICAgLmpvaW4oJycpO1xuXG4gICAgY29uc3QgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IgPVxuICAgICAgbmV3IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yKGlkKTtcblxuICAgIC8vIGVzYnVpbGQgcnVucyBhcyBwYXJ0IG9mIHRoZSBOb2RlanNGdW5jdGlvbiBjb25zdHJ1Y3Rvciwgc28gd2UgZWFnZXJseSBnZW5lcmF0ZSB0aGUgcHJvY2VzcyBlbnYgc2hpbSB3aXRob3V0IHR5cGVzIHNvIGl0IGNhbiBiZSBpbmNsdWRlZCBpbiB0aGUgZnVuY3Rpb24gYnVuZGxlLlxuICAgIC8vIFRoaXMgd2lsbCBiZSBvdmVyd3JpdHRlbiB3aXRoIHRoZSB0eXBlZCBmaWxlIGF0IHRoZSBlbmQgb2Ygc3ludGhlc2lzXG4gICAgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IuZ2VuZXJhdGVQcm9jZXNzRW52U2hpbSgpO1xuXG4gICAgbGV0IGZ1bmN0aW9uTGFtYmRhOiBOb2RlanNGdW5jdGlvbjtcbiAgICBjb25zdCBjZGtMb2dnaW5nT3B0aW9ucyA9IGNvbnZlcnRMb2dnaW5nT3B0aW9uc1RvQ0RLKHByb3BzLmxvZ2dpbmcpO1xuXG4gICAgLy8gQ3JlYXRlIGEgbG9nIGdyb3VwIGlmIHJldGVudGlvbiBpcyBzcGVjaWZpZWQgKHJlcGxhY2luZyBkZXByZWNhdGVkIGxvZ1JldGVudGlvbiBwcm9wZXJ0eSlcbiAgICBsZXQgbG9nR3JvdXAgPSBjZGtMb2dnaW5nT3B0aW9ucy5sb2dHcm91cDtcbiAgICBpZiAocHJvcHMubG9nZ2luZy5yZXRlbnRpb24gIT09IHVuZGVmaW5lZCAmJiAhbG9nR3JvdXApIHtcbiAgICAgIGxvZ0dyb3VwID0gY3JlYXRlTG9nR3JvdXAoc2NvcGUsIGlkLCBwcm9wcy5sb2dnaW5nKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgZnVuY3Rpb25MYW1iZGEgPSBuZXcgTm9kZWpzRnVuY3Rpb24oc2NvcGUsIGAke2lkfS1sYW1iZGFgLCB7XG4gICAgICAgIGVudHJ5OiBwcm9wcy5lbnRyeSxcbiAgICAgICAgdGltZW91dDogRHVyYXRpb24uc2Vjb25kcyhwcm9wcy50aW1lb3V0U2Vjb25kcyksXG4gICAgICAgIG1lbW9yeVNpemU6IHByb3BzLm1lbW9yeU1CLFxuICAgICAgICBhcmNoaXRlY3R1cmU6IGFyY2hpdGVjdHVyZU1hcFtwcm9wcy5hcmNoaXRlY3R1cmVdLFxuICAgICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZTogU2l6ZS5tZWJpYnl0ZXMocHJvcHMuZXBoZW1lcmFsU3RvcmFnZVNpemVNQiksXG4gICAgICAgIHJ1bnRpbWU6IG5vZGVWZXJzaW9uTWFwW3Byb3BzLnJ1bnRpbWVdLFxuICAgICAgICBsYXllcnM6IHByb3BzLnJlc29sdmVkTGF5ZXJzLFxuICAgICAgICBidW5kbGluZzoge1xuICAgICAgICAgIC4uLnByb3BzLmJ1bmRsaW5nLFxuICAgICAgICAgIGJhbm5lcjogYmFubmVyQ29kZSxcbiAgICAgICAgICBpbmplY3Q6IHNoaW1zLFxuICAgICAgICAgIGV4dGVybmFsTW9kdWxlczogT2JqZWN0LmtleXMocHJvcHMubGF5ZXJzKSxcbiAgICAgICAgICBsb2dMZXZlbDogRXNCdWlsZExvZ0xldmVsLkVSUk9SLFxuICAgICAgICB9LFxuICAgICAgICBsb2dHcm91cDogbG9nR3JvdXAsXG4gICAgICAgIGFwcGxpY2F0aW9uTG9nTGV2ZWxWMjogY2RrTG9nZ2luZ09wdGlvbnMubGV2ZWwsXG4gICAgICAgIGxvZ2dpbmdGb3JtYXQ6IGNka0xvZ2dpbmdPcHRpb25zLmZvcm1hdCxcbiAgICAgICAgZHVyYWJsZUNvbmZpZzogcHJvcHMuZHVyYWJsZUNvbmZpZ1xuICAgICAgICAgID8ge1xuICAgICAgICAgICAgICBleGVjdXRpb25UaW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKFxuICAgICAgICAgICAgICAgIHByb3BzLmR1cmFibGVDb25maWcuZXhlY3V0aW9uVGltZW91dFNlY29uZHMsXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgIHJldGVudGlvblBlcmlvZDogRHVyYXRpb24uZGF5cyhcbiAgICAgICAgICAgICAgICBwcm9wcy5kdXJhYmxlQ29uZmlnLnJldGVudGlvblBlcmlvZERheXMsXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICB9XG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gSWYgdGhlIGVycm9yIGlzIGZyb20gRVMgQnVuZGxlciB3aGljaCBpcyBleGVjdXRlZCBhcyBhIGNoaWxkIHByb2Nlc3MgYnkgQ0RLLFxuICAgICAgLy8gdGhlbiB0aGUgZXJyb3IgZnJvbSBDREsgY29udGFpbnMgdGhlIGNvbW1hbmQgdGhhdCB3YXMgZXhlY3V0ZWQgYWxvbmcgd2l0aCB0aGUgZXhpdCBzdGF0dXMuXG4gICAgICAvLyBXcmFwcGluZyBpdCBoZXJlICB3b3VsZCBjYXVzZSB0aGUgY2RrX2RlcGxveWVyIHRvIHJlLXRocm93IHRoaXMgd3JhcHBlZCBleGNlcHRpb25cbiAgICAgIC8vIGluc3RlYWQgb2Ygc2NyYXBpbmcgdGhlIHN0ZGVyciBmb3IgYWN0dWFsIEVTQnVpbGQgZXJyb3IuXG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiZcbiAgICAgICAgZXJyb3IubWVzc2FnZS5tYXRjaCgvRmFpbGVkIHRvIGJ1bmRsZSBhc3NldC4qZXhpdGVkIHdpdGggc3RhdHVzLylcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnTm9kZUpTRnVuY3Rpb25Db25zdHJ1Y3RJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgbm9kZWpzIGZ1bmN0aW9uIGNvbnN0cnVjdCcsXG4gICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLiBVc2UgYC0tZGVidWdgIGZvciBhZGRpdGlvbmFsIGRlYnVnZ2luZyBpbmZvcm1hdGlvbi4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBhcyBFcnJvcixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IHZlcnNpb246IElWZXJzaW9uIHwgdW5kZWZpbmVkO1xuICAgIGlmIChwcm9wcy5kdXJhYmxlQ29uZmlnKSB7XG4gICAgICB0cnkge1xuICAgICAgICB2ZXJzaW9uID0gZnVuY3Rpb25MYW1iZGEuY3VycmVudFZlcnNpb247XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAnRHVyYWJsZUZ1bmN0aW9uVmVyc2lvbkluaXRpYWxpemF0aW9uRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICAgICdGYWlsZWQgdG8gY3JlYXRlIHZlcnNpb24gZm9yIGR1cmFibGUgZnVuY3Rpb24uIER1cmFibGUgZnVuY3Rpb25zIHJlcXVpcmUgYSB2ZXJzaW9uZWQgTGFtYmRhIGZ1bmN0aW9uLicsXG4gICAgICAgICAgICByZXNvbHV0aW9uOiAnU2VlIHRoZSB1bmRlcmx5aW5nIGVycm9yIG1lc3NhZ2UgZm9yIG1vcmUgZGV0YWlscy4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3IgYXMgRXJyb3IsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjaGVkdWxlUHJvcHMgPSBjb252ZXJ0RnVuY3Rpb25TY2hlZHVsZXNUb1NjaGVkdWxlUHJvcHMoXG4gICAgICAgIGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgICBwcm9wcy5zY2hlZHVsZSxcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGxhbWJkYVRhcmdldCA9IG5ldyB0YXJnZXRzLkxhbWJkYUludm9rZSh2ZXJzaW9uID8/IGZ1bmN0aW9uTGFtYmRhKTtcblxuICAgICAgc2NoZWR1bGVQcm9wcy5mb3JFYWNoKCh7IHNjaGVkdWxlLCBkZXNjcmlwdGlvbiB9LCBpbmRleCkgPT4ge1xuICAgICAgICAvLyBMYW1iZGEgbmFtZSB3aWxsIGJlIHByZXBlbmRlZCB0byBzY2hlZHVsZSBpZCwgc28gb25seSB1c2luZyBpbmRleCBoZXJlIGZvciB1bmlxdWVuZXNzXG4gICAgICAgIG5ldyBzY2hlZHVsZXIuU2NoZWR1bGUoZnVuY3Rpb25MYW1iZGEsIGBzY2hlZHVsZS0ke2luZGV4fWAsIHtcbiAgICAgICAgICBzY2hlZHVsZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbixcbiAgICAgICAgICB0YXJnZXQ6IGxhbWJkYVRhcmdldCxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdGdW5jdGlvblNjaGVkdWxlSW5pdGlhbGl6YXRpb25FcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGluc3RhbnRpYXRlIHNjaGVkdWxlIGZvciBub2RlanMgZnVuY3Rpb24nLFxuICAgICAgICAgIHJlc29sdXRpb246ICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBUYWdzLm9mKGZ1bmN0aW9uTGFtYmRhKS5hZGQoVGFnTmFtZS5GUklFTkRMWV9OQU1FLCBpZCk7XG5cbiAgICB0aGlzLmZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yID0gbmV3IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yKFxuICAgICAgZnVuY3Rpb25MYW1iZGEsXG4gICAgICBwcm9wcy5lbnZpcm9ubWVudCxcbiAgICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICAgIGZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yLFxuICAgICk7XG5cbiAgICB0aGlzLnJlc291cmNlcyA9IHtcbiAgICAgIGxhbWJkYTogZnVuY3Rpb25MYW1iZGEsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuRnVuY3Rpb246IGZ1bmN0aW9uTGFtYmRhLm5vZGUuZmluZENoaWxkKCdSZXNvdXJjZScpIGFzIENmbkZ1bmN0aW9uLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5zdG9yZU91dHB1dCgpO1xuICB9XG5cbiAgYWRkRW52aXJvbm1lbnQgPSAoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0KSA9PiB7XG4gICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvci5hZGRFbnZpcm9ubWVudEVudHJ5KGtleSwgdmFsdWUpO1xuICB9O1xuXG4gIGdldFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPSAoKTogUmVzb3VyY2VBY2Nlc3NBY2NlcHRvciA9PlxuICAgIG5ldyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IoXG4gICAgICB0aGlzLFxuICAgICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvcixcbiAgICApO1xufVxuXG5jb25zdCBpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZSA9IChcbiAgdGVzdDogbnVtYmVyLFxuICBtaW46IG51bWJlcixcbiAgbWF4OiBudW1iZXIsXG4pID0+IG1pbiA8PSB0ZXN0ICYmIHRlc3QgPD0gbWF4ICYmIHRlc3QgJSAxID09PSAwO1xuXG5leHBvcnQgdHlwZSBOb2RlVmVyc2lvbiA9IDE2IHwgMTggfCAyMCB8IDIyO1xuXG5jb25zdCBub2RlVmVyc2lvbk1hcDogUmVjb3JkPE5vZGVWZXJzaW9uLCBSdW50aW1lPiA9IHtcbiAgMTY6IFJ1bnRpbWUuTk9ERUpTXzE2X1gsXG4gIDE4OiBSdW50aW1lLk5PREVKU18xOF9YLFxuICAyMDogUnVudGltZS5OT0RFSlNfMjBfWCxcbiAgMjI6IFJ1bnRpbWUuTk9ERUpTXzIyX1gsXG59O1xuXG5leHBvcnQgdHlwZSBGdW5jdGlvbkFyY2hpdGVjdHVyZSA9ICd4ODZfNjQnIHwgJ2FybTY0JztcblxuY29uc3QgYXJjaGl0ZWN0dXJlTWFwOiBSZWNvcmQ8RnVuY3Rpb25BcmNoaXRlY3R1cmUsIEFyY2hpdGVjdHVyZT4gPSB7XG4gIGFybTY0OiBBcmNoaXRlY3R1cmUuQVJNXzY0LFxuICB4ODZfNjQ6IEFyY2hpdGVjdHVyZS5YODZfNjQsXG59O1xuIl19